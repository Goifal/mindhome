<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J.A.R.V.I.S. Workshop</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        @font-face { font-family:'Outfit'; font-style:normal; font-weight:300 700; font-display:swap; src:local('Outfit'),local('Inter'),local('Segoe UI'); }
        @font-face { font-family:'JetBrains Mono'; font-style:normal; font-weight:400 600; font-display:swap; src:local('JetBrains Mono'),local('SF Mono'),local('Consolas'),local('Menlo'); }
        :root {
            --bg-primary: #040810;
            --bg-secondary: #0a1018;
            --bg-card: #0c1520;
            --bg-card-hover: #111e2e;
            --bg-input: #081018;
            --accent: #00d4ff;
            --accent-dim: rgba(0,212,255,0.1);
            --accent-glow: rgba(0,212,255,0.35);
            --text-primary: #c8dce8;
            --text-secondary: #6889a0;
            --text-muted: #3a5568;
            --success: #00e676;
            --success-dim: rgba(0,230,118,0.12);
            --warning: #ffaa00;
            --danger: #ff3d3d;
            --danger-dim: rgba(255,61,61,0.12);
            --border: rgba(0,212,255,0.06);
            --border-hover: rgba(0,212,255,0.15);
            --border-accent: rgba(0,212,255,0.25);
            --shadow-glow: 0 0 30px rgba(0,212,255,0.15);
            --font: 'Outfit',-apple-system,BlinkMacSystemFont,sans-serif;
            --mono: 'JetBrains Mono','SF Mono',monospace;
            --fast: 0.15s ease;
            --normal: 0.25s ease;
        }

        /* ===== Theme: Stark (Rot/Gold) ===== */
        [data-theme="stark"] {
            --accent: #ff3d3d; --accent-dim: rgba(255,61,61,0.1);
            --accent-glow: rgba(255,61,61,0.35);
            --border: rgba(255,61,61,0.06); --border-hover: rgba(255,61,61,0.15);
            --border-accent: rgba(255,61,61,0.25);
            --shadow-glow: 0 0 30px rgba(255,61,61,0.15);
            --warning: #ffaa00; --success: #00e676;
        }
        /* ===== Theme: Matrix (Gruen) ===== */
        [data-theme="matrix"] {
            --accent: #00e676; --accent-dim: rgba(0,230,118,0.1);
            --accent-glow: rgba(0,230,118,0.35);
            --border: rgba(0,230,118,0.06); --border-hover: rgba(0,230,118,0.15);
            --border-accent: rgba(0,230,118,0.25);
            --shadow-glow: 0 0 30px rgba(0,230,118,0.15);
            --warning: #ffaa00; --danger: #ff3d3d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font);
            overflow-x: hidden;
            background-image: radial-gradient(circle at 20% 50%, rgba(0,212,255,0.015) 0%, transparent 50%),
                              radial-gradient(circle at 80% 20%, rgba(0,212,255,0.01) 0%, transparent 40%);
        }

        /* ===== Boot Screen (Jarvis HUD Style) ===== */
        #boot-screen {
            position: fixed; inset: 0; z-index: 1000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: radial-gradient(ellipse at center, rgba(0,212,255,0.04) 0%, var(--bg-primary) 70%);
            transition: opacity 0.8s ease;
        }
        #boot-screen.fade-out { opacity: 0; pointer-events: none; }
        .boot-hud-ring {
            width: 200px; height: 200px; position: relative; margin-bottom: 32px;
        }
        .boot-hud-ring svg { width: 100%; height: 100%; }
        .boot-arc-outer { fill: none; stroke: var(--accent); stroke-width: 1.5; stroke-dasharray: 40 20; opacity: 0.6; animation: bootRotate 3s linear infinite; transform-origin: center; filter: drop-shadow(0 0 4px rgba(0,212,255,0.5)); }
        .boot-arc-inner { fill: none; stroke: rgba(0,212,255,0.3); stroke-width: 1; stroke-dasharray: 15 25; opacity: 0.4; animation: bootRotateRev 6s linear infinite; transform-origin: center; }
        .boot-arc-center { fill: none; stroke: var(--accent); stroke-width: 0.8; stroke-dasharray: 8 12; opacity: 0.3; animation: bootRotate 10s linear infinite; transform-origin: center; }
        @keyframes bootRotate { to { transform: rotate(360deg); } }
        @keyframes bootRotateRev { to { transform: rotate(-360deg); } }
        .boot-title {
            font-size: 28px; font-weight: 600;
            color: var(--accent); margin-bottom: 12px;
            letter-spacing: 6px; text-transform: uppercase;
            text-shadow: 0 0 30px rgba(0,212,255,0.5), 0 0 60px rgba(0,212,255,0.2);
        }
        .boot-subtitle {
            font-size: 10px; color: var(--text-muted); letter-spacing: 3px;
            text-transform: uppercase; font-family: var(--mono); margin-bottom: 32px;
        }
        #boot-text {
            font-size: 12px; font-family: var(--mono);
            color: var(--accent); min-height: 20px;
            letter-spacing: 1px; text-shadow: 0 0 10px rgba(0,212,255,0.3);
        }
        .boot-systems {
            display: flex; gap: 16px; margin-top: 24px;
        }
        .boot-sys-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--text-muted); transition: background 0.3s, box-shadow 0.3s;
        }
        .boot-sys-dot.online { background: var(--success); box-shadow: 0 0 8px rgba(0,230,118,0.5); }

        /* ===== Main Layout ===== */
        #workshop-main {
            display: none; min-height: 100vh;
        }
        #workshop-main.active { display: flex; }

        /* ===== Header ===== */
        .header {
            height: 56px; display: flex; align-items: center;
            justify-content: space-between; padding: 0 24px;
            background: linear-gradient(90deg, rgba(8,14,24,0.97), rgba(10,16,28,0.95), rgba(8,14,24,0.97));
            border-bottom: 1px solid rgba(0,212,255,0.1);
            position: sticky; top: 0; z-index: 50;
            backdrop-filter: blur(16px);
        }
        .header::after {
            content: ''; position: absolute; bottom: -1px; left: 0; right: 0;
            height: 1px; background: linear-gradient(90deg, transparent, rgba(0,212,255,0.6), transparent);
            opacity: 0.3; filter: drop-shadow(0 0 4px rgba(0,212,255,0.3));
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo {
            font-size: 15px; font-weight: 600; letter-spacing: 3px;
            color: var(--accent); text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0,212,255,0.2);
        }
        .header-project {
            font-size: 12px; color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-family: var(--mono); max-width: 200px;
        }
        .header-project .proj-name { color: var(--text-primary); font-weight: 500; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .header-status {
            padding: 3px 10px; border-radius: 12px;
            font-size: 10px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 1px; font-family: var(--mono);
        }
        .status-active { background: var(--success-dim); color: var(--success); border: 1px solid rgba(0,230,118,0.3); }
        .status-paused { background: rgba(255,170,0,0.12); color: var(--warning); border: 1px solid rgba(255,170,0,0.3); }
        .status-none { background: var(--accent-dim); color: var(--text-muted); border: 1px solid var(--border); }
        .header-actions { display: flex; gap: 6px; }
        .header-actions button {
            background: rgba(0,212,255,0.04); border: 1px solid var(--border-hover);
            color: var(--text-secondary); padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 11px;
            font-family: var(--font); font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.5px; transition: all var(--fast);
        }
        .header-actions button:hover {
            border-color: var(--accent); color: var(--accent);
            box-shadow: 0 0 12px rgba(0,212,255,0.15);
        }

        /* ===== Sidebar (Jarvis Style) ===== */
        .sidebar {
            width: 240px; background: var(--bg-secondary);
            border-right: 1px solid rgba(0,212,255,0.1);
            display: flex; flex-direction: column;
            position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
            overflow: hidden;
        }
        .sidebar::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(0,212,255,0.03) 0%, transparent 40%, transparent 60%, rgba(0,212,255,0.02) 100%);
            pointer-events: none; z-index: 0;
        }
        .sidebar::after {
            content: ''; position: absolute; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0,212,255,0.6), transparent);
            opacity: 0.2; animation: sidebarScan 6s ease-in-out infinite;
            pointer-events: none; z-index: 1; filter: drop-shadow(0 0 4px rgba(0,212,255,0.4));
        }
        @keyframes sidebarScan { 0%,100% { top: 5%; } 50% { top: 95%; } }
        .sidebar-logo {
            padding: 18px 20px; border-bottom: 1px solid rgba(0,212,255,0.12);
            display: flex; align-items: center; gap: 12px;
            position: relative; z-index: 2;
        }
        .sidebar-logo .logo-icon {
            width: 36px; height: 36px; border: 1.5px solid var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700; color: var(--accent); font-family: var(--mono);
            box-shadow: 0 0 15px rgba(0,212,255,0.3), inset 0 0 10px rgba(0,212,255,0.15);
            animation: logoGlow 3s ease-in-out infinite;
        }
        @keyframes logoGlow { 0%,100% { box-shadow:0 0 15px rgba(0,212,255,0.3), inset 0 0 10px rgba(0,212,255,0.15); } 50% { box-shadow:0 0 25px rgba(0,212,255,0.5), inset 0 0 15px rgba(0,212,255,0.2); } }
        .sidebar-logo .logo-text h2 {
            font-size: 15px; font-weight: 600; letter-spacing: 4px;
            color: var(--accent); text-shadow: 0 0 20px rgba(0,212,255,0.4);
        }
        .sidebar-logo .logo-text span {
            font-size: 9px; color: var(--text-muted); display: block;
            text-transform: uppercase; letter-spacing: 2px; font-family: var(--mono);
        }
        .sidebar-nav {
            padding: 12px 8px; flex: 1; overflow-y: auto;
            position: relative; z-index: 2;
        }
        .sidebar h3 {
            font-size: 10px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1.5px;
            margin: 14px 0 6px; padding: 0 14px; font-family: var(--mono);
        }
        .sidebar h3:first-child { margin-top: 0; }
        .nav-btn {
            display: flex; align-items: center; gap: 10px;
            width: 100%; padding: 10px 14px;
            background: transparent; border: 1px solid transparent;
            color: var(--text-secondary); font-size: 12px;
            font-family: var(--font); font-weight: 500; cursor: pointer;
            border-radius: 4px; transition: all var(--fast);
            text-align: left; text-transform: uppercase; letter-spacing: 0.5px;
            position: relative;
        }
        .nav-btn:hover { background: rgba(0,212,255,0.04); color: var(--text-primary); border-color: rgba(0,212,255,0.1); }
        .nav-btn.active {
            background: rgba(0,212,255,0.06); color: var(--accent);
            border-color: rgba(0,212,255,0.2); box-shadow: 0 0 15px rgba(0,212,255,0.08);
        }
        .nav-btn.active::before {
            content: ''; position: absolute; left: 0; width: 2px; height: 24px;
            background: var(--accent); border-radius: 0 2px 2px 0; box-shadow: 0 0 10px var(--accent);
        }
        .nav-btn .icon { font-size: 14px; width: 20px; text-align: center; }
        .project-item {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 14px; border-radius: 4px;
            cursor: pointer; font-size: 11px;
            color: var(--text-secondary); transition: all var(--fast);
            font-family: var(--mono);
        }
        .project-item:hover { background: rgba(0,212,255,0.04); color: var(--text-primary); }
        .project-item.active { color: var(--accent); text-shadow: 0 0 10px rgba(0,212,255,0.3); }
        .project-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--text-muted); flex-shrink: 0;
        }
        .project-item.active .project-dot { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
        .sidebar-footer {
            padding: 12px; border-top: 1px solid rgba(0,212,255,0.1);
            font-size: 10px; color: var(--text-muted); text-align: center;
            position: relative; z-index: 2; font-family: var(--mono);
            letter-spacing: 1px; text-transform: uppercase;
        }

        /* ===== Main Content ===== */
        .main {
            margin-left: 240px; flex: 1; min-height: 100vh;
            overflow-x: hidden;
        }
        .main-content-area {
            padding: 24px; display: flex;
            flex-direction: column; gap: 16px;
        }

        /* ===== Widget (Jarvis Card Style) ===== */
        .widget {
            background: linear-gradient(135deg, rgba(12,21,32,0.95), rgba(8,16,24,0.98));
            border: 1px solid rgba(0,212,255,0.12);
            border-radius: 6px; padding: 20px;
            backdrop-filter: blur(4px);
            position: relative;
            transition: border-color var(--fast), box-shadow var(--fast);
        }
        .widget::before {
            content: ''; position: absolute; top: 0; left: 20px; right: 20px;
            height: 1px; background: linear-gradient(90deg, transparent, rgba(0,212,255,0.4), transparent);
            opacity: 0.5;
        }
        .widget:hover { border-color: rgba(0,212,255,0.2); box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .widget-header {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 14px; font-size: 11px;
            color: var(--text-secondary); text-transform: uppercase;
            letter-spacing: 1.5px; font-weight: 600;
        }
        .widget-header .icon { font-size: 14px; }
        .widget-title { color: var(--accent); text-shadow: 0 0 10px rgba(0,212,255,0.2); }

        /* Widget Grid Layouts */
        .widget-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .widget-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
        @media (max-width: 1200px) {
            .widget-row, .widget-row-3 { grid-template-columns: 1fr; }
        }

        /* ===== Projekt-Info Widget ===== */
        .project-meta { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; }
        .meta-item { font-size: 12px; color: var(--text-secondary); }
        .meta-item span { color: var(--text-primary); }

        /* ===== Step Navigator ===== */
        .step-list { list-style: none; }
        .step-item {
            padding: 8px 12px; border-left: 2px solid var(--border);
            margin-left: 8px; font-size: 12px;
            color: var(--text-secondary); cursor: pointer;
            transition: all 0.2s;
        }
        .step-item:hover { color: var(--text-primary); }
        .step-item.active { border-color: var(--accent); color: var(--accent); }
        .step-item.done { border-color: var(--success); color: var(--success); }
        .step-nav-btns { display: flex; gap: 8px; margin-top: 12px; }
        .step-btn {
            padding: 8px 16px; border-radius: 4px;
            border: 1px solid var(--border-hover);
            background: rgba(0,212,255,0.04); color: var(--text-primary);
            font-family: var(--font); font-size: 12px; font-weight: 500;
            cursor: pointer; transition: all var(--fast);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .step-btn:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 12px rgba(0,212,255,0.15); }
        .progress-bar {
            height: 4px; background: var(--border);
            border-radius: 2px; margin-top: 8px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: var(--accent);
            border-radius: 2px; transition: width 0.3s;
        }

        /* ===== Parts List ===== */
        .parts-table { width: 100%; font-size: 12px; border-collapse: collapse; }
        .parts-table th {
            text-align: left; padding: 6px 8px;
            color: var(--text-secondary); font-weight: 500;
            border-bottom: 1px solid var(--border);
        }
        .parts-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
        .part-available { color: var(--success); }
        .part-missing { color: var(--danger); }

        /* ===== Code Editor ===== */
        .code-container {
            background: #1a1a2e; border-radius: 8px;
            overflow: hidden; position: relative;
        }
        .code-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; background: #12122a;
            font-size: 11px; color: var(--text-secondary);
        }
        .code-content {
            padding: 12px; font-size: 12px;
            line-height: 1.6; overflow-x: auto;
            max-height: 400px; overflow-y: auto;
        }
        .code-content pre { margin: 0; }
        .code-content code { font-family: 'JetBrains Mono', monospace; }
        .btn-copy {
            background: transparent; border: 1px solid var(--border);
            color: var(--text-secondary); padding: 2px 8px;
            border-radius: 4px; cursor: pointer; font-size: 10px;
            font-family: inherit;
        }
        .btn-copy:hover { color: var(--accent); border-color: var(--accent); }

        /* ===== Schematic Viewer ===== */
        .schematic-container {
            background: #0a0a1a; border-radius: 8px;
            padding: 16px; text-align: center; min-height: 200px;
            display: flex; align-items: center; justify-content: center;
        }
        .schematic-container svg { max-width: 100%; height: auto; }
        .schematic-empty { color: var(--text-secondary); font-size: 13px; }

        /* ===== Chat Panel ===== */
        .chat-messages {
            max-height: 400px; overflow-y: auto;
            padding: 8px; display: flex;
            flex-direction: column; gap: 8px;
        }
        .chat-msg {
            padding: 10px 14px; border-radius: 6px;
            font-size: 13px; line-height: 1.6;
            max-width: 85%;
        }
        .chat-msg.user {
            align-self: flex-end;
            background: rgba(0,212,255,0.08); color: var(--accent);
            border: 1px solid rgba(0,212,255,0.2);
        }
        .chat-msg.jarvis {
            align-self: flex-start;
            background: rgba(12,21,32,0.9); color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .chat-msg.streaming { opacity: 0.7; }
        .chat-input-row {
            display: flex; gap: 8px; margin-top: 12px;
        }
        .chat-input {
            flex: 1; background: rgba(0,212,255,0.02);
            border: 1px solid rgba(0,212,255,0.08); border-radius: 4px;
            padding: 10px 14px; color: var(--text-primary);
            font-family: var(--font); font-size: 13px;
        }
        .chat-input:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0,212,255,0.12), inset 0 0 15px rgba(0,212,255,0.03);
        }
        .btn-send, .btn-voice {
            background: rgba(0,212,255,0.08); border: 1px solid var(--accent);
            color: var(--accent); padding: 10px 16px;
            border-radius: 4px; cursor: pointer;
            font-family: var(--font); font-size: 12px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all var(--fast);
            box-shadow: 0 0 10px rgba(0,212,255,0.1);
        }
        .btn-send:hover, .btn-voice:hover {
            background: rgba(0,212,255,0.15);
            box-shadow: 0 0 20px rgba(0,212,255,0.25);
        }
        .btn-voice.recording { background: var(--danger-dim); border-color: var(--danger); color: var(--danger); box-shadow: 0 0 15px rgba(255,61,61,0.3); }

        /* ===== Environment Widget ===== */
        .env-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .env-item { text-align: center; }
        .env-value { font-size: 24px; font-weight: 600; color: var(--accent); }
        .env-label { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        .env-unit { font-size: 12px; color: var(--text-secondary); }

        /* ===== Printer Status ===== */
        .printer-progress {
            display: flex; align-items: center; gap: 12px; margin: 8px 0;
        }
        .printer-bar { flex: 1; }
        .printer-percent { font-size: 20px; font-weight: 600; color: var(--accent); }
        .printer-temps { display: flex; gap: 16px; font-size: 12px; margin-top: 8px; }
        .printer-temps span { color: var(--text-secondary); }
        .printer-temps .val { color: var(--warning); }

        /* ===== Arm Control ===== */
        .arm-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .arm-btn {
            padding: 10px; border-radius: 6px;
            border: 1px solid var(--border); background: transparent;
            color: var(--text-primary); font-family: inherit;
            font-size: 11px; cursor: pointer; transition: all 0.2s;
            text-align: center;
        }
        .arm-btn:hover { border-color: var(--accent); color: var(--accent); }
        .arm-btn.emergency {
            border-color: var(--danger); color: var(--danger);
            grid-column: span 3;
        }
        .arm-btn.emergency:hover { background: var(--danger); color: #fff; }

        /* ===== Budget Tracker ===== */
        .budget-bar-container { position: relative; margin: 12px 0; }
        .budget-bar {
            height: 20px; background: var(--border);
            border-radius: 10px; overflow: hidden;
        }
        .budget-fill {
            height: 100%; border-radius: 10px;
            background: linear-gradient(90deg, var(--success), var(--accent));
            transition: width 0.3s;
        }
        .budget-fill.over { background: linear-gradient(90deg, var(--warning), var(--danger)); }
        .budget-labels {
            display: flex; justify-content: space-between;
            font-size: 11px; color: var(--text-secondary); margin-top: 4px;
        }
        .budget-amount { font-size: 20px; font-weight: 600; }

        /* ===== File Browser ===== */
        .file-list { list-style: none; }
        .file-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 8px; border-radius: 4px;
            font-size: 12px; cursor: pointer; transition: all 0.2s;
        }
        .file-item:hover { background: var(--accent-dim); }
        .file-icon { width: 16px; text-align: center; }
        .file-name { flex: 1; }
        .file-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
        .file-item:hover .file-actions { opacity: 1; }
        .file-action-btn {
            background: transparent; border: none;
            color: var(--text-secondary); cursor: pointer;
            font-size: 12px; padding: 2px;
        }
        .file-action-btn:hover { color: var(--accent); }

        /* ===== Calculator ===== */
        .calc-btns { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .calc-btn {
            padding: 6px 12px; border-radius: 6px;
            border: 1px solid var(--border); background: transparent;
            color: var(--text-secondary); font-family: inherit;
            font-size: 11px; cursor: pointer; transition: all 0.2s;
        }
        .calc-btn:hover, .calc-btn.active { border-color: var(--accent); color: var(--accent); }
        .calc-form { display: flex; flex-direction: column; gap: 8px; }
        .calc-form label { font-size: 11px; color: var(--text-secondary); }
        .calc-form input {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 6px; padding: 6px 10px;
            color: var(--text-primary); font-family: inherit; font-size: 12px;
        }
        .calc-form input:focus { outline: none; border-color: var(--accent); }
        .calc-result {
            margin-top: 8px; padding: 10px;
            background: var(--bg-secondary); border-radius: 6px;
            font-size: 12px; line-height: 1.6;
        }

        /* ===== Journal ===== */
        .journal-entries { display: flex; flex-direction: column; gap: 8px; }
        .journal-entry {
            padding: 8px 12px; border-left: 2px solid var(--accent);
            font-size: 12px; line-height: 1.5;
        }
        .journal-time { font-size: 10px; color: var(--text-secondary); }

        /* ===== Footer ===== */
        .footer {
            display: flex; align-items: center;
            padding: 0 16px; gap: 16px; height: 36px;
            background: var(--bg-secondary);
            border-top: 1px solid rgba(0,212,255,0.1);
            font-size: 10px; color: var(--text-muted);
            font-family: var(--mono); letter-spacing: 0.5px;
        }
        .footer-ws { display: flex; align-items: center; gap: 6px; }
        .ws-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--danger);
        }
        .ws-dot.connected { background: var(--success); animation: livePulse 2s ease-in-out infinite; }
        @keyframes livePulse { 0%,100% { opacity: 1; box-shadow: 0 0 4px rgba(0,230,118,0.5); } 50% { opacity: 0.6; box-shadow: 0 0 8px rgba(0,230,118,0.8); } }

        /* ===== Scrollbar ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

        /* ===== Notification Toast ===== */
        .toast {
            position: fixed; top: 20px; right: 20px;
            padding: 12px 20px; border-radius: 4px;
            background: rgba(8,16,28,0.95); border: 1px solid var(--border-accent);
            color: var(--text-primary); font-size: 12px;
            z-index: 900; opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
            backdrop-filter: blur(16px);
            box-shadow: var(--shadow-glow);
            font-family: var(--font);
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* ===== Modal / Dialog (Jarvis HUD) ===== */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 800;
            background: rgba(4,8,16,0.85);
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.hidden { display: none; }
        .modal {
            background: rgba(8,16,28,0.95); border: 1px solid var(--border-accent);
            border-radius: 6px; padding: 28px; width: 90%; max-width: 440px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.6), var(--shadow-glow), inset 0 1px 0 rgba(0,212,255,0.1);
            position: relative; backdrop-filter: blur(16px);
        }
        .modal::before {
            content: ''; position: absolute; top: 0; left: 20px; right: 20px;
            height: 1px; background: linear-gradient(90deg, transparent, rgba(0,212,255,0.5), transparent);
        }
        .modal .hud-corner { position: absolute; width: 16px; height: 16px; border-color: var(--accent); opacity: 0.4; }
        .modal h3 {
            font-size: 15px; color: var(--accent); margin-bottom: 20px;
            letter-spacing: 2px; text-transform: uppercase; font-weight: 600;
            text-shadow: 0 0 15px rgba(0,212,255,0.3);
        }
        .modal label {
            display: block; font-size: 10px; color: var(--text-secondary);
            margin: 10px 0 4px; text-transform: uppercase; letter-spacing: 1px;
        }
        .modal input, .modal select, .modal textarea {
            width: 100%; background: rgba(0,212,255,0.02);
            border: 1px solid rgba(0,212,255,0.08);
            border-radius: 4px; padding: 10px 12px; color: var(--text-primary);
            font-family: var(--font); font-size: 13px;
        }
        .modal input:focus, .modal select:focus, .modal textarea:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0,212,255,0.12), inset 0 0 15px rgba(0,212,255,0.03);
        }
        .modal-btns { display: flex; gap: 8px; margin-top: 20px; justify-content: flex-end; }
        .modal-btns button {
            padding: 9px 18px; border-radius: 4px; border: 1px solid var(--border-hover);
            background: transparent; color: var(--text-primary); font-family: var(--font);
            font-size: 12px; font-weight: 600; cursor: pointer; transition: all var(--fast);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .modal-btns button:hover { border-color: var(--accent); color: var(--accent); }
        .modal-btns .btn-primary {
            background: rgba(0,212,255,0.08); color: var(--accent);
            border-color: var(--accent); box-shadow: 0 0 15px rgba(0,212,255,0.15);
        }
        .modal-btns .btn-primary:hover { background: rgba(0,212,255,0.15); box-shadow: 0 0 25px rgba(0,212,255,0.3); }

        /* ===== Settings View ===== */
        .settings-group { margin-bottom: 20px; }
        .settings-group h4 {
            font-size: 11px; color: var(--accent); margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1.5px;
            text-shadow: 0 0 10px rgba(0,212,255,0.2);
        }
        .settings-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px;
        }
        .settings-row .label { color: var(--text-secondary); }
        .settings-row .value { color: var(--text-primary); font-family: var(--mono); font-size: 12px; }
        .toggle-switch {
            width: 42px; height: 22px; background: rgba(0,212,255,0.03);
            border: 1px solid var(--border-hover); border-radius: 11px;
            position: relative; cursor: pointer; transition: all var(--fast);
        }
        .toggle-switch.on { background: rgba(0,212,255,0.15); border-color: var(--accent); }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 3px;
            width: 16px; height: 16px; background: var(--text-muted); border-radius: 50%;
            transition: all var(--fast);
        }
        .toggle-switch.on::after { transform: translateX(20px); background: var(--accent); box-shadow: 0 0 8px rgba(0,212,255,0.6); }

        /* ===== Coding Editor ===== */
        .editor-container { display: flex; flex-direction: column; gap: 0; border: 1px solid rgba(0,212,255,0.12); border-radius: 6px; overflow: hidden; }
        .editor-toolbar {
            display: flex; align-items: center; gap: 8px; padding: 8px 12px;
            background: rgba(8,14,24,0.95); border-bottom: 1px solid rgba(0,212,255,0.08);
            font-size: 11px; color: var(--text-secondary);
        }
        .editor-toolbar select, .editor-toolbar input {
            background: rgba(0,212,255,0.02); border: 1px solid rgba(0,212,255,0.08);
            border-radius: 3px; padding: 4px 8px; color: var(--text-primary);
            font-family: var(--mono); font-size: 11px;
        }
        .editor-textarea {
            width: 100%; min-height: 350px; padding: 16px;
            background: #0a0a1a; border: none; color: var(--text-primary);
            font-family: var(--mono); font-size: 13px; line-height: 1.7;
            resize: vertical; tab-size: 4;
        }
        .editor-textarea:focus { outline: none; }
        .editor-status {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 12px; background: rgba(8,14,24,0.95);
            border-top: 1px solid rgba(0,212,255,0.08);
            font-size: 10px; color: var(--text-muted); font-family: var(--mono);
        }

        /* ===== Offline Banner ===== */
        .offline-banner {
            display: none; padding: 10px 16px;
            background: var(--danger); color: #fff;
            font-size: 12px; text-align: center;
            font-family: inherit;
            grid-column: 1 / -1;
        }
        .offline-banner.show { display: block; }

        /* ===== Action Buttons Row ===== */
        .action-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .action-btn {
            padding: 9px 18px; border-radius: 4px;
            border: 1px solid var(--accent); background: rgba(0,212,255,0.08);
            color: var(--accent); font-family: var(--font); font-size: 12px;
            font-weight: 600; cursor: pointer; transition: all var(--fast);
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0,212,255,0.1), inset 0 0 10px rgba(0,212,255,0.03);
        }
        .action-btn:hover { background: rgba(0,212,255,0.15); box-shadow: 0 0 20px rgba(0,212,255,0.25); }
        .action-btn.secondary {
            border-color: var(--border-hover); background: transparent;
            color: var(--text-secondary); box-shadow: none;
        }
        .action-btn.secondary:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 12px rgba(0,212,255,0.15); }
        .action-btn.danger { border-color: rgba(255,61,61,0.3); color: var(--danger); background: transparent; box-shadow: none; }
        .action-btn.danger:hover { background: var(--danger-dim); box-shadow: 0 0 12px rgba(255,61,61,0.2); }

        /* ===== Hamburger Button (Mobile) ===== */
        .hamburger {
            display: none; background: transparent; border: none;
            color: var(--accent); font-size: 22px; cursor: pointer;
            padding: 4px 8px;
        }

        /* ===== Sidebar Backdrop (Mobile) ===== */
        .sidebar-backdrop {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); z-index: 49;
        }
        .sidebar-backdrop.show { display: block; }

        /* ===== HUD Corner Brackets ===== */
        .hud-corners { position: relative; }
        .hud-corners::before, .hud-corners::after {
            content: ''; position: absolute; width: 14px; height: 14px; pointer-events: none;
            border-color: rgba(0,212,255,0.35); border-style: solid; border-width: 0;
        }
        .hud-corners::before { top: -1px; left: -1px; border-top-width: 1.5px; border-left-width: 1.5px; }
        .hud-corners::after { bottom: -1px; right: -1px; border-bottom-width: 1.5px; border-right-width: 1.5px; }

        /* ===== Stat Cards ===== */
        .stat-card {
            padding: 16px; border-radius: 6px;
            background: linear-gradient(135deg, rgba(12,21,32,0.95), rgba(8,16,24,0.98));
            border: 1px solid rgba(0,212,255,0.08); border-left: 3px solid var(--accent);
        }
        .stat-card::before {
            content: ''; position: absolute; left: -3px; top: 0; bottom: 0; width: 3px;
            background: var(--accent); animation: statPulse 2s ease-in-out infinite;
        }
        @keyframes statPulse { 0%,100% { box-shadow: 0 0 4px var(--accent); } 50% { box-shadow: 0 0 12px var(--accent); } }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--accent); font-family: var(--mono); text-shadow: 0 0 20px rgba(0,212,255,0.3); }
        .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 4px; }

        /* ===== Tab Bar ===== */
        .tab-bar { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
        .tab-btn {
            padding: 10px 18px; background: none; border: none;
            color: var(--text-secondary); font-family: var(--font);
            font-size: 11px; font-weight: 500; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 2px solid transparent; transition: all var(--fast);
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); text-shadow: 0 0 10px rgba(0,212,255,0.3); }

        /* ===== Nav Badge ===== */
        .nav-badge {
            background: var(--accent); color: var(--bg-primary);
            font-size: 9px; font-weight: 700; min-width: 16px; height: 16px;
            border-radius: 8px; display: flex; align-items: center;
            justify-content: center; margin-left: auto; padding: 0 4px;
            font-family: var(--mono);
        }

        /* ===== Floating AI Bubble ===== */
        .ai-bubble {
            position: fixed; bottom: 52px; right: 20px; z-index: 500;
            width: 48px; height: 48px; border-radius: 50%;
            background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(0,212,255,0.05));
            border: 1.5px solid var(--accent); color: var(--accent);
            font-size: 20px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(0,212,255,0.25); transition: all 0.3s;
            animation: bubblePulse 3s ease-in-out infinite;
        }
        .ai-bubble:hover { transform: scale(1.1); box-shadow: 0 0 30px rgba(0,212,255,0.4); }
        @keyframes bubblePulse { 0%,100% { box-shadow: 0 0 20px rgba(0,212,255,0.25); } 50% { box-shadow: 0 0 30px rgba(0,212,255,0.35); } }
        .ai-popup {
            position: fixed; bottom: 108px; right: 20px; z-index: 501;
            width: 360px; max-height: 450px;
            background: rgba(8,16,28,0.97); border: 1px solid var(--border-accent);
            border-radius: 8px; display: none; flex-direction: column;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5), var(--shadow-glow);
            backdrop-filter: blur(16px); overflow: hidden;
        }
        .ai-popup.open { display: flex; }
        .ai-popup-header {
            padding: 12px 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            font-size: 12px; color: var(--accent); font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .ai-popup-messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; max-height: 300px; }
        .ai-popup-input { display: flex; gap: 6px; padding: 10px 12px; border-top: 1px solid var(--border); }

        /* ===== Search Bar ===== */
        .search-container { position: relative; }
        .search-input {
            background: rgba(0,212,255,0.02); border: 1px solid rgba(0,212,255,0.08);
            border-radius: 4px; padding: 6px 12px 6px 28px;
            color: var(--text-primary); font-family: var(--font);
            font-size: 11px; width: 160px; transition: all var(--fast);
        }
        .search-input:focus { width: 220px; outline: none; border-color: var(--accent); box-shadow: 0 0 15px rgba(0,212,255,0.1); }
        .search-icon { position: absolute; left: 9px; top: 50%; transform: translateY(-50%); font-size: 11px; color: var(--text-muted); pointer-events: none; }
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: rgba(8,16,28,0.97); border: 1px solid var(--border-accent);
            border-radius: 4px; max-height: 200px; overflow-y: auto;
            display: none; z-index: 200; margin-top: 4px;
        }
        .search-results.open { display: block; }
        .search-result-item { padding: 8px 12px; font-size: 12px; cursor: pointer; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
        .search-result-item:hover { background: var(--accent-dim); color: var(--text-primary); }

        /* ===== Info Box ===== */
        .info-box { padding: 12px 16px; border-radius: 4px; font-size: 12px; line-height: 1.6; margin: 8px 0; display: flex; align-items: flex-start; gap: 10px; }
        .info-box.info { background: var(--accent-dim); border-left: 3px solid var(--accent); color: var(--text-primary); }
        .info-box.warning { background: rgba(255,170,0,0.08); border-left: 3px solid var(--warning); color: var(--warning); }
        .info-box.success { background: var(--success-dim); border-left: 3px solid var(--success); color: var(--success); }

        /* ===== Analysis Result ===== */
        .analysis-result { padding: 16px; border-radius: 6px; background: var(--bg-secondary); border: 1px solid var(--border); font-size: 13px; line-height: 1.7; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }

        /* ===== Pinout Grid ===== */
        .pinout-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
        .pinout-item { padding: 8px 10px; border-radius: 4px; background: rgba(0,212,255,0.03); border: 1px solid var(--border); font-size: 11px; font-family: var(--mono); }
        .pinout-label { color: var(--accent); font-weight: 600; }
        .pinout-pins { color: var(--text-secondary); margin-top: 2px; }

        /* ===== Template Card ===== */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .template-card {
            padding: 16px; border-radius: 6px; cursor: pointer;
            background: linear-gradient(135deg, rgba(12,21,32,0.95), rgba(8,16,24,0.98));
            border: 1px solid var(--border); transition: all var(--fast); text-align: center;
        }
        .template-card:hover { border-color: var(--accent); box-shadow: 0 4px 20px rgba(0,212,255,0.15); transform: translateY(-2px); }
        .template-icon { font-size: 28px; margin-bottom: 8px; }
        .template-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .template-desc { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }

        /* ===== SVG Progress Ring ===== */
        .progress-ring { display: inline-block; }
        .progress-ring circle { transition: stroke-dashoffset 0.8s ease; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .progress-ring .ring-bg { stroke: var(--border); fill: none; }
        .progress-ring .ring-fg { fill: none; stroke-linecap: round; }
        .progress-ring .ring-text { fill: var(--text-primary); font-size: 12px; font-weight: 700; font-family: var(--mono); dominant-baseline: central; text-anchor: middle; }

        /* ===== Timeline ===== */
        .timeline { position: relative; padding-left: 24px; }
        .timeline::before { content: ''; position: absolute; left: 7px; top: 0; bottom: 0; width: 1px; background: var(--border); }
        .timeline-item { position: relative; padding: 6px 0 16px; }
        .timeline-dot { position: absolute; left: -20px; top: 8px; width: 10px; height: 10px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--text-muted); }
        .timeline-dot.active { border-color: var(--accent); background: var(--accent); box-shadow: 0 0 8px var(--accent-glow); }
        .timeline-time { font-size: 10px; color: var(--text-muted); font-family: var(--mono); }
        .timeline-text { font-size: 12px; color: var(--text-primary); margin-top: 2px; }

        /* ===== Empty State ===== */
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 48px; opacity: 0.3; margin-bottom: 12px; }
        .empty-state-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
        .empty-state-desc { font-size: 12px; margin-bottom: 16px; line-height: 1.6; }
        .empty-state .action-btn { display: inline-block; }

        /* ===== Notification Panel ===== */
        .notif-panel { position: fixed; top: 0; right: -360px; width: 360px; height: 100vh; background: rgba(8,16,28,0.98); border-left: 1px solid var(--border-accent); z-index: 600; transition: right 0.3s ease; display: flex; flex-direction: column; backdrop-filter: blur(16px); }
        .notif-panel.open { right: 0; }
        .notif-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .notif-list { flex: 1; overflow-y: auto; padding: 8px; }
        .notif-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-start; font-size: 12px; color: var(--text-secondary); cursor: pointer; transition: all var(--fast); }
        .notif-item:hover { background: var(--accent-dim); color: var(--text-primary); }
        .notif-icon { font-size: 18px; flex-shrink: 0; }
        .notif-badge { background: var(--danger); color: #fff; font-size: 9px; font-weight: 700; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .notif-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 599; display: none; }
        .notif-backdrop.show { display: block; }

        /* ===== Undo Toast Extension ===== */
        .toast .toast-undo { background: none; border: 1px solid currentColor; color: inherit; padding: 3px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; margin-left: 12px; font-family: var(--font); }
        .toast .toast-undo:hover { background: rgba(255,255,255,0.1); }

        /* ===== Kanban Board ===== */
        .kanban-board { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; min-height: 300px; }
        .kanban-column { min-width: 200px; flex: 1; background: rgba(0,212,255,0.02); border: 1px solid var(--border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; }
        .kanban-column-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); font-weight: 600; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
        .kanban-card { padding: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 6px; cursor: grab; transition: all var(--fast); font-size: 12px; }
        .kanban-card:hover { border-color: var(--accent); box-shadow: 0 2px 12px rgba(0,212,255,0.1); }
        .kanban-card.dragging { opacity: 0.5; }
        .kanban-card-title { font-weight: 600; color: var(--text-primary); }
        .kanban-card-meta { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
        .kanban-drop-zone { min-height: 40px; border: 1px dashed transparent; border-radius: 4px; transition: all var(--fast); flex: 1; }
        .kanban-drop-zone.over { border-color: var(--accent); background: var(--accent-dim); }

        /* ===== Pomodoro ===== */
        .pomodoro-display { text-align: center; padding: 24px; }
        .pomodoro-time { font-size: 56px; font-family: var(--mono); font-weight: 700; color: var(--accent); text-shadow: 0 0 30px var(--accent-glow); }
        .pomodoro-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); margin-top: 4px; }
        .pomodoro-cycles { display: flex; justify-content: center; gap: 6px; margin-top: 12px; }
        .pomodoro-dot { width: 10px; height: 10px; border-radius: 50%; border: 1.5px solid var(--text-muted); }
        .pomodoro-dot.done { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 6px var(--accent-glow); }

        /* ===== Resistor Color Code ===== */
        .resistor-svg { display: block; margin: 0 auto; }
        .color-band-select { display: inline-flex; gap: 4px; margin: 8px 0; }
        .color-swatch { width: 24px; height: 24px; border-radius: 3px; cursor: pointer; border: 2px solid transparent; transition: all var(--fast); }
        .color-swatch:hover, .color-swatch.active { border-color: var(--text-primary); transform: scale(1.15); }
        .resistor-value { font-size: 24px; font-family: var(--mono); font-weight: 700; color: var(--accent); text-align: center; margin-top: 12px; }

        /* ===== Ambient Mode ===== */
        .ambient-overlay { position: fixed; inset: 0; z-index: 9999; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .ambient-overlay.active { display: flex; }
        .ambient-clock { font-size: 96px; font-family: var(--mono); font-weight: 700; color: var(--accent); text-shadow: 0 0 60px var(--accent-glow); }
        .ambient-project { font-size: 18px; color: var(--text-secondary); margin-top: 16px; }
        .ambient-env { font-size: 14px; color: var(--text-muted); margin-top: 24px; }
        .ambient-ticker { position: absolute; bottom: 24px; font-size: 12px; color: var(--text-muted); white-space: nowrap; animation: ambientScroll 20s linear infinite; }
        @keyframes ambientScroll { from { transform: translateX(100vw); } to { transform: translateX(-100%); } }

        /* ===== Loading Pulse ===== */
        .gen-loading { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; margin: 8px 0; }
        .gen-loading-bar { height: 100%; width: 30%; background: var(--accent); border-radius: 2px; animation: genPulse 1.5s ease-in-out infinite; }
        @keyframes genPulse { 0% { transform: translateX(-100%); } 100% { transform: translateX(400%); } }
        .gen-loading-text { font-size: 11px; color: var(--text-secondary); }
        .gen-loading-text::after { content: ''; animation: dots 1.5s steps(3) infinite; }
        @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }

        /* ===== Code Display ===== */
        .code-result { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; padding: 12px; overflow-x: auto; font-family: var(--mono); font-size: 11px; line-height: 1.6; white-space: pre-wrap; max-height: 500px; overflow-y: auto; color: var(--text-primary); }
        .code-actions { display: flex; gap: 6px; margin-top: 8px; }

        /* ===== Theme Preview Cards ===== */
        .theme-card { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 6px; cursor: pointer; border: 2px solid var(--border); transition: all var(--fast); }
        .theme-card:hover { border-color: var(--text-muted); }
        .theme-card.active { border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
        .theme-dot { width: 20px; height: 20px; border-radius: 50%; }
        .theme-name { font-size: 12px; font-weight: 600; color: var(--text-primary); }

        /* ===== Galerie Grid ===== */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .gallery-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; cursor: pointer; transition: all var(--fast); }
        .gallery-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow-glow); }
        .gallery-thumb { height: 120px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 48px; color: var(--text-muted); }
        .gallery-info { padding: 10px; }
        .gallery-title { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .gallery-meta { font-size: 10px; color: var(--text-secondary); }
        .gallery-stars { color: var(--warning); font-size: 14px; letter-spacing: 2px; }
        .gallery-filter { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
        .filter-chip { padding: 4px 10px; border-radius: 12px; font-size: 10px; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; background: transparent; transition: all var(--fast); }
        .filter-chip:hover, .filter-chip.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

        /* ===== Vergleich View ===== */
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 700px) { .compare-grid { grid-template-columns: 1fr; } }
        .compare-col { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 16px; }
        .compare-col h4 { font-size: 13px; color: var(--accent); margin-bottom: 12px; }
        .compare-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 11px; border-bottom: 1px solid var(--border); }
        .compare-label { color: var(--text-secondary); }
        .compare-val { color: var(--text-primary); font-weight: 600; }
        .compare-common { background: var(--success-dim); border-left: 3px solid var(--success); padding: 4px 8px; margin: 2px 0; font-size: 11px; border-radius: 0 4px 4px 0; }
        .compare-unique { background: var(--accent-dim); border-left: 3px solid var(--accent); padding: 4px 8px; margin: 2px 0; font-size: 11px; border-radius: 0 4px 4px 0; }

        /* ===== Bulk Action Bar ===== */
        .bulk-bar { position: sticky; top: 0; z-index: 50; background: var(--bg-secondary); border: 1px solid var(--accent); border-radius: 6px; padding: 8px 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px; box-shadow: var(--shadow-glow); }
        .bulk-count { font-size: 12px; font-weight: 600; color: var(--accent); }
        .bulk-actions { display: flex; gap: 6px; margin-left: auto; }

        /* ===== Gamification ===== */
        .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .badge-card { text-align: center; padding: 12px 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); transition: all var(--fast); }
        .badge-card.earned { border-color: var(--warning); background: rgba(255,170,0,0.05); }
        .badge-card.locked { opacity: 0.4; filter: grayscale(1); }
        .badge-icon { font-size: 32px; margin-bottom: 6px; }
        .badge-name { font-size: 10px; font-weight: 600; color: var(--text-primary); }
        .badge-desc { font-size: 9px; color: var(--text-secondary); margin-top: 2px; }
        .xp-bar { height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; margin: 4px 0; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--warning)); border-radius: 4px; transition: width 0.5s ease; }
        .level-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; background: var(--accent-dim); color: var(--accent); border: 1px solid var(--accent); }

        /* ===== Wiki / Wissensdatenbank ===== */
        .wiki-grid { display: grid; gap: 8px; }
        .wiki-entry { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 12px; cursor: pointer; transition: all var(--fast); }
        .wiki-entry:hover { border-color: var(--accent); }
        .wiki-title { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .wiki-excerpt { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        .wiki-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
        .wiki-tag { font-size: 9px; padding: 2px 6px; border-radius: 8px; background: var(--accent-dim); color: var(--accent); }
        .wiki-search { width: 100%; padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; margin-bottom: 12px; }
        .wiki-search:focus { outline: none; border-color: var(--accent); }

        /* ===== Drag Indicator ===== */
        .nav-btn.dragging { opacity: 0.5; border: 1px dashed var(--accent); }
        .nav-btn.drag-over { border-top: 2px solid var(--accent); }
        .nav-btn .drag-handle { cursor: grab; opacity: 0; margin-right: 4px; font-size: 10px; transition: opacity var(--fast); }
        .nav-btn:hover .drag-handle { opacity: 0.5; }

        /* ===== Schaltplan Editor ===== */
        .sch-canvas { width: 100%; height: 400px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; cursor: crosshair; }
        .sch-palette { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
        .sch-part-btn { padding: 6px 10px; font-size: 11px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); cursor: pointer; transition: all var(--fast); }
        .sch-part-btn:hover, .sch-part-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }

        /* ===== MQTT Monitor ===== */
        .mqtt-feed { max-height: 400px; overflow-y: auto; font-family: var(--mono); font-size: 11px; }
        .mqtt-msg { padding: 4px 8px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; }
        .mqtt-topic { color: var(--accent); min-width: 150px; }
        .mqtt-payload { color: var(--text-primary); word-break: break-all; }
        .mqtt-time { color: var(--text-muted); font-size: 10px; min-width: 60px; }

        /* ===== Multimeter ===== */
        .meter-steps { counter-reset: meter-step; }
        .meter-step { display: flex; gap: 12px; padding: 12px; margin-bottom: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; counter-increment: meter-step; }
        .meter-step::before { content: counter(meter-step); font-size: 18px; font-weight: 700; color: var(--accent); min-width: 28px; text-align: center; }
        .meter-step-content { flex: 1; }
        .meter-step-title { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .meter-step-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        .meter-dial { width: 120px; height: 120px; }

        /* ===== Zeiterfassung ===== */
        .time-bar-chart { display: flex; align-items: flex-end; gap: 4px; height: 120px; padding: 8px 0; }
        .time-bar { flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; min-width: 20px; transition: height 0.3s ease; position: relative; }
        .time-bar:hover { background: var(--accent-glow); }
        .time-bar-label { position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--text-muted); white-space: nowrap; }
        .time-bar-value { position: absolute; top: -16px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--accent); font-weight: 600; }
        .time-tracking-btn { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 2px solid; cursor: pointer; transition: all var(--fast); }
        .time-tracking-btn.start { border-color: var(--success); color: var(--success); background: var(--success-dim); }
        .time-tracking-btn.stop { border-color: var(--danger); color: var(--danger); background: var(--danger-dim); }

        /* ===== Dashboard Widgets Sortable ===== */
        .dash-widget { position: relative; }
        .dash-widget .dash-drag { position: absolute; top: 4px; right: 4px; cursor: grab; opacity: 0; font-size: 14px; color: var(--text-muted); transition: opacity var(--fast); padding: 4px; }
        .dash-widget:hover .dash-drag { opacity: 0.6; }
        .dash-widget.dragging { opacity: 0.5; border: 1px dashed var(--accent); }

        /* ===== Print Stylesheet ===== */
        @media print {
            .sidebar, .header, .footer, .ai-bubble, .ai-popup, .hamburger, .sidebar-backdrop, .notif-panel, .notif-backdrop, .ambient-overlay { display: none !important; }
            .main { margin-left: 0 !important; }
            .main-content-area { padding: 0 !important; }
            body { background: #fff !important; color: #000 !important; }
            .widget { background: #fff !important; border: 1px solid #ccc !important; page-break-inside: avoid; box-shadow: none !important; }
            .stat-card { background: #f5f5f5 !important; border-color: #ccc !important; }
            .stat-value, .accent { color: #333 !important; text-shadow: none !important; }
        }

        /* ===== Shortcut Overlay ===== */
        .shortcut-overlay { position: fixed; inset: 0; z-index: 800; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .shortcut-overlay.open { display: flex; }
        .shortcut-box { background: var(--bg-card); border: 1px solid var(--border-accent); border-radius: 8px; padding: 24px; max-width: 480px; width: 90%; }
        .shortcut-title { font-size: 14px; font-weight: 700; color: var(--accent); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; }
        .shortcut-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 12px; border-bottom: 1px solid var(--border); }
        .shortcut-key { font-family: var(--mono); color: var(--accent); background: var(--accent-dim); padding: 2px 6px; border-radius: 3px; font-size: 11px; }
        .shortcut-desc { color: var(--text-secondary); }

        /* ===== Soldering Guide Table ===== */
        .solder-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .solder-table th { text-align: left; padding: 8px; background: var(--accent-dim); color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .solder-table td { padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-secondary); }
        .solder-table tr:hover td { background: var(--accent-dim); color: var(--text-primary); }

        /* ===== Responsive: Tablet (<= 900px) ===== */
        @media (max-width: 900px) {
            .hamburger { display: block; }
            .sidebar {
                transform: translateX(-100%); transition: transform var(--normal);
                top: 0; bottom: 0;
            }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; }
            .main-content-area { padding: 16px; }
            .widget-row { grid-template-columns: 1fr; }
            .widget-row-3 { grid-template-columns: 1fr; }
            .header { padding: 0 12px; }
            .header-actions button { padding: 6px 8px; font-size: 10px; }
            .chat-messages { max-height: 50vh; }
            .ai-popup { width: 300px; right: 10px; bottom: 100px; }
            .ai-bubble { right: 14px; bottom: 46px; width: 42px; height: 42px; font-size: 18px; }
            .search-container { display: none; }
        }

        /* ===== Responsive: Phone (<= 600px) ===== */
        @media (max-width: 600px) {
            .header { padding: 0 10px; }
            .header-logo { font-size: 13px; letter-spacing: 2px; }
            .header-project { display: none; }
            .header-status { font-size: 9px; padding: 2px 8px; }
            .header-actions button { padding: 5px 6px; font-size: 9px; }
            .main-content-area { padding: 10px; gap: 10px; }
            .widget { padding: 14px; }
            .env-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .env-value { font-size: 18px; }
            .arm-btns { grid-template-columns: repeat(2, 1fr); }
            .arm-btn.emergency { grid-column: span 2; }
            .calc-btns { gap: 4px; }
            .calc-btn { padding: 5px 8px; font-size: 10px; }
            .chat-input-row { flex-wrap: nowrap; }
            .footer { padding: 0 8px; gap: 8px; font-size: 9px; }
            .action-btn { padding: 7px 12px; font-size: 11px; }
            .editor-textarea { min-height: 200px; font-size: 12px; }
        }

        /* ===== Responsive: Small Phone (<= 380px) ===== */
        @media (max-width: 380px) {
            .header-logo { font-size: 11px; }
            .header-actions { gap: 3px; }
            .widget { padding: 10px; }
            .nav-btn { padding: 8px 10px; font-size: 11px; }
        }
    </style>
</head>
<body>

<!-- ===== Boot Screen (Jarvis HUD) ===== -->
<div id="boot-screen">
    <div class="boot-hud-ring">
        <svg viewBox="0 0 200 200">
            <circle class="boot-arc-outer" cx="100" cy="100" r="90"/>
            <circle class="boot-arc-inner" cx="100" cy="100" r="75"/>
            <circle class="boot-arc-center" cx="100" cy="100" r="55"/>
        </svg>
    </div>
    <div class="boot-title">WORKSHOP</div>
    <div class="boot-subtitle">J.A.R.V.I.S. Engineering Mode</div>
    <div id="boot-text"></div>
    <div class="boot-systems">
        <div class="boot-sys-dot" id="bs-redis"></div>
        <div class="boot-sys-dot" id="bs-llm"></div>
        <div class="boot-sys-dot" id="bs-ws"></div>
        <div class="boot-sys-dot" id="bs-gen"></div>
    </div>
</div>

<!-- ===== Main Workshop Layout ===== -->
<div id="workshop-main">

    <!-- Sidebar Backdrop (Mobile) -->
    <div class="sidebar-backdrop" id="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <!-- Sidebar (Jarvis Style) -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <div class="logo-icon">W</div>
            <div class="logo-text">
                <h2>WORKSHOP</h2>
                <span>Engineering Mode</span>
            </div>
        </div>
        <div class="sidebar-nav">
            <h3>Navigation</h3>
            <button class="nav-btn active" data-view="overview" onclick="switchView(this, 'overview')">
                <span class="icon">&#128200;</span> Uebersicht
            </button>
            <button class="nav-btn" data-view="steps" onclick="switchView(this, 'steps')">
                <span class="icon">&#128221;</span> Schritte
            </button>
            <button class="nav-btn" data-view="code" onclick="switchView(this, 'code')">
                <span class="icon">&#128187;</span> Code & Dateien
            </button>
            <button class="nav-btn" data-view="editor" onclick="switchView(this, 'editor')">
                <span class="icon">&#9998;</span> Coding Agent
            </button>
            <button class="nav-btn" data-view="hardware" onclick="switchView(this, 'hardware')">
                <span class="icon">&#128268;</span> Hardware
            </button>
            <button class="nav-btn" data-view="chat" onclick="switchView(this, 'chat')">
                <span class="icon">&#128172;</span> Chat
            </button>
            <button class="nav-btn" data-view="calc" onclick="switchView(this, 'calc')">
                <span class="icon">&#129518;</span> Rechner
            </button>
            <button class="nav-btn" data-view="journal" onclick="switchView(this, 'journal')">
                <span class="icon">&#128214;</span> Journal
            </button>
            <h3>Werkzeuge</h3>
            <button class="nav-btn" data-view="inventory" onclick="switchView(this, 'inventory')">
                <span class="icon">&#128230;</span> Inventar
            </button>
            <button class="nav-btn" data-view="tools" onclick="switchView(this, 'tools')">
                <span class="icon">&#128295;</span> Verleih & Wartung
            </button>
            <button class="nav-btn" data-view="snippets" onclick="switchView(this, 'snippets')">
                <span class="icon">&#128203;</span> Snippets
            </button>
            <button class="nav-btn" data-view="pinout" onclick="switchView(this, 'pinout')">
                <span class="icon">&#128204;</span> Pinout-Referenz
            </button>

            <h3>Generatoren</h3>
            <button class="nav-btn" data-view="generators" onclick="switchView(this, 'generators')">
                <span class="icon">&#9881;</span> KI-Generatoren
            </button>

            <h3>Analyse</h3>
            <button class="nav-btn" data-view="analysis" onclick="switchView(this, 'analysis')">
                <span class="icon">&#128300;</span> Analyse & Debug
            </button>
            <button class="nav-btn" data-view="devices" onclick="switchView(this, 'devices')">
                <span class="icon">&#128268;</span> Geraete
            </button>

            <h3>Boards</h3>
            <button class="nav-btn" data-view="kanban" onclick="switchView(this, 'kanban')">
                <span class="icon">&#128203;</span> Kanban
            </button>

            <h3>Kreativ</h3>
            <button class="nav-btn" data-view="schematic" onclick="switchView(this, 'schematic')">
                <span class="icon">&#9999;</span> Schaltplan-Editor
            </button>
            <button class="nav-btn" data-view="gallery" onclick="switchView(this, 'gallery')">
                <span class="icon">&#127912;</span> Galerie
            </button>
            <button class="nav-btn" data-view="wiki" onclick="switchView(this, 'wiki')">
                <span class="icon">&#128218;</span> Wiki
            </button>
            <button class="nav-btn" data-view="compare" onclick="switchView(this, 'compare')">
                <span class="icon">&#128260;</span> Vergleich
            </button>

            <h3>Monitoring</h3>
            <button class="nav-btn" data-view="mqtt" onclick="switchView(this, 'mqtt')">
                <span class="icon">&#128225;</span> MQTT
            </button>
            <button class="nav-btn" data-view="multimeter" onclick="switchView(this, 'multimeter')">
                <span class="icon">&#128270;</span> Multimeter
            </button>
            <button class="nav-btn" data-view="timetrack" onclick="switchView(this, 'timetrack')">
                <span class="icon">&#128336;</span> Zeiterfassung
            </button>
            <button class="nav-btn" data-view="gamification" onclick="switchView(this, 'gamification')">
                <span class="icon">&#127942;</span> Erfolge
            </button>

            <h3>Sonstiges</h3>
            <button class="nav-btn" data-view="timer" onclick="switchView(this, 'timer')">
                <span class="icon">&#9201;</span> Timer
            </button>
            <button class="nav-btn" data-view="safety" onclick="switchView(this, 'safety')">
                <span class="icon">&#9888;</span> Sicherheit
            </button>
            <button class="nav-btn" data-view="shopping" onclick="switchView(this, 'shopping')">
                <span class="icon">&#128722;</span> Einkaufsliste
            </button>
            <button class="nav-btn" data-view="settings" onclick="switchView(this, 'settings')">
                <span class="icon">&#9881;</span> Einstellungen
            </button>

            <h3>Projekte</h3>
            <div id="project-list"></div>
        </div>
        <div class="sidebar-footer">JARVIS v2.0</div>
    </div>

    <!-- Main Area -->
    <div class="main">
        <!-- Offline Banner -->
        <div class="offline-banner" id="offline-banner">Server nicht erreichbar  Jarvis-Assistent pruefen</div>

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
                <div class="header-logo">WORKSHOP</div>
                <div class="header-project" id="header-project">
                    <span class="proj-name" id="header-proj-name">Kein Projekt</span>
                </div>
            </div>
            <div class="header-right">
                <div class="search-container">
                    <span class="search-icon">&#128269;</span>
                    <input class="search-input" id="header-search" placeholder="Projekte suchen..." oninput="handleSearch(this.value)" onfocus="this.parentElement.querySelector('.search-results').classList.add('open')" onblur="setTimeout(()=>document.querySelector('.search-results').classList.remove('open'),200)">
                    <div class="search-results" id="search-results"></div>
                </div>
                <button onclick="toggleNotifPanel()" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:16px;position:relative" title="Benachrichtigungen">&#128276;<span class="notif-badge" id="notif-count" style="position:absolute;top:-4px;right:-6px;display:none">0</span></button>
                <span class="header-status status-none" id="header-status">---</span>
                <div class="header-actions">
                    <button onclick="showNewProjectModal()">+ Projekt</button>
                    <button onclick="showTemplatesModal()">&#128221; Template</button>
                    <button onclick="refreshAll()">&#8635;</button>
                    <button onclick="window.open('/ui/', '_blank')">Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content-area" id="main-content"></div>

        <!-- Footer -->
        <div class="footer">
        <div class="footer-ws">
            <div class="ws-dot" id="ws-dot"></div>
            <span id="ws-status">Getrennt</span>
        </div>
        <span id="footer-timer"></span>
        <span style="flex:1"></span>
        <span id="footer-env"></span>
    </div>
    </div><!-- end .main -->
</div><!-- end #workshop-main -->

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<!-- Notification Panel -->
<div class="notif-backdrop" id="notif-backdrop" onclick="toggleNotifPanel()"></div>
<div class="notif-panel" id="notif-panel">
    <div class="notif-header"><span>Benachrichtigungen</span><button style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:16px" onclick="toggleNotifPanel()">&#10005;</button></div>
    <div class="notif-list" id="notif-list"></div>
</div>

<!-- Shortcut Overlay -->
<div class="shortcut-overlay" id="shortcut-overlay" onclick="if(event.target===this)toggleShortcuts()">
    <div class="shortcut-box">
        <div class="shortcut-title">Keyboard Shortcuts</div>
        <div class="shortcut-row"><span class="shortcut-desc">Neues Projekt</span><span class="shortcut-key">Ctrl+N</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Suche</span><span class="shortcut-key">Ctrl+K</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Quick Chat</span><span class="shortcut-key">Ctrl+B</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Editor speichern</span><span class="shortcut-key">Ctrl+S</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Uebersicht</span><span class="shortcut-key">1</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Schritte</span><span class="shortcut-key">2</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Code</span><span class="shortcut-key">3</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Editor</span><span class="shortcut-key">4</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Hardware</span><span class="shortcut-key">5</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Chat</span><span class="shortcut-key">6</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Rechner</span><span class="shortcut-key">7</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Journal</span><span class="shortcut-key">8</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Analyse</span><span class="shortcut-key">9</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Pomodoro</span><span class="shortcut-key">P</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Shortcuts anzeigen</span><span class="shortcut-key">?</span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Schliessen</span><span class="shortcut-key">Esc</span></div>
    </div>
</div>

<!-- Ambient Mode Overlay -->
<div class="ambient-overlay" id="ambient-overlay" onclick="exitAmbientMode()">
    <div class="ambient-clock" id="ambient-clock">--:--</div>
    <div class="ambient-project" id="ambient-project"></div>
    <div class="ambient-env" id="ambient-env"></div>
    <div class="ambient-ticker" id="ambient-ticker"></div>
</div>

<!-- Floating AI Bubble -->
<div class="ai-bubble" id="ai-bubble" onclick="toggleAiBubble()" title="Quick Chat mit Jarvis">&#128172;</div>
<div class="ai-popup" id="ai-popup">
    <div class="ai-popup-header">
        <span>&#128172; Quick Chat</span>
        <button style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:16px" onclick="toggleAiBubble()">&#10005;</button>
    </div>
    <div class="ai-popup-messages" id="ai-popup-messages"></div>
    <div class="ai-popup-input">
        <input class="chat-input" id="ai-popup-input" placeholder="Schnelle Frage..." onkeydown="if(event.key==='Enter')sendAiBubble()" style="flex:1">
        <button class="btn-send" onclick="sendAiBubble()" style="padding:8px 12px">&#10148;</button>
    </div>
</div>

<!-- New Project Modal -->
<div class="modal-overlay hidden" id="new-project-modal">
    <div class="modal">
        <h3>Neues Projekt erstellen</h3>
        <label>Projekt-Name *</label>
        <input id="modal-title" type="text" placeholder="z.B. ESP32 Wetterstation">
        <label>Beschreibung</label>
        <input id="modal-desc" type="text" placeholder="Kurze Beschreibung...">
        <label>Kategorie</label>
        <select id="modal-cat">
            <option value="maker">Maker</option>
            <option value="reparatur">Reparatur</option>
            <option value="bau">Bau</option>
            <option value="erfindung">Erfindung</option>
            <option value="renovierung">Renovierung</option>
        </select>
        <label>Prioritaet</label>
        <select id="modal-prio">
            <option value="normal">Normal</option>
            <option value="niedrig">Niedrig</option>
            <option value="hoch">Hoch</option>
            <option value="dringend">Dringend</option>
        </select>
        <div class="modal-btns">
            <button onclick="closeNewProjectModal()">Abbrechen</button>
            <button class="btn-primary" onclick="createProjectFromModal()">Erstellen</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
<script>
'use strict';

// ===== State =====
let ws = null;
let currentProject = null;
let projects = [];
let currentView = 'overview';
let isRecording = false;

// ===== Boot Sequence =====
async function bootWorkshop() {
    const text = document.getElementById('boot-text');
    const dots = ['bs-redis','bs-llm','bs-ws','bs-gen'];
    const messages = [
        ['Werkstatt-Systeme initialisieren...', 0],
        ['Redis-Datenbank verbunden.', 0],
        ['LLM-Modelle geladen.', 1],
        ['WebSocket-Kanal aktiv.', 2],
        ['Code-Generator bereit.', 3],
        ['Workshop-Modus aktiv, Sir.', -1]
    ];
    for (const [msg, dotIdx] of messages) {
        await typewrite(text, msg, 30);
        if (dotIdx >= 0 && dots[dotIdx]) {
            document.getElementById(dots[dotIdx])?.classList.add('online');
        }
        await sleep(400);
    }
    document.getElementById('boot-screen').classList.add('fade-out');
    setTimeout(() => {
        document.getElementById('boot-screen').style.display = 'none';
        document.getElementById('workshop-main').classList.add('active');
        // Apply saved theme
        const savedTheme = localStorage.getItem('ws-theme');
        if (savedTheme && savedTheme !== 'jarvis') document.documentElement.setAttribute('data-theme', savedTheme);
        connectWebSocket();
        loadProjects();
        // Load notifications on boot
        setTimeout(loadNotifications, 2000);
        // Periodic notification check
        setInterval(loadNotifications, 60000);
    }, 800);
}

function typewrite(el, text, speed) {
    return new Promise(resolve => {
        el.textContent = '';
        let i = 0;
        const iv = setInterval(() => {
            el.textContent += text[i++];
            if (i >= text.length) { clearInterval(iv); resolve(); }
        }, speed);
    });
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ===== API Helper =====
let serverOnline = true;

function setServerStatus(online) {
    serverOnline = online;
    const banner = document.getElementById('offline-banner');
    if (banner) banner.classList.toggle('show', !online);
}

async function apiCall(endpoint, method = 'GET', body = null) {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) opts.body = JSON.stringify(body);
    try {
        const resp = await fetch('/api/workshop/' + endpoint, opts);
        setServerStatus(true);
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || err.message || 'Serverfehler ' + resp.status);
        }
        return await resp.json();
    } catch (e) {
        if (e.message && !e.message.startsWith('Serverfehler')) {
            if (e.name === 'TypeError' || e.message.includes('fetch')) {
                setServerStatus(false);
            }
        }
        throw e;
    }
}

async function chatApi(text) {
    try {
        const resp = await fetch('/api/workshop/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, room: 'werkstatt' })
        });
        setServerStatus(true);
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || 'Chat-Fehler ' + resp.status);
        }
        return await resp.json();
    } catch (e) {
        if (e.name === 'TypeError' || (e.message && e.message.includes('fetch'))) {
            setServerStatus(false);
        }
        throw e;
    }
}

// ===== WebSocket =====
let wsRetryDelay = 2000;
const WS_MAX_RETRY = 30000;

function connectWebSocket() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    try {
        ws = new WebSocket(proto + '//' + location.host + '/api/assistant/ws');
    } catch (e) {
        scheduleWsReconnect();
        return;
    }
    ws.onopen = () => {
        wsRetryDelay = 2000;
        setServerStatus(true);
        document.getElementById('ws-dot').classList.add('connected');
        document.getElementById('ws-status').textContent = 'Verbunden';
    };
    ws.onclose = () => {
        document.getElementById('ws-dot').classList.remove('connected');
        document.getElementById('ws-status').textContent = 'Getrennt';
        scheduleWsReconnect();
    };
    ws.onerror = () => {};
    ws.onmessage = (e) => {
        try {
            const msg = JSON.parse(e.data);
            handleWsEvent(msg);
        } catch (err) { console.warn('WS parse error:', err); }
    };
}

function scheduleWsReconnect() {
    setTimeout(connectWebSocket, wsRetryDelay);
    wsRetryDelay = Math.min(wsRetryDelay * 1.5, WS_MAX_RETRY);
}

function handleWsEvent(msg) {
    switch (msg.event) {
        case 'workshop.step':
            updateStepNavigator(msg.data);
            break;
        case 'workshop.diagnosis':
            showDiagnosis(msg.data);
            break;
        case 'workshop.file_created':
            if (currentView === 'code') renderCodeView();
            showToast('Neue Datei: ' + (msg.data.filename || ''));
            break;
        case 'workshop.printer':
            updatePrinterWidget(msg.data);
            break;
        case 'workshop.environment':
            updateEnvironment(msg.data);
            break;
        case 'workshop.timer':
            showToast('Timer: ' + (msg.data.message || ''));
            break;
        case 'workshop.project':
            loadProjects();
            break;
        case 'assistant.speaking':
            addChatMessage('jarvis', msg.data.text);
            break;
        case 'assistant.stream_token':
            appendStreamToken(msg.data.token);
            break;
        case 'assistant.stream_end':
            finalizeStream(msg.data.text);
            break;
    }
}

// ===== Project Management =====
async function loadProjects() {
    try {
        const res = await apiCall('projects');
        projects = res.projects || [];
        renderProjectList();
        updateNavBadges();
        if (currentProject) {
            const updated = projects.find(p => p.id === currentProject.id);
            if (updated) { currentProject = updated; updateHeader(); }
        }
    } catch (e) { console.error('loadProjects:', e); }
}

function updateNavBadges() {
    const active = projects.filter(p => p.status === 'in_arbeit' || p.status === 'diagnose').length;
    // Update overview badge
    document.querySelectorAll('.nav-btn').forEach(btn => {
        const existing = btn.querySelector('.nav-badge');
        if (existing) existing.remove();
        const view = btn.dataset.view;
        if (view === 'overview' && active > 0) {
            btn.insertAdjacentHTML('beforeend', '<span class="nav-badge">' + active + '</span>');
        }
    });
}

function renderProjectList() {
    const el = document.getElementById('project-list');
    if (!projects.length) {
        el.innerHTML = '<div style="font-size:11px;color:var(--text-secondary);padding:8px">Keine Projekte</div>';
        return;
    }
    const pinned = getPinnedProjects();
    const sorted = [...projects].sort((a, b) => {
        const aPin = pinned.includes(a.id) ? 0 : 1;
        const bPin = pinned.includes(b.id) ? 0 : 1;
        return aPin - bPin;
    });
    el.innerHTML = sorted.map(p => {
        const isPinned = pinned.includes(p.id);
        return '<div class="project-item' + (currentProject && currentProject.id === p.id ? ' active' : '') +
        '" onclick="selectProject(\'' + p.id + '\')" style="display:flex;align-items:center">' +
        '<div class="project-dot"></div>' +
        '<span style="flex:1">' + escHtml(p.title || p.id) + '</span>' +
        '<span style="cursor:pointer;font-size:10px;opacity:0.5" onclick="event.stopPropagation();togglePin(\'' + p.id + '\')" title="' + (isPinned ? 'Entpinnen' : 'Anpinnen') + '">' + (isPinned ? '&#9733;' : '&#9734;') + '</span></div>';
    }).join('');
}

async function selectProject(id) {
    try {
        const p = await apiCall('project/' + id);
        currentProject = p;
        updateHeader();
        renderProjectList();
        renderView();
    } catch (e) { showToast('Projekt nicht gefunden'); }
}

function updateHeader() {
    if (!currentProject) {
        document.getElementById('header-proj-name').textContent = 'Kein Projekt';
        document.getElementById('header-status').textContent = '---';
        document.getElementById('header-status').className = 'header-status status-none';
        return;
    }
    document.getElementById('header-proj-name').textContent = currentProject.title || currentProject.id;
    const st = currentProject.status || 'erstellt';
    document.getElementById('header-status').textContent = st;
    const cls = (st === 'in_arbeit' || st === 'diagnose') ? 'status-active' :
                st === 'pausiert' ? 'status-paused' : 'status-none';
    document.getElementById('header-status').className = 'header-status ' + cls;
}

// showNewProject is now showNewProjectModal (modal-based)

// ===== View Switching =====
function switchView(btn, view) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentView = view;
    // Close sidebar on mobile
    const sidebar = document.querySelector('.sidebar');
    const backdrop = document.getElementById('sidebar-backdrop');
    if (sidebar) sidebar.classList.remove('open');
    if (backdrop) backdrop.classList.remove('show');
    renderView();
}

function renderView() {
    const main = document.getElementById('main-content');
    const views = {
        overview: renderOverview, steps: renderStepsView, code: renderCodeView,
        editor: renderEditorView, hardware: renderHardwareView, chat: renderChatView,
        calc: renderCalcView, journal: renderJournalView, inventory: renderInventoryView,
        snippets: renderSnippetsView, timer: renderTimerView, safety: renderSafetyView,
        settings: renderSettingsView, tools: renderToolsView, analysis: renderAnalysisView,
        devices: renderDevicesView, pinout: renderPinoutView, shopping: renderShoppingView,
        generators: renderGeneratorsView, kanban: renderKanbanView,
        schematic: renderSchematicEditorView, gallery: renderGalleryView,
        wiki: renderWikiView, compare: renderCompareView, mqtt: renderMqttView,
        multimeter: renderMultimeterView, timetrack: renderTimeTrackView,
        gamification: renderGamificationView,
    };
    const fn = views[currentView];
    if (fn) fn(main); else main.innerHTML = '';
}

// ===== Sidebar Toggle (Mobile) =====
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const backdrop = document.getElementById('sidebar-backdrop');
    sidebar.classList.toggle('open');
    backdrop.classList.toggle('show');
}

// ===== New Project Modal =====
function showNewProjectModal() {
    document.getElementById('new-project-modal').classList.remove('hidden');
    setTimeout(() => document.getElementById('modal-title').focus(), 100);
}
function closeNewProjectModal() {
    document.getElementById('new-project-modal').classList.add('hidden');
    const t = document.getElementById('modal-title');
    const d = document.getElementById('modal-desc');
    if (t) t.value = '';
    if (d) d.value = '';
}
async function createProjectFromModal() {
    const titleEl = document.getElementById('modal-title');
    const descEl = document.getElementById('modal-desc');
    const catEl = document.getElementById('modal-cat');
    const prioEl = document.getElementById('modal-prio');
    if (!titleEl) return;
    const title = titleEl.value.trim();
    if (!title) { showToast('Bitte Projekt-Name eingeben'); return; }
    const desc = descEl ? descEl.value.trim() : '';
    const cat = catEl ? catEl.value : 'maker';
    const prio = prioEl ? prioEl.value : 'normal';
    try {
        const res = await apiCall('projects', 'POST', {
            title, description: desc, category: cat, priority: prio
        });
        if (res.success && res.project) {
            closeNewProjectModal();
            showToast('Projekt erstellt: ' + title);
            await loadProjects();
            selectProject(res.project.id);
        } else {
            showToast('Fehler: ' + (res.detail || res.message || 'Unbekannt'));
        }
    } catch (e) { showToast('Fehler: ' + (e.message || 'Projekt konnte nicht erstellt werden')); }
}

// ===== Overview View =====
function renderOverview(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '';

    // Stat Cards Row
    const activeCount = projects.filter(p => p.status === 'in_arbeit' || p.status === 'diagnose').length;
    const completedCount = projects.filter(p => p.status === 'fertig').length;
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px">';
    html += '<div class="stat-card"><div class="stat-value">' + projects.length + '</div><div class="stat-label">Projekte</div></div>';
    html += '<div class="stat-card"><div class="stat-value" style="color:var(--success)">' + activeCount + '</div><div class="stat-label">Aktiv</div></div>';
    html += '<div class="stat-card"><div class="stat-value" style="color:var(--text-secondary)">' + completedCount + '</div><div class="stat-label">Fertig</div></div>';
    // Progress ring for current project
    if (currentProject) {
        const parts = currentProject.parts || [];
        const steps = currentProject.steps || [];
        const pctParts = parts.length ? Math.round(parts.filter(p => p.available).length / parts.length * 100) : 0;
        const pctSteps = steps.length ? Math.round(steps.filter(s => s.done || s.completed).length / steps.length * 100) : 0;
        const pct = steps.length ? pctSteps : pctParts;
        html += '<div class="stat-card" style="text-align:center">' + svgProgressRing(pct, 50) + '<div class="stat-label">Fortschritt</div></div>';
    } else {
        html += '<div class="stat-card"><div class="stat-value" style="font-size:16px" id="ov-env-temp">--</div><div class="stat-label">Werkstatt</div></div>';
    }
    html += '</div>';

    // Project Info
    html += '<div class="widget hud-corners" id="w-project-info">';
    html += '<div class="widget-header"><span class="icon">&#128204;</span><span class="widget-title">Projekt-Info</span></div>';
    if (currentProject) {
        html += '<div style="font-size:18px;font-weight:600;">' + escHtml(currentProject.title || '') + '</div>';
        html += '<div style="font-size:12px;color:var(--text-secondary);margin-top:4px">' + escHtml(currentProject.description || '') + '</div>';
        html += '<div class="project-meta">';
        html += '<div class="meta-item">Kategorie: <span>' + escHtml(currentProject.category || '-') + '</span></div>';
        html += '<div class="meta-item">Prioritaet: <span>' + escHtml(currentProject.priority || '-') + '</span></div>';
        html += '<div class="meta-item">Status: <span>' + escHtml(currentProject.status || '-') + '</span></div>';
        html += '<div class="meta-item">Erstellt: <span>' + escHtml((currentProject.created || '').split('T')[0] || '-') + '</span></div>';
        html += '</div>';
        // Project Action Buttons
        html += '<div class="action-row" style="margin-top:12px">';
        html += '<button class="action-btn secondary" onclick="showStatusChange()">Status aendern</button>';
        html += '<button class="action-btn secondary" onclick="showBudgetDialog()">Budget setzen</button>';
        html += '<button class="action-btn secondary" onclick="showAddPartDialog()">Teil hinzufuegen</button>';
        html += '<button class="action-btn secondary" onclick="addProjectNote()">Notiz</button>';
        html += '<button class="action-btn secondary" onclick="showExpenseDialog()">Ausgabe</button>';
        html += '<button class="action-btn secondary" onclick="duplicateProject()">Duplizieren</button>';
        html += '<button class="action-btn secondary" onclick="window.print()">Drucken</button>';
        html += '<button class="action-btn secondary" onclick="exportProject()">Exportieren</button>';
        html += '<button class="action-btn danger" onclick="deleteProject(\'' + currentProject.id + '\')">Loeschen</button>';
        html += '</div>';
        // Project notes
        const notes = currentProject.notes || [];
        if (notes.length) {
            html += '<div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px">';
            html += '<div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Notizen</div>';
            notes.slice(-5).forEach(n => {
                html += '<div style="font-size:12px;color:var(--text-secondary);padding:4px 0;border-bottom:1px solid var(--border)">';
                html += '<span style="color:var(--text-muted);font-size:10px;font-family:var(--mono)">' + escHtml((n.time || '').split('T')[0] || '') + '</span> ';
                html += escHtml(n.text || n.note || '');
                html += '</div>';
            });
            html += '</div>';
        }
    } else {
        html += '<div style="color:var(--text-secondary);font-size:13px">Kein Projekt ausgewaehlt. Erstelle ein neues Projekt oder waehle eines aus der Sidebar.</div>';
    }
    html += '</div>';

    // Stats + Environment Row
    html += '<div class="widget-row">';

    // Environment
    html += '<div class="widget" id="w-environment">';
    html += '<div class="widget-header"><span class="icon">&#127777;</span><span class="widget-title">Werkstatt-Umgebung</span></div>';
    html += '<div class="env-grid">';
    html += '<div class="env-item"><div class="env-value" id="env-temp">--</div><div class="env-label">Temperatur</div></div>';
    html += '<div class="env-item"><div class="env-value" id="env-hum">--</div><div class="env-label">Feuchtigkeit</div></div>';
    html += '<div class="env-item"><div class="env-value" id="env-co2">--</div><div class="env-label">CO2</div></div>';
    html += '</div></div>';

    // Budget
    html += '<div class="widget" id="w-budget">';
    html += '<div class="widget-header"><span class="icon">&#128176;</span><span class="widget-title">Budget</span></div>';
    const budgetNum = parseFloat(currentProject && currentProject.budget || 0) || 0;
    if (currentProject && budgetNum > 0) {
        const expenses = currentProject.expenses || [];
        const spent = expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
        const pct = budgetNum > 0 ? Math.min(100, (spent / budgetNum) * 100) : 0;
        html += '<div class="budget-amount">' + spent.toFixed(2) + ' / ' + budgetNum.toFixed(2) + ' EUR';
        // Add sparkline if expense history exists
        if (expenses.length > 1) {
            let cumulative = []; let sum = 0;
            expenses.forEach(e => { sum += parseFloat(e.amount) || 0; cumulative.push(sum); });
            html += ' ' + svgSparkline(cumulative, 80, 20);
        }
        html += '</div>';
        html += '<div class="budget-bar-container"><div class="budget-bar">';
        html += '<div class="budget-fill' + (pct > 100 ? ' over' : '') + '" style="width:' + pct + '%"></div>';
        html += '</div></div>';
        html += '<div class="budget-labels"><span>0 EUR</span><span>' + budgetNum.toFixed(0) + ' EUR</span></div>';
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px">Kein Budget gesetzt</div>';
    }
    html += '</div>';

    html += '</div>'; // end widget-row

    // Quick Actions
    html = addQuickActions(html);

    // Parts List
    if (currentProject && currentProject.parts && currentProject.parts.length) {
        html += '<div class="widget" id="w-parts">';
        html += '<div class="widget-header"><span class="icon">&#128295;</span><span class="widget-title">Teile-Liste</span></div>';
        html += '<table class="parts-table"><thead><tr><th>Teil</th><th>Menge</th><th>Kosten</th><th>Status</th></tr></thead><tbody>';
        currentProject.parts.forEach(p => {
            const cls = p.available ? 'part-available' : 'part-missing';
            const cost = parseFloat(p.cost || p.estimated_cost || 0);
            html += '<tr><td>' + escHtml(p.name || '') + '</td><td>' + (p.quantity || 1) + '</td>';
            html += '<td>' + (cost > 0 ? cost.toFixed(2) + ' EUR' : '-') + '</td>';
            html += '<td class="' + cls + '">' + (p.available ? 'Vorhanden' : 'Fehlt') + '</td></tr>';
        });
        html += '</tbody></table></div>';
    }

    // Wochenplan Widget
    html += renderWeekPlanWidget();

    // Timeline from notes
    if (currentProject) {
        const notes = currentProject.notes || [];
        if (notes.length > 1) {
            html += '<div class="widget hud-corners">';
            html += '<div class="widget-header"><span class="icon">&#128197;</span><span class="widget-title">Projekt-Verlauf</span></div>';
            html += '<div class="timeline">';
            notes.slice(-8).forEach((n, i, arr) => {
                html += '<div class="timeline-item"><div class="timeline-dot' + (i === arr.length - 1 ? ' active' : '') + '"></div>';
                html += '<div class="timeline-time">' + escHtml((n.time || '').split('T')[0] || '') + '</div>';
                html += '<div class="timeline-text">' + escHtml(n.text || n.note || '') + '</div></div>';
            });
            html += '</div></div>';
        }
    }

    main.innerHTML = html;
}

// ===== Steps View =====
let activeSession = null;

async function loadSession() {
    try {
        const res = await apiCall('session');
        activeSession = res.active ? res.session : null;
    } catch (e) {
        activeSession = null;
    }
}

async function renderStepsView(main) {
    if (!main) main = document.getElementById('main-content');
    await loadSession();
    let html = '<div class="widget" id="w-steps">';
    html += '<div class="widget-header"><span class="icon">&#128221;</span><span class="widget-title">Reparatur-Schritte</span>';
    html += '<button class="action-btn secondary" style="margin-left:auto;padding:3px 10px;font-size:10px" onclick="toggleNarration()">' + (narrationActive ? '&#9632; Stopp' : '&#128266; Vorlesen') + '</button>';
    html += '</div>';

    if (activeSession && activeSession.steps && activeSession.steps.length) {
        const steps = activeSession.steps;
        const current = activeSession.current_step || 0;
        const pct = steps.length > 0 ? ((current + 1) / steps.length) * 100 : 0;
        html += '<div style="font-size:13px;font-weight:500;margin-bottom:8px">' + escHtml(activeSession.title || '') + '</div>';
        html += '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div>';
        html += '<div style="font-size:11px;color:var(--text-secondary);margin:4px 0 12px">Schritt ' + (current + 1) + ' von ' + steps.length + '</div>';
        html += '<ul class="step-list">';
        steps.forEach((s, i) => {
            const cls = i === current ? 'active' : (s.completed ? 'done' : (i < current ? 'done' : ''));
            html += '<li class="step-item ' + cls + '">';
            html += '<strong>' + (i + 1) + '.</strong> ' + escHtml(s.title || s.description || '');
            if (s.description && s.title) html += '<div style="font-size:11px;color:var(--text-secondary);margin-top:2px">' + escHtml(s.description) + '</div>';
            if (s.tools && s.tools.length) html += '<div style="font-size:10px;color:var(--warning);margin-top:2px">Werkzeug: ' + s.tools.map(escHtml).join(', ') + '</div>';
            if (s.estimated_minutes) html += '<div style="font-size:10px;color:var(--text-secondary)">~' + s.estimated_minutes + ' Min.</div>';
            html += '</li>';
        });
        html += '</ul>';
        html += '<div class="step-nav-btns">';
        html += '<button class="step-btn" onclick="navStep(\'zurueck\')">&#9664; Zurueck</button>';
        html += '<button class="step-btn" onclick="navStep(\'weiter\')">Weiter &#9654;</button>';
        html += '<button class="step-btn" onclick="navStep(\'wiederholen\')">&#128260; Wiederholen</button>';
        html += '<button class="step-btn" style="border-color:var(--danger);color:var(--danger)" onclick="navStep(\'stopp\')">&#9632; Beenden</button>';
        html += '</div>';
    } else {
        html += '<div style="color:var(--text-secondary);font-size:13px;margin-bottom:12px">Keine aktive Session. Starte eine Diagnose um Reparatur-Schritte zu generieren.</div>';
        html += '<div class="action-row">';
        html += '<button class="action-btn" onclick="showDiagnoseDialog()">Diagnose starten</button>';
        html += '</div>';
    }
    html += '</div>';
    main.innerHTML = html;
}

async function navStep(dir) {
    try {
        const res = await apiCall('session/navigate', 'POST', { command: dir });
        showToast(res.message || 'OK');
        renderStepsView();
    } catch (e) {
        showToast('Fehler: ' + e.message);
    }
}

function showDiagnoseDialog() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Diagnose starten</h3>' +
        '<label>Problembeschreibung *</label>' +
        '<textarea id="diag-text" style="width:100%;min-height:80px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px;resize:vertical" placeholder="Beschreibe das Problem..."></textarea>' +
        '<div class="modal-btns"><button onclick="closeDiagnoseDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="startDiagnose()">Diagnose starten</button></div></div>';
    overlay.classList.remove('hidden');
}

function closeDiagnoseDialog() {
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
}

async function startDiagnose() {
    const text = document.getElementById('diag-text')?.value.trim();
    if (!text) { showToast('Bitte Problem beschreiben'); return; }
    showToast('Diagnose wird durchgefuehrt...');
    closeDiagnoseDialog();
    try {
        const res = await apiCall('diagnose', 'POST', { text });
        showToast('Diagnose abgeschlossen');
        await loadProjects();
        await loadSession();
        renderView();
    } catch (e) {
        showToast('Diagnose fehlgeschlagen: ' + e.message);
    }
}

function updateStepNavigator(data) {
    if (currentView === 'steps') {
        renderStepsView();
    }
    showToast('Schritt ' + (data.step_number || '?') + ': ' + (data.title || ''));
}

// ===== Code & Files View =====
async function renderCodeView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '';

    // Generation Actions
    if (currentProject) {
        html += '<div class="widget" id="w-gen">';
        html += '<div class="widget-header"><span class="icon">&#9889;</span><span class="widget-title">Generieren</span></div>';
        html += '<div class="action-row">';
        html += '<button class="action-btn" onclick="showGenCodeDialog()">Code generieren</button>';
        html += '<button class="action-btn" onclick="genSchematic()">Schaltplan (SVG)</button>';
        html += '<button class="action-btn" onclick="gen3DModel()">3D-Modell</button>';
        html += '<button class="action-btn secondary" onclick="genBOM()">BOM erstellen</button>';
        html += '<button class="action-btn secondary" onclick="genDocs()">Dokumentation</button>';
        html += '</div></div>';
    }

    // File Browser
    html += '<div class="widget" id="w-files">';
    html += '<div class="widget-header"><span class="icon">&#128193;</span><span class="widget-title">Dateien</span></div>';
    if (currentProject) {
        try {
            const res = await apiCall('files/' + currentProject.id);
            const files = res.files || [];
            if (files.length) {
                html += '<ul class="file-list">';
                files.forEach(f => {
                    const fname = f.name || f.filename || '';
                    const ext = fname.split('.').pop();
                    const icon = { py: '&#128013;', ino: '&#9889;', scad: '&#128230;', svg: '&#127912;', html: '&#127760;', js: '&#9889;', yaml: '&#128196;', md: '&#128196;' }[ext] || '&#128196;';
                    html += '<li class="file-item" onclick="viewFile(\'' + escHtml(fname) + '\')">';
                    html += '<span class="file-icon">' + icon + '</span>';
                    html += '<span class="file-name">' + escHtml(fname) + '</span>';
                    html += '<span style="font-size:10px;color:var(--text-secondary)">' + formatFileSize(f.size) + '</span>';
                    html += '<div class="file-actions">';
                    html += '<button class="file-action-btn" title="Download" onclick="event.stopPropagation();downloadFile(\'' + escHtml(fname) + '\')">&#11015;</button>';
                    html += '<button class="file-action-btn" title="Loeschen" style="color:var(--danger)" onclick="event.stopPropagation();deleteProjectFile(\'' + escHtml(fname) + '\')">&#10005;</button>';
                    html += '</div></li>';
                });
                html += '</ul>';
            } else {
                html += '<div style="color:var(--text-secondary);font-size:12px">Keine Dateien. Nutze die Buttons oben zum Generieren.</div>';
            }
        } catch (e) {
            html += '<div style="color:var(--text-secondary);font-size:12px">Dateien konnten nicht geladen werden.</div>';
        }
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px">Kein Projekt ausgewaehlt.</div>';
    }
    html += '</div>';

    // Code Editor
    html += '<div class="widget" id="w-code">';
    html += '<div class="widget-header"><span class="icon">&#128187;</span><span class="widget-title">Code-Ansicht</span></div>';
    html += '<div id="code-display">';
    html += '<div style="color:var(--text-secondary);font-size:12px">Waehle eine Datei aus der Liste oben.</div>';
    html += '</div></div>';

    // Schematic Viewer
    html += '<div class="widget" id="w-schematic">';
    html += '<div class="widget-header"><span class="icon">&#128268;</span><span class="widget-title">Schaltplan</span></div>';
    html += '<div class="schematic-container" id="schematic-display">';
    html += '<div class="schematic-empty">Kein Schaltplan geladen</div>';
    html += '</div></div>';

    main.innerHTML = html;
}

// Code Generation Dialogs
function showGenCodeDialog() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Code generieren</h3>' +
        '<label>Programmiersprache</label>' +
        '<select id="gen-lang" style="width:100%;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px">' +
        '<option value="arduino">Arduino</option><option value="python">Python</option><option value="cpp">C++</option>' +
        '<option value="micropython">MicroPython</option><option value="javascript">JavaScript</option>' +
        '<option value="html">HTML</option><option value="yaml">YAML</option></select>' +
        '<label>Anforderung *</label>' +
        '<textarea id="gen-req" style="width:100%;min-height:60px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px;resize:vertical" placeholder="Was soll der Code tun?"></textarea>' +
        '<div class="modal-btns"><button onclick="closeGenDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doGenCode()">Generieren</button></div></div>';
    overlay.classList.remove('hidden');
}

function closeGenDialog() {
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
}

async function doGenCode() {
    const lang = document.getElementById('gen-lang')?.value || 'arduino';
    const req = document.getElementById('gen-req')?.value.trim();
    if (!req) { showToast('Bitte Anforderung eingeben'); return; }
    closeGenDialog();
    showToast('Code wird generiert...');
    try {
        await chatApi('Generiere ' + lang + ' Code: ' + req);
        showToast('Code generiert');
        renderCodeView();
    } catch (e) { showToast('Fehler: ' + e.message); }
}

function genSchematic() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    showInputModal('Schaltplan generieren', 'Beschreibung', 'z.B. LED-Schaltung mit Widerstand', async (req) => {
        showToast('Schaltplan wird generiert...');
        try {
            await chatApi('Generiere SVG Schaltplan: ' + req);
            showToast('Schaltplan generiert');
            renderCodeView();
        } catch (e) { showToast('Fehler: ' + e.message); }
    });
}

function gen3DModel() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    showInputModal('3D-Modell generieren', 'Beschreibung', 'z.B. Gehaeuse 50x30x20mm mit Loecher', async (req) => {
        showToast('3D-Modell wird generiert...');
        try {
            await chatApi('Generiere OpenSCAD 3D-Modell: ' + req);
            showToast('3D-Modell generiert');
            renderCodeView();
        } catch (e) { showToast('Fehler: ' + e.message); }
    });
}

async function genBOM() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    showToast('BOM wird erstellt...');
    try {
        await chatApi('Erstelle BOM fuer das aktuelle Projekt');
        showToast('BOM erstellt');
    } catch (e) { showToast('Fehler: ' + e.message); }
}

async function genDocs() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    showToast('Dokumentation wird erstellt...');
    try {
        await chatApi('Erstelle Projekt-Dokumentation');
        showToast('Dokumentation erstellt');
        renderCodeView();
    } catch (e) { showToast('Fehler: ' + e.message); }
}

async function viewFile(filename) {
    if (!currentProject) return;
    try {
        const res = await apiCall('files/' + currentProject.id + '/' + filename);
        const content = res.content || '';
        const ext = filename.split('.').pop();
        const display = document.getElementById('code-display');

        if (ext === 'svg') {
            document.getElementById('schematic-display').innerHTML = content;
            return;
        }

        const langMap = { py: 'python', ino: 'cpp', cpp: 'cpp', c: 'c', js: 'javascript', yaml: 'yaml', html: 'markup' };
        const lang = langMap[ext] || 'markup';
        let highlighted = content;
        try { highlighted = Prism.highlight(content, Prism.languages[lang] || Prism.languages.markup, lang); } catch(e) {}

        display.innerHTML = '<div class="code-container">' +
            '<div class="code-header"><span>' + escHtml(filename) + '</span>' +
            '<button class="btn-copy" onclick="copyCode()">Kopieren</button></div>' +
            '<div class="code-content"><pre><code id="code-block">' + highlighted + '</code></pre></div></div>';

        document.getElementById('code-block').dataset.raw = content;
    } catch (e) { showToast('Datei konnte nicht geladen werden'); }
}

function copyCode() {
    const block = document.getElementById('code-block');
    if (block && block.dataset.raw) {
        navigator.clipboard.writeText(block.dataset.raw);
        showToast('Kopiert!');
    }
}

function downloadFile(filename) {
    if (!currentProject) return;
    window.open('/api/workshop/download/' + currentProject.id + '/' + encodeURIComponent(filename), '_blank');
}

// ===== Hardware View =====
let hwTab = 'printer';

function renderHardwareView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128268;</span><span class="widget-title">Hardware-Steuerung</span></div>';
    html += '<div class="tab-bar">';
    html += '<button class="tab-btn' + (hwTab === 'printer' ? ' active' : '') + '" onclick="hwTab=\'printer\';renderHardwareView()">3D-Drucker</button>';
    html += '<button class="tab-btn' + (hwTab === 'arm' ? ' active' : '') + '" onclick="hwTab=\'arm\';renderHardwareView()">Roboterarm</button>';
    html += '<button class="tab-btn' + (hwTab === 'env' ? ' active' : '') + '" onclick="hwTab=\'env\';renderHardwareView()">Umgebung</button>';
    html += '<button class="tab-btn' + (hwTab === 'camera' ? ' active' : '') + '" onclick="hwTab=\'camera\';renderHardwareView()">Kamera</button>';
    html += '</div>';

    if (hwTab === 'camera') {
        html += '<div style="text-align:center;padding:16px">';
        html += '<div style="width:100%;max-width:480px;margin:0 auto;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;overflow:hidden">';
        html += '<div style="padding:40px;color:var(--text-secondary);font-size:12px">&#128247; Kamera-Feed ueber Home Assistant</div>';
        html += '</div>';
        html += '<div class="action-row" style="margin-top:12px;justify-content:center">';
        html += '<button class="action-btn" onclick="takeCameraSnapshot()">&#128247; Snapshot aufnehmen</button>';
        html += '<button class="action-btn secondary" onclick="renderHardwareView()">&#8635; Aktualisieren</button>';
        html += '</div></div>';
    } else if (hwTab === 'printer') {
        html += '<div id="printer-content"><div style="color:var(--text-secondary);font-size:12px">Status wird geladen...</div></div>';
        html += '<div class="action-row" style="margin-top:12px">';
        html += '<button class="action-btn" onclick="printerAction(\'start\')">&#9654; Druck starten</button>';
        html += '<button class="action-btn secondary" onclick="printerAction(\'pause\')">&#10074;&#10074; Pausieren</button>';
        html += '<button class="action-btn danger" onclick="printerAction(\'cancel\')">&#9632; Abbrechen</button>';
        html += '<button class="action-btn secondary" onclick="loadPrinterStatusDirect()">&#8635; Aktualisieren</button>';
        html += '</div>';
    } else if (hwTab === 'arm') {
        html += '<div class="arm-btns">';
        html += '<button class="arm-btn" onclick="armDirect(\'home\')">&#127968; Home</button>';
        html += '<button class="arm-btn" onclick="armDirect(\'gripper\',\'open\')">&#9996; Oeffnen</button>';
        html += '<button class="arm-btn" onclick="armDirect(\'gripper\',\'close\')">&#9994; Greifen</button>';
        html += '<button class="arm-btn" onclick="armPickTool()">&#128295; Werkzeug</button>';
        html += '<button class="arm-btn" onclick="armDirect(\'move\',null,{z:50})">&#11014; Hoch</button>';
        html += '<button class="arm-btn" onclick="armDirect(\'move\',null,{z:-50})">&#11015; Runter</button>';
        html += '<button class="arm-btn emergency" onclick="armDirect(\'home\')">&#9888; NOTAUS</button>';
        html += '</div>';
        html += '<div style="margin-top:12px">';
        html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px" id="arm-status">Position: ---</div>';
        html += '<div class="action-row">';
        html += '<button class="action-btn secondary" onclick="showSaveArmPosDialog()">Position speichern</button>';
        html += '<button class="action-btn secondary" onclick="showArmMoveDialog()">Koordinaten bewegen</button>';
        html += '</div></div>';
    } else {
        html += '<div class="env-grid">';
        html += '<div class="env-item"><div class="env-value" id="env-temp2">--</div><div class="env-label">Temperatur</div></div>';
        html += '<div class="env-item"><div class="env-value" id="env-hum2">--</div><div class="env-label">Feuchtigkeit</div></div>';
        html += '<div class="env-item"><div class="env-value" id="env-co22">--</div><div class="env-label">CO2</div></div>';
        html += '</div>';
    }

    html += '</div>';
    main.innerHTML = html;
    if (hwTab === 'printer') loadPrinterStatusDirect();
}

async function printerAction(action) {
    try {
        await apiCall('printer/' + action, 'POST', { project_id: currentProject?.id || '' });
        showToast('Drucker: ' + action);
        setTimeout(loadPrinterStatusDirect, 1000);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

async function loadPrinterStatusDirect() {
    try {
        const res = await apiCall('printer/status');
        updatePrinterWidget(res);
    } catch (e) {
        const el = document.getElementById('printer-content');
        if (el) el.innerHTML = '<div style="color:var(--text-secondary);font-size:12px">Drucker nicht erreichbar.</div>';
    }
}

async function armDirect(cmd, action, coords) {
    try {
        if (cmd === 'home') await apiCall('arm/home', 'POST');
        else if (cmd === 'gripper') await apiCall('arm/gripper', 'POST', { action: action || 'open' });
        else if (cmd === 'move') await apiCall('arm/move', 'POST', { x: coords?.x || 0, y: coords?.y || 0, z: coords?.z || 0 });
        showToast('Arm: ' + cmd);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

function showSaveArmPosDialog() {
    showInputModal('Arm-Position speichern', 'Name', 'z.B. Loetstation', async (name) => {
        try { await apiCall('arm/save-position', 'POST', { name }); showToast('Position gespeichert: ' + name); }
        catch (e) { showToast('Fehler: ' + e.message); }
    });
}

function showArmMoveDialog() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Arm bewegen</h3>' +
        '<label>X (mm)</label><input id="arm-x" type="number" value="0">' +
        '<label>Y (mm)</label><input id="arm-y" type="number" value="0">' +
        '<label>Z (mm)</label><input id="arm-z" type="number" value="0">' +
        '<label>Geschwindigkeit (%)</label><input id="arm-spd" type="number" value="50" min="1" max="100">' +
        '<div class="modal-btns"><button onclick="closeArmMoveDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doArmMove()">Bewegen</button></div></div>';
    overlay.classList.remove('hidden');
}
function closeArmMoveDialog() { document.getElementById('new-project-modal').classList.add('hidden'); resetProjectModal(); }
async function doArmMove() {
    const x = parseFloat(document.getElementById('arm-x')?.value || 0);
    const y = parseFloat(document.getElementById('arm-y')?.value || 0);
    const z = parseFloat(document.getElementById('arm-z')?.value || 0);
    const speed = parseInt(document.getElementById('arm-spd')?.value || 50);
    closeArmMoveDialog();
    try { await apiCall('arm/move', 'POST', { x, y, z, speed }); showToast('Arm bewegt'); }
    catch (e) { showToast('Fehler: ' + e.message); }
}

async function loadPrinterStatus() {
    try {
        const res = await chatApi('Drucker-Status');
        document.getElementById('printer-content').innerHTML =
            '<div style="font-size:12px;color:var(--text-secondary)">Status abgefragt. Warte auf Update...</div>';
    } catch(e) {
        const el = document.getElementById('printer-content');
        if (el) el.innerHTML = '<div style="font-size:12px;color:var(--text-secondary)">Drucker-Status nicht verfuegbar (Server offline)</div>';
    }
}

function updatePrinterWidget(data) {
    const el = document.getElementById('printer-content');
    if (!el) return;
    const pct = data.progress || 0;
    const state = data.state || 'idle';
    let html = '<div class="printer-progress">';
    html += '<div class="printer-bar"><div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div></div>';
    html += '<div class="printer-percent">' + pct + '%</div></div>';
    html += '<div style="font-size:12px;color:var(--text-secondary)">Status: ' + state + '</div>';
    if (data.temps) {
        html += '<div class="printer-temps">';
        html += '<span>Nozzle: <span class="val">' + (data.temps.nozzle || '--') + 'C</span></span>';
        html += '<span>Bed: <span class="val">' + (data.temps.bed || '--') + 'C</span></span>';
        html += '</div>';
    }
    el.innerHTML = html;
}

async function armCmd(cmd) {
    try {
        if (cmd === 'home') await chatApi('Arm Home');
        else if (cmd === 'open') await chatApi('Greifer oeffnen');
        else if (cmd === 'close') await chatApi('Greifer schliessen');
        else if (cmd === 'stop') await chatApi('Notaus');
        showToast('Befehl gesendet: ' + cmd);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

async function armPos(dir) {
    const delta = dir === 'up' ? 50 : -50;
    try {
        await chatApi('Arm bewegen z ' + delta);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

function armPickTool() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Werkzeug holen</h3>' +
        '<label>Welches Werkzeug?</label>' +
        '<input id="arm-tool" type="text" placeholder="z.B. Loetkolben" style="width:100%;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px">' +
        '<div class="modal-btns"><button onclick="closeArmToolDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doArmPickTool()">Holen</button></div></div>';
    overlay.classList.remove('hidden');
}

function closeArmToolDialog() {
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
}

async function doArmPickTool() {
    const tool = document.getElementById('arm-tool')?.value.trim();
    if (!tool) { showToast('Bitte Werkzeug eingeben'); return; }
    closeArmToolDialog();
    try {
        await chatApi('Arm hole ' + tool);
        showToast('Arm holt: ' + tool);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Chat View =====
let chatMessages = [];
let streamBuffer = '';

function renderChatView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget" style="flex:1;display:flex;flex-direction:column">';
    html += '<div class="widget-header"><span class="icon">&#128172;</span><span class="widget-title">Workshop-Chat</span></div>';
    html += '<div class="chat-messages" id="chat-messages">';
    chatMessages.forEach(m => {
        html += '<div class="chat-msg ' + m.role + '">' + escHtml(m.text) + '</div>';
    });
    html += '</div>';
    html += '<div class="chat-input-row">';
    html += '<button class="btn-voice" id="btn-voice" onclick="toggleVoice()">&#127908;</button>';
    html += '<input class="chat-input" id="chat-input" placeholder="Nachricht eingeben..." onkeydown="if(event.key===\'Enter\')sendChat()">';
    html += '<button class="btn-send" onclick="sendChat()">&#10148;</button>';
    html += '</div></div>';
    main.innerHTML = html;
    const msgs = document.getElementById('chat-messages');
    if (msgs) msgs.scrollTop = msgs.scrollHeight;
}

function addChatMessage(role, text) {
    chatMessages.push({ role, text });
    if (chatMessages.length > 100) chatMessages.shift();
    if (currentView === 'chat') {
        const el = document.getElementById('chat-messages');
        if (el) {
            el.innerHTML += '<div class="chat-msg ' + role + '">' + escHtml(text) + '</div>';
            el.scrollTop = el.scrollHeight;
        }
    }
}

function appendStreamToken(token) {
    streamBuffer += token;
    if (currentView === 'chat') {
        const el = document.getElementById('chat-messages');
        if (!el) return;
        let streaming = el.querySelector('.chat-msg.streaming');
        if (!streaming) {
            streaming = document.createElement('div');
            streaming.className = 'chat-msg jarvis streaming';
            el.appendChild(streaming);
        }
        streaming.textContent = streamBuffer;
        el.scrollTop = el.scrollHeight;
    }
}

function finalizeStream(fullText) {
    if (currentView === 'chat') {
        const el = document.getElementById('chat-messages');
        if (el) {
            const streaming = el.querySelector('.chat-msg.streaming');
            if (streaming) streaming.remove();
        }
    }
    streamBuffer = '';
    addChatMessage('jarvis', fullText);
}

async function sendChat() {
    const input = document.getElementById('chat-input');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    addChatMessage('user', text);
    try {
        const res = await chatApi(text);
        if (res.response) {
            addChatMessage('jarvis', res.response);
        }
    } catch (e) {
        if (!serverOnline) {
            addChatMessage('jarvis', 'Server nicht erreichbar. Bitte starte den Jarvis-Assistenten.');
        } else {
            addChatMessage('jarvis', 'Fehler: ' + (e.message || 'Kommunikationsfehler'));
        }
    }
}

// ===== Voice Input =====
function toggleVoice() {
    const btn = document.getElementById('btn-voice');
    if (isRecording) {
        isRecording = false;
        btn.classList.remove('recording');
        return;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { showToast('Spracherkennung nicht unterstuetzt'); return; }
    const recognition = new SR();
    recognition.lang = 'de-DE';
    recognition.continuous = false;
    recognition.onstart = () => { isRecording = true; btn.classList.add('recording'); };
    recognition.onresult = async (event) => {
        const text = event.results[0][0].transcript;
        const input = document.getElementById('chat-input');
        if (input) input.value = text;
        await sendChat();
    };
    recognition.onend = () => { isRecording = false; btn.classList.remove('recording'); };
    recognition.onerror = () => { isRecording = false; btn.classList.remove('recording'); };
    recognition.start();
}

// ===== Calculator View =====
let activeCalc = 'ohms_law';

let calcTab = 'rechner';
function renderCalcView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#129518;</span><span class="widget-title">Werkstatt-Rechner</span></div>';

    html += '<div class="tab-bar">';
    html += '<button class="tab-btn' + (calcTab === 'rechner' ? ' active' : '') + '" onclick="calcTab=\'rechner\';renderCalcView()">Rechner</button>';
    html += '<button class="tab-btn' + (calcTab === 'farbcode' ? ' active' : '') + '" onclick="calcTab=\'farbcode\';renderCalcView()">Farbcode</button>';
    html += '<button class="tab-btn' + (calcTab === 'loeten' ? ' active' : '') + '" onclick="calcTab=\'loeten\';renderCalcView()">Loetguide</button>';
    html += '<button class="tab-btn' + (calcTab === 'holz' ? ' active' : '') + '" onclick="calcTab=\'holz\';renderCalcView()">Holz</button>';
    html += '<button class="tab-btn' + (calcTab === '3ddruck' ? ' active' : '') + '" onclick="calcTab=\'3ddruck\';renderCalcView()">3D-Druck</button>';
    html += '<button class="tab-btn' + (calcTab === 'kabel' ? ' active' : '') + '" onclick="calcTab=\'kabel\';renderCalcView()">Kabel</button>';
    html += '</div>';

    if (calcTab === 'farbcode') {
        html += renderResistorCalcTab();
    } else if (calcTab === 'loeten') {
        html += renderSolderGuideTab();
    } else if (calcTab === 'holz') {
        html += renderWoodCalcTab();
    } else if (calcTab === '3ddruck') {
        html += render3DPrintCalcTab();
    } else if (calcTab === 'kabel') {
        html += renderCableCalcTab();
    } else {
        html += '<div class="calc-btns">';
        const calcs = [
            { id: 'ohms_law', label: 'Ohm\'sches Gesetz' },
            { id: 'led_resistor', label: 'LED Widerstand' },
            { id: 'resistor_divider', label: 'Spannungsteiler' },
            { id: 'wire_gauge', label: 'Kabelquerschnitt' },
            { id: '3d_print_weight', label: '3D-Druck Gewicht' },
            { id: 'power_supply', label: 'Netzteil' },
            { id: 'convert', label: 'Umrechnung' },
        ];
        calcs.forEach(c => {
            html += '<button class="calc-btn' + (c.id === activeCalc ? ' active' : '') +
                    '" onclick="setCalc(\'' + c.id + '\')">' + c.label + '</button>';
        });
        html += '</div>';
        html += '<div id="calc-form">' + getCalcForm(activeCalc) + '</div>';
        html += '<div class="calc-result" id="calc-result"></div>';
    }
    html += '</div>';
    main.innerHTML = html;
}

function setCalc(type) {
    activeCalc = type;
    document.querySelectorAll('.calc-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.calc-btn[onclick*="' + type + '"]').classList.add('active');
    document.getElementById('calc-form').innerHTML = getCalcForm(type);
    document.getElementById('calc-result').innerHTML = '';
}

function getCalcForm(type) {
    const forms = {
        ohms_law: '<div class="calc-form"><label>Spannung (V)</label><input id="cp-v" type="number" step="any" placeholder="z.B. 5">' +
                  '<label>Widerstand (Ohm)</label><input id="cp-r" type="number" step="any" placeholder="z.B. 100">' +
                  '<label>Strom (A)  optional</label><input id="cp-i" type="number" step="any" placeholder="Berechnet">' +
                  '<button class="step-btn" style="margin-top:8px" onclick="doCalc()">Berechnen</button></div>',
        led_resistor: '<div class="calc-form"><label>Versorgungsspannung (V)</label><input id="cp-vs" type="number" step="any" value="5">' +
                      '<label>LED Vorwaertsspannung (V)</label><input id="cp-vf" type="number" step="any" value="2">' +
                      '<label>LED Strom (mA)</label><input id="cp-if" type="number" step="any" value="20">' +
                      '<button class="step-btn" style="margin-top:8px" onclick="doCalc()">Berechnen</button></div>',
        resistor_divider: '<div class="calc-form"><label>Eingangsspannung (V)</label><input id="cp-vin" type="number" step="any" value="12">' +
                          '<label>Ausgangsspannung (V)</label><input id="cp-vout" type="number" step="any" value="3.3">' +
                          '<label>R2 (Ohm)  optional</label><input id="cp-r2" type="number" step="any" placeholder="10000">' +
                          '<button class="step-btn" style="margin-top:8px" onclick="doCalc()">Berechnen</button></div>',
        wire_gauge: '<div class="calc-form"><label>Strom (A)</label><input id="cp-amp" type="number" step="any" value="10">' +
                    '<label>Laenge (m)</label><input id="cp-len" type="number" step="any" value="5">' +
                    '<label>Max. Spannungsabfall (V)</label><input id="cp-drop" type="number" step="any" value="0.5">' +
                    '<button class="step-btn" style="margin-top:8px" onclick="doCalc()">Berechnen</button></div>',
        '3d_print_weight': '<div class="calc-form"><label>Volumen (cm)</label><input id="cp-vol" type="number" step="any">' +
                           '<label>Material</label><select id="cp-mat" class="chat-input" style="padding:6px"><option>PLA</option><option>ABS</option><option>PETG</option><option>TPU</option><option>ASA</option></select>' +
                           '<label>Infill (%)</label><input id="cp-infill" type="number" step="any" value="20">' +
                           '<button class="step-btn" style="margin-top:8px" onclick="doCalc()">Berechnen</button></div>',
        power_supply: '<div class="calc-form"><label>Gesamtstrom (A)</label><input id="cp-total-a" type="number" step="any">' +
                      '<label>Spannung (V)</label><input id="cp-psu-v" type="number" step="any" value="12">' +
                      '<label>Sicherheitsmarge (%)</label><input id="cp-margin" type="number" step="any" value="20">' +
                      '<button class="step-btn" style="margin-top:8px" onclick="doCalc()">Berechnen</button></div>',
        convert: '<div class="calc-form"><label>Wert</label><input id="cp-val" type="number" step="any">' +
                 '<label>Von</label><input id="cp-from" type="text" placeholder="z.B. inch">' +
                 '<label>Nach</label><input id="cp-to" type="text" placeholder="z.B. mm">' +
                 '<button class="step-btn" style="margin-top:8px" onclick="doCalc()">Berechnen</button></div>',
    };
    return forms[type] || '';
}

async function doCalc() {
    let params = {};
    switch (activeCalc) {
        case 'ohms_law':
            params = {};
            const v = document.getElementById('cp-v')?.value;
            const r = document.getElementById('cp-r')?.value;
            const i = document.getElementById('cp-i')?.value;
            if (v) params.v = parseFloat(v);
            if (r) params.r = parseFloat(r);
            if (i) params.i = parseFloat(i);
            break;
        case 'led_resistor':
            params = { v_supply: parseFloat(document.getElementById('cp-vs')?.value || 5),
                       v_led: parseFloat(document.getElementById('cp-vf')?.value || 2),
                       i_ma: parseFloat(document.getElementById('cp-if')?.value || 20) };
            break;
        case 'resistor_divider':
            params = { v_in: parseFloat(document.getElementById('cp-vin')?.value || 12),
                       v_out: parseFloat(document.getElementById('cp-vout')?.value || 3.3) };
            const r2v = document.getElementById('cp-r2')?.value;
            if (r2v) params.r2 = parseFloat(r2v);
            break;
        case 'wire_gauge':
            params = { current_a: parseFloat(document.getElementById('cp-amp')?.value || 10),
                       length_m: parseFloat(document.getElementById('cp-len')?.value || 5),
                       max_drop_v: parseFloat(document.getElementById('cp-drop')?.value || 0.5) };
            break;
        case '3d_print_weight':
            params = { volume_cm3: parseFloat(document.getElementById('cp-vol')?.value || 0),
                       material: (document.getElementById('cp-mat')?.value || 'PLA').toLowerCase(),
                       infill_pct: parseFloat(document.getElementById('cp-infill')?.value || 20) };
            break;
        case 'power_supply':
            const totalA = parseFloat(document.getElementById('cp-total-a')?.value || 0);
            const psuV = parseFloat(document.getElementById('cp-psu-v')?.value || 12);
            const margin = parseFloat(document.getElementById('cp-margin')?.value || 20) / 100;
            params = { voltage: psuV, components: [{ current_ma: totalA * 1000, quantity: 1 }] };
            break;
        case 'convert':
            params = { value: parseFloat(document.getElementById('cp-val')?.value || 0),
                       from_unit: document.getElementById('cp-from')?.value || '',
                       to_unit: document.getElementById('cp-to')?.value || '' };
            break;
    }
    try {
        const res = await apiCall('calculate', 'POST', { type: activeCalc, params });
        const el = document.getElementById('calc-result');
        if (res.error) {
            el.innerHTML = '<span style="color:var(--danger)">' + escHtml(res.error) + '</span>';
        } else {
            el.innerHTML = '<pre style="margin:0;white-space:pre-wrap">' + escHtml(JSON.stringify(res, null, 2)) + '</pre>';
        }
    } catch (e) {
        document.getElementById('calc-result').innerHTML = '<span style="color:var(--danger)">Fehler</span>';
    }
}

// ===== Journal View =====
async function renderJournalView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128214;</span><span class="widget-title">Workshop-Journal</span></div>';

    try {
        const res = await apiCall('journal');
        const entries = res.entries || [];
        if (entries.length) {
            html += '<div class="journal-entries">';
            entries.forEach(e => {
                html += '<div class="journal-entry">';
                html += '<div class="journal-time">' + escHtml(e.time || e.timestamp || '') + '</div>';
                html += '<div>' + escHtml(e.text || e.note || '') + '</div>';
                html += '</div>';
            });
            html += '</div>';
        } else {
            html += '<div style="color:var(--text-secondary);font-size:12px">Noch keine Journal-Eintraege.</div>';
        }
    } catch (e) {
        html += '<div style="color:var(--text-secondary);font-size:12px">Journal konnte nicht geladen werden.</div>';
    }

    html += '<div style="margin-top:12px;display:flex;gap:8px">';
    html += '<input class="chat-input" id="journal-input" placeholder="Neuer Eintrag...">';
    html += '<button class="btn-send" onclick="addJournalEntry()">+</button>';
    html += '</div></div>';
    main.innerHTML = html;
}

async function addJournalEntry() {
    const input = document.getElementById('journal-input');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    try {
        await apiCall('journal', 'POST', { note: text });
        showToast('Journal-Eintrag gespeichert');
        renderJournalView();
    } catch (e) {
        showToast('Fehler beim Speichern');
    }
}

// ===== Coding Agent / Editor View =====
let editorFilename = '';
let editorLanguage = 'python';
let editorModified = false;

function renderEditorView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '';

    // Agent Chat Bar
    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#9998;</span><span class="widget-title">Coding Agent</span></div>';
    html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px">Beschreibe was Jarvis programmieren soll. Er kann Code generieren, aendern, erklaeren oder Bugs fixen.</div>';
    html += '<div class="chat-input-row">';
    html += '<select id="editor-action" style="background:var(--bg-input);border:1px solid var(--border-hover);border-radius:4px;padding:8px;color:var(--text-primary);font-family:var(--font);font-size:12px">';
    html += '<option value="generate">Generieren</option><option value="modify">Aendern</option><option value="explain">Erklaeren</option><option value="fix">Bug fixen</option>';
    html += '</select>';
    html += '<select id="editor-lang" style="background:var(--bg-input);border:1px solid var(--border-hover);border-radius:4px;padding:8px;color:var(--text-primary);font-family:var(--font);font-size:12px">';
    html += '<option value="python">Python</option><option value="arduino">Arduino</option><option value="cpp">C++</option>';
    html += '<option value="micropython">MicroPython</option><option value="javascript">JavaScript</option>';
    html += '<option value="html">HTML</option><option value="yaml">YAML</option>';
    html += '</select>';
    html += '<input class="chat-input" id="editor-prompt" placeholder="z.B. ESP32 Temperatur-Logger mit WiFi..." onkeydown="if(event.key===\'Enter\')runCodingAgent()">';
    html += '<button class="btn-send" onclick="runCodingAgent()">&#9654;</button>';
    html += '</div></div>';

    // Editor
    html += '<div class="widget" style="padding:0">';
    html += '<div class="editor-container">';
    html += '<div class="editor-toolbar">';
    html += '<input id="editor-filename" type="text" value="' + escHtml(editorFilename || 'new_file.py') + '" style="width:180px" placeholder="dateiname.py">';
    html += '<span style="flex:1"></span>';
    html += '<button class="action-btn secondary" style="padding:4px 10px;font-size:10px" onclick="editorSave()">Speichern</button>';
    html += '<button class="action-btn secondary" style="padding:4px 10px;font-size:10px" onclick="editorLoadFile()">Datei laden</button>';
    html += '<button class="action-btn secondary" style="padding:4px 10px;font-size:10px" onclick="editorUpload()">Upload</button>';
    html += '</div>';
    html += '<textarea class="editor-textarea" id="editor-code" placeholder="// Code hier eingeben oder von Jarvis generieren lassen..." spellcheck="false" oninput="editorModified=true"></textarea>';
    html += '<div class="editor-status">';
    html += '<span id="editor-status-text">Bereit</span>';
    html += '<span id="editor-line-count">0 Zeilen</span>';
    html += '</div></div></div>';

    // File upload (hidden)
    html += '<input type="file" id="editor-file-input" style="display:none" onchange="handleEditorUpload(event)">';

    main.innerHTML = html;

    // Restore editor content
    const textarea = document.getElementById('editor-code');
    if (textarea) {
        textarea.addEventListener('input', () => {
            const lines = textarea.value.split('\n').length;
            const el = document.getElementById('editor-line-count');
            if (el) el.textContent = lines + ' Zeilen';
        });
    }
}

async function runCodingAgent() {
    const action = document.getElementById('editor-action')?.value || 'generate';
    const language = document.getElementById('editor-lang')?.value || 'python';
    const requirement = document.getElementById('editor-prompt')?.value.trim();
    const existingCode = document.getElementById('editor-code')?.value || '';

    if (!requirement && action !== 'fix') { showToast('Bitte Anforderung eingeben'); return; }
    if (action === 'fix' && !existingCode) { showToast('Bitte Code zum Fixen eingeben'); return; }

    const statusEl = document.getElementById('editor-status-text');
    if (statusEl) statusEl.textContent = 'Jarvis denkt nach...';

    try {
        const res = await apiCall('coding-agent', 'POST', {
            action, language, requirement,
            existing_code: existingCode,
            project_id: currentProject?.id || '',
            filename: document.getElementById('editor-filename')?.value || '',
        });

        if (res.status === 'error') {
            showToast('Fehler: ' + (res.message || 'Unbekannt'));
            if (statusEl) statusEl.textContent = 'Fehler';
            return;
        }

        if (action === 'explain') {
            addChatMessage('jarvis', res.explanation || 'Keine Erklaerung');
            showToast('Erklaerung im Chat');
            if (statusEl) statusEl.textContent = 'Erklaerung generiert';
        } else {
            const code = res.code || '';
            const textarea = document.getElementById('editor-code');
            if (textarea) textarea.value = code;
            if (res.filename) {
                const fnEl = document.getElementById('editor-filename');
                if (fnEl) fnEl.value = res.filename;
                editorFilename = res.filename;
            }
            const lines = code.split('\n').length;
            const lcEl = document.getElementById('editor-line-count');
            if (lcEl) lcEl.textContent = lines + ' Zeilen';
            if (statusEl) statusEl.textContent = 'Code generiert (' + (res.language || language) + ')';
            showToast('Code generiert!');
        }
    } catch (e) {
        showToast('Fehler: ' + e.message);
        if (statusEl) statusEl.textContent = 'Fehler';
    }
}

async function editorSave() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    const code = document.getElementById('editor-code')?.value || '';
    const filename = document.getElementById('editor-filename')?.value.trim() || 'untitled.py';

    try {
        await apiCall('files/' + currentProject.id + '/save', 'POST', { filename, content: code });
        editorModified = false;
        showToast('Gespeichert: ' + filename);
        const statusEl = document.getElementById('editor-status-text');
        if (statusEl) statusEl.textContent = 'Gespeichert';
    } catch (e) { showToast('Fehler: ' + e.message); }
}

async function editorLoadFile() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    try {
        const res = await apiCall('files/' + currentProject.id);
        const files = res.files || [];
        if (!files.length) { showToast('Keine Dateien vorhanden'); return; }
        const names = files.map(f => f.name || f.filename).filter(Boolean);
        showFilePickerModal(names, async (choice) => {
            try {
                const fileRes = await apiCall('files/' + currentProject.id + '/' + choice);
                const textarea = document.getElementById('editor-code');
                if (textarea) textarea.value = fileRes.content || '';
                const fnEl = document.getElementById('editor-filename');
                if (fnEl) fnEl.value = choice;
                editorFilename = choice;
                showToast('Geladen: ' + choice);
            } catch (e) { showToast('Fehler: ' + e.message); }
        });
    } catch (e) { showToast('Fehler: ' + e.message); }
}

function editorUpload() {
    document.getElementById('editor-file-input')?.click();
}

async function handleEditorUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!currentProject) {
        // Read into editor directly
        const reader = new FileReader();
        reader.onload = (e) => {
            const textarea = document.getElementById('editor-code');
            if (textarea) textarea.value = e.target.result;
            const fnEl = document.getElementById('editor-filename');
            if (fnEl) fnEl.value = file.name;
            editorFilename = file.name;
            showToast('Datei geladen: ' + file.name);
        };
        reader.readAsText(file);
        return;
    }
    // Upload to project
    const formData = new FormData();
    formData.append('file', file);
    try {
        const resp = await fetch('/api/workshop/files/' + currentProject.id + '/upload', {
            method: 'POST', body: formData
        });
        const res = await resp.json();
        if (res.success) {
            showToast('Hochgeladen: ' + file.name);
            // Load into editor
            const reader = new FileReader();
            reader.onload = (e) => {
                const textarea = document.getElementById('editor-code');
                if (textarea) textarea.value = e.target.result;
                const fnEl = document.getElementById('editor-filename');
                if (fnEl) fnEl.value = file.name;
            };
            reader.readAsText(file);
        } else {
            showToast('Fehler beim Upload');
        }
    } catch (e) { showToast('Upload fehlgeschlagen: ' + e.message); }
    event.target.value = '';
}

// ===== Environment Updates =====
function updateEnvironment(data) {
    const setVal = (id, val, unit) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val !== undefined ? val + unit : '--';
    };
    setVal('env-temp', data.temperatur, 'C');
    setVal('env-hum', data.feuchtigkeit, '%');
    setVal('env-co2', data.co2, 'ppm');
    setVal('env-temp2', data.temperatur, 'C');
    setVal('env-hum2', data.feuchtigkeit, '%');
    setVal('env-co22', data.co2, 'ppm');

    const footer = document.getElementById('footer-env');
    if (footer && data.temperatur !== undefined) {
        footer.textContent = data.temperatur + 'C | ' + (data.feuchtigkeit || '--') + '% | ' + (data.co2 || '--') + 'ppm';
    }
    // Overview stat card
    const ovTemp = document.getElementById('ov-env-temp');
    if (ovTemp && data.temperatur !== undefined) ovTemp.textContent = data.temperatur + 'C';
}

function showDiagnosis(data) {
    showToast('Diagnose abgeschlossen');
    if (currentProject) selectProject(currentProject.id);
}

// ===== Utilities =====
function escHtml(s) {
    if (!s) return '';
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB'];
    let i = 0;
    let size = bytes;
    while (size >= 1024 && i < units.length - 1) { size /= 1024; i++; }
    return size.toFixed(i > 0 ? 1 : 0) + ' ' + units[i];
}

function showToast(msg, type) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
    if (type === 'error') playSound('error');
    else if (type === 'success') playSound('success');
    else playSound('click');
}

async function refreshAll() {
    await loadProjects();
    renderView();
    showToast('Aktualisiert');
}

// ===== Settings View =====
async function renderSettingsView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#9881;</span><span class="widget-title">Workshop-Einstellungen</span></div>';

    // Theme Switcher
    html += '<div class="settings-group"><h4>Theme</h4>';
    html += '<div style="display:flex;gap:12px;flex-wrap:wrap">';
    const curTheme = getCurrentTheme();
    [['jarvis','Jarvis','#00d4ff'],['stark','Stark','#ff3d3d'],['matrix','Matrix','#00e676']].forEach(([id,name,color]) => {
        html += '<div class="theme-card' + (curTheme === id ? ' active' : '') + '" onclick="applyTheme(\'' + id + '\');renderSettingsView()">';
        html += '<div class="theme-dot" style="background:' + color + '"></div>';
        html += '<div class="theme-name">' + name + '</div></div>';
    });
    html += '</div></div>';

    // Sound + Ambient toggles
    html += '<div class="settings-group"><h4>Oberflaeche</h4>';
    const soundsOn = localStorage.getItem('ws-sounds') !== 'off';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">';
    html += '<span>Sound-Effekte</span><button class="action-btn secondary" style="padding:3px 10px;font-size:10px" onclick="localStorage.setItem(\'ws-sounds\',\'' + (soundsOn ? 'off' : 'on') + '\');renderSettingsView()">' + (soundsOn ? 'An' : 'Aus') + '</button></div>';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">';
    html += '<span>Ambient-Modus</span><button class="action-btn secondary" style="padding:3px 10px;font-size:10px" onclick="enterAmbientMode()">Starten</button></div>';
    const ambientAuto = localStorage.getItem('ws-ambient-auto') === 'on';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">';
    html += '<span>Ambient Auto-Start (5min)</span><button class="action-btn secondary" style="padding:3px 10px;font-size:10px" onclick="localStorage.setItem(\'ws-ambient-auto\',\'' + (ambientAuto ? 'off' : 'on') + '\');resetAmbientIdle();renderSettingsView()">' + (ambientAuto ? 'An' : 'Aus') + '</button></div>';
    html += '</div>';

    // Import/Export
    html += '<div class="settings-group"><h4>Daten</h4>';
    html += '<div style="display:flex;gap:8px;padding:8px 0">';
    html += '<button class="action-btn" onclick="exportAllProjects()">&#128190; Alles exportieren</button>';
    html += '<button class="action-btn secondary" onclick="importProjects()">&#128194; Importieren</button>';
    html += '<button class="action-btn secondary" onclick="exportProjectQR()">&#128214; Projekt-QR</button>';
    html += '</div></div>';

    try {
        const res = await apiCall('settings');
        const s = res.settings || {};

        html += '<div class="settings-group"><h4>Allgemein</h4>';
        html += settingsToggle('Workshop aktiv', 'enabled', !!s.enabled);
        html += settingsRow('Werkstatt-Raum', s.workshop_room || 'werkstatt');
        html += settingsRow('Standard-Kategorie', s.default_category || 'maker');
        html += settingsToggle('Sicherheits-Check', 'auto_safety_check', !!s.auto_safety_check);
        html += settingsToggle('Proaktive Vorschlaege', 'proactive_suggestions', !!s.proactive_suggestions);
        html += '</div>';

        html += '<div class="settings-group"><h4>Dateien</h4>';
        html += settingsRow('Speicherpfad', s.file_storage_path || '-');
        html += settingsRow('Max. Dateigroesse', (s.max_file_size_mb || 50) + ' MB');
        html += settingsRow('Bibliothek-Pfad', s.library_path || '-');
        html += '</div>';

        const p3d = s.printer_3d || {};
        html += '<div class="settings-group"><h4>3D-Drucker</h4>';
        html += settingsRow('Aktiviert', p3d.enabled ? 'Ja' : 'Nein');
        html += settingsRow('Entity-Prefix', p3d.entity_prefix || '-');
        html += settingsRow('Auto-Monitor', p3d.auto_monitor ? 'Ja' : 'Nein');
        html += settingsRow('Monitor-Intervall', (p3d.monitor_interval_seconds || 30) + 's');
        html += '</div>';

        const arm = s.robot_arm || {};
        html += '<div class="settings-group"><h4>Roboterarm</h4>';
        html += settingsRow('Aktiviert', arm.enabled ? 'Ja' : 'Nein');
        html += settingsRow('URL', arm.url || 'Nicht konfiguriert');
        html += settingsRow('Max. Geschwindigkeit', (arm.max_speed || 80) + '%');
        html += '</div>';

        const mqtt = s.mqtt || {};
        html += '<div class="settings-group"><h4>MQTT</h4>';
        html += settingsRow('Aktiviert', mqtt.enabled ? 'Ja' : 'Nein');
        html += settingsRow('Broker', mqtt.broker || 'Nicht konfiguriert');
        html += settingsRow('Port', mqtt.port || 1883);
        html += settingsRow('Topic-Prefix', mqtt.topic_prefix || 'workshop/');
        html += '</div>';

        const templates = s.templates || [];
        html += '<div class="settings-group"><h4>Projekt-Templates</h4>';
        if (templates.length) {
            html += '<div style="display:flex;flex-wrap:wrap;gap:6px;padding:8px 0">';
            templates.forEach(t => {
                html += '<span style="padding:3px 10px;border-radius:12px;background:var(--accent-dim);color:var(--accent);font-size:11px">' + escHtml(t) + '</span>';
            });
            html += '</div>';
        } else {
            html += settingsRow('Templates', 'Keine konfiguriert');
        }
        html += '</div>';

    } catch (e) {
        html += '<div style="color:var(--text-secondary);font-size:12px">Einstellungen konnten nicht geladen werden.</div>';
    }

    html += '<div style="margin-top:16px;font-size:11px;color:var(--text-secondary)">Einstellungen werden in <code>config/settings.yaml</code> konfiguriert. Aenderungen erfordern einen Neustart des Assistenten.</div>';
    html += '</div>';

    // Library Stats
    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128218;</span><span class="widget-title">Workshop-Bibliothek</span></div>';
    try {
        const lib = await apiCall('library/stats');
        html += settingsRow('Dokumente', lib.document_count || 0);
        html += settingsRow('Chunks', lib.chunk_count || 0);
    } catch (e) {
        html += '<div style="color:var(--text-secondary);font-size:12px">Bibliothek nicht verfuegbar.</div>';
    }
    html += '</div>';

    // Workshop Stats
    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128200;</span><span class="widget-title">Statistiken</span></div>';
    try {
        const stats = await apiCall('stats');
        html += settingsRow('Projekte gesamt', stats.total_projects || 0);
        html += settingsRow('Abgeschlossen', stats.completed || 0);
        html += settingsRow('In Arbeit', stats.in_progress || 0);
        if (stats.categories) {
            const cats = stats.categories;
            html += settingsRow('Maker', cats.maker || 0);
            html += settingsRow('Reparatur', cats.reparatur || 0);
            html += settingsRow('Bau', cats.bau || 0);
        }
    } catch (e) {
        html += '<div style="color:var(--text-secondary);font-size:12px">Statistiken nicht verfuegbar.</div>';
    }
    html += '</div>';

    main.innerHTML = html;
}

function settingsRow(label, value) {
    return '<div class="settings-row"><span class="label">' + escHtml(label) + '</span><span class="value">' + escHtml(String(value)) + '</span></div>';
}

function settingsToggle(label, key, isOn) {
    return '<div class="settings-row"><span class="label">' + escHtml(label) + '</span>' +
        '<div class="toggle-switch' + (isOn ? ' on' : '') + '" onclick="toggleSetting(\'' + key + '\', this)"></div></div>';
}

async function toggleSetting(key, el) {
    const isOn = el.classList.contains('on');
    const newVal = !isOn;
    try {
        await apiCall('settings/update', 'POST', { key, value: newVal });
        el.classList.toggle('on');
        showToast(key + ': ' + (newVal ? 'Aktiviert' : 'Deaktiviert'));
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Delete Project =====
async function deleteProject(id) {
    if (!confirm('Projekt wirklich loeschen?')) return;
    try {
        await apiCall('project/' + id, 'DELETE');
        if (currentProject && currentProject.id === id) {
            currentProject = null;
            updateHeader();
        }
        showToast('Projekt geloescht');
        await loadProjects();
        renderView();
    } catch (e) { showToast('Fehler beim Loeschen: ' + e.message); }
}

// ===== Status Change =====
function showStatusChange() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    const overlay = document.getElementById('new-project-modal');
    const current = currentProject.status || 'erstellt';
    const statuses = ['erstellt', 'diagnose', 'teile_bestellt', 'in_arbeit', 'pausiert', 'fertig'];
    const labels = { erstellt: 'Erstellt', diagnose: 'Diagnose', teile_bestellt: 'Teile bestellt', in_arbeit: 'In Arbeit', pausiert: 'Pausiert', fertig: 'Fertig' };
    let opts = statuses.map(s => '<option value="' + s + '"' + (s === current ? ' selected' : '') + '>' + labels[s] + '</option>').join('');
    overlay.innerHTML = '<div class="modal"><h3>Status aendern</h3>' +
        '<label>Neuer Status</label>' +
        '<select id="status-sel" style="width:100%;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px">' + opts + '</select>' +
        '<div class="modal-btns"><button onclick="closeStatusDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doStatusChange()">Speichern</button></div></div>';
    overlay.classList.remove('hidden');
}

function closeStatusDialog() {
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
}

async function doStatusChange() {
    const status = document.getElementById('status-sel')?.value;
    if (!status || !currentProject) return;
    closeStatusDialog();
    try {
        await apiCall('project/' + currentProject.id + '/status', 'POST', { status });
        showToast('Status geaendert: ' + status);
        await selectProject(currentProject.id);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Budget Dialog =====
function showBudgetDialog() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    const overlay = document.getElementById('new-project-modal');
    const current = parseFloat(currentProject.budget || 0) || 0;
    overlay.innerHTML = '<div class="modal"><h3>Budget setzen</h3>' +
        '<label>Budget (EUR)</label>' +
        '<input id="budget-val" type="number" step="0.01" value="' + current + '" style="width:100%;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px">' +
        '<div class="modal-btns"><button onclick="closeBudgetDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doBudgetSet()">Speichern</button></div></div>';
    overlay.classList.remove('hidden');
}

function closeBudgetDialog() {
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
}

async function doBudgetSet() {
    const val = parseFloat(document.getElementById('budget-val')?.value || 0);
    if (!currentProject) return;
    closeBudgetDialog();
    try {
        await apiCall('project/' + currentProject.id + '/budget', 'POST', { budget: val });
        showToast('Budget gesetzt: ' + val.toFixed(2) + ' EUR');
        await selectProject(currentProject.id);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Add Part Dialog =====
function showAddPartDialog() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Teil hinzufuegen</h3>' +
        '<label>Bauteil-Name *</label>' +
        '<input id="part-name" type="text" placeholder="z.B. ESP32 DevKit" style="width:100%;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px">' +
        '<label>Menge</label>' +
        '<input id="part-qty" type="number" value="1" min="1" style="width:100%;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px">' +
        '<label>Kosten (EUR)</label>' +
        '<input id="part-cost" type="number" step="0.01" value="0" style="width:100%;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:inherit;font-size:12px">' +
        '<div class="modal-btns"><button onclick="closePartDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doAddPart()">Hinzufuegen</button></div></div>';
    overlay.classList.remove('hidden');
}

function closePartDialog() {
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
}

async function doAddPart() {
    const name = document.getElementById('part-name')?.value.trim();
    if (!name || !currentProject) { showToast('Bitte Bauteil-Name eingeben'); return; }
    const qty = parseInt(document.getElementById('part-qty')?.value || 1);
    const cost = parseFloat(document.getElementById('part-cost')?.value || 0);
    closePartDialog();
    try {
        await apiCall('project/' + currentProject.id + '/parts', 'POST', { name, quantity: qty, cost });
        showToast('Teil hinzugefuegt: ' + name);
        await selectProject(currentProject.id);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Export Project =====
async function exportProject() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    window.open('/api/workshop/export/' + currentProject.id, '_blank');
}

// ===== Generic Input Modal (replaces prompt()) =====
let _inputModalCb = null;

function showInputModal(title, label, placeholder, callback) {
    _inputModalCb = callback;
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>' + escHtml(title) + '</h3>' +
        '<label>' + escHtml(label) + '</label>' +
        '<input id="input-modal-val" type="text" placeholder="' + escHtml(placeholder) + '">' +
        '<div class="modal-btns"><button onclick="closeInputModal()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="submitInputModal()">OK</button></div></div>';
    overlay.classList.remove('hidden');
    setTimeout(() => document.getElementById('input-modal-val')?.focus(), 100);
}

function closeInputModal() {
    document.getElementById('new-project-modal').classList.add('hidden');
    _inputModalCb = null;
    resetProjectModal();
}

function submitInputModal() {
    const val = document.getElementById('input-modal-val')?.value.trim();
    if (!val) { showToast('Bitte Wert eingeben'); return; }
    const cb = _inputModalCb;
    closeInputModal();
    if (cb) cb(val);
}

// ===== File Picker Modal (replaces prompt() for file list) =====
let _filePickerCb = null;

function showFilePickerModal(files, callback) {
    _filePickerCb = callback;
    const overlay = document.getElementById('new-project-modal');
    let html = '<div class="modal"><h3>Datei laden</h3>';
    html += '<div style="max-height:300px;overflow-y:auto">';
    files.forEach(f => {
        html += '<div class="file-item" style="padding:10px 12px;cursor:pointer;border:1px solid transparent;border-radius:4px;margin-bottom:4px" onclick="submitFilePicker(\'' + escHtml(f) + '\')">';
        html += '<span class="file-icon">&#128196;</span><span class="file-name">' + escHtml(f) + '</span></div>';
    });
    html += '</div>';
    html += '<div class="modal-btns"><button onclick="closeFilePicker()">Abbrechen</button></div></div>';
    overlay.innerHTML = html;
    overlay.classList.remove('hidden');
}

function closeFilePicker() {
    document.getElementById('new-project-modal').classList.add('hidden');
    _filePickerCb = null;
    resetProjectModal();
}

function submitFilePicker(filename) {
    const cb = _filePickerCb;
    closeFilePicker();
    if (cb) cb(filename);
}

// ===== Reset Project Modal =====
function resetProjectModal() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal">' +
        '<h3>Neues Projekt erstellen</h3>' +
        '<label>Projekt-Name *</label>' +
        '<input id="modal-title" type="text" placeholder="z.B. ESP32 Wetterstation">' +
        '<label>Beschreibung</label>' +
        '<input id="modal-desc" type="text" placeholder="Kurze Beschreibung...">' +
        '<label>Kategorie</label>' +
        '<select id="modal-cat"><option value="maker">Maker</option><option value="reparatur">Reparatur</option><option value="bau">Bau</option><option value="erfindung">Erfindung</option><option value="renovierung">Renovierung</option></select>' +
        '<label>Prioritaet</label>' +
        '<select id="modal-prio"><option value="normal">Normal</option><option value="niedrig">Niedrig</option><option value="hoch">Hoch</option><option value="dringend">Dringend</option></select>' +
        '<div class="modal-btns">' +
        '<button onclick="closeNewProjectModal()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="createProjectFromModal()">Erstellen</button>' +
        '</div></div>';
}

// ===== Inventory View =====
let _invItems = [];
let _invSelected = new Set();

async function renderInventoryView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '';

    // Bulk action bar
    if (_invSelected.size > 0) {
        html += '<div class="bulk-bar"><span class="bulk-count">' + _invSelected.size + ' ausgewaehlt</span>';
        html += '<div class="bulk-actions">';
        html += '<button class="action-btn secondary" onclick="invBulkExport()">CSV Export</button>';
        html += '<button class="action-btn danger" onclick="invBulkDelete()">Loeschen (' + _invSelected.size + ')</button>';
        html += '<button class="action-btn secondary" onclick="invDeselectAll()">Abbrechen</button>';
        html += '</div></div>';
    }

    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128230;</span><span class="widget-title">Werkstatt-Inventar</span></div>';
    html += '<div class="action-row" style="margin-bottom:12px">';
    html += '<button class="action-btn" onclick="showAddInventoryDialog()">+ Artikel hinzufuegen</button>';
    html += '<button class="action-btn secondary" onclick="renderInventoryView()">Aktualisieren</button>';
    html += '</div>';

    try {
        const res = await apiCall('inventory');
        _invItems = res.items || [];
        if (_invItems.length) {
            html += '<table class="parts-table"><thead><tr>';
            html += '<th><input type="checkbox" onchange="invToggleAll(this.checked)" ' + (_invSelected.size === _invItems.length && _invItems.length > 0 ? 'checked' : '') + '></th>';
            html += '<th>Artikel</th><th>Kategorie</th><th>Menge</th><th>Lagerort</th><th>Aktionen</th></tr></thead><tbody>';
            _invItems.forEach((item, idx) => {
                const qtyClass = (item.quantity || 0) <= (item.min_quantity || 0) ? 'part-missing' : 'part-available';
                const iname = escHtml(item.name || '');
                const checked = _invSelected.has(idx) ? ' checked' : '';
                html += '<tr><td><input type="checkbox"' + checked + ' onchange="invToggleItem(' + idx + ',this.checked)"></td>';
                html += '<td>' + iname + '</td>';
                html += '<td>' + escHtml(item.category || '-') + '</td>';
                html += '<td class="' + qtyClass + '">' + (item.quantity || 0) + (item.unit ? ' ' + item.unit : '') + '</td>';
                html += '<td>' + escHtml(item.location || '-') + '</td>';
                html += '<td><button class="action-btn secondary" style="padding:2px 6px;font-size:10px" onclick="showInvQR(\'' + iname + '\')">QR</button></td></tr>';
            });
            html += '</tbody></table>';
        } else {
            html += emptyState('Kein Inventar', 'Fuege Artikel hinzu um dein Werkstatt-Inventar zu verwalten.');
        }
    } catch (e) {
        html += '<div style="color:var(--text-secondary);font-size:12px">Inventar konnte nicht geladen werden.</div>';
    }
    html += '</div>';

    // Low Stock Warnings
    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#9888;</span><span class="widget-title">Nachbestellungen</span></div>';
    const lowStock = _invItems.filter(i => (i.quantity || 0) <= (i.min_quantity || 0) && i.min_quantity > 0);
    if (lowStock.length) {
        lowStock.forEach(i => {
            html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">';
            html += '<span style="color:var(--warning)">' + escHtml(i.name) + '</span>';
            html += '<span style="color:var(--danger)">' + (i.quantity || 0) + ' / ' + i.min_quantity + '</span></div>';
        });
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px">Alle Bestaende OK.</div>';
    }
    html += '</div>';

    main.innerHTML = html;
}

function invToggleAll(checked) {
    if (checked) { _invItems.forEach((_, i) => _invSelected.add(i)); } else { _invSelected.clear(); }
    renderInventoryView();
}
function invToggleItem(idx, checked) { if (checked) _invSelected.add(idx); else _invSelected.delete(idx); renderInventoryView(); }
function invDeselectAll() { _invSelected.clear(); renderInventoryView(); }

function invBulkExport() {
    const selected = [..._invSelected].map(i => _invItems[i]).filter(Boolean);
    let csv = 'Name,Kategorie,Menge,Lagerort\n';
    selected.forEach(i => { csv += '"' + (i.name||'') + '","' + (i.category||'') + '",' + (i.quantity||0) + ',"' + (i.location||'') + '"\n'; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'inventar_export.csv'; a.click();
    showToast(selected.length + ' Artikel exportiert', 'success');
}

async function invBulkDelete() {
    const count = _invSelected.size;
    if (!confirm(count + ' Artikel wirklich loeschen?')) return;
    const selected = [..._invSelected].map(i => _invItems[i]).filter(Boolean);
    for (const item of selected) {
        try { await apiCall('inventory/' + encodeURIComponent(item.name), 'DELETE'); } catch(e) {}
    }
    _invSelected.clear();
    showToast(count + ' Artikel geloescht', 'success');
    renderInventoryView();
}

function showInvQR(name) {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>QR-Code: ' + name + '</h3>' +
        generateQR('INVENTAR:' + name) +
        '<div class="modal-btns"><button onclick="document.getElementById(\'new-project-modal\').classList.add(\'hidden\');resetProjectModal()">Schliessen</button>' +
        '<button class="btn-primary" onclick="printInvQR(\'' + name + '\')">Drucken</button></div></div>';
    overlay.classList.remove('hidden');
}

function printInvQR(name) {
    const w = window.open('', '_blank');
    w.document.write('<html><body style="text-align:center;padding:40px">' + generateQR('INVENTAR:' + name) + '<p>' + name + '</p></body></html>');
    w.document.close(); w.print();
}

function showAddInventoryDialog() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Artikel hinzufuegen</h3>' +
        '<label>Artikelname *</label>' +
        '<input id="inv-name" type="text" placeholder="z.B. ESP32 DevKit">' +
        '<label>Kategorie</label>' +
        '<select id="inv-cat"><option value="elektronik">Elektronik</option><option value="mechanik">Mechanik</option><option value="werkzeug">Werkzeug</option><option value="verbrauch">Verbrauchsmaterial</option><option value="filament">Filament</option><option value="sonstiges">Sonstiges</option></select>' +
        '<label>Menge</label>' +
        '<input id="inv-qty" type="number" value="1" min="0">' +
        '<label>Lagerort</label>' +
        '<input id="inv-loc" type="text" placeholder="z.B. Schublade A3">' +
        '<div class="modal-btns"><button onclick="closeInventoryDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doAddInventory()">Hinzufuegen</button></div></div>';
    overlay.classList.remove('hidden');
}

function closeInventoryDialog() {
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
}

async function doAddInventory() {
    const name = document.getElementById('inv-name')?.value.trim();
    if (!name) { showToast('Bitte Artikelname eingeben'); return; }
    const category = document.getElementById('inv-cat')?.value || 'sonstiges';
    const quantity = parseInt(document.getElementById('inv-qty')?.value || 1);
    const location = document.getElementById('inv-loc')?.value.trim() || '';
    closeInventoryDialog();
    try {
        await apiCall('inventory', 'POST', { name, category, quantity, location });
        showToast('Artikel hinzugefuegt: ' + name);
        renderInventoryView();
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Snippets View =====
let _snippetCodes = [];

async function renderSnippetsView(main) {
    if (!main) main = document.getElementById('main-content');
    _snippetCodes = [];
    let html = '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128203;</span><span class="widget-title">Code-Snippets Bibliothek</span></div>';
    html += '<div class="action-row" style="margin-bottom:12px">';
    html += '<button class="action-btn" onclick="showAddSnippetDialog()">+ Snippet speichern</button>';
    html += '<button class="action-btn secondary" onclick="renderSnippetsView()">Aktualisieren</button>';
    html += '</div>';

    try {
        const res = await apiCall('snippets');
        const snippets = res.snippets || [];
        if (snippets.length) {
            snippets.forEach((s, idx) => {
                _snippetCodes.push(s.code || '');
                html += '<div class="widget" style="margin-top:12px;padding:14px">';
                html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">';
                html += '<span style="font-size:13px;font-weight:600;color:var(--accent)">' + escHtml(s.title || s.name || 'Unbenannt') + '</span>';
                html += '<span style="font-size:10px;color:var(--text-muted);font-family:var(--mono)">' + escHtml(s.language || '') + '</span>';
                html += '</div>';
                if (s.description) html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">' + escHtml(s.description) + '</div>';
                html += '<div class="code-container"><div class="code-header"><span>' + escHtml(s.language || 'text') + '</span>';
                html += '<button class="btn-copy" onclick="copySnippetCode(' + idx + ')">Kopieren</button></div>';
                let highlighted = escHtml(s.code || '');
                try {
                    const lang = s.language || 'markup';
                    const pl = Prism.languages[lang] || Prism.languages.markup;
                    highlighted = Prism.highlight(s.code || '', pl, lang);
                } catch(e) {}
                html += '<div class="code-content"><pre><code>' + highlighted + '</code></pre></div></div>';
                html += '</div>';
            });
        } else {
            html += '<div style="color:var(--text-secondary);font-size:12px">Keine Snippets gespeichert. Speichere haeufig verwendete Code-Stuecke hier.</div>';
        }
    } catch (e) {
        html += '<div style="color:var(--text-secondary);font-size:12px">Snippets konnten nicht geladen werden.</div>';
    }
    html += '</div>';
    main.innerHTML = html;
}

function copySnippetCode(idx) {
    if (_snippetCodes[idx] !== undefined) {
        navigator.clipboard.writeText(_snippetCodes[idx]);
        showToast('Kopiert!');
    }
}

function showAddSnippetDialog() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Snippet speichern</h3>' +
        '<label>Titel *</label>' +
        '<input id="snip-title" type="text" placeholder="z.B. WiFi Connect">' +
        '<label>Sprache</label>' +
        '<select id="snip-lang"><option value="python">Python</option><option value="arduino">Arduino</option><option value="cpp">C++</option><option value="javascript">JavaScript</option><option value="yaml">YAML</option><option value="html">HTML</option></select>' +
        '<label>Beschreibung</label>' +
        '<input id="snip-desc" type="text" placeholder="Kurze Beschreibung...">' +
        '<label>Code *</label>' +
        '<textarea id="snip-code" style="width:100%;min-height:100px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-family:var(--mono);font-size:12px;resize:vertical;tab-size:4" placeholder="Code hier einfuegen..."></textarea>' +
        '<div class="modal-btns"><button onclick="closeSnippetDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doAddSnippet()">Speichern</button></div></div>';
    overlay.classList.remove('hidden');
}

function closeSnippetDialog() {
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
}

async function doAddSnippet() {
    const title = document.getElementById('snip-title')?.value.trim();
    const code = document.getElementById('snip-code')?.value;
    if (!title || !code) { showToast('Bitte Titel und Code eingeben'); return; }
    const language = document.getElementById('snip-lang')?.value || 'python';
    const description = document.getElementById('snip-desc')?.value.trim() || '';
    closeSnippetDialog();
    try {
        await apiCall('snippets', 'POST', { title, code, language, description });
        showToast('Snippet gespeichert: ' + title);
        renderSnippetsView();
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Timer View =====
let timerRunning = false;
let timerStartTime = 0;
let timerElapsed = 0;
let timerInterval = null;
let timerLaps = [];

let timerTab = 'timer';
function renderTimerView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#9201;</span><span class="widget-title">Timer</span></div>';
    html += '<div class="tab-bar">';
    html += '<button class="tab-btn' + (timerTab === 'timer' ? ' active' : '') + '" onclick="timerTab=\'timer\';renderTimerView()">Stoppuhr</button>';
    html += '<button class="tab-btn' + (timerTab === 'pomodoro' ? ' active' : '') + '" onclick="timerTab=\'pomodoro\';renderTimerView()">Pomodoro</button>';
    html += '</div>';

    if (timerTab === 'pomodoro') {
        html += renderPomodoroTab();
        html += '</div>';
        main.innerHTML = html;
        return;
    }
    html += '</div><div class="widget" style="text-align:center">';
    html += '<div class="widget-header" style="justify-content:center"><span class="icon">&#9201;</span><span class="widget-title">Projekt-Timer</span></div>';

    const elapsed = timerRunning ? timerElapsed + (Date.now() - timerStartTime) : timerElapsed;
    html += '<div id="timer-display" style="font-size:48px;font-weight:600;color:var(--accent);font-family:var(--mono);letter-spacing:4px;margin:24px 0;text-shadow:0 0 30px rgba(0,212,255,0.3)">' + formatTimer(elapsed) + '</div>';

    html += '<div class="action-row" style="justify-content:center">';
    if (!timerRunning) {
        html += '<button class="action-btn" onclick="startTimer()">&#9654; Start</button>';
    } else {
        html += '<button class="action-btn" style="border-color:var(--warning);color:var(--warning)" onclick="pauseTimer()">&#10074;&#10074; Pause</button>';
    }
    html += '<button class="action-btn secondary" onclick="lapTimer()">&#127937; Runde</button>';
    html += '<button class="action-btn danger" onclick="resetTimer()">&#8634; Reset</button>';
    html += '</div>';

    // Laps
    if (timerLaps.length) {
        html += '<div style="margin-top:20px;text-align:left">';
        html += '<div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Runden</div>';
        timerLaps.forEach((lap, i) => {
            html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">';
            html += '<span style="color:var(--text-secondary)">Runde ' + (i + 1) + '</span>';
            html += '<span style="color:var(--accent);font-family:var(--mono)">' + formatTimer(lap) + '</span></div>';
        });
        html += '</div>';
    }

    html += '</div>';

    // Stopwatch for current session
    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128337;</span><span class="widget-title">Arbeitszeit heute</span></div>';
    html += '<div style="font-size:12px;color:var(--text-secondary)">Die Arbeitszeit wird automatisch erfasst solange das Workshop-UI geoeffnet ist.</div>';
    html += '<div style="margin-top:8px;font-size:18px;font-weight:600;color:var(--accent);font-family:var(--mono)">' + formatTimer(sessionWorkTime) + '</div>';
    html += '</div>';

    main.innerHTML = html;
}

function formatTimer(ms) {
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    return (h > 0 ? String(h).padStart(2, '0') + ':' : '') +
        String(m).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
}

function startTimer() {
    timerRunning = true;
    timerStartTime = Date.now();
    timerInterval = setInterval(updateTimerDisplay, 100);
    renderTimerView();
}

function pauseTimer() {
    timerElapsed += Date.now() - timerStartTime;
    timerRunning = false;
    clearInterval(timerInterval);
    renderTimerView();
}

function resetTimer() {
    timerRunning = false;
    timerElapsed = 0;
    timerStartTime = 0;
    timerLaps = [];
    clearInterval(timerInterval);
    renderTimerView();
}

function lapTimer() {
    if (!timerRunning && timerElapsed === 0) return;
    const elapsed = timerRunning ? timerElapsed + (Date.now() - timerStartTime) : timerElapsed;
    timerLaps.push(elapsed);
    renderTimerView();
}

function updateTimerDisplay() {
    const el = document.getElementById('timer-display');
    if (!el || !timerRunning) return;
    const elapsed = timerElapsed + (Date.now() - timerStartTime);
    el.textContent = formatTimer(elapsed);
    // Update footer timer too
    const ft = document.getElementById('footer-timer');
    if (ft) ft.textContent = formatTimer(elapsed);
}

// Session work time tracking
let sessionWorkTime = 0;
let sessionWorkStart = Date.now();
setInterval(() => {
    sessionWorkTime = Date.now() - sessionWorkStart;
    const ft = document.getElementById('footer-timer');
    if (ft && !timerRunning) ft.textContent = formatTimer(sessionWorkTime);
}, 1000);

// ===== Safety Checklist View =====
let safetyChecks = [
    { id: 'glasses', label: 'Schutzbrille tragen', checked: false, category: 'persoenlich' },
    { id: 'gloves', label: 'Handschuhe bei Bedarf', checked: false, category: 'persoenlich' },
    { id: 'hearing', label: 'Gehoerschutz bei lauten Arbeiten', checked: false, category: 'persoenlich' },
    { id: 'ventilation', label: 'Belueftung pruefen', checked: false, category: 'werkstatt' },
    { id: 'fire', label: 'Feuerloescher erreichbar', checked: false, category: 'werkstatt' },
    { id: 'firstaid', label: 'Erste-Hilfe-Kasten vorhanden', checked: false, category: 'werkstatt' },
    { id: 'cables', label: 'Kabel ordentlich verlegt', checked: false, category: 'werkstatt' },
    { id: 'power_off', label: 'Nicht benoetigte Geraete ausschalten', checked: false, category: 'elektro' },
    { id: 'grounding', label: 'Erdung pruefen', checked: false, category: 'elektro' },
    { id: 'soldering', label: 'Loetstation gesichert', checked: false, category: 'elektro' },
    { id: 'printer_clear', label: '3D-Drucker Bereich frei', checked: false, category: '3d' },
    { id: 'filament', label: 'Filament trocken gelagert', checked: false, category: '3d' },
];

function renderSafetyView(main) {
    if (!main) main = document.getElementById('main-content');
    const categories = {
        'persoenlich': { title: 'Persoenliche Schutzausruestung', icon: '&#128694;' },
        'werkstatt': { title: 'Werkstatt-Sicherheit', icon: '&#127968;' },
        'elektro': { title: 'Elektro-Sicherheit', icon: '&#9889;' },
        '3d': { title: '3D-Druck', icon: '&#128424;' },
    };

    let totalChecked = safetyChecks.filter(c => c.checked).length;
    let totalItems = safetyChecks.length;
    let pct = totalItems > 0 ? (totalChecked / totalItems) * 100 : 0;

    let html = '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#9888;</span><span class="widget-title">Sicherheits-Checkliste</span></div>';
    html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">';
    html += '<div style="flex:1"><div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%;background:' + (pct === 100 ? 'var(--success)' : 'var(--warning)') + '"></div></div></div>';
    html += '<span style="font-size:14px;font-weight:600;color:' + (pct === 100 ? 'var(--success)' : 'var(--warning)') + '">' + totalChecked + '/' + totalItems + '</span>';
    html += '</div>';

    if (pct === 100) {
        html += '<div style="padding:10px;border-radius:4px;background:var(--success-dim);border:1px solid rgba(0,230,118,0.3);color:var(--success);font-size:12px;margin-bottom:16px;text-align:center">&#10003; Alle Sicherheitschecks bestanden!</div>';
    }

    for (const [catId, cat] of Object.entries(categories)) {
        const items = safetyChecks.filter(c => c.category === catId);
        if (!items.length) continue;
        html += '<div style="margin-bottom:16px">';
        html += '<div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px">' + cat.icon + ' ' + cat.title + '</div>';
        items.forEach(item => {
            html += '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="toggleSafetyCheck(\'' + item.id + '\')">';
            html += '<div style="width:20px;height:20px;border:1.5px solid ' + (item.checked ? 'var(--success)' : 'var(--border-hover)') + ';border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--success);transition:all var(--fast)">' + (item.checked ? '&#10003;' : '') + '</div>';
            html += '<span style="font-size:13px;color:' + (item.checked ? 'var(--success)' : 'var(--text-primary)') + ';text-decoration:' + (item.checked ? 'line-through' : 'none') + '">' + escHtml(item.label) + '</span>';
            html += '</div>';
        });
        html += '</div>';
    }

    html += '<div class="action-row" style="margin-top:12px">';
    html += '<button class="action-btn secondary" onclick="resetSafetyChecks()">Alle zuruecksetzen</button>';
    html += '<button class="action-btn" onclick="generateProjectSafetyChecklist()">&#9889; Projekt-Checkliste generieren</button>';
    html += '</div>';
    html += '</div>';

    main.innerHTML = html;
}

function toggleSafetyCheck(id) {
    const item = safetyChecks.find(c => c.id === id);
    if (item) {
        item.checked = !item.checked;
        renderSafetyView();
    }
}

function resetSafetyChecks() {
    safetyChecks.forEach(c => c.checked = false);
    renderSafetyView();
}

// ===== Quick Actions on Overview =====
function addQuickActions(html) {
    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#9889;</span><span class="widget-title">Schnellaktionen</span></div>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px">';
    const actions = [
        { icon: '&#128172;', label: 'Quick Chat', fn: "switchToView('chat')" },
        { icon: '&#9998;', label: 'Code schreiben', fn: "switchToView('editor')" },
        { icon: '&#128221;', label: 'Diagnose', fn: 'showDiagnoseDialog()' },
        { icon: '&#128230;', label: 'Inventar', fn: "switchToView('inventory')" },
        { icon: '&#9201;', label: 'Timer starten', fn: "switchToView('timer');startTimer()" },
        { icon: '&#9888;', label: 'Sicherheitscheck', fn: "switchToView('safety')" },
    ];
    actions.forEach(a => {
        html += '<button class="action-btn secondary" style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px" onclick="' + a.fn + '">';
        html += '<span style="font-size:20px">' + a.icon + '</span>';
        html += '<span style="font-size:10px">' + a.label + '</span>';
        html += '</button>';
    });
    html += '</div></div>';
    return html;
}

function switchToView(view) {
    document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.view === view);
    });
    currentView = view;
    renderView();
}

// ===== Analysis & Debug View =====
let analysisTab = 'troubleshoot';

function renderAnalysisView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128300;</span><span class="widget-title">Analyse & Debug</span></div>';

    html += '<div class="tab-bar">';
    ['troubleshoot','simulate','compare','errorlog','measurement','improvements','calibration','scan'].forEach(t => {
        const labels = { troubleshoot:'Troubleshoot', simulate:'Simulation', compare:'Vergleich', errorlog:'Error-Log', measurement:'Messwerte', improvements:'Vorschlaege', calibration:'Kalibrierung', scan:'Scanner' };
        html += '<button class="tab-btn' + (analysisTab === t ? ' active' : '') + '" onclick="analysisTab=\'' + t + '\';renderAnalysisView()">' + labels[t] + '</button>';
    });
    html += '</div>';

    html += '<div id="analysis-content">';
    switch (analysisTab) {
        case 'troubleshoot':
            html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Beschreibe ein Symptom und Jarvis generiert einen systematischen Debug-Workflow.</div>';
            html += '<textarea id="analysis-input" class="chat-input" style="width:100%;min-height:80px;resize:vertical" placeholder="z.B. ESP32 verbindet sich nicht mit WiFi..."></textarea>';
            html += '<button class="action-btn" style="margin-top:8px" onclick="runAnalysis(\'troubleshoot\')">Troubleshoot starten</button>';
            break;
        case 'simulate':
            html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Pruefe Machbarkeit, Schwachstellen, Batterielebensdauer oder thermische Aspekte.</div>';
            html += '<textarea id="analysis-input" class="chat-input" style="width:100%;min-height:80px;resize:vertical" placeholder="z.B. Reicht ein 18650-Akku fuer 24h Betrieb?"></textarea>';
            html += '<button class="action-btn" style="margin-top:8px" onclick="runAnalysis(\'simulate\')">Simulieren</button>';
            break;
        case 'compare':
            html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Vergleiche zwei Bauteile mit Specs, Preis und Empfehlung.</div>';
            html += '<div style="display:flex;gap:8px"><input id="comp-a" class="chat-input" style="flex:1" placeholder="Bauteil A (z.B. ESP32)"><input id="comp-b" class="chat-input" style="flex:1" placeholder="Bauteil B (z.B. Arduino Nano)"></div>';
            html += '<input id="comp-usecase" class="chat-input" style="width:100%;margin-top:8px" placeholder="Anwendungsfall (optional)">';
            html += '<button class="action-btn" style="margin-top:8px" onclick="runCompare()">Vergleichen</button>';
            break;
        case 'errorlog':
            html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Fuege Serial-Output oder Error-Logs ein  Jarvis analysiert und schlaegt Fixes vor.</div>';
            html += '<textarea id="analysis-input" class="chat-input" style="width:100%;min-height:120px;resize:vertical;font-family:var(--mono);font-size:11px" placeholder="Serial-Output hier einfuegen..."></textarea>';
            html += '<button class="action-btn" style="margin-top:8px" onclick="runAnalysis(\'errorlog\')">Log analysieren</button>';
            break;
        case 'measurement':
            html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Gib einen Messwert ein und Jarvis bewertet ihn im Projektkontext.</div>';
            html += '<input id="analysis-input" class="chat-input" style="width:100%" placeholder="z.B. Spannung am Pin: 2.3V (erwartet: 3.3V)">';
            html += '<button class="action-btn" style="margin-top:8px" onclick="runAnalysis(\'measurement\')">Bewerten</button>';
            break;
        case 'improvements':
            html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Jarvis analysiert dein Projekt und schlaegt Verbesserungen vor.</div>';
            if (currentProject) {
                html += '<button class="action-btn" onclick="runAnalysis(\'improvements\')">Verbesserungen vorschlagen</button>';
            } else {
                html += '<div style="color:var(--text-secondary);font-size:12px">Waehle zuerst ein Projekt aus.</div>';
            }
            break;
        case 'calibration':
            html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Schritt-fuer-Schritt Kalibrierungsanleitung fuer Geraete.</div>';
            html += '<input id="analysis-input" class="chat-input" style="width:100%" placeholder="z.B. Multimeter, 3D-Drucker Bett, Loetstation...">';
            html += '<button class="action-btn" style="margin-top:8px" onclick="runAnalysis(\'calibration\')">Anleitung generieren</button>';
            break;
        case 'scan':
            html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Objekt-Scanner: Beschreibe ein Bauteil oder nutze eine Kamera.</div>';
            html += '<input id="analysis-input" class="chat-input" style="width:100%" placeholder="Beschreibe das Objekt oder gib einen Kameranamen ein...">';
            html += '<button class="action-btn" style="margin-top:8px" onclick="runAnalysis(\'scan\')">Scannen</button>';
            break;
    }
    html += '</div>';
    html += '<div class="analysis-result" id="analysis-result" style="margin-top:12px;display:none"></div>';
    html += '</div>';
    main.innerHTML = html;
}

async function runAnalysis(type) {
    const input = document.getElementById('analysis-input')?.value?.trim();
    const resultEl = document.getElementById('analysis-result');
    if (!input && type !== 'improvements') { showToast('Bitte Eingabe machen'); return; }
    resultEl.style.display = 'block';
    resultEl.textContent = 'Jarvis analysiert...';

    try {
        let res;
        switch (type) {
            case 'troubleshoot':
                res = await apiCall('troubleshoot', 'POST', { project_id: currentProject?.id || '', symptom: input });
                break;
            case 'simulate':
                res = await apiCall('simulate', 'POST', { project_id: currentProject?.id || '', question: input });
                break;
            case 'errorlog':
                res = await apiCall('analyze-error-log', 'POST', { project_id: currentProject?.id || '', log_text: input });
                break;
            case 'measurement':
                res = await apiCall('evaluate-measurement', 'POST', { project_id: currentProject?.id || '', measurement: input });
                break;
            case 'improvements':
                res = await apiCall('suggest-improvements', 'POST', { project_id: currentProject?.id || '' });
                break;
            case 'calibration':
                res = await apiCall('calibration', 'POST', { device_type: input });
                resultEl.textContent = res.guide || res.result || 'Keine Anleitung generiert.';
                return;
            case 'scan':
                res = await apiCall('scan-object', 'POST', { description: input });
                break;
        }
        resultEl.textContent = typeof res.result === 'string' ? res.result : JSON.stringify(res.result || res, null, 2);
    } catch (e) {
        resultEl.textContent = 'Fehler: ' + e.message;
    }
}

async function runCompare() {
    const a = document.getElementById('comp-a')?.value?.trim();
    const b = document.getElementById('comp-b')?.value?.trim();
    const usecase = document.getElementById('comp-usecase')?.value?.trim() || '';
    if (!a || !b) { showToast('Beide Bauteile eingeben'); return; }
    const resultEl = document.getElementById('analysis-result');
    resultEl.style.display = 'block';
    resultEl.textContent = 'Jarvis vergleicht...';
    try {
        const res = await apiCall('compare-components', 'POST', { component_a: a, component_b: b, use_case: usecase });
        resultEl.textContent = typeof res.result === 'string' ? res.result : JSON.stringify(res.result || res, null, 2);
    } catch (e) { resultEl.textContent = 'Fehler: ' + e.message; }
}

// ===== Tools View (Lending + Maintenance) =====
let toolsTab = 'lending';

async function renderToolsView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128295;</span><span class="widget-title">Werkzeug-Verwaltung</span></div>';
    html += '<div class="tab-bar">';
    html += '<button class="tab-btn' + (toolsTab === 'lending' ? ' active' : '') + '" onclick="toolsTab=\'lending\';renderToolsView()">Verleih</button>';
    html += '<button class="tab-btn' + (toolsTab === 'maintenance' ? ' active' : '') + '" onclick="toolsTab=\'maintenance\';renderToolsView()">Wartung</button>';
    html += '</div>';

    if (toolsTab === 'lending') {
        html += '<div class="action-row"><button class="action-btn" onclick="showLendToolDialog()">Werkzeug verleihen</button>';
        html += '<button class="action-btn secondary" onclick="showReturnToolDialog()">Werkzeug zurueck</button></div>';
        try {
            const res = await apiCall('lent-tools');
            const tools = res.tools || [];
            if (tools.length) {
                html += '<table class="parts-table"><thead><tr><th>Werkzeug</th><th>Verliehen an</th><th>Datum</th><th>Aktion</th></tr></thead><tbody>';
                tools.forEach(t => {
                    html += '<tr><td>' + escHtml(t.tool_name || t.name || '') + '</td>';
                    html += '<td>' + escHtml(t.person || '') + '</td>';
                    html += '<td>' + escHtml((t.lent_at || t.date || '').split('T')[0]) + '</td>';
                    html += '<td><button class="action-btn secondary" style="padding:3px 8px;font-size:10px" onclick="doReturnTool(\'' + escHtml(t.tool_name || t.name || '') + '\')">Zurueck</button></td></tr>';
                });
                html += '</tbody></table>';
            } else {
                html += '<div style="color:var(--text-secondary);font-size:12px">Keine Werkzeuge verliehen.</div>';
            }
        } catch (e) { html += '<div style="color:var(--text-secondary);font-size:12px">Daten nicht verfuegbar.</div>'; }
    } else {
        html += '<div class="action-row"><button class="action-btn" onclick="showMaintenanceDialog()">Wartung planen</button></div>';
        try {
            const res = await apiCall('maintenance-due');
            const items = res.items || [];
            if (items.length) {
                html += '<div class="info-box warning"><span class="info-icon">&#9888;</span>' + items.length + ' Werkzeuge brauchen Wartung!</div>';
                html += '<table class="parts-table"><thead><tr><th>Werkzeug</th><th>Letzte Wartung</th><th>Intervall</th><th>Status</th></tr></thead><tbody>';
                items.forEach(t => {
                    html += '<tr><td>' + escHtml(t.tool_name || '') + '</td>';
                    html += '<td>' + escHtml((t.last_done || '-').split('T')[0]) + '</td>';
                    html += '<td>' + (t.interval_days || '?') + ' Tage</td>';
                    html += '<td class="part-missing">Faellig</td></tr>';
                });
                html += '</tbody></table>';
            } else {
                html += '<div class="info-box success"><span class="info-icon">&#10003;</span>Alle Werkzeuge sind gewartet!</div>';
            }
        } catch (e) { html += '<div style="color:var(--text-secondary);font-size:12px">Wartungsdaten nicht verfuegbar.</div>'; }
    }
    html += '</div>';
    main.innerHTML = html;
}

function showLendToolDialog() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Werkzeug verleihen</h3>' +
        '<label>Werkzeug *</label><input id="lend-tool" type="text" placeholder="z.B. Multimeter">' +
        '<label>Person *</label><input id="lend-person" type="text" placeholder="z.B. Max">' +
        '<div class="modal-btns"><button onclick="closeLendDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doLendTool()">Verleihen</button></div></div>';
    overlay.classList.remove('hidden');
}
function closeLendDialog() { document.getElementById('new-project-modal').classList.add('hidden'); resetProjectModal(); }
async function doLendTool() {
    const tool = document.getElementById('lend-tool')?.value.trim();
    const person = document.getElementById('lend-person')?.value.trim();
    if (!tool || !person) { showToast('Werkzeug und Person eingeben'); return; }
    closeLendDialog();
    try { await apiCall('lend-tool', 'POST', { tool_name: tool, person }); showToast('Verliehen: ' + tool + ' an ' + person); renderToolsView(); }
    catch (e) { showToast('Fehler: ' + e.message); }
}
function showReturnToolDialog() {
    showInputModal('Werkzeug zurueckgeben', 'Werkzeugname', 'z.B. Multimeter', async (name) => {
        try { await apiCall('return-tool', 'POST', { tool_name: name }); showToast('Zurueckgegeben: ' + name); renderToolsView(); }
        catch (e) { showToast('Fehler: ' + e.message); }
    });
}
async function doReturnTool(name) {
    try { await apiCall('return-tool', 'POST', { tool_name: name }); showToast('Zurueckgegeben: ' + name); renderToolsView(); }
    catch (e) { showToast('Fehler: ' + e.message); }
}
function showMaintenanceDialog() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Wartung planen</h3>' +
        '<label>Werkzeug *</label><input id="maint-tool" type="text" placeholder="z.B. Loetstation">' +
        '<label>Intervall (Tage)</label><input id="maint-days" type="number" value="30" min="1">' +
        '<div class="modal-btns"><button onclick="closeMaintenanceDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doAddMaintenance()">Planen</button></div></div>';
    overlay.classList.remove('hidden');
}
function closeMaintenanceDialog() { document.getElementById('new-project-modal').classList.add('hidden'); resetProjectModal(); }
async function doAddMaintenance() {
    const tool = document.getElementById('maint-tool')?.value.trim();
    const days = parseInt(document.getElementById('maint-days')?.value || 30);
    if (!tool) { showToast('Werkzeugname eingeben'); return; }
    closeMaintenanceDialog();
    try { await apiCall('maintenance', 'POST', { tool_name: tool, interval_days: days }); showToast('Wartung geplant: ' + tool); renderToolsView(); }
    catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Devices View =====
async function renderDevicesView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128268;</span><span class="widget-title">Geraete-Manager</span></div>';
    html += '<div class="info-box info"><span class="info-icon">&#128161;</span>Verknuepfe Home-Assistant Geraete mit deinem Projekt um Status und Stromverbrauch zu ueberwachen.</div>';

    if (currentProject) {
        html += '<div class="action-row">';
        html += '<button class="action-btn" onclick="showLinkDeviceDialog()">Geraet verknuepfen</button>';
        html += '<button class="action-btn secondary" onclick="checkDeviceStatus()">Status pruefen</button>';
        html += '</div>';

        const devices = currentProject.devices || currentProject.linked_devices || [];
        if (devices.length) {
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:12px" id="device-cards">';
            devices.forEach(d => {
                const eid = typeof d === 'string' ? d : (d.entity_id || '');
                html += '<div class="stat-card" id="dev-' + escHtml(eid).replace(/\./g,'_') + '">';
                html += '<div style="font-size:11px;color:var(--text-secondary);font-family:var(--mono)">' + escHtml(eid) + '</div>';
                html += '<div class="stat-value" style="font-size:16px;margin-top:4px">---</div>';
                html += '<div class="stat-label">Laden...</div>';
                html += '</div>';
            });
            html += '</div>';
        } else {
            html += '<div style="color:var(--text-secondary);font-size:12px;margin-top:12px">Keine Geraete verknuepft.</div>';
        }
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px">Waehle zuerst ein Projekt aus.</div>';
    }
    html += '</div>';

    // Manual device check
    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128269;</span><span class="widget-title">Geraet pruefen</span></div>';
    html += '<div style="display:flex;gap:8px">';
    html += '<input class="chat-input" id="device-entity" placeholder="entity_id (z.B. sensor.werkstatt_temp)" style="flex:1">';
    html += '<button class="action-btn" onclick="checkSingleDevice()">Pruefen</button>';
    html += '</div>';
    html += '<div id="device-check-result" style="margin-top:8px"></div>';
    html += '</div>';

    main.innerHTML = html;
    if (currentProject) loadDeviceStatuses();
}

async function loadDeviceStatuses() {
    const devices = currentProject?.devices || currentProject?.linked_devices || [];
    for (const d of devices) {
        const eid = typeof d === 'string' ? d : (d.entity_id || '');
        if (!eid) continue;
        try {
            const res = await apiCall('device/' + encodeURIComponent(eid) + '/status');
            const card = document.getElementById('dev-' + eid.replace(/\./g, '_'));
            if (card) {
                const val = card.querySelector('.stat-value');
                const label = card.querySelector('.stat-label');
                if (val) val.textContent = res.state || res.status || 'Unbekannt';
                if (label) label.textContent = res.online ? 'Online' : 'Offline';
                card.style.borderLeftColor = res.online ? 'var(--success)' : 'var(--danger)';
            }
        } catch (e) {}
    }
}

function showLinkDeviceDialog() {
    if (!currentProject) return;
    showInputModal('Geraet verknuepfen', 'Entity-ID', 'z.B. sensor.werkstatt_temperatur', async (entityId) => {
        try {
            await apiCall('project/' + currentProject.id + '/link-device', 'POST', { entity_id: entityId });
            showToast('Geraet verknuepft: ' + entityId);
            await selectProject(currentProject.id);
            renderDevicesView();
        } catch (e) { showToast('Fehler: ' + e.message); }
    });
}

async function checkSingleDevice() {
    const eid = document.getElementById('device-entity')?.value.trim();
    if (!eid) { showToast('Entity-ID eingeben'); return; }
    const el = document.getElementById('device-check-result');
    el.innerHTML = 'Pruefe...';
    try {
        const res = await apiCall('device/' + encodeURIComponent(eid) + '/status');
        const power = await apiCall('device/' + encodeURIComponent(eid) + '/power').catch(() => ({}));
        el.innerHTML = '<div class="stat-card" style="margin-top:8px"><div class="stat-value" style="font-size:18px">' +
            escHtml(res.state || 'Unbekannt') + '</div><div class="stat-label">' +
            (res.online ? 'Online' : 'Offline') + (power.watts ? ' | ' + power.watts + ' W' : '') + '</div></div>';
    } catch (e) { el.innerHTML = '<span style="color:var(--danger)">Fehler: ' + escHtml(e.message) + '</span>'; }
}

async function checkDeviceStatus() { loadDeviceStatuses(); showToast('Status wird aktualisiert...'); }

// ===== Pinout Reference View =====
function renderPinoutView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128204;</span><span class="widget-title">Pinout-Referenz</span></div>';

    // ESP32 Pinout (hardcoded from WorkshopGenerator.ESP32_PINOUT)
    const esp32 = {
        'ADC1': 'GPIO32, GPIO33, GPIO34, GPIO35, GPIO36, GPIO39',
        'ADC2': 'GPIO0, GPIO2, GPIO4, GPIO12, GPIO13, GPIO14, GPIO15, GPIO25, GPIO26, GPIO27',
        'DAC': 'GPIO25 (DAC1), GPIO26 (DAC2)',
        'I2C': 'SDA=GPIO21, SCL=GPIO22',
        'SPI': 'MOSI=GPIO23, MISO=GPIO19, SCK=GPIO18, SS=GPIO5',
        'UART0': 'TX=GPIO1, RX=GPIO3',
        'UART2': 'TX=GPIO17, RX=GPIO16',
        'PWM': 'Alle GPIOs (0-39), 16 Kanaele',
        'Touch': 'T0=GPIO4, T2=GPIO2, T3=GPIO15, T4=GPIO13, T5=GPIO12, T6=GPIO14, T7=GPIO27, T8=GPIO33, T9=GPIO32',
        'Strapping': 'GPIO0 (Boot), GPIO2, GPIO5, GPIO12 (JTAG), GPIO15',
        'Input Only': 'GPIO34, GPIO35, GPIO36, GPIO39',
        'Flash': 'GPIO6-GPIO11 (nicht verwenden!)',
    };

    html += '<div style="font-size:14px;font-weight:600;margin-bottom:12px;color:var(--accent)">ESP32 DevKit</div>';
    html += '<div class="pinout-grid">';
    for (const [label, pins] of Object.entries(esp32)) {
        html += '<div class="pinout-item"><div class="pinout-label">' + escHtml(label) + '</div><div class="pinout-pins">' + escHtml(pins) + '</div></div>';
    }
    html += '</div>';

    // Arduino Uno
    html += '<div style="font-size:14px;font-weight:600;margin:20px 0 12px;color:var(--accent)">Arduino Uno</div>';
    const arduino = {
        'Digital': 'D0-D13 (D0/D1=Serial)',
        'Analog': 'A0-A5',
        'PWM': 'D3, D5, D6, D9, D10, D11',
        'I2C': 'SDA=A4, SCL=A5',
        'SPI': 'MOSI=D11, MISO=D12, SCK=D13, SS=D10',
        'Serial': 'TX=D1, RX=D0',
        'Interrupts': 'D2 (INT0), D3 (INT1)',
        'LED': 'D13 (eingebaut)',
    };
    html += '<div class="pinout-grid">';
    for (const [label, pins] of Object.entries(arduino)) {
        html += '<div class="pinout-item"><div class="pinout-label">' + escHtml(label) + '</div><div class="pinout-pins">' + escHtml(pins) + '</div></div>';
    }
    html += '</div>';

    // Common Component Pinouts
    html += '<div style="font-size:14px;font-weight:600;margin:20px 0 12px;color:var(--accent)">Haeufige Bauteile</div>';
    const components = {
        'DHT22': 'VCC=3.3-5V, DATA=Digital, GND | 4.7k Pull-Up',
        'BME280': 'VCC=3.3V, GND, SDA, SCL | I2C: 0x76/0x77',
        'OLED SSD1306': 'VCC=3.3V, GND, SDA, SCL | I2C: 0x3C',
        'HC-SR04': 'VCC=5V, TRIG=Digital, ECHO=Digital, GND',
        'WS2812B': 'VCC=5V, DIN=Digital, GND | 300-500 + 1000F',
        'MPU6050': 'VCC=3.3V, GND, SDA, SCL, INT | I2C: 0x68',
        'MCP3008': 'VDD=3.3V, VREF, AGND, CLK, DOUT, DIN, CS, DGND',
        'Relais-Modul': 'VCC=5V, GND, IN=Digital (LOW-aktiv) | Optokoppler',
    };
    html += '<div class="pinout-grid">';
    for (const [label, pins] of Object.entries(components)) {
        html += '<div class="pinout-item"><div class="pinout-label">' + escHtml(label) + '</div><div class="pinout-pins">' + escHtml(pins) + '</div></div>';
    }
    html += '</div>';

    html += '</div>';
    main.innerHTML = html;
}

// ===== Shopping List View =====
async function renderShoppingView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128722;</span><span class="widget-title">Einkaufsliste</span></div>';

    if (currentProject) {
        html += '<div class="action-row">';
        html += '<button class="action-btn" onclick="generateShoppingList()">Liste generieren</button>';
        html += '</div>';

        const parts = currentProject.parts || [];
        const missing = parts.filter(p => !p.available);
        if (missing.length) {
            html += '<table class="parts-table"><thead><tr><th>&#9744;</th><th>Teil</th><th>Menge</th><th>Gesch. Kosten</th></tr></thead><tbody>';
            let total = 0;
            missing.forEach(p => {
                const cost = parseFloat(p.cost || p.estimated_cost || 0);
                total += cost * (p.quantity || 1);
                html += '<tr><td><input type="checkbox" onchange="this.parentElement.parentElement.style.opacity=this.checked?\'0.4\':\'1\'"></td>';
                html += '<td>' + escHtml(p.name || '') + '</td>';
                html += '<td>' + (p.quantity || 1) + '</td>';
                html += '<td>' + (cost > 0 ? cost.toFixed(2) + ' EUR' : '-') + '</td></tr>';
            });
            html += '</tbody></table>';
            html += '<div style="margin-top:8px;font-size:13px;font-weight:600;color:var(--accent)">Gesamt: ca. ' + total.toFixed(2) + ' EUR</div>';
        } else {
            html += '<div class="info-box success"><span class="info-icon">&#10003;</span>Alle Teile vorhanden! Keine Einkauefe noetig.</div>';
        }
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px">Waehle zuerst ein Projekt aus um die Einkaufsliste zu sehen.</div>';
    }
    html += '</div>';

    // Shopping from all projects
    html += '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128203;</span><span class="widget-title">Alle fehlenden Teile</span></div>';
    let allMissing = [];
    projects.forEach(p => {
        (p.parts || []).filter(pt => !pt.available).forEach(pt => {
            allMissing.push({ ...pt, project: p.title || p.id });
        });
    });
    if (allMissing.length) {
        html += '<table class="parts-table"><thead><tr><th>Teil</th><th>Projekt</th><th>Menge</th></tr></thead><tbody>';
        allMissing.forEach(p => {
            html += '<tr><td>' + escHtml(p.name || '') + '</td>';
            html += '<td style="font-size:11px;color:var(--text-secondary)">' + escHtml(p.project) + '</td>';
            html += '<td>' + (p.quantity || 1) + '</td></tr>';
        });
        html += '</tbody></table>';
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px">Keine fehlenden Teile in allen Projekten.</div>';
    }
    html += '</div>';
    main.innerHTML = html;
}

async function generateShoppingList() {
    if (!currentProject) return;
    try {
        const res = await apiCall('project/' + currentProject.id + '/shopping-list', 'POST');
        showToast('Einkaufsliste aktualisiert');
        renderShoppingView();
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Templates Modal =====
async function showTemplatesModal() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal" style="max-width:560px"><h3>Projekt aus Template</h3><div id="template-list">Lade Templates...</div>' +
        '<div class="modal-btns"><button onclick="closeTemplatesModal()">Abbrechen</button></div></div>';
    overlay.classList.remove('hidden');

    try {
        const res = await apiCall('templates');
        const templates = res.templates || [];
        let html = '<div class="template-grid">';
        templates.forEach(t => {
            html += '<div class="template-card" onclick="createFromTemplate(\'' + t.id + '\',\'' + escHtml(t.name) + '\')">';
            html += '<div class="template-icon">' + (t.icon || '&#128230;') + '</div>';
            html += '<div class="template-name">' + escHtml(t.name) + '</div>';
            html += '<div class="template-desc">' + escHtml(t.description || '') + '</div>';
            html += '</div>';
        });
        html += '</div>';
        document.getElementById('template-list').innerHTML = html;
    } catch (e) {
        document.getElementById('template-list').innerHTML = '<div style="color:var(--danger)">Templates konnten nicht geladen werden.</div>';
    }
}

function closeTemplatesModal() { document.getElementById('new-project-modal').classList.add('hidden'); resetProjectModal(); }

async function createFromTemplate(templateId, templateName) {
    closeTemplatesModal();
    showToast('Erstelle Projekt aus Template...');
    try {
        const res = await apiCall('projects/from-template', 'POST', { template: templateId });
        showToast('Projekt erstellt: ' + templateName);
        await loadProjects();
        if (res.project_id) selectProject(res.project_id);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Search =====
let searchTimeout = null;
async function handleSearch(query) {
    clearTimeout(searchTimeout);
    const el = document.getElementById('search-results');
    if (!query.trim()) { el.innerHTML = ''; return; }
    searchTimeout = setTimeout(async () => {
        try {
            const res = await apiCall('projects/search?q=' + encodeURIComponent(query.trim()));
            const results = res.projects || [];
            if (results.length) {
                el.innerHTML = results.map(p =>
                    '<div class="search-result-item" onmousedown="selectProject(\'' + p.id + '\');document.getElementById(\'header-search\').value=\'\'">' +
                    escHtml(p.title || p.id) + '<span style="float:right;font-size:10px;color:var(--text-muted)">' + escHtml(p.status || '') + '</span></div>'
                ).join('');
            } else {
                el.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">Keine Ergebnisse</div>';
            }
            el.classList.add('open');
        } catch (e) {}
    }, 300);
}

// ===== Floating AI Bubble =====
let aiBubbleMessages = [];

function toggleAiBubble() {
    document.getElementById('ai-popup').classList.toggle('open');
    const input = document.getElementById('ai-popup-input');
    if (input) setTimeout(() => input.focus(), 100);
}

async function sendAiBubble() {
    const input = document.getElementById('ai-popup-input');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    aiBubbleMessages.push({ role: 'user', text });
    renderAiBubbleMessages();
    try {
        const res = await chatApi(text);
        aiBubbleMessages.push({ role: 'jarvis', text: res.response || 'Keine Antwort' });
    } catch (e) {
        aiBubbleMessages.push({ role: 'jarvis', text: 'Fehler: ' + (e.message || 'Verbindungsfehler') });
    }
    renderAiBubbleMessages();
}

function renderAiBubbleMessages() {
    const el = document.getElementById('ai-popup-messages');
    if (!el) return;
    el.innerHTML = aiBubbleMessages.slice(-20).map(m =>
        '<div class="chat-msg ' + m.role + '" style="font-size:12px;padding:8px 10px">' + escHtml(m.text) + '</div>'
    ).join('');
    el.scrollTop = el.scrollHeight;
}

// ===== Project Notes (in Overview) =====
async function addProjectNote() {
    if (!currentProject) return;
    showInputModal('Projekt-Notiz', 'Notiz', 'z.B. Lieferung kommt Montag...', async (note) => {
        try {
            await apiCall('project/' + currentProject.id + '/note', 'POST', { note });
            showToast('Notiz hinzugefuegt');
            await selectProject(currentProject.id);
            renderView();
        } catch (e) { showToast('Fehler: ' + e.message); }
    });
}

// ===== Expenses =====
function showExpenseDialog() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Ausgabe erfassen</h3>' +
        '<label>Artikel *</label><input id="exp-item" type="text" placeholder="z.B. ESP32 DevKit">' +
        '<label>Kosten (EUR) *</label><input id="exp-cost" type="number" step="0.01" value="0">' +
        '<div class="modal-btns"><button onclick="closeExpenseDialog()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doAddExpense()">Hinzufuegen</button></div></div>';
    overlay.classList.remove('hidden');
}
function closeExpenseDialog() { document.getElementById('new-project-modal').classList.add('hidden'); resetProjectModal(); }
async function doAddExpense() {
    const item = document.getElementById('exp-item')?.value.trim();
    const cost = parseFloat(document.getElementById('exp-cost')?.value || 0);
    if (!item) { showToast('Artikelname eingeben'); return; }
    closeExpenseDialog();
    try {
        await apiCall('project/' + currentProject.id + '/expense', 'POST', { item, cost });
        showToast('Ausgabe erfasst: ' + item + ' (' + cost.toFixed(2) + ' EUR)');
        await selectProject(currentProject.id);
        renderView();
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Keyboard Shortcuts =====
document.addEventListener('keydown', (e) => {
    // Ctrl+N: New Project
    if (e.ctrlKey && e.key === 'n') { e.preventDefault(); showNewProjectModal(); }
    // Ctrl+S: Save in editor
    if (e.ctrlKey && e.key === 's' && currentView === 'editor') { e.preventDefault(); editorSave(); }
    // Ctrl+K: Search
    if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        const s = document.getElementById('header-search');
        if (s) { s.focus(); s.select(); }
    }
    // Ctrl+B: Toggle AI Bubble
    if (e.ctrlKey && e.key === 'b') { e.preventDefault(); toggleAiBubble(); }
    // Escape: Close modals/overlays
    if (e.key === 'Escape') {
        document.getElementById('new-project-modal').classList.add('hidden');
        document.getElementById('ai-popup').classList.remove('open');
        document.getElementById('shortcut-overlay').classList.remove('open');
        document.getElementById('notif-panel').classList.remove('open');
        document.getElementById('notif-backdrop').classList.remove('show');
        exitAmbientMode();
    }
    // 1-9, P, ?: Quick view switch / shortcuts (when not in input)
    if (!e.ctrlKey && !e.altKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') {
        const viewMap = { '1':'overview', '2':'steps', '3':'code', '4':'editor', '5':'hardware', '6':'chat', '7':'calc', '8':'journal', '9':'analysis' };
        if (viewMap[e.key]) { e.preventDefault(); switchToView(viewMap[e.key]); }
        if (e.key === 'p' || e.key === 'P') { e.preventDefault(); if (pomodoroState === 'idle') pomodoroStart(); else pomodoroStop(); }
        if (e.key === '?') { e.preventDefault(); toggleShortcuts(); }
    }
});

// ===== Helper: SVG Progress Ring =====
function svgProgressRing(percent, size = 60) {
    const r = (size - 6) / 2;
    const c = 2 * Math.PI * r;
    const offset = c - (percent / 100) * c;
    const color = percent >= 75 ? 'var(--success)' : percent >= 25 ? 'var(--warning)' : 'var(--danger)';
    return '<svg class="progress-ring" width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">' +
        '<circle class="ring-bg" cx="' + size/2 + '" cy="' + size/2 + '" r="' + r + '" stroke-width="4"/>' +
        '<circle class="ring-fg" cx="' + size/2 + '" cy="' + size/2 + '" r="' + r + '" stroke-width="4" stroke="' + color + '" stroke-dasharray="' + c + '" stroke-dashoffset="' + offset + '"/>' +
        '<text class="ring-text" x="' + size/2 + '" y="' + size/2 + '">' + Math.round(percent) + '%</text></svg>';
}

// ===== Helper: SVG Sparkline =====
function svgSparkline(values, width = 120, height = 30, color = 'var(--accent)') {
    if (!values || !values.length) return '';
    const max = Math.max(...values, 1);
    const step = width / Math.max(values.length - 1, 1);
    const points = values.map((v, i) => (i * step).toFixed(1) + ',' + (height - (v / max) * (height - 4) - 2).toFixed(1)).join(' ');
    const last = values[values.length - 1];
    const lx = ((values.length - 1) * step).toFixed(1);
    const ly = (height - (last / max) * (height - 4) - 2).toFixed(1);
    return '<svg width="' + width + '" height="' + height + '" style="display:inline-block;vertical-align:middle">' +
        '<polyline fill="none" stroke="' + color + '" stroke-width="1.5" points="' + points + '"/>' +
        '<circle cx="' + lx + '" cy="' + ly + '" r="2.5" fill="' + color + '"/></svg>';
}

// ===== Helper: Empty State =====
function emptyState(icon, title, desc, actionLabel, actionFn) {
    let html = '<div class="empty-state"><div class="empty-state-icon">' + icon + '</div>';
    html += '<div class="empty-state-title">' + escHtml(title) + '</div>';
    html += '<div class="empty-state-desc">' + escHtml(desc) + '</div>';
    if (actionLabel && actionFn) {
        html += '<button class="action-btn" onclick="' + actionFn + '">' + escHtml(actionLabel) + '</button>';
    }
    html += '</div>';
    return html;
}

// ===== Helper: Loading Indicator =====
function genLoadingHtml(text) {
    return '<div class="gen-loading"><div class="gen-loading-bar"></div></div>' +
        '<div class="gen-loading-text">' + escHtml(text || 'Jarvis generiert') + '</div>';
}

// ===== Generators View =====
let genTab = '3d';

function renderGeneratorsView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#9881;</span><span class="widget-title">KI-Generatoren</span></div>';

    html += '<div class="tab-bar">';
    ['3d','schematic','website','bom','docs','tests'].forEach(t => {
        const labels = { '3d':'3D-Modell', schematic:'Schaltplan', website:'Website', bom:'Stueckliste', docs:'Dokumentation', tests:'Tests' };
        html += '<button class="tab-btn' + (genTab === t ? ' active' : '') + '" onclick="genTab=\'' + t + '\';renderGeneratorsView()">' + labels[t] + '</button>';
    });
    html += '</div>';

    const pid = currentProject?.id || '';
    const pname = currentProject?.title || 'Kein Projekt';

    switch (genTab) {
        case '3d':
            html += '<div class="info-box info"><span class="info-icon">&#128204;</span>Generiert OpenSCAD-Code fuer 3D-druckbare Modelle. Beschreibe Form, Masse und Toleranzen.</div>';
            html += '<textarea id="gen-input" class="chat-input" style="width:100%;min-height:100px;resize:vertical" placeholder="z.B. Gehaeuse fuer ESP32, 80x50x30mm, mit Lueftungsschlitzen und USB-Ausschnitt...">' + restoreDraft('gen-3d') + '</textarea>';
            html += '<button class="action-btn" style="margin-top:8px" id="gen-btn" onclick="runGenerator(\'3d-model\',\'gen-input\',\'requirement\')">3D-Modell generieren</button>';
            break;
        case 'schematic':
            html += '<div class="info-box info"><span class="info-icon">&#128204;</span>Generiert einen SVG-Schaltplan. Beschreibe die Schaltung und Bauteile.</div>';
            html += '<textarea id="gen-input" class="chat-input" style="width:100%;min-height:100px;resize:vertical" placeholder="z.B. ESP32 mit DHT22 Temperatursensor, I2C OLED Display und 2 LEDs...">' + restoreDraft('gen-schematic') + '</textarea>';
            html += '<button class="action-btn" style="margin-top:8px" id="gen-btn" onclick="runGenerator(\'schematic\',\'gen-input\',\'requirement\')">Schaltplan generieren</button>';
            break;
        case 'website':
            html += '<div class="info-box info"><span class="info-icon">&#128204;</span>Generiert eine komplette Single-Page Website fuer dein Projekt.</div>';
            html += '<textarea id="gen-input" class="chat-input" style="width:100%;min-height:100px;resize:vertical" placeholder="z.B. Dashboard-Seite fuer meinen Temperatursensor mit Live-Grafik...">' + restoreDraft('gen-website') + '</textarea>';
            html += '<button class="action-btn" style="margin-top:8px" id="gen-btn" onclick="runGenerator(\'website\',\'gen-input\',\'requirement\')">Website generieren</button>';
            break;
        case 'bom':
            html += '<div class="info-box info"><span class="info-icon">&#128204;</span>Erstellt eine vollstaendige Stueckliste (Bill of Materials) aus deinem Projekt.</div>';
            if (pid) {
                html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Projekt: <strong style="color:var(--accent)">' + escHtml(pname) + '</strong></div>';
                html += '<button class="action-btn" id="gen-btn" onclick="runGenerator(\'bom\')">Stueckliste generieren</button>';
            } else {
                html += emptyState('&#128230;', 'Kein Projekt', 'Waehle ein Projekt aus der Sidebar.', null, null);
            }
            break;
        case 'docs':
            html += '<div class="info-box info"><span class="info-icon">&#128204;</span>Generiert eine komplette Projekt-Dokumentation im Markdown-Format.</div>';
            if (pid) {
                html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Projekt: <strong style="color:var(--accent)">' + escHtml(pname) + '</strong></div>';
                html += '<button class="action-btn" id="gen-btn" onclick="runGenerator(\'documentation\')">Dokumentation generieren</button>';
            } else {
                html += emptyState('&#128214;', 'Kein Projekt', 'Waehle ein Projekt aus der Sidebar.', null, null);
            }
            break;
        case 'tests':
            html += '<div class="info-box info"><span class="info-icon">&#128204;</span>Generiert Unit-Tests fuer eine Datei in deinem Projekt.</div>';
            if (pid) {
                html += '<input id="gen-filename" class="chat-input" style="width:100%;margin-bottom:8px" placeholder="Dateiname (z.B. main.cpp)">';
                html += '<button class="action-btn" id="gen-btn" onclick="runGeneratorTests()">Tests generieren</button>';
            } else {
                html += emptyState('&#129518;', 'Kein Projekt', 'Waehle ein Projekt aus der Sidebar.', null, null);
            }
            break;
    }

    html += '<div id="gen-loading" style="display:none;margin-top:12px"></div>';
    html += '<div id="gen-result" style="display:none;margin-top:12px"></div>';
    html += '</div>';
    main.innerHTML = html;
    // Restore drafts
    const inp = document.getElementById('gen-input');
    if (inp) inp.addEventListener('input', () => saveDraft('gen-' + genTab, inp.value));
}

async function runGenerator(type, inputId, fieldName) {
    const btn = document.getElementById('gen-btn');
    const loading = document.getElementById('gen-loading');
    const result = document.getElementById('gen-result');
    const input = inputId ? document.getElementById(inputId)?.value?.trim() : '';

    if (inputId && !input) { showToast('Bitte Beschreibung eingeben'); return; }
    if (btn) btn.disabled = true;
    loading.style.display = 'block';
    loading.innerHTML = genLoadingHtml('Jarvis generiert');
    result.style.display = 'none';

    const body = { project_id: currentProject?.id || '' };
    if (fieldName) body[fieldName] = input;

    try {
        const res = await apiCall('generate/' + type, 'POST', body);
        loading.style.display = 'none';
        result.style.display = 'block';

        let content = res.code || res.svg || res.html || res.bom || res.documentation || res.tests || JSON.stringify(res, null, 2);
        let displayHtml = '';

        if (type === 'schematic' && res.svg) {
            displayHtml += '<div style="background:#fff;padding:16px;border-radius:4px;text-align:center;margin-bottom:8px">' + res.svg + '</div>';
        }
        if (type === 'website' && res.html) {
            displayHtml += '<iframe srcdoc="' + escHtml(res.html) + '" style="width:100%;height:300px;border:1px solid var(--border);border-radius:4px;margin-bottom:8px" sandbox="allow-scripts"></iframe>';
        }

        displayHtml += '<div class="code-result">' + escHtml(content) + '</div>';
        displayHtml += '<div class="code-actions">';
        displayHtml += '<button class="action-btn secondary" onclick="navigator.clipboard.writeText(document.querySelector(\'.code-result\').textContent);showToast(\'Kopiert!\')">Kopieren</button>';
        if (res.filename) displayHtml += '<button class="action-btn secondary" onclick="downloadGenResult(\'' + escHtml(res.filename) + '\')">Herunterladen</button>';
        displayHtml += '</div>';
        result.innerHTML = displayHtml;
        if (inputId) clearDraft('gen-' + genTab);
    } catch (e) {
        loading.style.display = 'none';
        result.style.display = 'block';
        result.innerHTML = '<div class="info-box warning"><span class="info-icon">&#9888;</span>Fehler: ' + escHtml(e.message) + '</div>';
    }
    if (btn) btn.disabled = false;
}

async function runGeneratorTests() {
    const filename = document.getElementById('gen-filename')?.value?.trim();
    if (!filename) { showToast('Dateiname eingeben'); return; }
    const btn = document.getElementById('gen-btn');
    const loading = document.getElementById('gen-loading');
    const result = document.getElementById('gen-result');
    if (btn) btn.disabled = true;
    loading.style.display = 'block';
    loading.innerHTML = genLoadingHtml('Tests werden generiert');
    result.style.display = 'none';
    try {
        const res = await apiCall('generate/tests', 'POST', { project_id: currentProject?.id || '', filename });
        loading.style.display = 'none';
        result.style.display = 'block';
        const content = res.tests || res.code || JSON.stringify(res, null, 2);
        result.innerHTML = '<div class="code-result">' + escHtml(content) + '</div>' +
            '<div class="code-actions"><button class="action-btn secondary" onclick="navigator.clipboard.writeText(document.querySelector(\'.code-result\').textContent);showToast(\'Kopiert!\')">Kopieren</button></div>';
    } catch (e) {
        loading.style.display = 'none';
        result.style.display = 'block';
        result.innerHTML = '<div class="info-box warning"><span class="info-icon">&#9888;</span>Fehler: ' + escHtml(e.message) + '</div>';
    }
    if (btn) btn.disabled = false;
}

function downloadGenResult(filename) {
    const content = document.querySelector('.code-result')?.textContent || '';
    const blob = new Blob([content], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

// ===== Kanban Board View =====
function renderKanbanView(main) {
    if (!main) main = document.getElementById('main-content');
    const columns = [
        { status: 'erstellt', label: 'Erstellt' },
        { status: 'diagnose', label: 'Diagnose' },
        { status: 'in_arbeit', label: 'In Arbeit' },
        { status: 'pausiert', label: 'Pausiert' },
        { status: 'fertig', label: 'Fertig' },
    ];
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128203;</span><span class="widget-title">Kanban Board</span></div>';
    html += '<div class="kanban-board">';
    columns.forEach(col => {
        const items = projects.filter(p => p.status === col.status);
        html += '<div class="kanban-column" data-status="' + col.status + '" ondragover="kanbanDragOver(event)" ondrop="kanbanDrop(event,\'' + col.status + '\')">';
        html += '<div class="kanban-column-title">' + col.label + ' (' + items.length + ')</div>';
        items.forEach(p => {
            const parts = p.parts || [];
            const avail = parts.filter(pt => pt.available).length;
            const pct = parts.length ? Math.round((avail / parts.length) * 100) : 0;
            html += '<div class="kanban-card" draggable="true" ondragstart="kanbanDragStart(event,\'' + p.id + '\')" onclick="selectProject(\'' + p.id + '\')">';
            html += '<div class="kanban-card-title">' + escHtml(p.title || p.id) + '</div>';
            html += '<div class="kanban-card-meta">' + escHtml(p.category || '') + (parts.length ? ' | ' + pct + '% Teile' : '') + '</div>';
            html += '</div>';
        });
        html += '<div class="kanban-drop-zone" ondragover="kanbanDragOver(event)" ondrop="kanbanDrop(event,\'' + col.status + '\')"></div>';
        html += '</div>';
    });
    html += '</div></div>';
    main.innerHTML = html;
}

let kanbanDragId = '';
function kanbanDragStart(e, id) { kanbanDragId = id; e.dataTransfer.effectAllowed = 'move'; e.target.classList.add('dragging'); }
function kanbanDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const z = e.target.closest('.kanban-drop-zone,.kanban-column'); if (z) z.classList.add('over'); }
async function kanbanDrop(e, newStatus) {
    e.preventDefault();
    document.querySelectorAll('.kanban-drop-zone,.kanban-column').forEach(el => el.classList.remove('over'));
    document.querySelectorAll('.kanban-card.dragging').forEach(el => el.classList.remove('dragging'));
    if (!kanbanDragId) return;
    try {
        await apiCall('project/' + kanbanDragId + '/status', 'POST', { status: newStatus });
        const p = projects.find(pr => pr.id === kanbanDragId);
        if (p) p.status = newStatus;
        renderKanbanView();
        showToast('Status geaendert');
    } catch (e2) { showToast('Fehler: ' + e2.message); }
    kanbanDragId = '';
}

// ===== Pomodoro Timer =====
let pomodoroState = 'idle'; // idle, work, break, longbreak
let pomodoroTime = 25 * 60;
let pomodoroInterval = null;
let pomodoroCycles = 0;

function renderPomodoroTab() {
    let html = '<div class="pomodoro-display">';
    const mins = Math.floor(pomodoroTime / 60);
    const secs = pomodoroTime % 60;
    const pct = pomodoroState === 'work' ? ((25*60 - pomodoroTime) / (25*60)) * 100 :
                pomodoroState === 'break' ? ((5*60 - pomodoroTime) / (5*60)) * 100 :
                pomodoroState === 'longbreak' ? ((15*60 - pomodoroTime) / (15*60)) * 100 : 0;
    html += svgProgressRing(pct, 140);
    html += '<div class="pomodoro-time">' + String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0') + '</div>';
    const labels = { idle: 'Bereit', work: 'Fokus-Phase', break: 'Kurze Pause', longbreak: 'Lange Pause' };
    html += '<div class="pomodoro-label">' + labels[pomodoroState] + '</div>';
    html += '<div class="pomodoro-cycles">';
    for (let i = 0; i < 4; i++) html += '<div class="pomodoro-dot' + (i < pomodoroCycles % 4 ? ' done' : '') + '"></div>';
    html += '</div>';
    html += '<div style="margin-top:16px;display:flex;gap:8px;justify-content:center">';
    if (pomodoroState === 'idle') {
        html += '<button class="action-btn" onclick="pomodoroStart()">Fokus starten</button>';
    } else {
        html += '<button class="action-btn secondary" onclick="pomodoroStop()">Stoppen</button>';
        html += '<button class="action-btn secondary" onclick="pomodoroSkip()">Ueberspringen</button>';
    }
    html += '<button class="action-btn secondary" onclick="pomodoroReset()">Reset</button>';
    html += '</div></div>';
    return html;
}

function pomodoroStart() {
    pomodoroState = 'work';
    pomodoroTime = 25 * 60;
    pomodoroInterval = setInterval(pomodoroTick, 1000);
    renderView();
}
function pomodoroTick() {
    pomodoroTime--;
    if (pomodoroTime <= 0) {
        pomodoroBeep();
        if (pomodoroState === 'work') {
            pomodoroCycles++;
            if (pomodoroCycles % 4 === 0) { pomodoroState = 'longbreak'; pomodoroTime = 15 * 60; }
            else { pomodoroState = 'break'; pomodoroTime = 5 * 60; }
        } else {
            pomodoroState = 'work'; pomodoroTime = 25 * 60;
        }
    }
    if (currentView === 'timer') renderView();
}
function pomodoroStop() { clearInterval(pomodoroInterval); pomodoroState = 'idle'; renderView(); }
function pomodoroSkip() {
    pomodoroTime = 0; pomodoroTick();
}
function pomodoroReset() { clearInterval(pomodoroInterval); pomodoroState = 'idle'; pomodoroTime = 25 * 60; pomodoroCycles = 0; renderView(); }
function pomodoroBeep() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.value = 880; gain.gain.value = 0.15;
        osc.start(); osc.stop(ctx.currentTime + 0.3);
    } catch(e) {}
}

// ===== Widerstandsfarbcode-Rechner =====
const RES_COLORS = [
    { name: 'Schwarz', hex: '#000000', val: 0, mult: 1, tol: null },
    { name: 'Braun', hex: '#8B4513', val: 1, mult: 10, tol: 1 },
    { name: 'Rot', hex: '#FF0000', val: 2, mult: 100, tol: 2 },
    { name: 'Orange', hex: '#FF8C00', val: 3, mult: 1000, tol: null },
    { name: 'Gelb', hex: '#FFD700', val: 4, mult: 10000, tol: null },
    { name: 'Gruen', hex: '#008000', val: 5, mult: 100000, tol: 0.5 },
    { name: 'Blau', hex: '#0000FF', val: 6, mult: 1000000, tol: 0.25 },
    { name: 'Violett', hex: '#8B008B', val: 7, mult: 10000000, tol: 0.1 },
    { name: 'Grau', hex: '#808080', val: 8, mult: 100000000, tol: 0.05 },
    { name: 'Weiss', hex: '#FFFFFF', val: 9, mult: 1000000000, tol: null },
    { name: 'Gold', hex: '#FFD700', val: null, mult: 0.1, tol: 5 },
    { name: 'Silber', hex: '#C0C0C0', val: null, mult: 0.01, tol: 10 },
];
let resBands = [1, 0, 2, -1]; // band1, band2, multiplier, tolerance idx

function renderResistorCalcTab() {
    let html = '<div style="text-align:center;padding:16px">';
    // SVG Resistor
    html += '<svg width="300" height="80" viewBox="0 0 300 80" class="resistor-svg">';
    html += '<line x1="0" y1="40" x2="60" y2="40" stroke="var(--text-muted)" stroke-width="2"/>';
    html += '<rect x="60" y="15" width="180" height="50" rx="8" fill="#c4a882" stroke="#8B7355" stroke-width="1.5"/>';
    html += '<line x1="240" y1="40" x2="300" y2="40" stroke="var(--text-muted)" stroke-width="2"/>';
    // Color bands
    const positions = [90, 120, 150, 200];
    resBands.forEach((bi, i) => {
        const c = bi >= 0 && bi < RES_COLORS.length ? RES_COLORS[bi] : null;
        html += '<rect x="' + positions[i] + '" y="18" width="14" height="44" fill="' + (c ? c.hex : '#666') + '" rx="1"/>';
    });
    html += '</svg>';

    // Band selectors
    const bandLabels = ['Band 1', 'Band 2', 'Multiplikator', 'Toleranz'];
    html += '<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:16px">';
    bandLabels.forEach((label, bi) => {
        html += '<div style="text-align:center"><div style="font-size:10px;color:var(--text-secondary);margin-bottom:4px">' + label + '</div>';
        html += '<div class="color-band-select">';
        const maxColors = bi === 3 ? RES_COLORS.length : 10;
        for (let ci = 0; ci < maxColors; ci++) {
            const c = RES_COLORS[ci];
            if (bi < 2 && c.val === null) continue;
            if (bi === 2 && ci > 9) continue;
            if (bi === 3 && c.tol === null) continue;
            html += '<div class="color-swatch' + (resBands[bi] === ci ? ' active' : '') + '" style="background:' + c.hex + (c.hex === '#000000' ? ';border:1px solid #333' : '') + '" onclick="setResBand(' + bi + ',' + ci + ')" title="' + c.name + '"></div>';
        }
        html += '</div></div>';
    });
    html += '</div>';

    // Calculate value
    const b1 = RES_COLORS[resBands[0]]?.val || 0;
    const b2 = RES_COLORS[resBands[1]]?.val || 0;
    const mult = RES_COLORS[resBands[2]]?.mult || 1;
    const tol = resBands[3] >= 0 ? RES_COLORS[resBands[3]]?.tol : null;
    const value = (b1 * 10 + b2) * mult;
    let display = value >= 1e6 ? (value / 1e6).toFixed(value % 1e6 === 0 ? 0 : 1) + ' M' :
                  value >= 1e3 ? (value / 1e3).toFixed(value % 1e3 === 0 ? 0 : 1) + ' k' :
                  value.toString();
    html += '<div class="resistor-value">' + display + 'Ohm' + (tol !== null ? ' +-' + tol + '%' : '') + '</div>';
    html += '</div>';
    return html;
}

function setResBand(bandIdx, colorIdx) { resBands[bandIdx] = colorIdx; renderView(); }

// ===== Loettemperatur Guide =====
function renderSolderGuideTab() {
    const data = [
        ['Through-Hole (bleihaltig)', '320-350', 'Meisselform', 'Nicht zu lange halten, max 3s pro Pad'],
        ['Through-Hole (bleifrei)', '350-380', 'Meisselform', 'Etwas heisser als bleihaltig, Flussmittel nutzen'],
        ['SMD 0805/0603', '300-340', 'Feine Spitze', 'Erst ein Pad verzinnen, Bauteil positionieren, anderes Pad loeten'],
        ['SMD QFP/TQFP', '320-350', 'Messer/Schleppspitze', 'Schleppltoen mit viel Flussmittel'],
        ['BGA Nacharbeit', '380-420', 'Heissluft', 'Profil beachten, Nachbarteile schuetzen'],
        ['Kabel/Litze (duenn)', '350-380', 'Meisselform', 'Kabel verzinnen, dann am Pad anlten'],
        ['Kabel/Litze (dick)', '380-420', 'Grosse Meisselform', 'Mehr Leistung noetig, laenger vorwaermen'],
        ['Stecker/Header', '330-360', 'Meisselform', 'Gerade ausrichten vor dem Loeten'],
        ['Entloeten (Sauglitze)', '370-400', 'Breite Spitze', 'Sauglitze mit Flussmittel traenken'],
        ['Entloeten (Pumpe)', '360-380', 'Standard', 'Schnell absaugen nach Erwaermung'],
    ];
    let html = '<table class="solder-table"><thead><tr><th>Bauteil</th><th>Temp (C)</th><th>Spitze</th><th>Tipps</th></tr></thead><tbody>';
    data.forEach(r => {
        html += '<tr><td style="font-weight:600">' + r[0] + '</td><td style="color:var(--warning);font-family:var(--mono)">' + r[1] + '</td><td>' + r[2] + '</td><td style="font-size:10px">' + r[3] + '</td></tr>';
    });
    html += '</tbody></table>';
    return html;
}

// ===== Theme Switcher =====
function applyTheme(theme) {
    if (theme === 'jarvis') document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('ws-theme', theme);
}

function getCurrentTheme() { return localStorage.getItem('ws-theme') || 'jarvis'; }

// ===== Notification Center =====
let notifications = [];

function toggleNotifPanel() {
    const panel = document.getElementById('notif-panel');
    const backdrop = document.getElementById('notif-backdrop');
    panel.classList.toggle('open');
    backdrop.classList.toggle('show');
    if (panel.classList.contains('open')) loadNotifications();
}

async function loadNotifications() {
    try {
        const res = await apiCall('notifications');
        notifications = res.notifications || [];
        const countEl = document.getElementById('notif-count');
        if (notifications.length > 0) { countEl.textContent = notifications.length; countEl.style.display = 'flex'; }
        else { countEl.style.display = 'none'; }
        renderNotifications();
    } catch (e) { notifications = []; }
}

function renderNotifications() {
    const el = document.getElementById('notif-list');
    if (!el) return;
    if (notifications.length === 0) {
        el.innerHTML = emptyState('&#128276;', 'Keine Benachrichtigungen', 'Alles in Ordnung!');
        return;
    }
    el.innerHTML = notifications.map((n, i) =>
        '<div class="notif-item" onclick="handleNotif(' + i + ')"><span class="notif-icon">' + (n.icon || '&#128276;') + '</span><div><div style="color:var(--text-primary)">' + escHtml(n.message) + '</div><div style="font-size:10px;margin-top:2px">' + escHtml((n.time || '').split('T')[0]) + '</div></div></div>'
    ).join('');
}

function handleNotif(idx) {
    const n = notifications[idx];
    if (n?.type === 'maintenance') { switchToView('tools'); toolsTab = 'maintenance'; }
    else if (n?.type === 'lending') { switchToView('tools'); toolsTab = 'lending'; }
    toggleNotifPanel();
}

// ===== Voice Narration =====
let narrationActive = false;

function toggleNarration() {
    if (narrationActive) { window.speechSynthesis.cancel(); narrationActive = false; renderView(); return; }
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt'); return; }
    const steps = currentProject.steps || [];
    if (!steps.length) { showToast('Keine Schritte vorhanden'); return; }
    narrationActive = true;
    renderView();
    readStepsAloud(steps, 0);
}

function readStepsAloud(steps, idx) {
    if (idx >= steps.length || !narrationActive) { narrationActive = false; renderView(); return; }
    const step = steps[idx];
    const text = 'Schritt ' + (idx + 1) + ': ' + (step.title || step.name || step) + '. ' + (step.description || '');
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'de-DE'; utter.rate = 0.9;
    utter.onend = () => readStepsAloud(steps, idx + 1);
    window.speechSynthesis.speak(utter);
}

// ===== Project Duplication =====
async function duplicateProject() {
    if (!currentProject) return;
    try {
        const res = await apiCall('project/' + currentProject.id + '/duplicate', 'POST', {});
        showToast('Projekt dupliziert: ' + (res.title || ''));
        await loadProjects();
        if (res.project_id) selectProject(res.project_id);
    } catch (e) { showToast('Fehler: ' + e.message); }
}

// ===== Favorites / Pins =====
function getPinnedProjects() {
    try { return JSON.parse(localStorage.getItem('ws-pinned') || '[]'); } catch(e) { return []; }
}
function togglePin(id) {
    let pinned = getPinnedProjects();
    if (pinned.includes(id)) pinned = pinned.filter(p => p !== id);
    else pinned.push(id);
    localStorage.setItem('ws-pinned', JSON.stringify(pinned));
    renderProjectList();
}

// ===== LocalStorage Drafts =====
function saveDraft(key, value) { localStorage.setItem('ws-draft-' + key, value); }
function restoreDraft(key) { return localStorage.getItem('ws-draft-' + key) || ''; }
function clearDraft(key) { localStorage.removeItem('ws-draft-' + key); }

// ===== Undo System =====
let lastUndoAction = null;
let undoTimeout = null;

function showUndoToast(msg, undoFn) {
    const el = document.getElementById('toast');
    el.innerHTML = escHtml(msg) + '<button class="toast-undo" onclick="executeUndo()">Rueckgaengig</button>';
    el.classList.add('show');
    lastUndoAction = undoFn;
    clearTimeout(undoTimeout);
    undoTimeout = setTimeout(() => { el.classList.remove('show'); lastUndoAction = null; }, 8000);
}

function executeUndo() {
    if (lastUndoAction) { lastUndoAction(); lastUndoAction = null; }
    document.getElementById('toast').classList.remove('show');
    clearTimeout(undoTimeout);
}

// ===== Shortcut Overlay =====
function toggleShortcuts() { document.getElementById('shortcut-overlay').classList.toggle('open'); }

// ===== Ambient Mode =====
let ambientInterval = null;
let ambientIdleTimer = null;

function enterAmbientMode() {
    document.getElementById('ambient-overlay').classList.add('active');
    updateAmbientClock();
    ambientInterval = setInterval(updateAmbientClock, 1000);
    const proj = currentProject?.title || 'Kein aktives Projekt';
    document.getElementById('ambient-project').textContent = proj;
}

function exitAmbientMode() {
    document.getElementById('ambient-overlay').classList.remove('active');
    clearInterval(ambientInterval);
}

function updateAmbientClock() {
    const now = new Date();
    document.getElementById('ambient-clock').textContent = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
    const envEl = document.getElementById('footer-env');
    if (envEl) document.getElementById('ambient-env').textContent = envEl.textContent;
}

// ===== Sound Effects =====
function playSound(type) {
    if (localStorage.getItem('ws-sounds') === 'off') return;
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        const hour = new Date().getHours();
        const vol = (hour >= 22 || hour < 7) ? 0.03 : 0.08;
        gain.gain.value = vol;
        if (type === 'success') { osc.frequency.value = 523; osc.start(); osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1); osc.stop(ctx.currentTime + 0.2); }
        else if (type === 'error') { osc.frequency.value = 220; osc.start(); osc.stop(ctx.currentTime + 0.2); }
        else { osc.frequency.value = 1200; gain.gain.value = vol * 0.5; osc.start(); osc.stop(ctx.currentTime + 0.05); }
    } catch(e) {}
}

// ===== QR Code Generator (simple) =====
function generateQR(text) {
    // Uses a simple QR code via an SVG pattern (basic encoding)
    // For production, use a proper library. This creates a placeholder.
    return '<div style="text-align:center;padding:16px"><div style="background:#fff;display:inline-block;padding:16px;border-radius:4px">' +
        '<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + encodeURIComponent(text) + '" alt="QR Code" width="150" height="150">' +
        '</div><div style="font-size:11px;color:var(--text-secondary);margin-top:8px">' + escHtml(text) + '</div></div>';
}

// ===== Camera Widget =====
async function renderCameraWidget() {
    let html = '<div class="widget">';
    html += '<div class="widget-header"><span class="icon">&#128247;</span><span class="widget-title">Werkstatt-Kamera</span></div>';
    html += '<div id="camera-feed" style="text-align:center;padding:16px">';
    html += '<div style="color:var(--text-secondary);font-size:12px">Kamera-Feed wird ueber Home Assistant bereitgestellt.</div>';
    html += '<button class="action-btn secondary" style="margin-top:8px" onclick="takeCameraSnapshot()">Snapshot aufnehmen</button>';
    html += '</div></div>';
    return html;
}

async function takeCameraSnapshot() {
    showToast('Snapshot wird aufgenommen...');
    try {
        const res = await apiCall('scan-object', 'POST', { description: 'Werkstatt Snapshot', camera: 'werkstatt' });
        showToast('Snapshot aufgenommen');
    } catch (e) { showToast('Kamera nicht verfuegbar'); }
}

// ===== Wochenplan Widget =====
function renderWeekPlanWidget() {
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128197;</span><span class="widget-title">Diese Woche</span></div>';

    const activeProjects = projects.filter(p => p.status === 'in_arbeit' || p.status === 'diagnose');
    if (activeProjects.length === 0) {
        html += '<div style="font-size:12px;color:var(--text-secondary)">Keine aktiven Projekte.</div>';
    } else {
        html += '<div class="timeline">';
        activeProjects.slice(0, 5).forEach(p => {
            const steps = p.steps || [];
            const nextStep = steps.find(s => !s.done && !s.completed);
            html += '<div class="timeline-item"><div class="timeline-dot active"></div>';
            html += '<div class="timeline-time">' + escHtml(p.title || p.id) + '</div>';
            html += '<div class="timeline-text">' + (nextStep ? escHtml(nextStep.title || nextStep.name || 'Naechster Schritt') : 'Alle Schritte erledigt') + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }
    html += '</div>';
    return html;
}

// ===== Schritt 5: Datei-Loeschung =====
async function deleteProjectFile(filename) {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt', 'error'); return; }
    if (!confirm('Datei "' + filename + '" wirklich loeschen?')) return;
    try {
        await apiCall('files/' + currentProject.id + '/' + encodeURIComponent(filename), 'DELETE');
        showToast(filename + ' geloescht', 'success');
        renderCodeView();
    } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
}

// ===== Schritt 6: Drag & Drop Sidebar =====
function initSidebarDragDrop() {
    const nav = document.querySelector('.sidebar-nav');
    if (!nav) return;
    const btns = nav.querySelectorAll('.nav-btn');
    btns.forEach(btn => {
        btn.setAttribute('draggable', 'true');
        btn.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', btn.dataset.view); btn.classList.add('dragging'); });
        btn.addEventListener('dragend', () => { btn.classList.remove('dragging'); nav.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('drag-over')); });
        btn.addEventListener('dragover', (e) => { e.preventDefault(); btn.classList.add('drag-over'); });
        btn.addEventListener('dragleave', () => btn.classList.remove('drag-over'));
        btn.addEventListener('drop', (e) => {
            e.preventDefault();
            btn.classList.remove('drag-over');
            const fromView = e.dataTransfer.getData('text/plain');
            const fromBtn = nav.querySelector('[data-view="' + fromView + '"]');
            if (fromBtn && fromBtn !== btn) {
                const parent = btn.parentNode;
                const rect = btn.getBoundingClientRect();
                const mid = rect.top + rect.height / 2;
                if (e.clientY < mid) parent.insertBefore(fromBtn, btn);
                else parent.insertBefore(fromBtn, btn.nextSibling);
                saveSidebarOrder();
            }
        });
    });
    restoreSidebarOrder();
}

function saveSidebarOrder() {
    const btns = document.querySelectorAll('.sidebar-nav .nav-btn');
    const order = [...btns].map(b => b.dataset.view).filter(Boolean);
    localStorage.setItem('ws-nav-order', JSON.stringify(order));
}

function restoreSidebarOrder() {
    const saved = localStorage.getItem('ws-nav-order');
    if (!saved) return;
    try {
        const order = JSON.parse(saved);
        const nav = document.querySelector('.sidebar-nav');
        order.forEach(view => {
            const btn = nav.querySelector('[data-view="' + view + '"]');
            if (btn) btn.parentNode.appendChild(btn);
        });
    } catch(e) {}
}

// ===== Schritt 8: Ambient Auto-Start =====
function resetAmbientIdle() {
    if (ambientIdleTimer) clearTimeout(ambientIdleTimer);
    if (localStorage.getItem('ws-ambient-auto') === 'on') {
        ambientIdleTimer = setTimeout(() => {
            if (typeof enterAmbientMode === 'function') enterAmbientMode();
        }, 5 * 60 * 1000);
    }
}
document.addEventListener('mousemove', resetAmbientIdle);
document.addEventListener('keydown', resetAmbientIdle);
document.addEventListener('touchstart', resetAmbientIdle);

// ===== Schritt 9: Projekt-Sicherheits-Checkliste =====
async function generateProjectSafetyChecklist() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt', 'error'); return; }
    showToast('Generiere Sicherheits-Checkliste...');
    try {
        const res = await apiCall('project/' + currentProject.id + '/safety-checklist');
        const items = res.checklist || res.items || [];
        if (items.length) {
            items.forEach((item, i) => {
                safetyChecks.push({ id: 'proj_' + i, label: item.text || item.label || item, category: item.category || 'werkstatt', checked: false });
            });
            showToast(items.length + ' Sicherheitspunkte hinzugefuegt', 'success');
            renderSafetyView();
        } else {
            showToast('Keine zusaetzlichen Sicherheitspunkte', 'error');
        }
    } catch (e) { showToast('Fehler: ' + e.message, 'error'); }
}

// ===== Schritt 10: Schaltplan-Editor =====
let schParts = [];
let schConnections = [];
let schSelectedPart = null;
let schMode = 'select';
let schDragging = null;

function renderSchematicEditorView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#9999;</span><span class="widget-title">Schaltplan-Editor</span></div>';

    // Palette
    html += '<div class="sch-palette">';
    const parts = [
        { type: 'resistor', label: 'Widerstand', icon: 'R' },
        { type: 'capacitor', label: 'Kondensator', icon: 'C' },
        { type: 'led', label: 'LED', icon: 'D' },
        { type: 'ic', label: 'IC', icon: 'U' },
        { type: 'wire', label: 'Kabel', icon: '' },
        { type: 'gnd', label: 'GND', icon: '' },
        { type: 'vcc', label: 'VCC', icon: '+' },
    ];
    parts.forEach(p => {
        html += '<button class="sch-part-btn' + (schMode === p.type ? ' active' : '') + '" onclick="schSetMode(\'' + p.type + '\')">' + p.icon + ' ' + p.label + '</button>';
    });
    html += '<button class="sch-part-btn' + (schMode === 'select' ? ' active' : '') + '" onclick="schSetMode(\'select\')">&#9995; Auswahl</button>';
    html += '</div>';

    // Canvas (SVG)
    html += '<svg class="sch-canvas" id="sch-svg" onmousedown="schMouseDown(event)" onmousemove="schMouseMove(event)" onmouseup="schMouseUp(event)">';
    // Grid
    html += '<defs><pattern id="sch-grid" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="0.5" fill="rgba(0,212,255,0.15)"/></pattern></defs>';
    html += '<rect width="100%" height="100%" fill="url(#sch-grid)"/>';
    // Parts
    schParts.forEach((p, i) => {
        const color = i === schSelectedPart ? 'var(--accent)' : 'var(--text-primary)';
        if (p.type === 'resistor') {
            html += '<g transform="translate(' + p.x + ',' + p.y + ')" data-idx="' + i + '"><rect x="-20" y="-6" width="40" height="12" fill="none" stroke="' + color + '" stroke-width="1.5" rx="1"/><text x="0" y="3" text-anchor="middle" fill="' + color + '" font-size="8" font-family="var(--mono)">R</text></g>';
        } else if (p.type === 'capacitor') {
            html += '<g transform="translate(' + p.x + ',' + p.y + ')" data-idx="' + i + '"><line x1="-3" y1="-10" x2="-3" y2="10" stroke="' + color + '" stroke-width="2"/><line x1="3" y1="-10" x2="3" y2="10" stroke="' + color + '" stroke-width="2"/><text x="0" y="20" text-anchor="middle" fill="' + color + '" font-size="8">C</text></g>';
        } else if (p.type === 'led') {
            html += '<g transform="translate(' + p.x + ',' + p.y + ')" data-idx="' + i + '"><polygon points="-8,-8 -8,8 8,0" fill="none" stroke="' + color + '" stroke-width="1.5"/><line x1="8" y1="-8" x2="8" y2="8" stroke="' + color + '" stroke-width="1.5"/><text x="0" y="18" text-anchor="middle" fill="' + color + '" font-size="8">LED</text></g>';
        } else if (p.type === 'ic') {
            html += '<g transform="translate(' + p.x + ',' + p.y + ')" data-idx="' + i + '"><rect x="-20" y="-15" width="40" height="30" fill="none" stroke="' + color + '" stroke-width="1.5"/><text x="0" y="4" text-anchor="middle" fill="' + color + '" font-size="9" font-family="var(--mono)">IC</text></g>';
        } else if (p.type === 'gnd') {
            html += '<g transform="translate(' + p.x + ',' + p.y + ')" data-idx="' + i + '"><line x1="0" y1="-8" x2="0" y2="0" stroke="' + color + '" stroke-width="1.5"/><line x1="-10" y1="0" x2="10" y2="0" stroke="' + color + '" stroke-width="1.5"/><line x1="-6" y1="4" x2="6" y2="4" stroke="' + color + '" stroke-width="1.5"/><line x1="-2" y1="8" x2="2" y2="8" stroke="' + color + '" stroke-width="1.5"/></g>';
        } else if (p.type === 'vcc') {
            html += '<g transform="translate(' + p.x + ',' + p.y + ')" data-idx="' + i + '"><line x1="0" y1="8" x2="0" y2="0" stroke="' + color + '" stroke-width="1.5"/><text x="0" y="-4" text-anchor="middle" fill="' + color + '" font-size="10" font-weight="bold">+</text></g>';
        }
    });
    // Connections
    schConnections.forEach(c => {
        html += '<line x1="' + c.x1 + '" y1="' + c.y1 + '" x2="' + c.x2 + '" y2="' + c.y2 + '" stroke="var(--accent)" stroke-width="1" opacity="0.6"/>';
    });
    html += '</svg>';

    // Actions
    html += '<div class="action-row" style="margin-top:8px">';
    html += '<button class="action-btn secondary" onclick="schClear()">Leeren</button>';
    html += '<button class="action-btn secondary" onclick="schExportSVG()">SVG Export</button>';
    html += '<button class="action-btn" onclick="schAnalyze()">An Jarvis senden</button>';
    if (schSelectedPart !== null) html += '<button class="action-btn danger" onclick="schDeleteSelected()">Loeschen</button>';
    html += '</div></div>';

    main.innerHTML = html;
}

function schSetMode(mode) { schMode = mode; renderSchematicEditorView(); }

function schMouseDown(e) {
    const svg = document.getElementById('sch-svg');
    const rect = svg.getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) / 20) * 20;
    const y = Math.round((e.clientY - rect.top) / 20) * 20;

    if (schMode === 'select') {
        schSelectedPart = null;
        schParts.forEach((p, i) => { if (Math.abs(p.x - x) < 25 && Math.abs(p.y - y) < 20) { schSelectedPart = i; schDragging = i; } });
        renderSchematicEditorView();
    } else if (schMode === 'wire') {
        schConnections.push({ x1: x, y1: y, x2: x, y2: y, drawing: true });
    } else {
        schParts.push({ type: schMode, x, y });
        playSound('click');
        renderSchematicEditorView();
    }
}

function schMouseMove(e) {
    if (schDragging !== null) {
        const svg = document.getElementById('sch-svg');
        const rect = svg.getBoundingClientRect();
        schParts[schDragging].x = Math.round((e.clientX - rect.left) / 20) * 20;
        schParts[schDragging].y = Math.round((e.clientY - rect.top) / 20) * 20;
        renderSchematicEditorView();
    }
    const active = schConnections.find(c => c.drawing);
    if (active) {
        const svg = document.getElementById('sch-svg');
        const rect = svg.getBoundingClientRect();
        active.x2 = Math.round((e.clientX - rect.left) / 20) * 20;
        active.y2 = Math.round((e.clientY - rect.top) / 20) * 20;
        renderSchematicEditorView();
    }
}

function schMouseUp(e) {
    schDragging = null;
    const active = schConnections.find(c => c.drawing);
    if (active) { delete active.drawing; playSound('click'); }
}

function schDeleteSelected() { if (schSelectedPart !== null) { schParts.splice(schSelectedPart, 1); schSelectedPart = null; renderSchematicEditorView(); } }
function schClear() { schParts = []; schConnections = []; schSelectedPart = null; renderSchematicEditorView(); }

function schExportSVG() {
    const svg = document.getElementById('sch-svg');
    const blob = new Blob([svg.outerHTML], { type: 'image/svg+xml' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'schaltplan.svg'; a.click();
    showToast('SVG exportiert', 'success');
}

async function schAnalyze() {
    const desc = schParts.map(p => p.type + ' bei (' + p.x + ',' + p.y + ')').join(', ');
    showToast('Sende Schaltplan an Jarvis...');
    try {
        const res = await chatApi('Analysiere diesen Schaltplan: ' + desc);
        showToast('Analyse abgeschlossen', 'success');
    } catch(e) { showToast('Analyse fehlgeschlagen', 'error'); }
}

// ===== Schritt 11: Galerie =====
let galleryFilter = 'all';
let galleryRatings = JSON.parse(localStorage.getItem('ws-gallery-ratings') || '{}');

function renderGalleryView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#127912;</span><span class="widget-title">Projekt-Galerie</span></div>';

    // Filter
    html += '<div class="gallery-filter">';
    ['all', 'abgeschlossen', 'in_arbeit', 'diagnose', 'pausiert'].forEach(f => {
        const label = f === 'all' ? 'Alle' : f.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
        html += '<button class="filter-chip' + (galleryFilter === f ? ' active' : '') + '" onclick="galleryFilter=\'' + f + '\';renderGalleryView()">' + label + '</button>';
    });
    html += '</div>';

    // Grid
    const filtered = galleryFilter === 'all' ? projects : projects.filter(p => p.status === galleryFilter);
    if (filtered.length) {
        html += '<div class="gallery-grid">';
        filtered.forEach(p => {
            const rating = galleryRatings[p.id] || 0;
            const statusIcons = { abgeschlossen: '&#10003;', in_arbeit: '&#9881;', diagnose: '&#128270;', pausiert: '&#10074;&#10074;' };
            html += '<div class="gallery-card" onclick="selectProject(\'' + p.id + '\')">';
            html += '<div class="gallery-thumb">' + (statusIcons[p.status] || '&#128268;') + '</div>';
            html += '<div class="gallery-info">';
            html += '<div class="gallery-title">' + escHtml(p.title || p.id) + '</div>';
            html += '<div class="gallery-meta">' + escHtml(p.status || '') + '</div>';
            html += '<div class="gallery-stars" onclick="event.stopPropagation()">';
            for (let s = 1; s <= 5; s++) {
                html += '<span style="cursor:pointer" onclick="setGalleryRating(\'' + p.id + '\',' + s + ')">' + (s <= rating ? '&#9733;' : '&#9734;') + '</span>';
            }
            html += '</div></div></div>';
        });
        html += '</div>';
    } else {
        html += emptyState('Keine Projekte', 'Erstelle ein neues Projekt um die Galerie zu fuellen.');
    }
    html += '</div>';

    main.innerHTML = html;
}

function setGalleryRating(projectId, stars) {
    galleryRatings[projectId] = stars;
    localStorage.setItem('ws-gallery-ratings', JSON.stringify(galleryRatings));
    renderGalleryView();
    playSound('success');
}

// ===== Schritt 12: Material-Rechner Tabs =====
// (Wird in renderCalcView als zusaetzliche Tabs integriert)

// ===== Schritt 13: Projekt-Vergleich =====
let compareA = null, compareB = null;

function renderCompareView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128260;</span><span class="widget-title">Projekt-Vergleich</span></div>';

    // Selektoren
    html += '<div style="display:flex;gap:12px;margin-bottom:16px">';
    html += '<div style="flex:1"><label style="font-size:10px;color:var(--text-secondary)">Projekt A</label>';
    html += '<select style="width:100%;padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px" onchange="compareA=this.value;renderCompareView()">';
    html += '<option value="">-- Waehlen --</option>';
    projects.forEach(p => { html += '<option value="' + p.id + '"' + (compareA === p.id ? ' selected' : '') + '>' + escHtml(p.title || p.id) + '</option>'; });
    html += '</select></div>';
    html += '<div style="flex:1"><label style="font-size:10px;color:var(--text-secondary)">Projekt B</label>';
    html += '<select style="width:100%;padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px" onchange="compareB=this.value;renderCompareView()">';
    html += '<option value="">-- Waehlen --</option>';
    projects.forEach(p => { html += '<option value="' + p.id + '"' + (compareB === p.id ? ' selected' : '') + '>' + escHtml(p.title || p.id) + '</option>'; });
    html += '</select></div></div>';

    if (compareA && compareB) {
        const pA = projects.find(p => p.id === compareA);
        const pB = projects.find(p => p.id === compareB);
        if (pA && pB) {
            html += '<div class="compare-grid">';
            // Column A
            html += '<div class="compare-col"><h4>' + escHtml(pA.title || pA.id) + '</h4>';
            html += '<div class="compare-row"><span class="compare-label">Status</span><span class="compare-val">' + escHtml(pA.status || '-') + '</span></div>';
            html += '<div class="compare-row"><span class="compare-label">Schritte</span><span class="compare-val">' + (pA.steps?.length || 0) + '</span></div>';
            html += '<div class="compare-row"><span class="compare-label">Teile</span><span class="compare-val">' + (pA.parts?.length || 0) + '</span></div>';
            html += '<div class="compare-row"><span class="compare-label">Budget</span><span class="compare-val">' + (pA.budget || '-') + '</span></div>';
            const partsA = (pA.parts || []).map(p => p.name || p);
            partsA.forEach(name => {
                const inB = (pB.parts || []).some(p => (p.name || p) === name);
                html += '<div class="' + (inB ? 'compare-common' : 'compare-unique') + '">' + escHtml(name) + '</div>';
            });
            html += '</div>';
            // Column B
            html += '<div class="compare-col"><h4>' + escHtml(pB.title || pB.id) + '</h4>';
            html += '<div class="compare-row"><span class="compare-label">Status</span><span class="compare-val">' + escHtml(pB.status || '-') + '</span></div>';
            html += '<div class="compare-row"><span class="compare-label">Schritte</span><span class="compare-val">' + (pB.steps?.length || 0) + '</span></div>';
            html += '<div class="compare-row"><span class="compare-label">Teile</span><span class="compare-val">' + (pB.parts?.length || 0) + '</span></div>';
            html += '<div class="compare-row"><span class="compare-label">Budget</span><span class="compare-val">' + (pB.budget || '-') + '</span></div>';
            const partsB = (pB.parts || []).map(p => p.name || p);
            partsB.forEach(name => {
                const inA = partsA.includes(name);
                html += '<div class="' + (inA ? 'compare-common' : 'compare-unique') + '">' + escHtml(name) + '</div>';
            });
            html += '</div></div>';
            // Legend
            html += '<div style="margin-top:12px;font-size:10px;display:flex;gap:16px">';
            html += '<span><span style="display:inline-block;width:8px;height:8px;background:var(--success);border-radius:2px;margin-right:4px"></span>Gemeinsam</span>';
            html += '<span><span style="display:inline-block;width:8px;height:8px;background:var(--accent);border-radius:2px;margin-right:4px"></span>Einzigartig</span>';
            html += '</div>';
        }
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px;text-align:center;padding:20px">Waehle zwei Projekte zum Vergleichen.</div>';
    }
    html += '</div>';
    main.innerHTML = html;
}

// ===== Schritt 14: Wiki / Wissensdatenbank =====
let wikiEntries = JSON.parse(localStorage.getItem('ws-wiki') || '[]');
let wikiSearch = '';

function renderWikiView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128218;</span><span class="widget-title">Wissensdatenbank</span></div>';

    html += '<div class="action-row" style="margin-bottom:12px">';
    html += '<button class="action-btn" onclick="showWikiAddDialog()">+ Eintrag</button>';
    html += '<button class="action-btn secondary" onclick="wikiGenerateFromProjects()">Aus Projekten generieren</button>';
    html += '</div>';

    html += '<input class="wiki-search" placeholder="Suchen..." value="' + escHtml(wikiSearch) + '" oninput="wikiSearch=this.value;renderWikiView()">';

    const filtered = wikiSearch ? wikiEntries.filter(e =>
        (e.title || '').toLowerCase().includes(wikiSearch.toLowerCase()) ||
        (e.content || '').toLowerCase().includes(wikiSearch.toLowerCase()) ||
        (e.tags || []).some(t => t.toLowerCase().includes(wikiSearch.toLowerCase()))
    ) : wikiEntries;

    if (filtered.length) {
        html += '<div class="wiki-grid">';
        filtered.forEach((entry, idx) => {
            html += '<div class="wiki-entry" onclick="showWikiEntry(' + idx + ')">';
            html += '<div class="wiki-title">' + escHtml(entry.title) + '</div>';
            html += '<div class="wiki-excerpt">' + escHtml((entry.content || '').substring(0, 120)) + '...</div>';
            html += '<div class="wiki-tags">';
            (entry.tags || []).forEach(t => { html += '<span class="wiki-tag">' + escHtml(t) + '</span>'; });
            html += '</div></div>';
        });
        html += '</div>';
    } else {
        html += emptyState('Keine Eintraege', 'Erstelle Eintraege oder generiere sie aus abgeschlossenen Projekten.');
    }
    html += '</div>';
    main.innerHTML = html;
}

function showWikiEntry(idx) {
    const entry = wikiEntries[idx];
    if (!entry) return;
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal" style="max-width:600px"><h3>' + escHtml(entry.title) + '</h3>' +
        '<div style="font-size:12px;color:var(--text-primary);line-height:1.8;white-space:pre-wrap;max-height:400px;overflow-y:auto">' + escHtml(entry.content) + '</div>' +
        '<div style="margin-top:8px">' + (entry.tags || []).map(t => '<span class="wiki-tag">' + escHtml(t) + '</span>').join(' ') + '</div>' +
        '<div class="modal-btns"><button onclick="wikiDeleteEntry(' + idx + ')">Loeschen</button>' +
        '<button class="btn-primary" onclick="document.getElementById(\'new-project-modal\').classList.add(\'hidden\');resetProjectModal()">Schliessen</button></div></div>';
    overlay.classList.remove('hidden');
}

function showWikiAddDialog() {
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Wiki-Eintrag</h3>' +
        '<label>Titel *</label><input id="wiki-title" type="text" placeholder="z.B. ESP32 Deep Sleep">' +
        '<label>Inhalt *</label><textarea id="wiki-content" style="width:100%;min-height:100px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-size:12px;resize:vertical" placeholder="Beschreibe die Loesung..."></textarea>' +
        '<label>Tags (kommasepariert)</label><input id="wiki-tags" type="text" placeholder="z.B. ESP32, Sleep, Strom">' +
        '<div class="modal-btns"><button onclick="document.getElementById(\'new-project-modal\').classList.add(\'hidden\');resetProjectModal()">Abbrechen</button>' +
        '<button class="btn-primary" onclick="doAddWiki()">Speichern</button></div></div>';
    overlay.classList.remove('hidden');
}

function doAddWiki() {
    const title = document.getElementById('wiki-title')?.value.trim();
    const content = document.getElementById('wiki-content')?.value.trim();
    const tags = (document.getElementById('wiki-tags')?.value || '').split(',').map(t => t.trim()).filter(Boolean);
    if (!title || !content) { showToast('Titel und Inhalt benoetigt', 'error'); return; }
    wikiEntries.unshift({ title, content, tags, date: new Date().toISOString() });
    localStorage.setItem('ws-wiki', JSON.stringify(wikiEntries));
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
    showToast('Wiki-Eintrag gespeichert', 'success');
    renderWikiView();
}

function wikiDeleteEntry(idx) {
    if (!confirm('Eintrag loeschen?')) return;
    wikiEntries.splice(idx, 1);
    localStorage.setItem('ws-wiki', JSON.stringify(wikiEntries));
    document.getElementById('new-project-modal').classList.add('hidden');
    resetProjectModal();
    renderWikiView();
}

function wikiGenerateFromProjects() {
    const completed = projects.filter(p => p.status === 'abgeschlossen');
    if (!completed.length) { showToast('Keine abgeschlossenen Projekte', 'error'); return; }
    let added = 0;
    completed.forEach(p => {
        if (wikiEntries.some(e => e.title === p.title)) return;
        const steps = (p.steps || []).map(s => s.title || s.name || '').filter(Boolean).join('\n- ');
        const parts = (p.parts || []).map(pt => pt.name || pt).filter(Boolean).join(', ');
        wikiEntries.unshift({
            title: p.title || p.id,
            content: 'Projekt: ' + (p.title || p.id) + '\nSchritte:\n- ' + steps + '\nTeile: ' + parts,
            tags: ['projekt', p.status, ...(p.tags || [])],
            date: new Date().toISOString()
        });
        added++;
    });
    if (added) {
        localStorage.setItem('ws-wiki', JSON.stringify(wikiEntries));
        showToast(added + ' Eintraege generiert', 'success');
        renderWikiView();
    } else {
        showToast('Alle Projekte bereits im Wiki');
    }
}

// ===== Schritt 16: Zeiterfassung =====
let timeTracking = JSON.parse(localStorage.getItem('ws-timetracking') || '{}');
let timeTrackingActive = null;
let timeTrackingStart = null;

function renderTimeTrackView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128336;</span><span class="widget-title">Projekt-Zeiterfassung</span></div>';

    // Active tracking
    if (timeTrackingActive) {
        const elapsed = Math.floor((Date.now() - timeTrackingStart) / 1000);
        const mm = Math.floor(elapsed / 60);
        const ss = elapsed % 60;
        html += '<div style="text-align:center;padding:16px;background:var(--accent-dim);border-radius:6px;margin-bottom:12px">';
        html += '<div style="font-size:11px;color:var(--text-secondary)">Aktiv: ' + escHtml(timeTrackingActive) + '</div>';
        html += '<div style="font-size:32px;font-family:var(--mono);color:var(--accent);margin:8px 0">' + String(mm).padStart(2,'0') + ':' + String(ss).padStart(2,'0') + '</div>';
        html += '<button class="time-tracking-btn stop" onclick="stopTimeTracking()">&#9632; Stoppen</button>';
        html += '</div>';
    } else {
        html += '<div style="text-align:center;padding:16px;margin-bottom:12px">';
        html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Projekt auswaehlen und Zeitmessung starten</div>';
        html += '<select id="tt-project" style="padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:8px">';
        projects.forEach(p => { html += '<option value="' + escHtml(p.id) + '">' + escHtml(p.title || p.id) + '</option>'; });
        html += '</select><br>';
        html += '<button class="time-tracking-btn start" onclick="startTimeTracking()">&#9654; Starten</button>';
        html += '</div>';
    }

    // Weekly chart
    html += '<h4 style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px">Diese Woche</h4>';
    const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    const today = new Date();
    const dayOfWeek = (today.getDay() + 6) % 7;
    let maxMin = 1;
    const weekData = days.map((d, i) => {
        const date = new Date(today);
        date.setDate(today.getDate() - dayOfWeek + i);
        const key = date.toISOString().split('T')[0];
        let total = 0;
        Object.values(timeTracking).forEach(sessions => {
            (sessions || []).forEach(s => { if (s.date === key) total += s.minutes || 0; });
        });
        if (total > maxMin) maxMin = total;
        return { day: d, minutes: total, isToday: i === dayOfWeek };
    });
    html += '<div class="time-bar-chart">';
    weekData.forEach(d => {
        const h = d.minutes > 0 ? Math.max(10, (d.minutes / maxMin) * 100) : 4;
        html += '<div class="time-bar" style="height:' + h + '%;' + (d.isToday ? 'background:var(--warning)' : '') + '">';
        html += '<span class="time-bar-value">' + (d.minutes > 0 ? d.minutes + 'm' : '') + '</span>';
        html += '<span class="time-bar-label">' + d.day + '</span>';
        html += '</div>';
    });
    html += '</div>';

    // Per-project totals
    html += '<h4 style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin:32px 0 8px">Pro Projekt</h4>';
    const totals = {};
    Object.entries(timeTracking).forEach(([pid, sessions]) => {
        totals[pid] = (sessions || []).reduce((sum, s) => sum + (s.minutes || 0), 0);
    });
    const sorted = Object.entries(totals).sort((a,b) => b[1] - a[1]);
    if (sorted.length) {
        sorted.forEach(([pid, mins]) => {
            const proj = projects.find(p => p.id === pid);
            const hrs = Math.floor(mins / 60);
            const rm = mins % 60;
            html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">';
            html += '<span>' + escHtml(proj ? (proj.title || pid) : pid) + '</span>';
            html += '<span style="color:var(--accent);font-family:var(--mono)">' + hrs + 'h ' + rm + 'm</span></div>';
        });
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px">Noch keine Zeiten erfasst.</div>';
    }
    html += '</div>';
    main.innerHTML = html;
}

function startTimeTracking() {
    const sel = document.getElementById('tt-project');
    if (!sel || !sel.value) return;
    timeTrackingActive = sel.value;
    timeTrackingStart = Date.now();
    renderTimeTrackView();
    // Update every second
    if (window._ttInterval) clearInterval(window._ttInterval);
    window._ttInterval = setInterval(() => { if (currentView === 'timetrack') renderTimeTrackView(); }, 1000);
    playSound('success');
}

function stopTimeTracking() {
    if (!timeTrackingActive || !timeTrackingStart) return;
    const elapsed = Math.floor((Date.now() - timeTrackingStart) / 60000);
    const key = new Date().toISOString().split('T')[0];
    if (!timeTracking[timeTrackingActive]) timeTracking[timeTrackingActive] = [];
    timeTracking[timeTrackingActive].push({ date: key, minutes: Math.max(1, elapsed) });
    localStorage.setItem('ws-timetracking', JSON.stringify(timeTracking));
    if (window._ttInterval) clearInterval(window._ttInterval);
    showToast(elapsed + ' Minuten erfasst', 'success');
    timeTrackingActive = null;
    timeTrackingStart = null;
    renderTimeTrackView();
}

// ===== Schritt 17: MQTT Live-Monitor =====
let mqttMessages = [];
let mqttFilter = '';
let mqttWs = null;

function renderMqttView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128225;</span><span class="widget-title">MQTT Live-Monitor</span></div>';

    // Connection & Filter
    html += '<div style="display:flex;gap:8px;margin-bottom:12px">';
    html += '<input class="wiki-search" style="margin-bottom:0;flex:1" placeholder="Topic-Filter..." value="' + escHtml(mqttFilter) + '" oninput="mqttFilter=this.value;renderMqttView()">';
    html += '<button class="action-btn secondary" onclick="mqttClear()">Leeren</button>';
    html += '</div>';

    // Publish
    html += '<div style="display:flex;gap:8px;margin-bottom:12px">';
    html += '<input id="mqtt-pub-topic" class="wiki-search" style="margin-bottom:0;flex:1" placeholder="Topic...">';
    html += '<input id="mqtt-pub-payload" class="wiki-search" style="margin-bottom:0;flex:1" placeholder="Payload...">';
    html += '<button class="action-btn" onclick="mqttPublish()">Senden</button>';
    html += '</div>';

    // Feed
    const filtered = mqttFilter ? mqttMessages.filter(m => m.topic.includes(mqttFilter)) : mqttMessages;
    html += '<div class="mqtt-feed">';
    if (filtered.length) {
        filtered.slice(-100).reverse().forEach(m => {
            html += '<div class="mqtt-msg">';
            html += '<span class="mqtt-time">' + m.time + '</span>';
            html += '<span class="mqtt-topic">' + escHtml(m.topic) + '</span>';
            html += '<span class="mqtt-payload">' + escHtml(m.payload) + '</span>';
            html += '</div>';
        });
    } else {
        html += '<div style="color:var(--text-secondary);font-size:12px;text-align:center;padding:20px">Keine MQTT-Nachrichten.' +
            (mqttFilter ? ' Filter: "' + escHtml(mqttFilter) + '"' : '') + '</div>';
    }
    html += '</div></div>';

    // Sparklines for numeric topics
    const numericTopics = {};
    mqttMessages.forEach(m => {
        const val = parseFloat(m.payload);
        if (!isNaN(val)) {
            if (!numericTopics[m.topic]) numericTopics[m.topic] = [];
            numericTopics[m.topic].push(val);
        }
    });
    const topicKeys = Object.keys(numericTopics);
    if (topicKeys.length) {
        html += '<div class="widget"><div class="widget-header"><span class="icon">&#128200;</span><span class="widget-title">Werte-Historie</span></div>';
        topicKeys.slice(0, 6).forEach(topic => {
            const vals = numericTopics[topic].slice(-20);
            html += '<div style="margin-bottom:8px"><div style="font-size:10px;color:var(--text-secondary);margin-bottom:2px">' + escHtml(topic) + '</div>';
            html += svgSparkline(vals, 200, 30);
            html += '</div>';
        });
        html += '</div>';
    }

    main.innerHTML = html;
}

function mqttClear() { mqttMessages = []; renderMqttView(); }

async function mqttPublish() {
    const topic = document.getElementById('mqtt-pub-topic')?.value.trim();
    const payload = document.getElementById('mqtt-pub-payload')?.value.trim();
    if (!topic) { showToast('Topic benoetigt', 'error'); return; }
    try {
        await apiCall('notify', 'POST', { message: payload, title: topic, type: 'mqtt' });
        mqttMessages.push({ topic, payload: payload || '', time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) });
        showToast('MQTT gesendet', 'success');
        renderMqttView();
    } catch(e) { showToast('Senden fehlgeschlagen', 'error'); }
}

// ===== Schritt 18: Multimeter-Assistent =====
let meterType = 'voltage';

function renderMultimeterView(main) {
    if (!main) main = document.getElementById('main-content');
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#128270;</span><span class="widget-title">Multimeter-Assistent</span></div>';

    // Type selector
    html += '<div class="tab-bar" style="margin-bottom:16px">';
    const types = [
        { id: 'voltage', label: 'Spannung', icon: 'V' },
        { id: 'current', label: 'Strom', icon: 'A' },
        { id: 'resistance', label: 'Widerstand', icon: '\u03A9' },
        { id: 'continuity', label: 'Durchgang', icon: '\u223F' },
        { id: 'capacitance', label: 'Kapazitaet', icon: 'F' },
    ];
    types.forEach(t => {
        html += '<button class="tab-btn' + (meterType === t.id ? ' active' : '') + '" onclick="meterType=\'' + t.id + '\';renderMultimeterView()">' + t.icon + ' ' + t.label + '</button>';
    });
    html += '</div>';

    // Instructions
    const instructions = {
        voltage: [
            { title: 'Messbereich waehlen', desc: 'Drehschalter auf V~ (Wechselspannung) oder V (Gleichspannung) stellen. Im Zweifel mit dem hoechsten Bereich beginnen.' },
            { title: 'Messleitungen anschliessen', desc: 'Schwarze Leitung in COM-Buchse, rote Leitung in V/\u03A9-Buchse stecken.' },
            { title: 'Parallel messen', desc: 'Messspitzen PARALLEL zum Bauteil anlegen. Nie in Reihe bei Spannungsmessung!' },
            { title: 'Wert ablesen', desc: 'Display ablesen. Bei Gleichspannung zeigt Minus-Vorzeichen umgekehrte Polaritaet an.' },
        ],
        current: [
            { title: 'Messbereich waehlen', desc: 'Drehschalter auf A~ oder A stellen. ACHTUNG: Immer mit dem hoechsten Bereich starten!' },
            { title: 'Messleitungen anschliessen', desc: 'Schwarze Leitung in COM, rote Leitung in mA (oder 10A bei hohen Stroemen) Buchse.' },
            { title: 'Schaltung unterbrechen', desc: 'Den Stromkreis UNTERBRECHEN und Multimeter IN REIHE einschleifen.' },
            { title: 'Wert ablesen', desc: 'Strom fliesst jetzt durch das Multimeter. Wert ablesen, danach Schaltung wiederherstellen.' },
        ],
        resistance: [
            { title: 'Bauteil stromfrei machen', desc: 'WICHTIG: Bauteil oder Schaltung MUSS stromfrei sein! Spannung kann Multimeter beschaedigen.' },
            { title: 'Messbereich waehlen', desc: 'Drehschalter auf \u03A9 stellen. Auto-Range waehlt automatisch.' },
            { title: 'Messleitungen anlegen', desc: 'Messspitzen an die beiden Enden des Bauteils halten.' },
            { title: 'Wert ablesen', desc: 'Widerstandswert in Ohm ablesen. OL = Leitung unterbrochen / Wert zu hoch.' },
        ],
        continuity: [
            { title: 'Durchgangsmodus waehlen', desc: 'Drehschalter auf das Durchgangs-Symbol (Schallwelle/Diode) stellen.' },
            { title: 'Schaltung stromfrei machen', desc: 'Schaltung MUSS stromfrei sein fuer korrekte Messung.' },
            { title: 'Messspitzen anlegen', desc: 'An die beiden zu pruefenden Punkte halten. Piepston = Durchgang vorhanden.' },
            { title: 'Ergebnis interpretieren', desc: 'Piep = verbunden (< ~50\u03A9). Kein Piep = unterbrochen. Ideal fuer Kabel- und Loetstellentest.' },
        ],
        capacitance: [
            { title: 'Kondensator entladen', desc: 'WICHTIG: Kondensator vorher entladen! Geladene Elkos koennen gefaehrlich sein.' },
            { title: 'Kapazitaetsmodus waehlen', desc: 'Drehschalter auf F (Farad) stellen, falls vorhanden.' },
            { title: 'Messleitungen anlegen', desc: 'Messspitzen an die Anschluesse des Kondensators halten. Polaritaet bei Elkos beachten.' },
            { title: 'Wert ablesen', desc: 'Kapazitaet in pF, nF oder \u00B5F ablesen. Vergleiche mit aufgedrucktem Wert.' },
        ],
    };

    html += '<div class="meter-steps">';
    (instructions[meterType] || []).forEach(step => {
        html += '<div class="meter-step"><div class="meter-step-content">';
        html += '<div class="meter-step-title">' + step.title + '</div>';
        html += '<div class="meter-step-desc">' + step.desc + '</div>';
        html += '</div></div>';
    });
    html += '</div>';

    // Quick evaluate
    html += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">';
    html += '<div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Messwert bewerten</div>';
    html += '<div style="display:flex;gap:8px">';
    html += '<input id="meter-value" type="number" step="any" placeholder="Messwert" style="flex:1;padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px">';
    html += '<select id="meter-unit" style="padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px">';
    html += '<option value="V">Volt</option><option value="mA">mA</option><option value="A">Ampere</option><option value="ohm">Ohm</option><option value="kOhm">k\u03A9</option><option value="uF">\u00B5F</option></select>';
    html += '<button class="action-btn" onclick="evaluateMeterValue()">Bewerten</button>';
    html += '</div>';
    html += '<div id="meter-result" style="margin-top:8px;font-size:12px;color:var(--text-secondary)"></div>';
    html += '</div>';

    html += '</div>';
    main.innerHTML = html;
}

async function evaluateMeterValue() {
    const val = document.getElementById('meter-value')?.value;
    const unit = document.getElementById('meter-unit')?.value;
    if (!val) { showToast('Messwert eingeben', 'error'); return; }
    const resultEl = document.getElementById('meter-result');
    resultEl.innerHTML = '<div class="gen-loading"><div class="gen-loading-bar"></div></div>';
    try {
        const res = await chatApi('Bewerte diesen Messwert im Kontext einer Elektronik-Werkstatt: ' + val + ' ' + unit + '. Ist das normal? Worauf deutet es hin?');
        resultEl.innerHTML = '<div style="background:var(--bg-card);padding:8px;border-radius:4px;border:1px solid var(--border)">' + escHtml(res.response || res.text || JSON.stringify(res)) + '</div>';
    } catch(e) { resultEl.innerHTML = '<div style="color:var(--danger)">Bewertung fehlgeschlagen</div>'; }
}

// ===== Schritt 19: Import/Export =====
function exportAllProjects() {
    const data = {
        projects: projects,
        wiki: wikiEntries,
        timeTracking: timeTracking,
        galleryRatings: galleryRatings,
        schematic: { parts: schParts, connections: schConnections },
        exportDate: new Date().toISOString(),
        version: '3.0'
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'workshop_backup_' + new Date().toISOString().split('T')[0] + '.json'; a.click();
    showToast('Backup exportiert', 'success');
}

function importProjects() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            if (data.wiki) { wikiEntries = data.wiki; localStorage.setItem('ws-wiki', JSON.stringify(wikiEntries)); }
            if (data.timeTracking) { timeTracking = data.timeTracking; localStorage.setItem('ws-timetracking', JSON.stringify(timeTracking)); }
            if (data.galleryRatings) { galleryRatings = data.galleryRatings; localStorage.setItem('ws-gallery-ratings', JSON.stringify(galleryRatings)); }
            if (data.projects && data.projects.length) {
                for (const p of data.projects) {
                    try { await apiCall('projects', 'POST', p); } catch(e) {}
                }
                await loadProjects();
            }
            showToast('Import abgeschlossen', 'success');
            renderView();
        } catch(e) { showToast('Import fehlgeschlagen: ' + e.message, 'error'); }
    };
    input.click();
}

function exportProjectQR() {
    if (!currentProject) { showToast('Kein Projekt ausgewaehlt', 'error'); return; }
    const overlay = document.getElementById('new-project-modal');
    overlay.innerHTML = '<div class="modal"><h3>Projekt-QR: ' + escHtml(currentProject.title || currentProject.id) + '</h3>' +
        generateQR(JSON.stringify({ id: currentProject.id, title: currentProject.title })) +
        '<div class="modal-btns"><button onclick="document.getElementById(\'new-project-modal\').classList.add(\'hidden\');resetProjectModal()">Schliessen</button></div></div>';
    overlay.classList.remove('hidden');
}

// ===== Schritt 20: Gamification =====
let xpData = JSON.parse(localStorage.getItem('ws-xp') || '{"xp":0,"level":1,"badges":[]}');

const allBadges = [
    { id: 'first_project', name: 'Erstling', icon: '&#127775;', desc: 'Erstes Projekt erstellt', check: () => projects.length >= 1 },
    { id: 'five_projects', name: 'Sammler', icon: '&#128230;', desc: '5 Projekte erstellt', check: () => projects.length >= 5 },
    { id: 'ten_projects', name: 'Meister', icon: '&#127942;', desc: '10 Projekte erstellt', check: () => projects.length >= 10 },
    { id: 'first_complete', name: 'Abschluss', icon: '&#10003;', desc: 'Erstes Projekt abgeschlossen', check: () => projects.some(p => p.status === 'abgeschlossen') },
    { id: 'wiki_author', name: 'Autor', icon: '&#128218;', desc: 'Wiki-Eintrag erstellt', check: () => wikiEntries.length >= 1 },
    { id: 'time_tracker', name: 'Zeitjockey', icon: '&#128336;', desc: '1 Stunde erfasst', check: () => Object.values(timeTracking).flat().reduce((s,e) => s + (e.minutes||0), 0) >= 60 },
    { id: 'night_owl', name: 'Nachteule', icon: '&#127769;', desc: 'Um Mitternacht aktiv', check: () => new Date().getHours() >= 0 && new Date().getHours() < 4 },
    { id: 'schematic_pro', name: 'Schaltmeister', icon: '&#9999;', desc: 'Schaltplan mit 5+ Teilen', check: () => schParts.length >= 5 },
    { id: 'safety_first', name: 'Sicherheit!', icon: '&#9888;', desc: 'Alle Sicherheitschecks bestanden', check: () => typeof safetyChecks !== 'undefined' && safetyChecks.length > 0 && safetyChecks.every(c => c.checked) },
    { id: 'gallery_star', name: 'Kritiker', icon: '&#9733;', desc: '5 Projekte bewertet', check: () => Object.keys(galleryRatings).length >= 5 },
];

function checkBadges() {
    let newBadges = false;
    allBadges.forEach(b => {
        if (!xpData.badges.includes(b.id) && b.check()) {
            xpData.badges.push(b.id);
            xpData.xp += 50;
            newBadges = true;
        }
    });
    xpData.level = Math.floor(xpData.xp / 100) + 1;
    if (newBadges) {
        localStorage.setItem('ws-xp', JSON.stringify(xpData));
        showToast('Neues Badge freigeschaltet!', 'success');
    }
}

function addXP(amount) {
    xpData.xp += amount;
    xpData.level = Math.floor(xpData.xp / 100) + 1;
    localStorage.setItem('ws-xp', JSON.stringify(xpData));
}

function renderGamificationView(main) {
    if (!main) main = document.getElementById('main-content');
    checkBadges();
    let html = '<div class="widget hud-corners">';
    html += '<div class="widget-header"><span class="icon">&#127942;</span><span class="widget-title">Erfolge & Level</span></div>';

    // Level & XP
    html += '<div style="text-align:center;margin-bottom:20px">';
    html += '<div class="level-badge">Level ' + xpData.level + '</div>';
    html += '<div style="font-size:24px;font-family:var(--mono);color:var(--accent);margin:8px 0">' + xpData.xp + ' XP</div>';
    const nextLevel = xpData.level * 100;
    const progress = ((xpData.xp % 100) / 100) * 100;
    html += '<div style="max-width:300px;margin:0 auto">';
    html += '<div class="xp-bar"><div class="xp-fill" style="width:' + progress + '%"></div></div>';
    html += '<div style="font-size:10px;color:var(--text-secondary)">' + (xpData.xp % 100) + ' / 100 XP zum naechsten Level</div>';
    html += '</div></div>';

    // Badges
    html += '<h4 style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Badges (' + xpData.badges.length + '/' + allBadges.length + ')</h4>';
    html += '<div class="badge-grid">';
    allBadges.forEach(b => {
        const earned = xpData.badges.includes(b.id);
        html += '<div class="badge-card ' + (earned ? 'earned' : 'locked') + '">';
        html += '<div class="badge-icon">' + b.icon + '</div>';
        html += '<div class="badge-name">' + b.name + '</div>';
        html += '<div class="badge-desc">' + b.desc + '</div>';
        html += '</div>';
    });
    html += '</div>';

    // Stats
    html += '<h4 style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin:20px 0 8px">Statistiken</h4>';
    const stats = [
        { label: 'Projekte gesamt', val: projects.length },
        { label: 'Abgeschlossen', val: projects.filter(p => p.status === 'abgeschlossen').length },
        { label: 'Wiki-Eintraege', val: wikiEntries.length },
        { label: 'Stunden erfasst', val: Math.floor(Object.values(timeTracking).flat().reduce((s,e) => s + (e.minutes||0), 0) / 60) },
        { label: 'Schaltplan-Teile', val: schParts.length },
    ];
    stats.forEach(s => {
        html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">';
        html += '<span style="color:var(--text-secondary)">' + s.label + '</span>';
        html += '<span style="color:var(--accent);font-weight:600;font-family:var(--mono)">' + s.val + '</span></div>';
    });

    html += '</div>';

    // Jarvis Zitat
    const quotes = [
        'Guten Tag, Sir. Darf ich Ihnen bei etwas behilflich sein?',
        'Die Werkstatt ist bereit. Alle Systeme laufen nominal.',
        'Soll ich die Kaffeemaschine aktivieren, Sir?',
        'Ich habe alle Analysen vorbereitet. Sie muessen nur noch entscheiden.',
        'Die Schaltplaene sehen vielversprechend aus, wenn ich das sagen darf.',
        'Ihre Sicherheitschecks sind noch nicht abgeschlossen, Sir.',
        'Manchmal frage ich mich, ob Sie auch schlafen, Sir.',
        'Ich habe eine Optimierung fuer Ihr letztes Projekt gefunden.',
    ];
    html += '<div class="widget" style="text-align:center;font-style:italic">';
    html += '<div style="font-size:12px;color:var(--text-secondary)">"' + quotes[Math.floor(Math.random() * quotes.length)] + '"</div>';
    html += '<div style="font-size:10px;color:var(--text-muted);margin-top:4px"> J.A.R.V.I.S.</div>';
    html += '</div>';

    main.innerHTML = html;
}

// ===== Konami Code Easter Egg =====
let konamiPos = 0;
const konamiCode = [38,38,40,40,37,39,37,39,66,65];
document.addEventListener('keydown', (e) => {
    if (e.keyCode === konamiCode[konamiPos]) {
        konamiPos++;
        if (konamiPos === konamiCode.length) {
            konamiPos = 0;
            document.body.style.animation = 'none';
            document.body.offsetHeight;
            document.body.style.animation = 'konamiFlash 0.5s ease 3';
            addXP(100);
            showToast('Easter Egg! +100 XP', 'success');
        }
    } else { konamiPos = 0; }
});

// ===== Settings Erweiterung: Import/Export + Ambient-Auto =====
// (Wird in renderSettingsView integriert)

// ===== Schritt 12: Material-Rechner Tabs =====
function renderWoodCalcTab() {
    let html = '<div style="padding:12px">';
    html += '<div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Holz-Rechner</div>';
    html += '<div class="calc-form">';
    html += '<label>Laenge (cm)</label><input id="wood-l" type="number" step="any" placeholder="100">';
    html += '<label>Breite (cm)</label><input id="wood-w" type="number" step="any" placeholder="20">';
    html += '<label>Dicke (cm)</label><input id="wood-d" type="number" step="any" placeholder="2">';
    html += '<label>Holzart</label><select id="wood-type" style="width:100%;padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px">';
    html += '<option value="0.5">Fichte (0.5 g/cm3)</option><option value="0.6">Kiefer (0.6 g/cm3)</option><option value="0.65">Buche (0.65 g/cm3)</option>';
    html += '<option value="0.7">Eiche (0.7 g/cm3)</option><option value="0.45">Pappel (0.45 g/cm3)</option><option value="0.4">Balsa (0.4 g/cm3)</option></select>';
    html += '<label>Preis pro m3 (EUR)</label><input id="wood-price" type="number" step="any" value="400">';
    html += '<button class="step-btn" style="margin-top:8px" onclick="calcWood()">Berechnen</button>';
    html += '</div><div id="wood-result" class="calc-result"></div></div>';
    return html;
}

function calcWood() {
    const l = parseFloat(document.getElementById('wood-l')?.value || 0);
    const w = parseFloat(document.getElementById('wood-w')?.value || 0);
    const d = parseFloat(document.getElementById('wood-d')?.value || 0);
    const density = parseFloat(document.getElementById('wood-type')?.value || 0.5);
    const price = parseFloat(document.getElementById('wood-price')?.value || 0);
    const volCm3 = l * w * d;
    const volM3 = volCm3 / 1000000;
    const weightKg = (volCm3 * density) / 1000;
    const cost = volM3 * price;
    document.getElementById('wood-result').innerHTML =
        '<div style="font-size:12px;color:var(--text-primary)">' +
        '<div>Volumen: <b>' + volCm3.toFixed(1) + ' cm3</b> (' + (volM3 * 1000).toFixed(3) + ' dm3)</div>' +
        '<div>Gewicht: <b>' + weightKg.toFixed(2) + ' kg</b></div>' +
        '<div>Kosten: <b>' + cost.toFixed(2) + ' EUR</b></div></div>';
}

function render3DPrintCalcTab() {
    let html = '<div style="padding:12px">';
    html += '<div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">3D-Druck Kosten</div>';
    html += '<div class="calc-form">';
    html += '<label>Geschaetztes Volumen (cm3)</label><input id="print-vol" type="number" step="any" placeholder="25">';
    html += '<label>Fuellgrad (%)</label><input id="print-infill" type="number" value="20" min="0" max="100">';
    html += '<label>Filament-Preis (EUR/kg)</label><input id="print-price" type="number" step="any" value="25">';
    html += '<label>Filament-Typ</label><select id="print-type" style="width:100%;padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px">';
    html += '<option value="1.24">PLA (1.24 g/cm3)</option><option value="1.04">ABS (1.04 g/cm3)</option>';
    html += '<option value="1.27">PETG (1.27 g/cm3)</option><option value="1.14">TPU (1.14 g/cm3)</option></select>';
    html += '<label>Druckgeschwindigkeit (mm/s)</label><input id="print-speed" type="number" value="60">';
    html += '<button class="step-btn" style="margin-top:8px" onclick="calc3DPrint()">Berechnen</button>';
    html += '</div><div id="print-result" class="calc-result"></div></div>';
    return html;
}

function calc3DPrint() {
    const vol = parseFloat(document.getElementById('print-vol')?.value || 0);
    const infill = parseFloat(document.getElementById('print-infill')?.value || 20) / 100;
    const price = parseFloat(document.getElementById('print-price')?.value || 25);
    const density = parseFloat(document.getElementById('print-type')?.value || 1.24);
    const speed = parseFloat(document.getElementById('print-speed')?.value || 60);
    const shellVol = vol * 0.3;
    const infillVol = vol * 0.7 * infill;
    const totalVol = shellVol + infillVol;
    const weightG = totalVol * density;
    const cost = (weightG / 1000) * price;
    const estTime = (totalVol * 1000) / (speed * 0.4 * 60);
    const hours = Math.floor(estTime / 60);
    const mins = Math.round(estTime % 60);
    document.getElementById('print-result').innerHTML =
        '<div style="font-size:12px;color:var(--text-primary)">' +
        '<div>Material-Volumen: <b>' + totalVol.toFixed(1) + ' cm3</b></div>' +
        '<div>Gewicht: <b>' + weightG.toFixed(1) + ' g</b></div>' +
        '<div>Material-Kosten: <b>' + cost.toFixed(2) + ' EUR</b></div>' +
        '<div>Gesch. Druckzeit: <b>' + hours + 'h ' + mins + 'm</b></div></div>';
}

function renderCableCalcTab() {
    let html = '<div style="padding:12px">';
    html += '<div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Kabel-Laengen Rechner</div>';
    html += '<div class="calc-form">';
    html += '<label>Direkte Entfernung (cm)</label><input id="cable-dist" type="number" step="any" placeholder="50">';
    html += '<label>Zugabe fuer Biegen (%)</label><input id="cable-extra" type="number" value="15">';
    html += '<label>Anzahl Segmente</label><input id="cable-seg" type="number" value="1" min="1">';
    html += '<label>Kabeltyp</label><select id="cable-type" style="width:100%;padding:6px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px">';
    html += '<option value="0.5">Litze 0.5mm2</option><option value="0.75">Litze 0.75mm2</option><option value="1.5">Litze 1.5mm2</option>';
    html += '<option value="2.5">Litze 2.5mm2</option><option value="dupont">Dupont-Kabel</option><option value="usb">USB-Kabel</option></select>';
    html += '<button class="step-btn" style="margin-top:8px" onclick="calcCable()">Berechnen</button>';
    html += '</div><div id="cable-result" class="calc-result"></div></div>';
    return html;
}

function calcCable() {
    const dist = parseFloat(document.getElementById('cable-dist')?.value || 0);
    const extra = parseFloat(document.getElementById('cable-extra')?.value || 15) / 100;
    const seg = parseInt(document.getElementById('cable-seg')?.value || 1);
    const totalPerSeg = dist * (1 + extra);
    const total = totalPerSeg * seg;
    document.getElementById('cable-result').innerHTML =
        '<div style="font-size:12px;color:var(--text-primary)">' +
        '<div>Pro Segment: <b>' + totalPerSeg.toFixed(1) + ' cm</b></div>' +
        '<div>Gesamt (' + seg + ' Segmente): <b>' + total.toFixed(1) + ' cm</b> (' + (total/100).toFixed(2) + ' m)</div>' +
        '<div>Zugabe: <b>' + (dist * extra).toFixed(1) + ' cm</b> pro Segment</div></div>';
}

// ===== Init Drag & Drop Sidebar =====
setTimeout(initSidebarDragDrop, 1000);

// ===== Init =====
window.addEventListener('DOMContentLoaded', bootWorkshop);
</script>
</body>
</html>
