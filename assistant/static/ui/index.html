<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jarvis — MindHome Dashboard</title>
<style>
/* ============================================================
   MindHome Design System — Jarvis Dashboard v2
   Dark futuristic, amber accents, Outfit font
   ============================================================ */
/* Offline-Fonts: System-Fonts statt Google CDN (Offline-Prinzip) */
@font-face {
  font-family: 'Outfit';
  font-style: normal;
  font-weight: 300 700;
  font-display: swap;
  src: local('Outfit'), local('Inter'), local('Segoe UI');
}
@font-face {
  font-family: 'JetBrains Mono';
  font-style: normal;
  font-weight: 400 500;
  font-display: swap;
  src: local('JetBrains Mono'), local('SF Mono'), local('Consolas'), local('Menlo');
}

:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2035;
  --bg-card-hover: #1f2847;
  --bg-input: #151d30;
  --bg-overlay: rgba(10, 14, 23, 0.85);
  --text-primary: #e8ecf4;
  --text-secondary: #8892a8;
  --text-muted: #5a6478;
  --accent: #f59e0b;
  --accent-dim: rgba(245, 158, 11, 0.15);
  --accent-glow: rgba(245, 158, 11, 0.3);
  --blue: #3b82f6;
  --blue-dim: rgba(59, 130, 246, 0.15);
  --success: #10b981;
  --success-dim: rgba(16, 185, 129, 0.15);
  --danger: #ef4444;
  --danger-dim: rgba(239, 68, 68, 0.15);
  --border: rgba(255, 255, 255, 0.06);
  --border-hover: rgba(255, 255, 255, 0.12);
  --border-accent: rgba(245, 158, 11, 0.3);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
  --shadow-glow: 0 0 20px rgba(245, 158, 11, 0.15);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --font: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'JetBrains Mono', 'SF Mono', monospace;
  --sidebar-w: 220px;
  --header-h: 56px;
  --fast: 0.15s ease;
  --normal: 0.25s ease;
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:var(--font); background:var(--bg-primary); color:var(--text-primary); min-height:100vh; overflow-x:hidden; background-image: radial-gradient(rgba(245,158,11,0.03) 1px, transparent 1px); background-size: 28px 28px; }

/* ---- Login HUD ---- */
.login-screen { display:flex; align-items:center; justify-content:center; min-height:100vh; background: radial-gradient(ellipse at center, rgba(245,158,11,0.03) 0%, var(--bg-primary) 70%); overflow: hidden; }
.login-box { background: rgba(26,32,53,0.85); border: 1px solid var(--border-accent); border-radius:var(--radius-lg); padding:48px 40px; width:360px; text-align:center; box-shadow: var(--shadow-lg), var(--shadow-glow); position: relative; backdrop-filter: blur(12px); }
.login-box h1 { font-size:28px; font-weight:600; margin-bottom:8px; color:var(--accent); letter-spacing: 4px; }
.login-box p { color:var(--text-secondary); margin-bottom:32px; font-size:14px; text-transform: uppercase; letter-spacing: 2px; font-family: var(--mono); }
.login-box input { width:100%; padding:14px 16px; background:var(--bg-input); border:1px solid var(--border-accent); border-radius:var(--radius-sm); color:var(--text-primary); font-family:var(--mono); font-size:24px; text-align:center; letter-spacing:12px; outline:none; transition: border-color var(--fast), box-shadow var(--fast); }
.login-box input:focus { border-color:var(--accent); box-shadow: 0 0 20px rgba(245,158,11,0.2); }
.login-box input::placeholder { letter-spacing:4px; font-size:14px; color:var(--text-muted); }
.login-box button { width:100%; margin-top:20px; padding:14px; background:var(--accent); color:#0a0e17; border:none; border-radius:var(--radius-sm); font-family:var(--font); font-size:16px; font-weight:600; cursor:pointer; text-transform: uppercase; letter-spacing: 2px; transition: all var(--fast); }
.login-box button:hover { opacity:0.9; box-shadow: 0 0 20px rgba(245,158,11,0.3); }
.login-error { color:var(--danger); font-size:13px; margin-top:12px; min-height:20px; }
.login-hud-ring { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); width: 120px; height: 120px; }
.login-hud-ring svg { width: 100%; height: 100%; animation: hudSpin 8s linear infinite; }
.login-hud-arc { fill: none; stroke: var(--accent); stroke-width: 1.5; stroke-dasharray: 40 20; opacity: 0.6; }
.login-hud-arc-inner { fill: none; stroke: rgba(245,158,11,0.3); stroke-width: 1; stroke-dasharray: 15 25; opacity: 0.4; }
.login-scan-line { position: absolute; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity: 0.3; animation: scanDown 3s ease-in-out infinite; }
.login-corner { position: absolute; width: 16px; height: 16px; border-color: var(--accent); opacity: 0.4; }
.login-corner.tl { top: 8px; left: 8px; border-top: 1px solid; border-left: 1px solid; }
.login-corner.tr { top: 8px; right: 8px; border-top: 1px solid; border-right: 1px solid; }
.login-corner.bl { bottom: 8px; left: 8px; border-bottom: 1px solid; border-left: 1px solid; }
.login-corner.br { bottom: 8px; right: 8px; border-bottom: 1px solid; border-right: 1px solid; }
@keyframes hudSpin { to { transform: rotate(360deg); } }
@keyframes scanDown { 0%,100% { top: 10%; } 50% { top: 90%; } }

/* ---- App ---- */
.app { display:none; }
.app.active { display:flex; min-height:100vh; }

/* Sidebar */
.sidebar { width:var(--sidebar-w); background:var(--bg-secondary); border-right:1px solid var(--border-accent); display:flex; flex-direction:column; position:fixed; top:0; left:0; bottom:0; z-index:100; overflow:hidden; }
.sidebar::before { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(180deg, rgba(245,158,11,0.04) 0%, transparent 40%, transparent 60%, rgba(245,158,11,0.02) 100%); pointer-events:none; z-index:0; }
.sidebar::after { content:''; position:absolute; left:0; right:0; height:1px; background:linear-gradient(90deg, transparent, var(--accent), transparent); opacity:0.15; animation:sidebarScan 6s ease-in-out infinite; pointer-events:none; z-index:1; }
@keyframes sidebarScan { 0%,100% { top:5%; } 50% { top:95%; } }
.sidebar-logo { padding:18px 20px; border-bottom:1px solid var(--border-accent); display:flex; align-items:center; gap:12px; position:relative; z-index:2; }
.sidebar-logo .logo-icon { width:36px; height:36px; border:1.5px solid var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:700; color:var(--accent); font-family:var(--mono); box-shadow:0 0 12px rgba(245,158,11,0.2), inset 0 0 8px rgba(245,158,11,0.1); animation:logoGlow 3s ease-in-out infinite; }
@keyframes logoGlow { 0%,100% { box-shadow:0 0 12px rgba(245,158,11,0.2), inset 0 0 8px rgba(245,158,11,0.1); } 50% { box-shadow:0 0 20px rgba(245,158,11,0.35), inset 0 0 12px rgba(245,158,11,0.15); } }
.sidebar-logo h2 { font-size:17px; font-weight:600; letter-spacing:3px; color:var(--accent); }
.sidebar-logo span { font-size:9px; color:var(--text-muted); display:block; text-transform:uppercase; letter-spacing:2px; }
.sidebar-nav { padding:12px 8px; flex:1; overflow-y:auto; position:relative; z-index:2; }
.nav-item { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:var(--radius-sm); color:var(--text-secondary); cursor:pointer; font-size:13px; font-weight:500; margin-bottom:2px; transition:all var(--fast); border:1px solid transparent; text-transform:uppercase; letter-spacing:0.5px; font-size:12px; }
.nav-item:hover { background:rgba(245,158,11,0.05); color:var(--text-primary); border-color:rgba(245,158,11,0.1); }
.nav-item.active { background:var(--accent-dim); color:var(--accent); border-color:var(--border-accent); box-shadow:0 0 10px rgba(245,158,11,0.1); }
.nav-item.active::before { content:''; position:absolute; left:0; width:2px; height:24px; background:var(--accent); border-radius:0 2px 2px 0; box-shadow:0 0 8px var(--accent); }
.nav-item .nav-icon { width:18px; text-align:center; font-size:14px; }
.sidebar-footer { padding:12px; border-top:1px solid var(--border-accent); font-size:10px; color:var(--text-muted); text-align:center; position:relative; z-index:2; font-family:var(--mono); letter-spacing:1px; text-transform:uppercase; }

/* Main */
.main { margin-left:var(--sidebar-w); flex:1; min-height:100vh; }
.main-header { height:var(--header-h); border-bottom:1px solid var(--border-accent); display:flex; align-items:center; justify-content:space-between; padding:0 28px; background:rgba(17,24,39,0.92); backdrop-filter:blur(12px); position:sticky; top:0; z-index:50; }
.main-header::after { content:''; position:absolute; bottom:-1px; left:0; right:0; height:1px; background:linear-gradient(90deg, transparent, var(--accent), transparent); opacity:0.3; }
.main-header h1 { font-size:15px; font-weight:600; text-transform:uppercase; letter-spacing:2px; color:var(--text-secondary); }
.main-content { padding:28px; }

/* Responsive */
@media (max-width:900px) {
  .sidebar { transform:translateX(-100%); transition:transform var(--normal); }
  .sidebar.open { transform:translateX(0); }
  .main { margin-left:0; }
  .mobile-toggle { display:flex !important; }
}

/* Pages */
.page { display:none; }
.page.active { display:block; }

/* Grid */
.grid { display:grid; gap:16px; }
.grid-2 { grid-template-columns:repeat(2,1fr); }
.grid-3 { grid-template-columns:repeat(3,1fr); }
.grid-4 { grid-template-columns:repeat(4,1fr); }
@media (max-width:1200px) { .grid-4 { grid-template-columns:repeat(2,1fr); } }
@media (max-width:900px) { .grid-2,.grid-3,.grid-4 { grid-template-columns:1fr; } }

/* Card */
.card { background:var(--bg-card); border:1px solid rgba(245,158,11,0.12); border-radius:var(--radius-md); padding:20px; margin-bottom:16px; position:relative; transition:all var(--normal); }
.card::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg, transparent, rgba(245,158,11,0.4), transparent); border-radius:var(--radius-md) var(--radius-md) 0 0; }
.card:hover { border-color:var(--border-accent); box-shadow:0 0 20px rgba(245,158,11,0.08); }
.card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.card-header h3 { font-size:14px; font-weight:600; text-transform:uppercase; letter-spacing:1px; color:var(--accent); }

/* Stat */
.stat-card { background:var(--bg-card); border:1px solid rgba(245,158,11,0.12); border-radius:var(--radius-md); padding:18px 20px; position:relative; overflow:hidden; transition:all var(--normal); }
.stat-card::before { content:''; position:absolute; top:0; left:0; width:3px; height:100%; background:linear-gradient(180deg, var(--accent), transparent); border-radius:var(--radius-md) 0 0 var(--radius-md); }
.stat-card::after { content:''; position:absolute; top:0; right:0; bottom:0; width:40%; background:radial-gradient(ellipse at right, rgba(245,158,11,0.03), transparent); pointer-events:none; }
.stat-card:hover { border-color:var(--border-accent); box-shadow:0 0 20px rgba(245,158,11,0.1); transform:translateY(-1px); }
.stat-label { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px; font-family:var(--mono); }
.stat-value { font-size:28px; font-weight:700; font-family:var(--mono); color:var(--accent); text-shadow:0 0 20px rgba(245,158,11,0.2); }
.stat-sub { font-size:11px; color:var(--text-secondary); margin-top:4px; font-family:var(--mono); }

/* Form */
.form-group { margin-bottom:16px; }
.form-group label { display:block; font-size:11px; font-weight:600; color:var(--text-muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:1px; }
.form-group .hint { font-size:11px; color:var(--text-muted); margin-top:3px; }
input[type="text"],input[type="number"],select,textarea { width:100%; padding:9px 12px; background:var(--bg-input); border:1px solid rgba(245,158,11,0.1); border-radius:var(--radius-sm); color:var(--text-primary); font-family:var(--font); font-size:13px; outline:none; transition:all var(--fast); }
input:focus,select:focus,textarea:focus { border-color:var(--accent); box-shadow:0 0 12px rgba(245,158,11,0.1); }
select { cursor:pointer; }
textarea { resize:vertical; min-height:70px; font-family:var(--mono); font-size:12px; }

/* Range */
.range-group { display:flex; align-items:center; gap:14px; }
.range-group input[type="range"] { flex:1; -webkit-appearance:none; height:3px; background:rgba(245,158,11,0.15); border-radius:2px; border:none; outline:none; }
.range-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent); cursor:pointer; box-shadow:0 0 12px rgba(245,158,11,0.5); border:2px solid rgba(245,158,11,0.8); }
.range-value { min-width:40px; text-align:center; font-family:var(--mono); font-size:14px; font-weight:700; color:var(--accent); text-shadow:0 0 10px rgba(245,158,11,0.3); }

/* Toggle */
.toggle-group { display:flex; align-items:center; justify-content:space-between; }
.toggle { position:relative; width:42px; height:22px; cursor:pointer; }
.toggle input { display:none; }
.toggle-track { position:absolute; inset:0; background:var(--bg-input); border:1px solid rgba(245,158,11,0.15); border-radius:11px; transition:all var(--fast); }
.toggle input:checked + .toggle-track { background:var(--accent-dim); border-color:var(--accent); box-shadow:0 0 10px rgba(245,158,11,0.2); }
.toggle-thumb { position:absolute; top:3px; left:3px; width:16px; height:16px; border-radius:50%; background:var(--text-muted); transition:all var(--fast); }
.toggle input:checked ~ .toggle-thumb { left:23px; background:var(--accent); box-shadow:0 0 8px rgba(245,158,11,0.4); }

/* Buttons */
.btn { display:inline-flex; align-items:center; gap:8px; padding:9px 18px; border:none; border-radius:var(--radius-sm); font-family:var(--font); font-size:12px; font-weight:600; cursor:pointer; transition:all var(--fast); text-transform:uppercase; letter-spacing:1px; }
.btn-primary { background:var(--accent); color:#0a0e17; box-shadow:0 0 10px rgba(245,158,11,0.2); }
.btn-primary:hover { opacity:0.9; box-shadow:0 0 20px rgba(245,158,11,0.4); }
.btn-secondary { background:transparent; color:var(--text-primary); border:1px solid var(--border-accent); }
.btn-secondary:hover { border-color:var(--accent); background:rgba(245,158,11,0.05); box-shadow:0 0 10px rgba(245,158,11,0.1); }
.btn-danger { background:transparent; color:var(--danger); border:1px solid rgba(239,68,68,0.3); }
.btn-danger:hover { border-color:var(--danger); background:var(--danger-dim); }
.btn-sm { padding:5px 12px; font-size:11px; }

/* Tab Bar */
.tab-bar { display:flex; gap:2px; background:rgba(21,29,48,0.5); padding:3px; border-radius:var(--radius-sm); margin-bottom:20px; flex-wrap:wrap; border:1px solid rgba(245,158,11,0.08); }
.tab-item { padding:7px 14px; border-radius:6px; font-size:11px; font-weight:500; color:var(--text-secondary); cursor:pointer; transition:all var(--fast); white-space:nowrap; text-transform:uppercase; letter-spacing:0.5px; }
.tab-item:hover { color:var(--text-primary); background:rgba(245,158,11,0.05); }
.tab-item.active { background:rgba(245,158,11,0.1); color:var(--accent); box-shadow:0 0 10px rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.2); }

/* Settings Section (collapsible) */
.s-section { border:1px solid rgba(245,158,11,0.1); border-radius:var(--radius-md); margin-bottom:14px; overflow:hidden; }
.s-section-hdr { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:var(--bg-card); cursor:pointer; transition:all var(--fast); border-left:2px solid transparent; }
.s-section-hdr:hover { background:var(--bg-card-hover); border-left-color:var(--accent); }
.s-section-hdr h3 { font-size:13px; font-weight:600; display:flex; align-items:center; gap:8px; text-transform:uppercase; letter-spacing:0.5px; }
.s-section-hdr .arrow { transition:transform var(--fast); color:var(--accent); font-size:12px; }
.s-section-hdr.open .arrow { transform:rotate(180deg); }
.s-section-hdr.open { border-left-color:var(--accent); }
.s-section-body { padding:0 18px; max-height:0; overflow:hidden; transition:max-height 0.3s ease,padding 0.3s ease; }
.s-section-body.open { padding:18px; max-height:5000px; }

/* Entity */
.entity-picker { background:var(--bg-card); border:1px solid rgba(245,158,11,0.1); border-radius:var(--radius-md); padding:14px; margin-bottom:14px; }
.entity-search { padding:8px 12px; background:var(--bg-input); border:1px solid rgba(245,158,11,0.1); border-radius:var(--radius-sm); color:var(--text-primary); font-size:13px; width:100%; margin-bottom:10px; outline:none; font-family:var(--mono); transition:all var(--fast); }
.entity-search:focus { border-color:var(--accent); box-shadow:0 0 12px rgba(245,158,11,0.1); }
.entity-list { max-height:400px; overflow-y:auto; border:1px solid rgba(245,158,11,0.08); border-radius:var(--radius-sm); }
.entity-item { display:flex; align-items:center; gap:10px; padding:8px 12px; cursor:pointer; font-size:12px; border-bottom:1px solid rgba(245,158,11,0.05); transition:all var(--fast); }
.entity-item:last-child { border-bottom:none; }
.entity-item:hover { background:rgba(245,158,11,0.03); border-left:2px solid var(--accent); }
.entity-item .eid { color:var(--text-muted); font-family:var(--mono); font-size:10px; }
.entity-item .ename { flex:1; font-family:var(--mono); font-size:12px; }
.selected-entities { display:flex; flex-wrap:wrap; gap:5px; margin-top:6px; }
.entity-tag { display:inline-flex; align-items:center; gap:5px; padding:3px 9px; background:var(--accent-dim); border:1px solid var(--border-accent); border-radius:16px; font-size:11px; color:var(--accent); font-family:var(--mono); }
.entity-tag .remove { cursor:pointer; opacity:0.6; font-size:13px; }
.entity-tag .remove:hover { opacity:1; }

/* Logs */
.log-entry { display:flex; gap:14px; padding:10px 14px; border-bottom:1px solid rgba(245,158,11,0.06); font-size:12px; transition:background var(--fast); }
.log-entry:hover { background:rgba(245,158,11,0.03); }
.log-time { color:var(--text-muted); font-family:var(--mono); font-size:11px; min-width:70px; }
.log-role { min-width:55px; font-weight:700; font-size:10px; text-transform:uppercase; letter-spacing:1px; font-family:var(--mono); }
.log-role.user { color:var(--blue); }
.log-role.assistant { color:var(--accent); }
.log-content { flex:1; color:var(--text-primary); line-height:1.5; }

/* Fehlerspeicher */
.err-entry { display:flex; gap:14px; padding:10px 14px; border-bottom:1px solid rgba(245,158,11,0.06); font-size:12px; align-items:flex-start; transition:background var(--fast); }
.err-entry:hover { background:rgba(245,158,11,0.03); }
.err-entry.level-ERROR { border-left:3px solid var(--danger); box-shadow:inset 4px 0 12px rgba(239,68,68,0.05); }
.err-entry.level-WARNING { border-left:3px solid var(--accent); box-shadow:inset 4px 0 12px rgba(245,158,11,0.05); }
.err-time { color:var(--text-muted); font-family:var(--mono); font-size:11px; min-width:130px; white-space:nowrap; }
.err-level { min-width:60px; font-weight:700; font-size:11px; text-transform:uppercase; font-family:var(--mono); }
.err-level.ERROR { color:var(--danger); }
.err-level.WARNING { color:var(--accent); }
.err-logger { min-width:120px; color:var(--text-muted); font-family:var(--mono); font-size:11px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.err-msg { flex:1; color:var(--text-primary); line-height:1.5; word-break:break-word; }
.err-badge { display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 5px; border-radius:9px; background:var(--danger); color:white; font-size:10px; font-weight:700; margin-left:6px; }
.err-filter-bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.err-filter-bar .btn { font-size:10px; padding:4px 12px; border:1px solid rgba(245,158,11,0.12); }
.err-filter-bar .btn.active-filter { background:var(--accent-dim); color:var(--accent); border-color:var(--accent); box-shadow:0 0 8px rgba(245,158,11,0.15); }

/* Audit Log */
.audit-entry { display:flex; gap:14px; padding:10px 14px; border-bottom:1px solid rgba(245,158,11,0.06); font-size:12px; align-items:flex-start; transition:background var(--fast); }
.audit-entry:hover { background:rgba(245,158,11,0.03); }
.audit-time { color:var(--text-muted); font-family:var(--mono); font-size:10px; min-width:130px; white-space:nowrap; }
.audit-action { min-width:120px; font-weight:700; font-size:10px; font-family:var(--mono); padding:2px 8px; border-radius:4px; text-align:center; text-transform:uppercase; letter-spacing:0.5px; }
.audit-action.auth { background:var(--blue-dim); color:var(--blue); }
.audit-action.settings { background:var(--accent-dim); color:var(--accent); }
.audit-action.security { background:var(--danger-dim); color:var(--danger); }
.audit-action.system { background:var(--success-dim); color:var(--success); }
.audit-details { flex:1; color:var(--text-secondary); font-size:11px; word-break:break-word; }

/* Live-Status Indicator */
.live-dot { width:8px; height:8px; border-radius:50%; background:var(--success); display:inline-block; animation:livePulse 2s infinite; box-shadow:0 0 8px rgba(16,185,129,0.5); }
.live-dot.offline { background:var(--danger); animation:none; box-shadow:0 0 8px rgba(239,68,68,0.5); }
@keyframes livePulse { 0%,100%{opacity:1;box-shadow:0 0 8px rgba(16,185,129,0.5);} 50%{opacity:0.4;box-shadow:0 0 4px rgba(16,185,129,0.2);} }

/* Health Trends */
.trend-card { padding:14px; }
.trend-row { display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid rgba(245,158,11,0.06); }
.trend-row:last-child { border-bottom:none; }
.trend-label { min-width:100px; font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-family:var(--mono); }
.trend-value { font-size:18px; font-weight:700; font-family:var(--mono); min-width:70px; color:var(--accent); }
.trend-unit { font-size:10px; color:var(--text-muted); font-family:var(--mono); }
.trend-arrow { font-size:14px; }
.trend-arrow.up { color:var(--danger); text-shadow:0 0 8px rgba(239,68,68,0.3); }
.trend-arrow.down { color:var(--blue); text-shadow:0 0 8px rgba(59,130,246,0.3); }
.trend-arrow.stable { color:var(--success); text-shadow:0 0 8px rgba(16,185,129,0.3); }
.trend-sparkline { flex:1; height:24px; }
.trend-period-bar { display:flex; gap:6px; margin-bottom:12px; }
.trend-period-bar button { font-size:10px; padding:3px 10px; border:1px solid rgba(245,158,11,0.15); border-radius:4px; background:transparent; color:var(--text-muted); cursor:pointer; font-family:var(--mono); text-transform:uppercase; transition:all var(--fast); }
.trend-period-bar button:hover { border-color:var(--border-accent); color:var(--text-primary); }
.trend-period-bar button.active { background:var(--accent-dim); color:var(--accent); border-color:var(--accent); box-shadow:0 0 8px rgba(245,158,11,0.15); }

/* Section Header */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
.section-header h2 { font-size:16px; font-weight:600; text-transform:uppercase; letter-spacing:2px; color:var(--accent); }
.section-header p { font-size:11px; color:var(--text-muted); margin-top:3px; text-transform:uppercase; letter-spacing:1px; font-family:var(--mono); }

/* Knowledge Files */
.file-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid var(--border); font-size:12px; }
.file-name { flex:1; font-weight:500; }
.file-size { color:var(--text-muted); font-family:var(--mono); font-size:11px; }

/* Badge */
.badge { padding:3px 10px; border-radius:16px; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:1px; font-family:var(--mono); }
.badge-ok { background:var(--success-dim); color:var(--success); border:1px solid rgba(16,185,129,0.3); }
.badge-warn { background:rgba(245,158,11,0.15); color:var(--accent); border:1px solid rgba(245,158,11,0.3); }
.badge-err { background:var(--danger-dim); color:var(--danger); border:1px solid rgba(239,68,68,0.3); }

/* Mobile */
.mobile-toggle { display:none; align-items:center; justify-content:center; width:34px; height:34px; border-radius:var(--radius-sm); background:transparent; border:1px solid var(--border-accent); cursor:pointer; font-size:16px; color:var(--accent); transition:all var(--fast); }
.mobile-toggle:hover { box-shadow:0 0 10px rgba(245,158,11,0.2); }

/* Toast */
.toast { position:fixed; bottom:20px; right:20px; padding:12px 22px; border-radius:var(--radius-sm); font-size:12px; font-weight:600; box-shadow:var(--shadow-lg); z-index:9999; transform:translateY(80px); opacity:0; transition:all 0.3s ease; text-transform:uppercase; letter-spacing:1px; font-family:var(--mono); backdrop-filter:blur(8px); }
.toast.show { transform:translateY(0); opacity:1; }
.toast-success { background:rgba(16,185,129,0.9); color:white; border:1px solid rgba(16,185,129,0.6); box-shadow:0 0 20px rgba(16,185,129,0.3); }
.toast-error { background:rgba(239,68,68,0.9); color:white; border:1px solid rgba(239,68,68,0.6); box-shadow:0 0 20px rgba(239,68,68,0.3); }
.toast-info { background:rgba(59,130,246,0.9); color:white; border:1px solid rgba(59,130,246,0.6); box-shadow:0 0 20px rgba(59,130,246,0.3); }

/* Scrollbar */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(245,158,11,0.2); border-radius:2px; }
::-webkit-scrollbar-thumb:hover { background:rgba(245,158,11,0.4); }

/* Loading */
.spinner { width:28px; height:28px; border:2px solid rgba(245,158,11,0.15); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; display:inline-block; margin-right:10px; box-shadow:0 0 10px rgba(245,158,11,0.1); }
@keyframes spin { to { transform:rotate(360deg); } }

/* Keyword tags editor */
.kw-editor { display:flex; flex-wrap:wrap; gap:4px; padding:8px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); min-height:36px; cursor:text; }
.kw-tag { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; background:var(--accent-dim); border:1px solid var(--border-accent); border-radius:12px; font-size:11px; color:var(--accent); font-family:var(--mono); }
.kw-tag .kw-rm { cursor:pointer; opacity:0.6; }
.kw-tag .kw-rm:hover { opacity:1; }
.kw-input { border:none; background:transparent; color:var(--text-primary); font-family:var(--font); font-size:12px; outline:none; min-width:80px; flex:1; }

/* Chip Select — klickbare vordefinierte Optionen */
.chip-grid { display:flex; flex-wrap:wrap; gap:6px; padding:8px 0; }
.chip-opt { display:inline-flex; align-items:center; gap:4px; padding:5px 12px; background:transparent; border:1px solid rgba(245,158,11,0.12); border-radius:16px; font-size:11px; color:var(--text-secondary); cursor:pointer; transition:all var(--fast); user-select:none; text-transform:uppercase; letter-spacing:0.5px; }
.chip-opt:hover { border-color:var(--border-accent); color:var(--text-primary); background:rgba(245,158,11,0.05); }
.chip-opt.selected { background:var(--accent-dim); border-color:var(--accent); color:var(--accent); font-weight:600; box-shadow:0 0 10px rgba(245,158,11,0.15); }
.chip-opt.selected::before { content:'✓ '; font-size:10px; }

/* Info-Hint Box */
.info-box { display:flex; align-items:flex-start; gap:8px; padding:10px 14px; background:var(--blue-dim); border:1px solid rgba(59,130,246,0.2); border-radius:var(--radius-sm); margin-bottom:14px; font-size:12px; color:var(--text-secondary); line-height:1.5; }
.info-box .info-icon { font-size:14px; flex-shrink:0; margin-top:1px; }

/* ---- Jarvis Boot Sequence ---- */
.boot-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
.boot-hud { position: relative; width: 180px; height: 180px; margin-bottom: 40px; }
.boot-circle { width: 100%; height: 100%; animation: bootRotate 3s linear infinite; }
.boot-ring { fill: none; stroke: rgba(245,158,11,0.15); stroke-width: 2; }
.boot-ring-fill { fill: none; stroke: var(--accent); stroke-width: 2; stroke-dasharray: 565; stroke-dashoffset: 565; stroke-linecap: round; animation: bootDraw 2s ease-out forwards; }
.boot-logo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 56px; font-weight: 700; color: var(--accent); opacity: 0; animation: bootFadeIn 0.6s ease 0.3s forwards; text-shadow: 0 0 30px rgba(245,158,11,0.5); }
.boot-text { font-family: var(--mono); font-size: 14px; color: var(--accent); letter-spacing: 2px; min-height: 20px; text-transform: uppercase; }
.boot-systems { display: flex; gap: 12px; margin-top: 24px; }
.boot-sys { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); opacity: 0; animation: bootFadeIn 0.3s ease forwards; }
.boot-sys .sys-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); transition: background 0.3s; }
.boot-sys.online .sys-dot { background: var(--success); }
.boot-sys.online { color: var(--text-secondary); }
.boot-screen.fade-out { animation: bootFadeOut 0.5s ease forwards; }
@keyframes bootDraw { to { stroke-dashoffset: 0; } }
@keyframes bootRotate { to { transform: rotate(360deg); } }
@keyframes bootFadeIn { to { opacity: 1; } }
@keyframes bootFadeOut { to { opacity: 0; pointer-events: none; } }
</style>
</head>
<body>

<!-- SETUP (erstmaliger Aufruf) -->
<div id="setupScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#9881;</div>
    <h1>JARVIS</h1>
    <p>Ersteinrichtung — PIN festlegen</p>
    <input type="password" id="setupPin" maxlength="16" placeholder="PIN waehlen" style="margin-bottom:12px;"
           onkeydown="if(event.key==='Enter')document.getElementById('setupPinConfirm').focus()">
    <input type="password" id="setupPinConfirm" maxlength="16" placeholder="PIN bestaetigen"
           onkeydown="if(event.key==='Enter')doSetup()">
    <button onclick="doSetup()">PIN setzen</button>
    <div id="setupError" class="login-error"></div>
  </div>
</div>

<!-- RECOVERY KEY anzeigen (nach Setup) -->
<div id="recoveryScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#128273;</div>
    <h1>Recovery-Key</h1>
    <p style="color:var(--accent);font-weight:600;margin-bottom:16px;">Diesen Schluessel sicher aufbewahren!</p>
    <p style="margin-bottom:20px;font-size:13px;">Falls du deinen PIN vergisst, kannst du ihn nur mit diesem Key zuruecksetzen. Er wird nur einmal angezeigt.</p>
    <div id="recoveryKeyDisplay" style="background:var(--bg-input);border:2px solid var(--accent);border-radius:var(--radius-sm);padding:18px;font-family:var(--mono);font-size:22px;letter-spacing:4px;color:var(--accent);margin-bottom:20px;user-select:all;"></div>
    <button onclick="recoveryAcknowledged()">Ich habe den Key gespeichert</button>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <!-- HUD Ring oben -->
    <div class="login-hud-ring">
      <svg viewBox="0 0 120 120">
        <circle class="login-hud-arc" cx="60" cy="60" r="54" />
        <circle class="login-hud-arc-inner" cx="60" cy="60" r="46" />
      </svg>
    </div>
    <!-- Corner Brackets -->
    <div class="login-corner tl"></div>
    <div class="login-corner tr"></div>
    <div class="login-corner bl"></div>
    <div class="login-corner br"></div>
    <!-- Scan-Linie -->
    <div class="login-scan-line"></div>
    <!-- Content -->
    <h1>JARVIS</h1>
    <p>MindHome Assistant</p>
    <input type="password" id="pinInput" maxlength="16" placeholder="PIN" autofocus
           onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">Authentifizieren</button>
    <div id="loginError" class="login-error"></div>
    <div style="margin-top:20px;">
      <a href="#" onclick="showResetScreen();return false;" style="color:var(--text-muted);font-size:12px;text-decoration:none;">PIN vergessen?</a>
    </div>
  </div>
</div>

<!-- PIN RESET -->
<div id="resetScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#128273;</div>
    <h1>PIN zuruecksetzen</h1>
    <p>Recovery-Key eingeben</p>
    <input type="text" id="resetRecoveryKey" maxlength="16" placeholder="Recovery-Key" style="margin-bottom:12px;letter-spacing:2px;text-transform:uppercase;"
           onkeydown="if(event.key==='Enter')document.getElementById('resetNewPin').focus()">
    <input type="password" id="resetNewPin" maxlength="16" placeholder="Neuer PIN" style="margin-bottom:12px;"
           onkeydown="if(event.key==='Enter')document.getElementById('resetNewPinConfirm').focus()">
    <input type="password" id="resetNewPinConfirm" maxlength="16" placeholder="Neuer PIN bestaetigen"
           onkeydown="if(event.key==='Enter')doResetPin()">
    <button onclick="doResetPin()">PIN zuruecksetzen</button>
    <div id="resetError" class="login-error"></div>
    <div style="margin-top:16px;">
      <a href="#" onclick="showLoginScreen();return false;" style="color:var(--text-muted);font-size:12px;text-decoration:none;">Zurueck zur Anmeldung</a>
    </div>
  </div>
</div>

<!-- NEUER RECOVERY KEY (nach Reset) -->
<div id="newRecoveryScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#128273;</div>
    <h1>Neuer Recovery-Key</h1>
    <p style="color:var(--accent);font-weight:600;margin-bottom:16px;">Neuen Schluessel sicher aufbewahren!</p>
    <p style="margin-bottom:20px;font-size:13px;">Der alte Recovery-Key ist ungueltig. Dieser neue Key wird nur einmal angezeigt.</p>
    <div id="newRecoveryKeyDisplay" style="background:var(--bg-input);border:2px solid var(--accent);border-radius:var(--radius-sm);padding:18px;font-family:var(--mono);font-size:22px;letter-spacing:4px;color:var(--accent);margin-bottom:20px;user-select:all;"></div>
    <button onclick="newRecoveryAcknowledged()">Ich habe den Key gespeichert</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">J</div>
      <div><h2>JARVIS</h2><span>MindHome Assistant</span></div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" data-page="dashboard"><span class="nav-icon">&#9632;</span>Dashboard</div>
      <div class="nav-item" data-page="settings"><span class="nav-icon">&#9881;</span>Einstellungen</div>
      <div class="nav-item" data-page="entities"><span class="nav-icon">&#8801;</span>Entities</div>
      <div class="nav-item" data-page="knowledge"><span class="nav-icon">&#128218;</span>Wissen</div>
      <div class="nav-item" data-page="logs"><span class="nav-icon">&#9776;</span>Logs</div>
      <div class="nav-item" data-page="errors"><span class="nav-icon">&#9888;</span>Fehler<span id="errBadge" class="err-badge" style="display:none;">0</span></div>
    </nav>
    <div class="sidebar-footer">MindHome Assistant v1.4.1</div>
  </aside>

  <div class="main">
    <header class="main-header">
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">&#9776;</div>
        <h1 id="pageTitle">Dashboard</h1>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <span id="statusBadge" class="badge badge-ok">Online</span>
        <button class="btn btn-sm btn-secondary" onclick="doLogout()">Abmelden</button>
      </div>
    </header>

    <div class="main-content">
      <!-- ============ DASHBOARD ============ -->
      <div id="page-dashboard" class="page active">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;">
          <span id="liveIndicator" class="live-dot"></span>
          <span style="font-size:11px;color:var(--text-muted);" id="liveTimestamp">—</span>
          <span id="whisperBadge" style="display:none;font-size:10px;padding:2px 8px;background:var(--blue-dim);color:var(--blue);border-radius:10px;font-weight:600;">Flüstermodus</span>
        </div>
        <div id="dashStats" class="grid grid-4"></div>
        <div class="grid grid-2" style="margin-top:16px;">
          <div class="card"><div class="card-header"><h3>Komponenten</h3></div><div id="compList"></div></div>
          <div class="card"><div class="card-header"><h3>Status</h3></div><div id="moodInfo"></div></div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
            <h3>Raumklima</h3>
            <div class="trend-period-bar" id="trendPeriodBar">
              <button class="active" onclick="loadHealthTrends(24)">24h</button>
              <button onclick="loadHealthTrends(48)">48h</button>
              <button onclick="loadHealthTrends(168)">7 Tage</button>
            </div>
          </div>
          <div id="healthTrendsContainer" class="trend-card"></div>
        </div>
      </div>

      <!-- ============ SETTINGS ============ -->
      <div id="page-settings" class="page">
        <div class="section-header">
          <div><h2>Einstellungen</h2><p>Alle Konfigurationen aus settings.yaml</p></div>
          <button class="btn btn-primary" onclick="saveAllSettings()">Speichern</button>
        </div>
        <!-- 11 Tabs -->
        <div class="tab-bar" id="settingsTabBar">
          <div class="tab-item active" data-tab="tab-general">Allgemein</div>
          <div class="tab-item" data-tab="tab-persons">Personen</div>
          <div class="tab-item" data-tab="tab-personality">Persönlichkeit</div>
          <div class="tab-item" data-tab="tab-memory">Gedächtnis</div>
          <div class="tab-item" data-tab="tab-mood">Stimmung</div>
          <div class="tab-item" data-tab="tab-rooms">Räume</div>
          <div class="tab-item" data-tab="tab-voice">Stimme</div>
          <div class="tab-item" data-tab="tab-routines">Routinen</div>
          <div class="tab-item" data-tab="tab-security">Sicherheit</div>
          <div class="tab-item" data-tab="tab-autonomie">KI-Autonomie</div>
          <div class="tab-item" data-tab="tab-eastereggs">Easter Eggs</div>
          <div class="tab-item" data-tab="tab-system">System</div>
        </div>
        <div id="settingsContent"></div>
      </div>

      <!-- ============ ENTITIES ============ -->
      <div id="page-entities" class="page">
        <div class="section-header">
          <div><h2>Home Assistant Entities</h2><p>Alle Entities — klicke zum Kopieren</p></div>
          <button class="btn btn-secondary" onclick="loadEntities()">Aktualisieren</button>
        </div>
        <div class="grid grid-2" style="margin-bottom:14px;">
          <div class="form-group" style="margin-bottom:0;">
            <select id="entityDomainFilter" onchange="filterEntities()"><option value="">Alle Domains</option></select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <input type="text" id="entitySearchInput" placeholder="Entity suchen..." oninput="filterEntities()">
          </div>
        </div>
        <div class="card" style="padding:0;"><div id="entityBrowser" class="entity-list" style="max-height:500px;"></div></div>
      </div>

      <!-- ============ KNOWLEDGE ============ -->
      <div id="page-knowledge" class="page">
        <div class="section-header">
          <div><h2>Wissensdatenbank</h2><p>Dateien in config/knowledge/ — RAG-Quelle</p></div>
          <button class="btn btn-primary" onclick="ingestKnowledge()">Neu einlesen</button>
        </div>
        <div id="kbStats" class="grid grid-3" style="margin-bottom:16px;"></div>
        <div class="card"><div class="card-header"><h3>Dateien</h3></div><div id="kbFiles"></div></div>
      </div>

      <!-- ============ LOGS ============ -->
      <div id="page-logs" class="page">
        <div class="section-header">
          <div><h2>Protokolle</h2><p>Gespraeche und Audit-Ereignisse</p></div>
          <button class="btn btn-secondary" onclick="currentLogTab==='conversations'?loadLogs():loadAudit()">Aktualisieren</button>
        </div>
        <div class="tab-bar" id="logsTabBar" style="margin-bottom:14px;">
          <div class="tab-item active" data-logtab="conversations" onclick="switchLogTab('conversations')">Gespraeche</div>
          <div class="tab-item" data-logtab="audit" onclick="switchLogTab('audit')">Audit-Log</div>
        </div>
        <div class="card" style="padding:0;">
          <div id="logsContainer"></div>
          <div id="auditContainer" style="display:none;"></div>
        </div>
      </div>

      <div id="page-errors" class="page">
        <div class="section-header">
          <div><h2>Fehlerspeicher</h2><p>Letzte Warnungen und Fehler des Assistenten</p></div>
          <div class="err-filter-bar">
            <button class="btn btn-secondary active-filter" id="errFilterAll" onclick="filterErrors('')">Alle</button>
            <button class="btn btn-secondary" id="errFilterError" onclick="filterErrors('ERROR')">Fehler</button>
            <button class="btn btn-secondary" id="errFilterWarn" onclick="filterErrors('WARNING')">Warnungen</button>
            <button class="btn btn-secondary" onclick="loadErrors()">Aktualisieren</button>
            <button class="btn btn-danger" onclick="clearErrors()">Leeren</button>
          </div>
        </div>
        <div class="card" style="padding:0;"><div id="errorsContainer"></div></div>
        <div style="margin-top:8px;font-size:11px;color:var(--text-muted);" id="errorsInfo"></div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- BOOT SCREEN -->
<div id="bootScreen" class="boot-screen" style="display:none;">
  <div class="boot-hud">
    <svg class="boot-circle" viewBox="0 0 200 200">
      <circle class="boot-ring" cx="100" cy="100" r="90" />
      <circle class="boot-ring-fill" cx="100" cy="100" r="90" />
    </svg>
    <div class="boot-logo">J</div>
  </div>
  <div class="boot-text" id="bootText"></div>
  <div class="boot-systems" id="bootSystems"></div>
</div>

<script>
/* ============================================================
   Jarvis Dashboard v2 — JavaScript
   11 Settings Tabs: Allgemein, Personen, Persoenlichkeit, Gedaechtnis,
   Stimmung, Raeume, Stimme, Routinen, Sicherheit, KI-Autonomie, Easter Eggs
   ============================================================ */

let TOKEN = '';
let S = {};  // Settings cache
let ALL_ENTITIES = [];
const API = '';

// ---- Session-Timeout: Auto-Logout bei Inaktivitaet (30 Min) ----
const SESSION_TIMEOUT_MS = 30 * 60 * 1000;  // 30 Minuten
let _sessionTimer = null;
function resetSessionTimer() {
  if (_sessionTimer) clearTimeout(_sessionTimer);
  if (!TOKEN) return;
  _sessionTimer = setTimeout(() => {
    doLogout();
    alert('Sitzung abgelaufen (30 Min Inaktivitaet). Bitte erneut anmelden.');
  }, SESSION_TIMEOUT_MS);
}
['click','keydown','scroll','mousemove','touchstart'].forEach(evt =>
  document.addEventListener(evt, resetSessionTimer, {passive: true})
);

// ---- Screens ausblenden ----
function hideAllScreens() {
  ['setupScreen','recoveryScreen','loginScreen','resetScreen','newRecoveryScreen','bootScreen'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  document.getElementById('app').classList.remove('active');
}

// ---- Jarvis Boot Sequence ----
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function typeText(el, text, speed) {
  el.textContent = '';
  for (const ch of text) { el.textContent += ch; await sleep(speed); }
}

function playBootSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    // Ton 1: Tiefer Sweep (0-1.5s)
    const o1 = ctx.createOscillator(), g1 = ctx.createGain();
    o1.type = 'sine';
    o1.frequency.setValueAtTime(80, ctx.currentTime);
    o1.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 1.5);
    g1.gain.setValueAtTime(0, ctx.currentTime);
    g1.gain.linearRampToValueAtTime(0.15, ctx.currentTime + 0.3);
    g1.gain.linearRampToValueAtTime(0, ctx.currentTime + 1.5);
    o1.connect(g1).connect(ctx.destination);
    o1.start(); o1.stop(ctx.currentTime + 1.5);
    // Ton 2: Hoher Ping (1.5s)
    const o2 = ctx.createOscillator(), g2 = ctx.createGain();
    o2.type = 'sine';
    o2.frequency.setValueAtTime(880, ctx.currentTime + 1.5);
    g2.gain.setValueAtTime(0, ctx.currentTime + 1.5);
    g2.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 1.55);
    g2.gain.linearRampToValueAtTime(0, ctx.currentTime + 2.5);
    o2.connect(g2).connect(ctx.destination);
    o2.start(ctx.currentTime + 1.5); o2.stop(ctx.currentTime + 2.5);
    // Ton 3: Confirmation-Chime (3s)
    const o3 = ctx.createOscillator(), g3 = ctx.createGain();
    o3.type = 'triangle';
    o3.frequency.setValueAtTime(660, ctx.currentTime + 3);
    o3.frequency.setValueAtTime(880, ctx.currentTime + 3.15);
    g3.gain.setValueAtTime(0, ctx.currentTime + 3);
    g3.gain.linearRampToValueAtTime(0.12, ctx.currentTime + 3.05);
    g3.gain.linearRampToValueAtTime(0, ctx.currentTime + 3.8);
    o3.connect(g3).connect(ctx.destination);
    o3.start(ctx.currentTime + 3); o3.stop(ctx.currentTime + 3.8);
  } catch(e) { /* Audio nicht verfuegbar */ }
}

async function playBootSequence() {
  const screen = document.getElementById('bootScreen');
  const textEl = document.getElementById('bootText');
  const sysEl = document.getElementById('bootSystems');
  screen.style.display = 'flex';
  playBootSound();

  const systems = ['LLM', 'HA', 'Redis', 'Memory', 'TTS'];
  sysEl.innerHTML = systems.map((s, i) =>
    `<div class="boot-sys" style="animation-delay:${0.8 + i * 0.3}s" id="bootSys${i}"><span class="sys-dot"></span>${s}</div>`
  ).join('');

  await typeText(textEl, 'INITIALIZING...', 60);
  await sleep(600);
  for (let i = 0; i < systems.length; i++) {
    await sleep(300);
    const el = document.getElementById('bootSys' + i);
    if (el) el.classList.add('online');
  }
  await sleep(300);
  textEl.textContent = '';
  await typeText(textEl, 'ALL SYSTEMS ONLINE', 40);
  await sleep(800);

  screen.classList.add('fade-out');
  await sleep(500);
  screen.style.display = 'none';
  screen.classList.remove('fade-out');
}

// ---- Setup-Status pruefen und richtigen Screen zeigen ----
async function checkSetupAndShow() {
  try {
    const r = await fetch(`${API}/api/ui/setup-status`);
    const d = await r.json();
    hideAllScreens();
    if (!d.setup_complete) {
      // Erster Aufruf: Setup-Screen
      document.getElementById('setupScreen').style.display = 'flex';
      document.getElementById('setupPin').focus();
    } else {
      // Setup fertig: Token pruefen oder Login zeigen
      const t = sessionStorage.getItem('jt');
      if (t) {
        // Pruefen ob Token aelter als 4h (Backend-Timeout)
        const ts = parseInt(sessionStorage.getItem('jt_ts') || '0');
        if (Date.now() - ts > 4 * 60 * 60 * 1000) {
          sessionStorage.removeItem('jt');
          sessionStorage.removeItem('jt_ts');
        } else {
          TOKEN = t;
          try {
            const sr = await fetch(`${API}/api/ui/stats`, {headers: {'Authorization': `Bearer ${TOKEN}`}});
            if (sr.ok) { resetSessionTimer(); await showApp(); return; }
          } catch(e) {}
        }
      }
      showLoginScreen();
    }
  } catch(e) {
    // Fallback: Login zeigen
    showLoginScreen();
  }
}

// ---- Setup: PIN setzen ----
async function doSetup() {
  const pin = document.getElementById('setupPin').value;
  const confirm = document.getElementById('setupPinConfirm').value;
  const err = document.getElementById('setupError');
  err.textContent = '';

  if (pin.length < 4) { err.textContent = 'PIN muss mindestens 4 Zeichen haben'; return; }
  if (pin !== confirm) { err.textContent = 'PINs stimmen nicht ueberein'; return; }

  try {
    const r = await fetch(`${API}/api/ui/setup`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({pin, pin_confirm: confirm})
    });
    const d = await r.json();
    if (!r.ok) { err.textContent = d.detail || 'Fehler'; return; }

    // Recovery-Key anzeigen
    hideAllScreens();
    document.getElementById('recoveryKeyDisplay').textContent = d.recovery_key;
    document.getElementById('recoveryScreen').style.display = 'flex';
  } catch(e) { err.textContent = 'Verbindung fehlgeschlagen'; }
}

function recoveryAcknowledged() {
  hideAllScreens();
  showLoginScreen();
}

// ---- Login ----
function showLoginScreen() {
  hideAllScreens();
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('pinInput').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('pinInput').focus();
}

async function doLogin() {
  const pin = document.getElementById('pinInput').value;
  const err = document.getElementById('loginError');
  err.textContent = '';

  if (!pin) { err.textContent = 'PIN eingeben'; return; }

  try {
    const r = await fetch(`${API}/api/ui/auth`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({pin})
    });
    if (!r.ok) { err.textContent = 'Falscher PIN'; return; }
    const d = await r.json();
    TOKEN = d.token;
    sessionStorage.setItem('jt', TOKEN);
    sessionStorage.setItem('jt_ts', Date.now().toString());
    resetSessionTimer();
    await showApp();
  } catch(e) { err.textContent = 'Verbindung fehlgeschlagen'; }
}

function doLogout() {
  TOKEN = '';
  sessionStorage.removeItem('jt');
  sessionStorage.removeItem('jt_ts');
  sessionStorage.removeItem('jb');
  if (_sessionTimer) { clearTimeout(_sessionTimer); _sessionTimer = null; }
  stopLiveRefresh();
  hideAllScreens();
  showLoginScreen();
}

async function showApp() {
  hideAllScreens();
  // Boot-Animation nur beim ersten Aufruf pro Session
  if (!sessionStorage.getItem('jb')) {
    sessionStorage.setItem('jb', '1');
    await playBootSequence();
  }
  document.getElementById('app').classList.add('active');
  loadDashboard();
  startLiveRefresh();
  loadHealthTrends(_trendHours);
  refreshErrBadge();
}

// ---- PIN Reset ----
function showResetScreen() {
  hideAllScreens();
  document.getElementById('resetScreen').style.display = 'flex';
  document.getElementById('resetRecoveryKey').value = '';
  document.getElementById('resetNewPin').value = '';
  document.getElementById('resetNewPinConfirm').value = '';
  document.getElementById('resetError').textContent = '';
  document.getElementById('resetRecoveryKey').focus();
}

async function doResetPin() {
  const recovery_key = document.getElementById('resetRecoveryKey').value.trim().toUpperCase();
  const new_pin = document.getElementById('resetNewPin').value;
  const new_pin_confirm = document.getElementById('resetNewPinConfirm').value;
  const err = document.getElementById('resetError');
  err.textContent = '';

  if (!recovery_key) { err.textContent = 'Recovery-Key eingeben'; return; }
  if (new_pin.length < 4) { err.textContent = 'PIN muss mindestens 4 Zeichen haben'; return; }
  if (new_pin !== new_pin_confirm) { err.textContent = 'PINs stimmen nicht ueberein'; return; }

  try {
    const r = await fetch(`${API}/api/ui/reset-pin`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({recovery_key, new_pin, new_pin_confirm})
    });
    const d = await r.json();
    if (!r.ok) { err.textContent = d.detail || 'Falscher Recovery-Key'; return; }

    // Neuen Recovery-Key anzeigen
    hideAllScreens();
    document.getElementById('newRecoveryKeyDisplay').textContent = d.recovery_key;
    document.getElementById('newRecoveryScreen').style.display = 'flex';
  } catch(e) { err.textContent = 'Verbindung fehlgeschlagen'; }
}

function newRecoveryAcknowledged() {
  hideAllScreens();
  showLoginScreen();
}

// ---- Init: Setup-Status pruefen ----
checkSetupAndShow();

// ---- API ----
async function api(path, method='GET', body=null) {
  const url = `${API}${path}`;
  const opts = {method, headers:{'Content-Type':'application/json', 'Authorization': `Bearer ${TOKEN}`}};
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(url, opts);
  if (r.status === 401) { doLogout(); throw new Error('Auth'); }
  if (!r.ok) {
    let detail = `HTTP ${r.status}`;
    try { const d = await r.json(); detail = d.detail || detail; } catch(e) {}
    throw new Error(detail);
  }
  try { return await r.json(); }
  catch(e) { throw new Error('Ungueltige Server-Antwort'); }
}

// ---- Navigation ----
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    item.classList.add('active');
    const pg = item.dataset.page;
    document.getElementById(`page-${pg}`).classList.add('active');
    const titles = {dashboard:'Dashboard',settings:'Einstellungen',entities:'Entities',knowledge:'Wissen',logs:'Logs',errors:'Fehler'};
    document.getElementById('pageTitle').textContent = titles[pg] || pg;
    stopLiveRefresh();  // Immer stoppen bei Seitenwechsel
    if (pg==='dashboard') { loadDashboard(); startLiveRefresh(); loadHealthTrends(_trendHours); }
    else if (pg==='settings') loadSettings();
    else if (pg==='entities') loadEntities();
    else if (pg==='knowledge') loadKnowledge();
    else if (pg==='logs') { if(currentLogTab==='audit') loadAudit(); else loadLogs(); }
    else if (pg==='errors') loadErrors();
    document.getElementById('sidebar').classList.remove('open');
  });
});

// ---- Toast ----
let _toastTimer = null;
function toast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast toast-${type} show`;
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ---- Helpers ----
function esc(s) { if (s == null) return ''; const d=document.createElement('div'); d.textContent=String(s); return d.innerHTML.replace(/'/g,'&#39;'); }
function fmtBytes(b) { if(b==null||isNaN(b)) return '0 B'; if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
function getPath(obj,path) { return path.split('.').reduce((o,k)=>o?.[k], obj); }
function setPath(obj,path,val) {
  const parts=path.split('.'); let cur=obj;
  for(let i=0;i<parts.length-1;i++) { if(cur[parts[i]]==null||typeof cur[parts[i]]!=='object') cur[parts[i]]={}; cur=cur[parts[i]]; }
  cur[parts[parts.length-1]]=val;
}
function deepMerge(target, source) {
  for (const key of Object.keys(source)) {
    if (source[key]&&typeof source[key]==='object'&&!Array.isArray(source[key])
        &&target[key]&&typeof target[key]==='object'&&!Array.isArray(target[key])) {
      deepMerge(target[key], source[key]);
    } else {
      target[key] = source[key];
    }
  }
  return target;
}

// ---- Dashboard ----
async function loadDashboard() {
  try {
    const d = await api('/api/ui/stats');
    const mem=d.memory||{}, sem=mem.semantic||{}, kb=d.knowledge_base||{}, auto=d.autonomy||{};
    document.getElementById('dashStats').innerHTML = `
      <div class="stat-card"><div class="stat-label">Fakten</div><div class="stat-value">${sem.total_facts||0}</div>
        <div class="stat-sub">${(sem.persons||[]).length} Personen</div></div>
      <div class="stat-card"><div class="stat-label">Wissensbasis</div><div class="stat-value">${kb.total_chunks||0}</div>
        <div class="stat-sub">${(kb.sources||[]).length} Quellen</div></div>
      <div class="stat-card"><div class="stat-label">Episoden</div><div class="stat-value">${mem.episodic_count||0}</div>
        <div class="stat-sub">Langzeitgedaechtnis</div></div>
      <div class="stat-card"><div class="stat-label">Autonomie</div><div class="stat-value" style="color:var(--accent);">${auto.level||'?'}/5</div>
        <div class="stat-sub">${esc(auto.name||'')}</div></div>`;
    const comps=d.components||{};
    let ch='';
    for(const [n,s] of Object.entries(comps)) {
      const ok=s==='connected'||String(s).includes('active');
      ch+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
        <span style="font-size:12px;">${esc(n)}</span>
        <span style="font-size:11px;color:${ok?'var(--success)':'var(--danger)'};font-family:var(--mono);">${esc(s)}</span></div>`;
    }
    document.getElementById('compList').innerHTML=ch;
    const mood=d.mood||{};
    document.getElementById('moodInfo').innerHTML=`
      <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;">
        <span style="font-size:12px;">Stimmung</span><span style="font-size:12px;color:var(--accent);font-weight:600;">${esc(mood.mood||'neutral')}</span></div>
      <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;">
        <span style="font-size:12px;">Stress</span><span style="font-size:12px;font-family:var(--mono);">${esc((mood.stress_level||0).toFixed(2))}</span></div>
      <div style="padding:8px 0;display:flex;justify-content:space-between;">
        <span style="font-size:12px;">Redis</span><span style="font-size:11px;color:${mem.redis_connected?'var(--success)':'var(--danger)'};">${mem.redis_connected?'Verbunden':'Getrennt'}</span></div>`;
  } catch(e) { console.error('Dashboard fail:', e); }
}

// ---- Live-Status Auto-Refresh ----
let _liveInterval = null;

function startLiveRefresh() {
  stopLiveRefresh();
  refreshLiveStatus();
  _liveInterval = setInterval(refreshLiveStatus, 30000);
}

function stopLiveRefresh() {
  if (_liveInterval) { clearInterval(_liveInterval); _liveInterval = null; }
}

async function refreshLiveStatus() {
  try {
    const d = await api('/api/ui/live-status');
    const dot = document.getElementById('liveIndicator');
    const ts = document.getElementById('liveTimestamp');
    const wb = document.getElementById('whisperBadge');
    if (dot) dot.classList.toggle('offline', !d.components_ok);
    if (ts) ts.textContent = 'Aktualisiert: ' + new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    if (wb) wb.style.display = d.whisper_mode ? '' : 'none';
    const sb = document.getElementById('statusBadge');
    if (sb) { sb.textContent = d.components_ok ? 'Online' : 'Offline'; sb.className = 'badge ' + (d.components_ok ? 'badge-ok' : 'badge-err'); }
    // Mood und Stress im Status-Bereich aktualisieren
    const mi = document.getElementById('moodInfo');
    if (mi && d.mood) {
      const mood = d.mood;
      mi.innerHTML = `
        <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;">
          <span style="font-size:12px;">Stimmung</span><span style="font-size:12px;color:var(--accent);font-weight:600;">${esc(mood.mood||'neutral')}</span></div>
        <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;">
          <span style="font-size:12px;">Stress</span><span style="font-size:12px;font-family:var(--mono);">${esc((mood.stress_level||0).toFixed(2))}</span></div>
        <div style="padding:8px 0;display:flex;justify-content:space-between;">
          <span style="font-size:12px;">Autonomie</span><span style="font-size:12px;color:var(--accent);font-weight:600;">${esc(d.autonomy?.level||'?')}/5</span></div>`;
    }
  } catch(e) {
    const dot = document.getElementById('liveIndicator');
    if (dot) dot.classList.add('offline');
    const sb = document.getElementById('statusBadge');
    if (sb) { sb.textContent = 'Offline'; sb.className = 'badge badge-err'; }
  }
}

// ---- Health Trends ----
let _trendHours = 24;

async function loadHealthTrends(hours) {
  _trendHours = hours || 24;
  // Button aktiv markieren
  document.querySelectorAll('#trendPeriodBar button').forEach(b => {
    b.classList.toggle('active', parseInt(b.textContent)=== hours || (b.textContent==='7 Tage' && hours===168) || (b.textContent==='24h' && hours===24) || (b.textContent==='48h' && hours===48));
  });
  const c = document.getElementById('healthTrendsContainer');
  try {
    const d = await api(`/api/ui/health-trends?hours=${hours}`);
    const current = d.current || {};
    const trends = d.trends || {};
    const sensors = [
      {key:'co2', label:'CO2', unit:'ppm', icon:'&#127811;', goodMax:800, warnMax:1200},
      {key:'temperature', label:'Temperatur', unit:'°C', icon:'&#127777;'},
      {key:'humidity', label:'Luftfeuchtigkeit', unit:'%', icon:'&#128167;', goodMin:40, goodMax:60},
    ];
    let html = '';
    let hasData = false;
    for (const s of sensors) {
      const val = current[s.key];
      const trendData = trends[s.key] || [];
      if (val === undefined && trendData.length === 0) continue;
      hasData = true;
      // Trend-Pfeil berechnen
      let arrow = 'stable', arrowIcon = '&#8594;';
      if (trendData.length >= 2) {
        const recent = trendData[trendData.length-1].value;
        const older = trendData[Math.max(0, trendData.length-3)].value;
        if (recent > older + 1) { arrow='up'; arrowIcon='&#8593;'; }
        else if (recent < older - 1) { arrow='down'; arrowIcon='&#8595;'; }
      }
      // Mini-Sparkline SVG
      let sparkline = '';
      if (trendData.length >= 2) {
        const vals = trendData.map(t => t.value);
        const min = Math.min(...vals), max = Math.max(...vals);
        const range = max - min || 1;
        const w = 120, h = 24;
        const points = vals.map((v, i) => `${(i/(vals.length-1))*w},${h-(((v-min)/range)*h)}`).join(' ');
        sparkline = `<svg class="trend-sparkline" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><polyline points="${points}" fill="none" stroke="var(--accent)" stroke-width="1.5" /></svg>`;
      }
      html += `<div class="trend-row">
        <span class="trend-label">${s.icon} ${s.label}</span>
        <span class="trend-value">${val!==undefined ? (typeof val==='number'?val.toFixed(1):val) : '—'}</span>
        <span class="trend-unit">${s.unit}</span>
        <span class="trend-arrow ${arrow}">${arrowIcon}</span>
        ${sparkline}
        <span style="font-size:10px;color:var(--text-muted);">${trendData.length} Messpunkte</span>
      </div>`;
    }
    if (!hasData) {
      html = '<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:12px;">Keine Sensordaten verfuegbar</div>';
    }
    c.innerHTML = html;
  } catch(e) {
    c.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:12px;">Keine Sensordaten verfuegbar</div>';
  }
}

// ============================================================
//  SETTINGS - 11 Tabs
// ============================================================

let currentTab = 'tab-general';

// Tab switching
document.getElementById('settingsTabBar').addEventListener('click', e => {
  const tab = e.target.closest('.tab-item');
  if (!tab || tab.dataset.tab === currentTab) return;
  // Aktuelle Tab-Werte in S uebernehmen bevor Tab wechselt
  mergeCurrentTabIntoS();
  document.querySelectorAll('#settingsTabBar .tab-item').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  currentTab = tab.dataset.tab;
  renderCurrentTab();
});

function mergeCurrentTabIntoS() {
  try {
    const current = collectSettings();
    deepMerge(S, current);
  } catch(e) { /* Tab noch nicht gerendert */ }
}

async function loadSettings() {
  try {
    S = await api('/api/ui/settings');
    renderCurrentTab();
  } catch(e) { console.error('Settings fail:', e); }
}

function renderCurrentTab() {
  const c = document.getElementById('settingsContent');
  try {
    switch(currentTab) {
      case 'tab-general': c.innerHTML = renderGeneral(); break;
      case 'tab-persons': c.innerHTML = renderPersons(); break;
      case 'tab-personality': c.innerHTML = renderPersonality(); break;
      case 'tab-memory': c.innerHTML = renderMemory(); break;
      case 'tab-mood': c.innerHTML = renderMood(); break;
      case 'tab-rooms': c.innerHTML = renderRooms(); break;
      case 'tab-voice': c.innerHTML = renderVoice(); break;
      case 'tab-routines': c.innerHTML = renderRoutines(); break;
      case 'tab-security': c.innerHTML = renderSecurity(); loadApiKey(); loadNotifyChannels(); break;
      case 'tab-autonomie': c.innerHTML = renderAutonomie(); loadSnapshots(); loadOptStatus(); break;
      case 'tab-eastereggs': c.innerHTML = renderEasterEggs(); loadEasterEggs(); break;
      case 'tab-system': c.innerHTML = renderSystem(); loadSystemStatus(); break;
    }
  } catch(err) {
    c.innerHTML = '<div style="padding:24px;color:var(--danger);"><h3>Rendering-Fehler</h3><pre style="margin-top:12px;font-size:12px;white-space:pre-wrap;">' + esc(err.message) + '\n' + esc(err.stack) + '</pre></div>';
    console.error('Tab render error:', err);
  }
  bindFormEvents();
}

// ---- Form field generators ----
function fText(path, label, hint='', ro=false) {
  const v = getPath(S,path) ?? '';
  return `<div class="form-group"><label>${label}</label>
    <input type="text" data-path="${path}" value="${esc(String(v))}" ${ro?'readonly':''}>${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}
function fNum(path, label, min='', max='', step='1', hint='') {
  const v = getPath(S,path) ?? '';
  return `<div class="form-group"><label>${label}</label>
    <input type="number" data-path="${path}" value="${v}" min="${min}" max="${max}" step="${step}">${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}
function fRange(path, label, min, max, step, labels=null) {
  const v = getPath(S,path) ?? min;
  const lbl = labels ? (labels[v]||v) : v;
  return `<div class="form-group"><label>${label}</label>
    <div class="range-group"><input type="range" data-path="${path}" min="${min}" max="${max}" step="${step}" value="${v}"
      oninput="updRange(this)"><span class="range-value" id="rv_${path.replace(/\./g,'_')}">${lbl}</span></div></div>`;
}
function fToggle(path, label) {
  const v = getPath(S,path);
  return `<div class="form-group"><div class="toggle-group"><label>${label}</label>
    <label class="toggle"><input type="checkbox" data-path="${path}" ${v?'checked':''}><span class="toggle-track"></span><span class="toggle-thumb"></span></label></div></div>`;
}
function fSelect(path, label, opts) {
  const v = getPath(S,path) ?? '';
  let h = `<div class="form-group"><label>${label}</label><select data-path="${path}">`;
  for(const o of opts) h += `<option value="${o.v}" ${v==o.v?'selected':''}>${o.l}</option>`;
  return h + `</select></div>`;
}
function fKeywords(path, label) {
  const arr = getPath(S,path) || [];
  let tags = arr.map(k => `<span class="kw-tag">${esc(k)}<span class="kw-rm" onclick="rmKw(this,'${path}')">&#10005;</span></span>`).join('');
  return `<div class="form-group"><label>${label}</label>
    <div class="kw-editor" data-path="${path}" onclick="this.querySelector('input').focus()">
      ${tags}<input class="kw-input" placeholder="+ hinzufuegen..." onkeydown="addKw(event,this,'${path}')">
    </div></div>`;
}
function fTextarea(path, label, hint='') {
  const v = getPath(S,path);
  const isArr = Array.isArray(v);
  const isObj = v && typeof v === 'object' && !isArr;
  const txt = isArr ? v.join('\n') : (isObj ? JSON.stringify(v,null,2) : String(v??''));
  const dtype = isArr ? 'array' : (isObj ? 'json' : 'text');
  return `<div class="form-group"><label>${label}</label>
    <textarea data-path="${path}" data-type="${dtype}">${esc(txt)}</textarea>${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}

// Klickbare Chip-Auswahl (vordefinierte Optionen zum An/Abklicken)
function fChipSelect(path, label, options, hint='') {
  const arr = getPath(S, path) || [];
  let chips = options.map(opt => {
    const val = typeof opt === 'string' ? opt : opt.v;
    const lbl = typeof opt === 'string' ? opt : opt.l;
    const sel = arr.includes(val) ? 'selected' : '';
    return `<span class="chip-opt ${sel}" data-chip-path="${path}" data-chip-val="${esc(val)}" onclick="toggleChip('${path}','${esc(val)}')">${esc(lbl)}</span>`;
  }).join('');
  // Auch custom Werte anzeigen die nicht in options sind
  const optValues = options.map(o => typeof o === 'string' ? o : o.v);
  arr.filter(v => !optValues.includes(v)).forEach(v => {
    chips += `<span class="chip-opt selected" data-chip-path="${path}" data-chip-val="${esc(v)}" onclick="toggleChip('${path}','${esc(v)}')">${esc(v)}</span>`;
  });
  return `<div class="form-group"><label>${label}</label>
    <div class="chip-grid" data-path="${path}">${chips}</div>
    ${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}

function toggleChip(path, value) {
  mergeCurrentTabIntoS();
  const arr = getPath(S, path) || [];
  const idx = arr.indexOf(value);
  if (idx >= 0) arr.splice(idx, 1); else arr.push(value);
  setPath(S, path, arr);
  renderCurrentTab();
}

// Modell-Auswahl als Dropdown
function fModelSelect(path, label, hint='') {
  const v = getPath(S, path) ?? '';
  const models = [
    {v:'qwen3:4b', l:'Qwen3 4B (Schnell)'},
    {v:'qwen3:8b', l:'Qwen3 8B (Ausgewogen)'},
    {v:'qwen3:14b', l:'Qwen3 14B (Smart)'},
    {v:'qwen3:32b', l:'Qwen3 32B (Deep)'},
    {v:'llama3.2:3b', l:'Llama 3.2 3B'},
    {v:'llama3.1:8b', l:'Llama 3.1 8B'},
    {v:'gemma3:4b', l:'Gemma3 4B'},
    {v:'gemma3:12b', l:'Gemma3 12B'},
    {v:'gemma3:27b', l:'Gemma3 27B'},
    {v:'phi4:14b', l:'Phi4 14B'},
    {v:'mistral:7b', l:'Mistral 7B'},
    {v:'deepseek-r1:14b', l:'DeepSeek-R1 14B'},
    {v:'deepseek-r1:32b', l:'DeepSeek-R1 32B'},
  ];
  // Aktuellen Wert in Liste sicherstellen
  const hasVal = models.some(m => m.v === v);
  let h = `<div class="form-group"><label>${label}</label><select data-path="${path}">`;
  if (!hasVal && v) h += `<option value="${esc(v)}" selected>${esc(v)}</option>`;
  for (const m of models) h += `<option value="${m.v}" ${v===m.v?'selected':''}>${m.l}</option>`;
  return h + `</select>${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}

// Info-Box
function fInfo(text) {
  return `<div class="info-box"><span class="info-icon">&#128161;</span>${text}</div>`;
}

function sectionWrap(icon, title, content) {
  return `<div class="s-section"><div class="s-section-hdr open" onclick="toggleSec(this)">
    <h3>${icon} ${title}</h3><span class="arrow">&#9660;</span></div>
    <div class="s-section-body open">${content}</div></div>`;
}

function updRange(el) {
  const path = el.dataset.path;
  document.getElementById('rv_'+path.replace(/\./g,'_')).textContent = el.value;
}
function toggleSec(hdr) { hdr.classList.toggle('open'); hdr.nextElementSibling.classList.toggle('open'); }

function addKw(e, input, path) {
  if (e.key !== 'Enter' || !input.value.trim()) return;
  e.preventDefault();
  mergeCurrentTabIntoS();
  const arr = getPath(S, path) || [];
  const val = input.value.trim();
  if (!arr.includes(val)) {
    arr.push(val);
    setPath(S, path, arr);
    renderCurrentTab();
  }
}
function rmKw(el, path) {
  mergeCurrentTabIntoS();
  const tag = el.parentElement;
  const word = tag.textContent.replace('✕','').trim();
  const arr = (getPath(S, path) || []).filter(k => k !== word);
  setPath(S, path, arr);
  renderCurrentTab();
}

function bindFormEvents() {
  // no-op: we collect on save
}

// ---- Tab 1: Allgemein ----
function renderGeneral() {
  return sectionWrap('&#9881;', 'Assistent',
    fInfo('Grundeinstellungen fuer deinen Assistenten — Name, Sprache und Version.') +
    fText('assistant.name', 'Name', 'So stellt sich der Assistent vor') +
    fText('assistant.version', 'Version', '', true) +
    fSelect('assistant.language', 'Sprache', [{v:'de',l:'Deutsch'},{v:'en',l:'English'}])
  ) +
  sectionWrap('&#9889;', 'Autonomie',
    fInfo('Wie selbststaendig darf der Assistent handeln? Je hoeher, desto mehr macht er eigenstaendig.') +
    fRange('autonomy.level', 'Autonomie-Level', 1, 5, 1, {1:'Assistent',2:'Butler',3:'Mitbewohner',4:'Vertrauter',5:'Autopilot'})
  ) +
  sectionWrap('&#129302;', 'Modell-Routing',
    fInfo('Welche KI-Modelle sollen fuer welche Aufgaben genutzt werden? Deaktivierte Modelle werden uebersprungen — Fallback auf das naechstkleinere.') +
    fToggle('models.enabled.fast', 'Fast — Einfache Befehle (Licht an, Timer, etc.)') +
    fToggle('models.enabled.smart', 'Smart — Konversation & Standardanfragen') +
    fToggle('models.enabled.deep', 'Deep — Komplexe Analyse & Planung') +
    fModelSelect('models.fast', 'Fast-Modell', 'Fuer schnelle, einfache Befehle') +
    fModelSelect('models.smart', 'Smart-Modell', 'Fuer normale Gespraeche') +
    fModelSelect('models.deep', 'Deep-Modell', 'Fuer komplexe Aufgaben') +
    fRange('models.deep_min_words', 'Deep ab Woertern', 5, 50, 1, {5:'5',10:'10',15:'15',20:'20',25:'25',30:'30',35:'35',40:'40',45:'45',50:'50'}) +
    fRange('models.options.temperature', 'Kreativitaet (Temperatur)', 0, 2, 0.1, {0:'Exakt',0.5:'Konservativ',0.7:'Standard',1:'Kreativ',1.5:'Sehr kreativ',2:'Maximum'}) +
    fRange('models.options.max_tokens', 'Antwortlaenge (Max Tokens)', 64, 4096, 64)
  ) +
  sectionWrap('&#127991;', 'Schnell-Erkennung',
    fInfo('Klicke auf Woerter, die das jeweilige Modell ausloesen sollen. Ausgewaehlte Woerter sind hervorgehoben.') +
    fChipSelect('models.fast_keywords', 'Fast-Keywords — Woerter fuer schnelle Antworten', [
      'licht','lampe','an','aus','timer','stopp','danke','ja','nein','ok','stop',
      'wecker','alarm','pause','weiter','leiser','lauter','heller','dunkler',
      'rolladen','hoch','runter','temperatur','heizung','musik'
    ]) +
    fChipSelect('models.deep_keywords', 'Deep-Keywords — Woerter fuer ausfuehrliche Analyse', [
      'warum','erklaere','vergleiche','analysiere','plane','zusammenfassung',
      'recherchiere','berechne','strategie','vor- und nachteile','unterschied',
      'optimiere','hilf mir bei','was meinst du','ueberblick'
    ]) +
    fChipSelect('models.cooking_keywords', 'Koch-Keywords — Woerter die den Koch-Modus aktivieren', [
      'rezept','kochen','backen','zubereiten','gericht','essen','zutaten',
      'portion','mahlzeit','fruehstueck','mittagessen','abendessen','snack',
      'dessert','kuchen','suppe','salat','pizza','pasta','sauce'
    ])
  ) +
  sectionWrap('&#128274;', 'Dashboard & PIN',
    fInfo('Der Zugang zum Dashboard ist mit einer PIN geschuetzt. Der Recovery-Key wird benoetigt wenn du die PIN vergisst.') +
    '<div class="form-group"><label>PIN-Schutz</label>' +
    '<p style="font-size:12px;color:var(--success);margin-bottom:8px;">PIN ist gesetzt und aktiv</p>' +
    '<p style="font-size:11px;color:var(--text-muted);margin-bottom:12px;">PIN aendern: "PIN vergessen?" auf dem Login-Screen nutzen.</p></div>' +
    '<div class="form-group"><label>Recovery-Key</label>' +
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Falls du deine PIN vergisst, brauchst du diesen Key zum Zuruecksetzen. Sicher aufbewahren!</p>' +
    '<div style="display:flex;gap:8px;align-items:center;">' +
    '<input type="text" id="recoveryKeyDisplay" readonly style="flex:1;font-family:var(--mono);font-size:14px;letter-spacing:2px;text-align:center;" value="Versteckt — Klicke Generieren" />' +
    '<button class="btn btn-primary" onclick="regenerateRecoveryKey()" style="white-space:nowrap;">Neu generieren</button>' +
    '</div>' +
    '<p style="font-size:11px;color:var(--danger);margin-top:6px;">Nach dem Generieren wird der Key nur EINMAL angezeigt. Notiere ihn sofort!</p>' +
    '</div>'
  );
}

// ---- Tab: Personen & Haushalt ----
function renderPersons() {
  const members = getPath(S, 'household.members') || [];
  const primaryUser = getPath(S, 'household.primary_user') || '';

  const roleInfo = {
    owner: {icon:'&#128081;', color:'var(--accent)', desc:'Voller Zugriff inkl. Sicherheit'},
    member: {icon:'&#128100;', color:'var(--blue)', desc:'Alles ausser Sicherheit'},
    guest: {icon:'&#128587;', color:'var(--text-muted)', desc:'Nur Licht, Klima, Medien'}
  };

  let memberRows = '';
  members.forEach((m, i) => {
    const ri = roleInfo[m.role] || roleInfo.member;
    memberRows += `<div class="person-row" style="display:flex;gap:10px;align-items:center;margin-bottom:10px;padding:12px;background:var(--bg-secondary);border-radius:var(--radius-sm);border-left:3px solid ${ri.color};">
      <span style="font-size:20px;">${ri.icon}</span>
      <input type="text" value="${esc(m.name || '')}" data-member-idx="${i}" data-member-field="name"
        placeholder="Name eingeben..." style="flex:1;font-size:14px;">
      <select data-member-idx="${i}" data-member-field="role" style="width:160px;" onchange="mergeCurrentTabIntoS();renderCurrentTab()">
        <option value="owner" ${m.role==='owner'?'selected':''}>&#128081; Hausherr/in</option>
        <option value="member" ${m.role==='member'?'selected':''}>&#128100; Mitbewohner/in</option>
        <option value="guest" ${m.role==='guest'?'selected':''}>&#128587; Gast</option>
      </select>
      <button class="btn btn-danger btn-sm" onclick="removeHouseholdMember(${i})"
        style="padding:6px 10px;min-width:auto;" title="Entfernen">&#128465;</button>
    </div>`;
  });

  return sectionWrap('&#128100;', 'Hauptbenutzer',
    fInfo('Dein Name — so kennt und begruesst dich der Assistent.') +
    '<div class="form-group"><label>Dein Name</label>' +
    '<input type="text" data-path="household.primary_user" value="' + esc(primaryUser) + '" placeholder="z.B. Alex" style="font-size:15px;">' +
    '</div>'
  ) +
  sectionWrap('&#128106;', 'Haushaltsmitglieder',
    fInfo('Alle Personen im Haushalt. Die Rolle bestimmt was jeder steuern darf.') +
    '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;">' +
    '<div style="padding:8px 12px;background:var(--accent-dim);border-radius:6px;font-size:11px;text-align:center;"><b>&#128081; Hausherr/in</b><br>Voller Zugriff</div>' +
    '<div style="padding:8px 12px;background:var(--blue-dim);border-radius:6px;font-size:11px;text-align:center;"><b>&#128100; Mitbewohner/in</b><br>Alles ausser Sicherheit</div>' +
    '<div style="padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:6px;font-size:11px;text-align:center;"><b>&#128587; Gast</b><br>Nur Licht, Klima, Medien</div>' +
    '</div>' +
    '<div id="householdMembers">' + memberRows + '</div>' +
    '<button class="btn btn-secondary" onclick="addHouseholdMember()" style="margin-top:8px;width:100%;justify-content:center;">+ Person hinzufuegen</button>'
  );
}

function addHouseholdMember() {
  mergeCurrentTabIntoS();
  const members = getPath(S, 'household.members') || [];
  members.push({name: '', role: 'member'});
  setPath(S, 'household.members', members);
  renderCurrentTab();
}

function removeHouseholdMember(idx) {
  mergeCurrentTabIntoS();
  const members = getPath(S, 'household.members') || [];
  members.splice(idx, 1);
  setPath(S, 'household.members', members);
  renderCurrentTab();
}

function collectHouseholdMembers() {
  const members = [];
  document.querySelectorAll('#householdMembers .person-row').forEach(row => {
    const nameEl = row.querySelector('[data-member-field="name"]');
    const roleEl = row.querySelector('[data-member-field="role"]');
    if (nameEl && roleEl && nameEl.value.trim()) {
      members.push({name: nameEl.value.trim(), role: roleEl.value});
    }
  });
  return members;
}

// ---- Tab 2: Persoenlichkeit ----
function renderPersonality() {
  const styleOpts = [
    {v:'minimal',l:'Minimal — Kurz und praezise'},
    {v:'verschlafen',l:'Verschlafen — Ruhig, wenig Worte'},
    {v:'knapp',l:'Knapp — Auf den Punkt'},
    {v:'freundlich',l:'Freundlich — Warm und einladend'},
    {v:'butler',l:'Butler — Formell und elegant'},
    {v:'entspannt',l:'Entspannt — Locker und gemuetlich'},
    {v:'sachlich',l:'Sachlich — Neutral und informativ'},
    {v:'warm',l:'Warm — Herzlich und persoenlich'},
    {v:'muede',l:'Muede — Kurz, leise, sanft'}
  ];
  return sectionWrap('&#127917;', 'Stil & Charakter',
    fInfo('Wie soll sich der Assistent verhalten? Stil, Humor und Meinungsfreude einstellen.') +
    fSelect('personality.style', 'Grundstil', styleOpts) +
    fRange('personality.sarcasm_level', 'Sarkasmus-Level', 1, 5, 1, {1:'Sachlich',2:'Gelegentl. trocken',3:'Standard Butler',4:'Haeufig',5:'Vollgas Ironie'}) +
    fRange('personality.opinion_intensity', 'Meinungs-Intensitaet', 0, 3, 1, {0:'Still',1:'Selten',2:'Gelegentlich',3:'Redselig'}) +
    fToggle('personality.self_irony_enabled', 'Selbstironie aktiviert') +
    fRange('personality.self_irony_max_per_day', 'Max. Selbstironie pro Tag', 0, 20, 1)
  ) +
  sectionWrap('&#128200;', 'Charakter-Entwicklung',
    fInfo('Der Assistent wird mit der Zeit weniger formell — wie ein echter Butler, der seinen Herrn kennenlernt.') +
    fToggle('personality.character_evolution', 'Charakter entwickelt sich ueber Zeit') +
    fRange('personality.formality_start', 'Formalitaet am Anfang', 0, 100, 5, {0:'Sehr locker',25:'Locker',50:'Normal',75:'Formell',100:'Sehr formell'}) +
    fRange('personality.formality_min', 'Minimale Formalitaet', 0, 100, 5, {0:'Sehr locker',25:'Locker',50:'Normal',75:'Formell',100:'Sehr formell'}) +
    fRange('personality.formality_decay_per_day', 'Abbau pro Tag', 0, 5, 0.1)
  ) +
  sectionWrap('&#128336;', 'Tageszeit-Stile',
    fInfo('Der Assistent passt seinen Stil je nach Tageszeit an. Waehle fuer jede Zeit einen passenden Stil und maximale Satzlaenge.') +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#127749; Fruehmorgens (05:00 - 08:00)</div>' +
    fSelect('personality.time_layers.early_morning.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.early_morning.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>' +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#9728; Morgens (08:00 - 12:00)</div>' +
    fSelect('personality.time_layers.morning.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.morning.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>' +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#127774; Nachmittags (12:00 - 18:00)</div>' +
    fSelect('personality.time_layers.afternoon.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.afternoon.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>' +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#127751; Abends (18:00 - 22:00)</div>' +
    fSelect('personality.time_layers.evening.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.evening.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>' +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#127769; Nachts (22:00 - 05:00)</div>' +
    fSelect('personality.time_layers.night.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.night.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>'
  );
}

// ---- Tab 3: Gedaechtnis ----
function renderMemory() {
  return sectionWrap('&#128065;', 'Semantisches Gedaechtnis',
    fInfo('Der Assistent merkt sich Fakten aus Gespraechen — z.B. "Du trinkst gern Kaffee". Hier steuerst du, wie das funktioniert.') +
    fToggle('memory.extraction_enabled', 'Fakten automatisch aus Gespraechen lernen') +
    fRange('memory.extraction_min_words', 'Min. Nachrichtenlaenge fuer Extraktion', 1, 20, 1) +
    fModelSelect('memory.extraction_model', 'Modell fuer Fakten-Extraktion') +
    fRange('memory.extraction_temperature', 'Extraktions-Genauigkeit', 0, 1, 0.1, {0:'Sehr exakt',0.1:'Exakt',0.3:'Normal',0.5:'Flexibel',0.7:'Kreativ',1:'Sehr kreativ'}) +
    fRange('memory.extraction_max_tokens', 'Max. Antwortlaenge Extraktion', 64, 2048, 64) +
    fRange('memory.max_person_facts_in_context', 'Personen-Fakten im Gespraech', 1, 20, 1) +
    fRange('memory.max_relevant_facts_in_context', 'Relevante Fakten im Gespraech', 1, 10, 1) +
    fRange('memory.min_confidence_for_context', 'Min. Sicherheit fuer Nutzung', 0, 1, 0.05, {0:'Alles nutzen',0.3:'Niedrig',0.5:'Mittel',0.6:'Standard',0.8:'Hoch',1:'Nur sichere'}) +
    fRange('memory.duplicate_threshold', 'Duplikat-Erkennung', 0, 1, 0.05, {0:'Streng',0.5:'Mittel',0.8:'Locker',1:'Aus'}) +
    fRange('memory.episode_min_words', 'Min. Woerter fuer Episode', 1, 20, 1) +
    fRange('memory.default_confidence', 'Standard-Sicherheit neuer Fakten', 0, 1, 0.05)
  ) +
  sectionWrap('&#128218;', 'Wissensdatenbank (RAG)',
    fInfo('Eigene Dokumente als Wissensquelle. Dateien in config/knowledge/ werden automatisch eingelesen.') +
    fToggle('knowledge_base.enabled', 'Wissensdatenbank aktiv') +
    fToggle('knowledge_base.auto_ingest', 'Automatisch beim Start einlesen') +
    fRange('knowledge_base.chunk_size', 'Textblock-Groesse', 100, 2000, 50, {100:'Klein (100)',300:'Mittel (300)',500:'Standard (500)',1000:'Gross (1000)',2000:'Sehr gross (2000)'}) +
    fRange('knowledge_base.chunk_overlap', 'Ueberlappung zwischen Bloecken', 0, 500, 25) +
    fRange('knowledge_base.max_distance', 'Suchgenauigkeit', 0.5, 2, 0.1, {0.5:'Sehr genau',1:'Standard',1.5:'Breit',2:'Sehr breit'}) +
    fRange('knowledge_base.search_limit', 'Max. Treffer pro Suche', 1, 10, 1) +
    fChipSelect('knowledge_base.supported_extensions', 'Unterstuetzte Dateitypen', [
      '.txt','.md','.pdf','.csv','.json','.yaml','.yml','.xml','.html','.log','.doc','.docx'
    ], 'Welche Dateitypen sollen eingelesen werden?')
  ) +
  sectionWrap('&#128221;', 'Korrektur-Lernen',
    fInfo('Wenn du den Assistenten korrigierst, merkt er sich das. Wie sicher soll er sich bei Korrekturen sein?') +
    fRange('correction.confidence', 'Sicherheit bei Korrekturen', 0, 1, 0.05, {0:'Unsicher',0.5:'Mittel',0.8:'Sicher',0.95:'Sehr sicher',1:'Absolut sicher'}) +
    fModelSelect('correction.model', 'Modell fuer Korrektur-Analyse') +
    fRange('correction.temperature', 'Analyse-Kreativitaet', 0, 1, 0.1, {0:'Exakt',0.3:'Normal',0.5:'Flexibel',1:'Kreativ'})
  ) +
  sectionWrap('&#128197;', 'Tages-Zusammenfassung',
    fInfo('Automatische Zusammenfassungen des Tages, der Woche und des Monats.') +
    fRange('summarizer.run_hour', 'Uhrzeit (Stunde)', 0, 23, 1) +
    fRange('summarizer.run_minute', 'Uhrzeit (Minute)', 0, 59, 1) +
    fModelSelect('summarizer.model', 'Zusammenfassungs-Modell') +
    fRange('summarizer.max_tokens_daily', 'Laenge taeglich', 128, 2048, 64) +
    fRange('summarizer.max_tokens_weekly', 'Laenge woechentlich', 128, 2048, 64) +
    fRange('summarizer.max_tokens_monthly', 'Laenge monatlich', 128, 2048, 64)
  ) +
  sectionWrap('&#128172;', 'Kontext',
    fInfo('Wie viel Gespraechsverlauf soll der Assistent bei jeder Antwort beruecksichtigen?') +
    fRange('context.recent_conversations', 'Letzte Gespraeche merken', 1, 20, 1) +
    fRange('context.api_timeout', 'Wartezeit fuer Antworten (Sek.)', 1, 30, 1)
  );
}

// ---- Tab 4: Stimmung ----
function renderMood() {
  return sectionWrap('&#128578;', 'Stimmungserkennung',
    fInfo('Der Assistent erkennt deine Stimmung anhand von Worten und Sprechgeschwindigkeit und passt seine Antworten an.') +
    fRange('mood.rapid_command_seconds', 'Schnelle Befehle erkennen (Sek.)', 1, 30, 1, {1:'1s',5:'5s',10:'10s',15:'15s',30:'30s'}) +
    fRange('mood.stress_decay_seconds', 'Stress-Abbau nach (Sek.)', 60, 600, 30, {60:'1 Min',120:'2 Min',180:'3 Min',300:'5 Min',600:'10 Min'}) +
    fRange('mood.frustration_threshold', 'Frustrations-Schwelle', 1, 10, 1, {1:'Empfindlich',3:'Normal',5:'Geduldig',7:'Sehr geduldig',10:'Ignorieren'}) +
    fRange('mood.tired_hour_start', 'Muede ab Uhrzeit', 0, 23, 1) +
    fRange('mood.tired_hour_end', 'Muede bis Uhrzeit', 0, 23, 1)
  ) +
  sectionWrap('&#9889;', 'Stress-Einfluss',
    fInfo('Wie stark beeinflussen verschiedene Signale den erkannten Stresslevel?') +
    fRange('mood.rapid_command_stress_boost', 'Schnelle Befehle hintereinander', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.positive_stress_reduction', 'Positive Worte reduzieren Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.negative_stress_boost', 'Negative Worte erhoehen Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.impatient_stress_boost', 'Ungeduld erhoeht Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.tired_boost', 'Muedigkeit erhoeht Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.repetition_stress_boost', 'Wiederholungen erhoehen Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'})
  ) +
  sectionWrap('&#128172;', 'Stimmungs-Erkennung — Woerter',
    fInfo('Klicke auf Woerter, die der Assistent als Stimmungssignal erkennen soll.') +
    fChipSelect('mood.positive_keywords', 'Positive Stimmung', [
      'danke','super','toll','perfekt','genau','klasse','wunderbar','prima',
      'cool','nice','geil','mega','hammer','top','gut gemacht','bravo',
      'lieb','freut mich','ausgezeichnet','fantastisch','herrlich'
    ]) +
    fChipSelect('mood.negative_keywords', 'Negative Stimmung', [
      'mist','scheisse','nein','falsch','schlecht','nervig','bloed',
      'egal','vergiss es','lass','stopp','aufhoeren','genug',
      'katastrophe','furchtbar','schrecklich','idiot','dumm'
    ]) +
    fChipSelect('mood.impatient_keywords', 'Ungeduld', [
      'schnell','sofort','jetzt','beeil dich','mach schon','hurry',
      'los','tempo','endlich','wird das noch','wie lange noch',
      'komm schon','beeilung','dalli','zack zack'
    ]) +
    fChipSelect('mood.tired_keywords', 'Muedigkeit', [
      'muede','schlafen','gute nacht','schlaf','bett','gaehnen',
      'erschoepft','fertig','kaputt','ausgelaugt','matt',
      'pennen','heia','einschlafen','nachts'
    ])
  ) +
  sectionWrap('&#127908;', 'Stimm-Analyse',
    fInfo('Der Assistent erkennt anhand deiner Sprechgeschwindigkeit ob du gestresst, muede oder entspannt bist.') +
    fToggle('voice_analysis.enabled', 'Stimm-Analyse aktiv') +
    fRange('voice_analysis.wpm_fast', 'Schnelles Sprechen ab (WPM)', 100, 300, 10, {100:'100',150:'150',180:'180',200:'200',250:'250',300:'300'}) +
    fRange('voice_analysis.wpm_slow', 'Langsames Sprechen unter (WPM)', 30, 150, 10, {30:'30',60:'60',80:'80',100:'100',120:'120',150:'150'}) +
    fRange('voice_analysis.wpm_normal', 'Normales Sprechtempo (WPM)', 50, 200, 10, {50:'50',80:'80',100:'100',120:'120',150:'150',200:'200'}) +
    fToggle('voice_analysis.use_whisper_metadata', 'Whisper-Metadaten nutzen') +
    fRange('voice_analysis.voice_weight', 'Stimm-Gewichtung', 0, 1, 0.05, {0:'Ignorieren',0.25:'Schwach',0.5:'Mittel',0.75:'Stark',1:'Voll'})
  );
}

// ---- Tab 5: Raeume ----
function renderRooms() {
  return sectionWrap('&#127968;', 'Multi-Room',
    fInfo('Der Assistent erkennt in welchem Raum du bist und antwortet dort. Praesenz-Timeout = wie lange er dich in einem Raum "merkt".') +
    fToggle('multi_room.enabled', 'Multi-Room Erkennung aktiv') +
    fRange('multi_room.presence_timeout_minutes', 'Praesenz-Timeout', 1, 60, 1, {1:'1 Min',5:'5 Min',10:'10 Min',15:'15 Min',30:'30 Min',60:'1 Std'})
  ) +
  sectionWrap('&#128266;', 'Raum-Speaker',
    fInfo('Welcher Lautsprecher gehoert zu welchem Raum? Format: raumname: media_player.entity_id (ein Eintrag pro Zeile)') +
    fTextarea('multi_room.room_speakers', 'Speaker-Zuordnung', 'z.B. wohnzimmer: media_player.wohnzimmer_speaker')
  ) +
  sectionWrap('&#128694;', 'Raum-Bewegungsmelder',
    fInfo('Welcher Bewegungsmelder gehoert zu welchem Raum? Damit weiss der Assistent wo du bist.') +
    fTextarea('multi_room.room_motion_sensors', 'Bewegungsmelder-Zuordnung', 'z.B. wohnzimmer: binary_sensor.motion_wohnzimmer')
  ) +
  sectionWrap('&#127916;', 'Aktivitaets-Sensoren',
    fInfo('Welche Home Assistant Entities sollen fuer die Aktivitaetserkennung genutzt werden? Gehe zu "Entities" im Seitenmenue um IDs nachzuschlagen.') +
    fKeywords('activity.entities.media_players', 'Media Player (z.B. media_player.tv)') +
    fKeywords('activity.entities.mic_sensors', 'Mikrofon-Sensoren') +
    fKeywords('activity.entities.bed_sensors', 'Bett-Sensoren (Schlaf-Erkennung)') +
    fKeywords('activity.entities.pc_sensors', 'PC-Sensoren (Arbeit-Erkennung)')
  ) +
  sectionWrap('&#9200;', 'Aktivitaets-Zeiten',
    fInfo('Wann ist Nacht? Ab wann zaehlt Besuch? Wie lange muss Fokus dauern?') +
    fRange('activity.thresholds.night_start', 'Nacht beginnt um', 0, 23, 1) +
    fRange('activity.thresholds.night_end', 'Nacht endet um', 0, 23, 1) +
    fRange('activity.thresholds.guest_person_count', 'Besuch ab Personen', 1, 10, 1) +
    fRange('activity.thresholds.focus_min_minutes', 'Fokus-Modus ab Minuten', 5, 120, 5, {5:'5 Min',15:'15 Min',30:'30 Min',60:'1 Std',120:'2 Std'})
  ) +
  sectionWrap('&#128101;', 'Personen-Profile',
    fInfo('Erweiterte Einstellungen pro Person — Benachrichtigungs-Service und bevorzugter Raum.') +
    fTextarea('person_profiles.profiles', 'Profile', 'z.B. alex: {notify_service: notify.mobile, preferred_room: wohnzimmer}')
  );
}

// ---- Tab 6: Stimme ----
function renderVoice() {
  const soundOpts = [
    {v:'',l:'Kein Sound'},
    {v:'listening',l:'Zuhoeren-Ton'},
    {v:'confirmed',l:'Bestaetigung'},
    {v:'warning',l:'Warnung'},
    {v:'alarm',l:'Alarm'},
    {v:'doorbell',l:'Tuerklingel'},
    {v:'greeting',l:'Begruessung'},
    {v:'error',l:'Fehler'},
    {v:'goodnight',l:'Gute Nacht'},
    {v:'chime',l:'Glockenspiel'},
    {v:'notification',l:'Benachrichtigung'}
  ];
  return sectionWrap('&#128266;', 'Sprachausgabe (TTS)',
    fInfo('Wie schnell und mit welchen Pausen soll der Assistent sprechen?') +
    fToggle('tts.ssml_enabled', 'Fortgeschrittene Betonung (SSML)') +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Sprechgeschwindigkeit pro Situation</div>' +
    fRange('tts.speed.confirmation', 'Bestaetigung', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.warning', 'Warnung', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.briefing', 'Briefing', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.greeting', 'Begruessung', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.question', 'Frage', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.casual', 'Normal', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Sprechpausen</div>' +
    fRange('tts.pauses.before_important', 'Vor wichtigen Infos (ms)', 0, 1000, 50) +
    fRange('tts.pauses.between_sentences', 'Zwischen Saetzen (ms)', 0, 1000, 50) +
    fRange('tts.pauses.after_greeting', 'Nach Begruessung (ms)', 0, 1000, 50) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Fluestern</div>' +
    fChipSelect('tts.whisper_triggers', 'Fluestern aktivieren bei', [
      'psst','leise','fluestern','schlafen','baby','schlaf','ruhe',
      'still','shh','nachts','nacht'
    ]) +
    fChipSelect('tts.whisper_cancel_triggers', 'Fluestern beenden bei', [
      'normal','laut','aufwachen','morgen','wach','genug gefluestert'
    ])
  ) +
  sectionWrap('&#128264;', 'Lautstaerke',
    fInfo('Lautstaerke je nach Tageszeit. 0 = stumm, 1 = volle Lautstaerke.') +
    fRange('volume.day', '&#9728; Tag', 0, 1, 0.05) +
    fRange('volume.evening', '&#127751; Abend', 0, 1, 0.05) +
    fRange('volume.night', '&#127769; Nacht', 0, 1, 0.05) +
    fRange('volume.sleeping', '&#128164; Schlafen', 0, 1, 0.05) +
    fRange('volume.emergency', '&#128680; Notfall', 0, 1, 0.05) +
    fRange('volume.whisper', '&#129296; Fluestern', 0, 1, 0.05) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Tageszeit-Wechsel</div>' +
    fRange('volume.morning_start', 'Morgen ab', 0, 23, 1) +
    fRange('volume.evening_start', 'Abend ab', 0, 23, 1) +
    fRange('volume.night_start', 'Nacht ab', 0, 23, 1)
  ) +
  sectionWrap('&#127925;', 'Sound-Effekte',
    fInfo('Kurze Toene bei bestimmten Ereignissen. Deaktiviere Sounds komplett oder waehle pro Ereignis.') +
    fToggle('sounds.enabled', 'Sound-Effekte aktiv') +
    fSelect('sounds.events.listening', 'Zuhoeren-Sound', soundOpts) +
    fSelect('sounds.events.confirmed', 'Bestaetigung-Sound', soundOpts) +
    fSelect('sounds.events.warning', 'Warnung-Sound', soundOpts) +
    fSelect('sounds.events.alarm', 'Alarm-Sound', soundOpts) +
    fSelect('sounds.events.doorbell', 'Tuerklingel-Sound', soundOpts) +
    fSelect('sounds.events.greeting', 'Begruessung-Sound', soundOpts) +
    fSelect('sounds.events.error', 'Fehler-Sound', soundOpts) +
    fSelect('sounds.events.goodnight', 'Gute-Nacht-Sound', soundOpts) +
    fRange('sounds.night_volume_factor', 'Nacht-Lautstaerke-Faktor', 0, 1, 0.1, {0:'Stumm',0.3:'Leise',0.5:'Halb',0.7:'Etwas leiser',1:'Normal'})
  ) +
  sectionWrap('&#127916;', 'Szenen-Uebergaenge',
    fInfo('Wie lange dauert der Uebergang bei Szenen-Wechsel? (z.B. Licht dimmen fuer Filmabend)') +
    fToggle('narration.enabled', 'Szenen-Narration aktiv') +
    fRange('narration.default_transition', 'Standard (Sek.)', 1, 20, 1) +
    fRange('narration.scene_transitions.filmabend', 'Filmabend (Sek.)', 1, 30, 1) +
    fRange('narration.scene_transitions.gute_nacht', 'Gute Nacht (Sek.)', 1, 30, 1) +
    fRange('narration.scene_transitions.aufwachen', 'Aufwachen (Sek.)', 1, 30, 1) +
    fRange('narration.scene_transitions.gemuetlich', 'Gemuetlich (Sek.)', 1, 30, 1) +
    fRange('narration.step_delay', 'Verzoegerung zwischen Schritten (Sek.)', 0, 10, 0.5) +
    fToggle('narration.narrate_actions', 'Aktionen ansagen ("Licht wird gedimmt...")')
  ) +
  sectionWrap('&#128100;', 'Sprecher-Erkennung',
    fInfo('Erkennt wer spricht und passt die Antwort an. Jede Person muss einmalig "eingelernt" werden.') +
    fToggle('speaker_recognition.enabled', 'Sprecher-Erkennung aktiv') +
    fRange('speaker_recognition.min_confidence', 'Erkennungs-Sicherheit', 0, 1, 0.05, {0:'Jeder',0.3:'Niedrig',0.5:'Mittel',0.7:'Hoch',0.9:'Sehr hoch',1:'Perfekt'}) +
    fRange('speaker_recognition.enrollment_duration', 'Einlern-Dauer (Sek.)', 5, 120, 5, {5:'5s (kurz)',15:'15s',30:'30s (empfohlen)',60:'1 Min',120:'2 Min'}) +
    fToggle('speaker_recognition.fallback_ask', 'Bei Unsicherheit nachfragen: "Wer spricht?"') +
    fRange('speaker_recognition.max_profiles', 'Max. Sprecher-Profile', 1, 50, 1)
  );
}

// ---- Tab 7: Routinen ----
function renderRoutines() {
  const morningStyleOpts = [
    {v:'kompakt',l:'Kompakt — Kurzes Briefing'},
    {v:'ausfuehrlich',l:'Ausfuehrlich — Detailliertes Update'},
    {v:'freundlich',l:'Freundlich — Lockerer Start'},
    {v:'butler',l:'Butler — Formeller Morgengruss'},
    {v:'minimal',l:'Minimal — Nur das Wichtigste'},
    {v:'entspannt',l:'Entspannt — Gemuetlicher Start'}
  ];
  return sectionWrap('&#127748;', 'Morgen-Briefing',
    fInfo('Automatisches Update am Morgen — Wetter, Termine, Neuigkeiten. Wird ausgeloest wenn du morgens das erste Mal erkannt wirst.') +
    fToggle('routines.morning_briefing.enabled', 'Morgen-Briefing aktiv') +
    fSelect('routines.morning_briefing.trigger', 'Ausloeser', [
      {v:'first_motion_after_night',l:'Erste Bewegung nach der Nacht'},
      {v:'first_voice_after_night',l:'Erstes Sprachkommando nach der Nacht'},
      {v:'alarm_dismissed',l:'Wecker ausgeschaltet'},
      {v:'manual',l:'Nur auf Anfrage'}
    ]) +
    fChipSelect('routines.morning_briefing.modules', 'Was soll im Briefing enthalten sein?', [
      {v:'greeting',l:'Begruessung'},
      {v:'weather',l:'Wetter'},
      {v:'calendar',l:'Termine'},
      {v:'news',l:'Nachrichten'},
      {v:'reminders',l:'Erinnerungen'},
      {v:'traffic',l:'Verkehr'},
      {v:'smart_home',l:'Smart Home Status'},
      {v:'energy',l:'Energieverbrauch'},
      {v:'birthday',l:'Geburtstage'},
      {v:'quote',l:'Tages-Zitat'}
    ]) +
    fSelect('routines.morning_briefing.weekday_style', 'Stil unter der Woche', morningStyleOpts) +
    fSelect('routines.morning_briefing.weekend_style', 'Stil am Wochenende', morningStyleOpts) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Morgen-Aktionen</div>' +
    fToggle('routines.morning_briefing.morning_actions.covers_up', 'Rolladen automatisch hochfahren') +
    fToggle('routines.morning_briefing.morning_actions.lights_soft', 'Licht sanft einschalten')
  ) +
  sectionWrap('&#127769;', 'Gute-Nacht-Routine',
    fInfo('Automatische Aktionen wenn du "Gute Nacht" sagst — Lichter aus, Heizung runter, alles pruefen.') +
    fToggle('routines.good_night.enabled', 'Gute-Nacht-Routine aktiv') +
    fChipSelect('routines.good_night.triggers', 'Ausloese-Phrasen', [
      'gute nacht','schlaf gut','nacht','geh schlafen','ab ins bett',
      'ich geh pennen','bis morgen','nacht jarvis','schlafenszeit'
    ]) +
    fChipSelect('routines.good_night.checks', 'Sicherheits-Checks vor dem Schlafen', [
      {v:'doors',l:'Tueren geschlossen?'},
      {v:'windows',l:'Fenster geschlossen?'},
      {v:'lights',l:'Alle Lichter aus?'},
      {v:'stove',l:'Herd aus?'},
      {v:'oven',l:'Ofen aus?'},
      {v:'iron',l:'Buegeleisen aus?'},
      {v:'garage',l:'Garage zu?'},
      {v:'alarm',l:'Alarmanlage scharf?'}
    ]) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Automatische Aktionen</div>' +
    fToggle('routines.good_night.actions.lights_off', 'Alle Lichter ausschalten') +
    fToggle('routines.good_night.actions.heating_night', 'Heizung auf Nacht-Modus') +
    fToggle('routines.good_night.actions.covers_down', 'Rolladen runterfahren') +
    fToggle('routines.good_night.actions.alarm_arm_home', 'Alarmanlage scharf schalten')
  ) +
  sectionWrap('&#128101;', 'Gaeste-Modus',
    fInfo('Wenn Besuch da ist — der Assistent wird formeller und zeigt keine privaten Infos.') +
    fChipSelect('routines.guest_mode.triggers', 'Aktivierung durch', [
      'besuch','gaeste','gast','besucher','gast modus','wir haben besuch',
      'gaeste da','jemand zu besuch'
    ]) +
    fToggle('routines.guest_mode.restrictions.hide_personal_info', 'Persoenliche Infos verstecken') +
    fToggle('routines.guest_mode.restrictions.formal_tone', 'Formeller Ton aktivieren') +
    fToggle('routines.guest_mode.restrictions.restrict_security', 'Sicherheitsfunktionen einschraenken') +
    fToggle('routines.guest_mode.restrictions.suggest_guest_wifi', 'Gaeste-WLAN vorschlagen')
  ) +
  sectionWrap('&#128276;', 'Proaktive Meldungen',
    fInfo('Der Assistent meldet sich von allein — z.B. bei offenen Fenstern oder Vergesslichkeit. Je hoeher der Autonomie-Level, desto mehr meldet er sich.') +
    fToggle('proactive.enabled', 'Proaktive Meldungen aktiv') +
    fRange('proactive.cooldown_seconds', 'Mindestabstand zwischen Meldungen', 60, 3600, 60, {60:'1 Min',120:'2 Min',300:'5 Min',600:'10 Min',1800:'30 Min',3600:'1 Std'}) +
    fRange('proactive.music_follow_cooldown_minutes', 'Musik-Nachfolge Pause', 1, 30, 1) +
    fRange('proactive.min_autonomy_level', 'Ab Autonomie-Level', 1, 5, 1, {1:'Assistent',2:'Butler',3:'Mitbewohner',4:'Vertrauter',5:'Autopilot'}) +
    fChipSelect('proactive.silence_scenes', 'Nicht stoeren bei', [
      'filmabend','schlafen','meditation','telefonat','meeting',
      'konzentration','gaeste','nicht_stoeren','musik','arbeit'
    ])
  ) +
  sectionWrap('&#9200;', 'Zeitgefuehl',
    fInfo('Der Assistent erinnert dich wenn Geraete zu lange laufen — z.B. Ofen vergessen, PC-Pause noetig.') +
    fToggle('time_awareness.enabled', 'Zeitgefuehl aktiv') +
    fRange('time_awareness.check_interval_minutes', 'Pruef-Intervall', 1, 30, 1, {1:'Jede Min.',5:'5 Min.',10:'10 Min.',15:'15 Min.',30:'30 Min.'}) +
    fRange('time_awareness.thresholds.oven', 'Ofen-Warnung nach', 10, 180, 5, {10:'10 Min',30:'30 Min',60:'1 Std',120:'2 Std',180:'3 Std'}) +
    fRange('time_awareness.thresholds.iron', 'Buegeleisen-Warnung nach', 5, 120, 5, {5:'5 Min',15:'15 Min',30:'30 Min',60:'1 Std',120:'2 Std'}) +
    fRange('time_awareness.thresholds.light_empty_room', 'Licht im leeren Raum nach', 5, 120, 5, {5:'5 Min',15:'15 Min',30:'30 Min',60:'1 Std'}) +
    fRange('time_awareness.thresholds.window_open_cold', 'Fenster offen bei Kaelte nach', 30, 600, 30, {30:'30 Min',60:'1 Std',120:'2 Std',300:'5 Std',600:'10 Std'}) +
    fRange('time_awareness.thresholds.pc_no_break', 'PC-Pause erinnern nach', 60, 720, 30, {60:'1 Std',120:'2 Std',180:'3 Std',360:'6 Std',720:'12 Std'}) +
    fToggle('time_awareness.counters.coffee_machine', 'Kaffee-Zaehler (zaehlt deine Kaffees)')
  ) +
  sectionWrap('&#128300;', 'Vorausdenken',
    fInfo('Der Assistent lernt deine Gewohnheiten und schlaegt Aktionen vor — z.B. "Du machst normalerweise jetzt das Licht an".') +
    fToggle('anticipation.enabled', 'Vorausdenken aktiv') +
    fRange('anticipation.history_days', 'Lern-Zeitraum (Tage)', 7, 90, 7, {7:'1 Woche',14:'2 Wochen',30:'1 Monat',60:'2 Monate',90:'3 Monate'}) +
    fRange('anticipation.min_confidence', 'Mindest-Sicherheit', 0, 1, 0.05, {0:'Alles vorschlagen',0.3:'Niedrig',0.5:'Mittel',0.7:'Hoch',0.9:'Sehr hoch'}) +
    fRange('anticipation.check_interval_minutes', 'Pruef-Intervall', 5, 60, 5, {5:'5 Min',10:'10 Min',15:'15 Min',30:'30 Min',60:'1 Std'}) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Ab welcher Sicherheit...</div>' +
    fRange('anticipation.thresholds.ask', '...nachfragen?', 0, 1, 0.05, {0.3:'30%',0.5:'50%',0.6:'60%',0.7:'70%',0.8:'80%'}) +
    fRange('anticipation.thresholds.suggest', '...vorschlagen?', 0, 1, 0.05, {0.5:'50%',0.6:'60%',0.7:'70%',0.8:'80%',0.9:'90%'}) +
    fRange('anticipation.thresholds.auto', '...automatisch ausfuehren?', 0, 1, 0.05, {0.7:'70%',0.8:'80%',0.9:'90%',0.95:'95%',1:'100%'})
  ) +
  sectionWrap('&#128203;', 'Absicht-Erkennung',
    fInfo('Erkennt offene Absichten — z.B. "Ich muss noch einkaufen" wird als Aufgabe gemerkt und spaeter erinnert.') +
    fToggle('intent_tracking.enabled', 'Absicht-Erkennung aktiv') +
    fRange('intent_tracking.check_interval_minutes', 'Pruef-Intervall', 10, 240, 10, {10:'10 Min',30:'30 Min',60:'1 Std',120:'2 Std',240:'4 Std'}) +
    fRange('intent_tracking.remind_hours_before', 'Erinnerung vorher', 1, 48, 1, {1:'1 Std',2:'2 Std',4:'4 Std',12:'12 Std',24:'1 Tag',48:'2 Tage'})
  ) +
  sectionWrap('&#128172;', 'Gespraechs-Fortfuehrung',
    fInfo('Wenn ein Gespraech unterbrochen wird — soll der Assistent spaeter nachfragen? "Wolltest du vorhin noch was wegen...?"') +
    fToggle('conversation_continuity.enabled', 'Gespraech fortsetzen') +
    fRange('conversation_continuity.resume_after_minutes', 'Nachfragen nach', 1, 60, 1, {1:'1 Min',5:'5 Min',10:'10 Min',15:'15 Min',30:'30 Min',60:'1 Std'}) +
    fRange('conversation_continuity.expire_hours', 'Thema vergessen nach', 1, 72, 1, {1:'1 Std',6:'6 Std',12:'12 Std',24:'1 Tag',48:'2 Tage',72:'3 Tage'})
  );
}

// ---- Tab 8: Sicherheit & Erweitert ----
function renderSecurity() {
  const hMode = getPath(S, 'heating.mode') || 'room_thermostat';
  const isCurve = hMode === 'heating_curve';

  return sectionWrap('&#128293;', 'Heizung',
    fInfo('Wie wird geheizt? Einzelraumregelung = jeder Raum hat eigenen Thermostat. Heizkurve = zentrale Waermepumpe mit Offset-Steuerung.') +
    '<div class="form-group"><label>Heizungsmodus</label>' +
    '<select data-path="heating.mode" onchange="mergeCurrentTabIntoS();setPath(S,\'heating.mode\',this.value);renderCurrentTab();">' +
    '<option value="room_thermostat" ' + (hMode==='room_thermostat'?'selected':'') + '>Raumthermostate (Einzelraumregelung)</option>' +
    '<option value="heating_curve" ' + (hMode==='heating_curve'?'selected':'') + '>Heizkurve (Waermepumpe, Vorlauf-Offset)</option>' +
    '</select></div>' +
    (isCurve ?
      fText('heating.curve_entity', 'Heizungs-Entity', 'z.B. climate.panasonic_heat_pump_main_z1_temp') +
      fRange('heating.curve_offset_min', 'Min. Offset (°C)', -10, 0, 0.5) +
      fRange('heating.curve_offset_max', 'Max. Offset (°C)', 0, 10, 0.5) +
      fRange('heating.night_offset', 'Nacht-Offset (°C)', -10, 0, 0.5) +
      fRange('heating.away_offset', 'Abwesenheits-Offset (°C)', -10, 0, 0.5)
    :
      '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Jeder Raum hat seinen eigenen Thermostat. Temperatur-Grenzen findest du unten bei Sicherheit.</p>'
    )
  ) +
  sectionWrap('&#128274;', 'Sicherheit',
    fInfo('Welche Aktionen brauchen eine Bestaetigung? Und welche Temperatur-Grenzen gelten?') +
    fChipSelect('security.require_confirmation', 'Bestaetigung erforderlich fuer', [
      {v:'alarm_disarm',l:'Alarm deaktivieren'},
      {v:'alarm_arm',l:'Alarm aktivieren'},
      {v:'lock_unlock',l:'Tuerschloss oeffnen'},
      {v:'garage_open',l:'Garage oeffnen'},
      {v:'heating_off',l:'Heizung ausschalten'},
      {v:'all_lights_off',l:'Alle Lichter aus'},
      {v:'cover_open',l:'Rolladen oeffnen'},
      {v:'camera_disable',l:'Kamera deaktivieren'},
      {v:'automation_delete',l:'Automation loeschen'}
    ]) +
    (!isCurve ?
      fRange('security.climate_limits.min', 'Temperatur Min (°C)', 5, 25, 0.5) +
      fRange('security.climate_limits.max', 'Temperatur Max (°C)', 20, 35, 0.5)
    : '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Im Heizkurven-Modus gelten die Offset-Grenzen von oben.</p>'
    )
  ) +
  sectionWrap('&#128273;', 'API Key (Netzwerk-Schutz)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Schuetzt die Assistant-API gegen unbefugte Netzwerkzugriffe. Diesen Key im HA-Addon und in der HA-Integration eintragen, DANN Pruefung aktivieren.</p>' +
    '<div class="form-group" style="margin-bottom:12px;">' +
    '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;">' +
    '<input type="checkbox" id="apiKeyEnforcement" onchange="toggleApiKeyEnforcement(this.checked)" style="width:18px;height:18px;" />' +
    '<span>API Key Pruefung aktiv</span>' +
    '</label>' +
    '<p id="apiKeyEnforcementHint" style="font-size:11px;color:var(--text-secondary);margin-top:4px;"></p>' +
    '</div>' +
    '<div class="form-group"><label>Aktueller API Key</label>' +
    '<div style="display:flex;gap:8px;align-items:center;">' +
    '<input type="text" id="apiKeyDisplay" readonly style="flex:1;font-family:monospace;font-size:12px;" value="Wird geladen..." />' +
    '<button onclick="copyApiKey()" style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg-card);cursor:pointer;font-size:12px;">Kopieren</button>' +
    '</div></div>' +
    '<div style="margin-top:8px;"><button onclick="regenerateApiKey()" style="padding:6px 12px;border:1px solid var(--danger);border-radius:6px;background:transparent;color:var(--danger);cursor:pointer;font-size:12px;">Key neu generieren</button>' +
    '<span style="font-size:11px;color:var(--text-secondary);margin-left:8px;">Achtung: Addon + HA-Integration muessen danach aktualisiert werden!</span></div>'
  ) +
  sectionWrap('&#128272;', 'Vertrauensstufen',
    fInfo('Standard-Vertrauensstufe fuer neue Personen und was Gaeste/Besitzer duerfen.') +
    fSelect('trust_levels.default', 'Standard fuer neue Personen', [
      {v:0,l:'Gast (eingeschraenkt)'},
      {v:1,l:'Mitbewohner (normal)'},
      {v:2,l:'Besitzer (voll)'}
    ]) +
    fChipSelect('trust_levels.guest_allowed_actions', 'Gaeste duerfen', [
      {v:'light_control',l:'Licht steuern'},
      {v:'climate_control',l:'Temperatur aendern'},
      {v:'media_control',l:'Musik/TV steuern'},
      {v:'cover_control',l:'Rolladen steuern'},
      {v:'scene_activate',l:'Szenen aktivieren'},
      {v:'timer_set',l:'Timer stellen'},
      {v:'weather_query',l:'Wetter fragen'},
      {v:'smalltalk',l:'Smalltalk'}
    ]) +
    fChipSelect('trust_levels.security_actions', 'Nur Besitzer duerfen', [
      {v:'alarm_control',l:'Alarmanlage'},
      {v:'lock_control',l:'Tuerschloesser'},
      {v:'camera_control',l:'Kameras'},
      {v:'garage_control',l:'Garage'},
      {v:'automation_edit',l:'Automationen bearbeiten'},
      {v:'settings_change',l:'Einstellungen aendern'},
      {v:'person_manage',l:'Personen verwalten'},
      {v:'system_restart',l:'System neustarten'}
    ])
  ) +
  sectionWrap('&#128295;', 'Diagnostik',
    fInfo('Automatische Pruefung von Sensoren, Batterien und Geraetestatus.') +
    fToggle('diagnostics.enabled', 'Geraete-Diagnostik aktiv') +
    fRange('diagnostics.check_interval_minutes', 'Pruef-Intervall', 5, 120, 5, {5:'5 Min',15:'15 Min',30:'30 Min',60:'1 Std',120:'2 Std'}) +
    fRange('diagnostics.battery_warning_threshold', 'Batterie-Warnung ab', 5, 50, 5, {5:'5%',10:'10%',15:'15%',20:'20%',30:'30%',50:'50%'}) +
    fRange('diagnostics.stale_sensor_minutes', 'Sensor veraltet nach', 30, 600, 30, {30:'30 Min',60:'1 Std',120:'2 Std',300:'5 Std',600:'10 Std'}) +
    fRange('diagnostics.offline_threshold_minutes', 'Geraet offline nach', 10, 120, 10, {10:'10 Min',30:'30 Min',60:'1 Std',120:'2 Std'}) +
    fRange('diagnostics.alert_cooldown_minutes', 'Wiederholung fruehestens nach', 10, 240, 10, {10:'10 Min',30:'30 Min',60:'1 Std',120:'2 Std',240:'4 Std'})
  ) +
  sectionWrap('&#128200;', 'Feedback-System',
    fInfo('Wie reagiert der Assistent auf positives/negatives Feedback? Scores bestimmen wie haeufig er sich meldet.') +
    fRange('feedback.auto_timeout_seconds', 'Feedback-Timeout', 30, 600, 30, {30:'30s',60:'1 Min',120:'2 Min',300:'5 Min',600:'10 Min'}) +
    fRange('feedback.base_cooldown_seconds', 'Basis-Abstand', 60, 1800, 60, {60:'1 Min',120:'2 Min',300:'5 Min',600:'10 Min',1800:'30 Min'}) +
    fRange('feedback.score_suppress', 'Unterdruecken unter', 0, 1, 0.05) +
    fRange('feedback.score_reduce', 'Reduzieren unter', 0, 1, 0.05) +
    fRange('feedback.score_normal', 'Normal ab', 0, 1, 0.05) +
    fRange('feedback.score_boost', 'Boost ab', 0, 1, 0.05)
  ) +
  sectionWrap('&#128683;', 'Antwort-Filter',
    fInfo('Unerwuenschte Phrasen aus den Antworten filtern und maximale Antwortlaenge begrenzen.') +
    fToggle('response_filter.enabled', 'Antwort-Filter aktiv') +
    fRange('response_filter.max_response_sentences', 'Max. Saetze pro Antwort', 0, 20, 1, {0:'Kein Limit',1:'1',2:'2',3:'3',5:'5',10:'10',20:'20'}) +
    fChipSelect('response_filter.banned_phrases', 'Verbotene Phrasen', [
      'als KI','als Sprachmodell','ich bin ein KI','ich habe keine Gefuehle',
      'ich bin nur eine Maschine','als AI','language model','ich kann nicht fuehlen',
      'ich bin kein Mensch','mein Training','meine Trainingsdaten'
    ]) +
    fChipSelect('response_filter.banned_starters', 'Verbotene Satzanfaenge', [
      'Natuerlich!','Selbstverstaendlich!','Klar!','Gerne!',
      'Absolut!','Definitiv!','Auf jeden Fall!','Sicher!',
      'Das ist eine gute Frage','Ich verstehe'
    ])
  ) +
  sectionWrap('&#127859;', 'Koch-Assistent',
    fInfo('Der Assistent kann dir Rezepte vorschlagen und beim Kochen helfen — Schritt fuer Schritt mit Timer.') +
    fToggle('cooking.enabled', 'Koch-Assistent aktiv') +
    fSelect('cooking.language', 'Rezept-Sprache', [{v:'de',l:'Deutsch'},{v:'en',l:'English'}]) +
    fRange('cooking.default_portions', 'Standard-Portionen', 1, 12, 1) +
    fRange('cooking.max_steps', 'Max. Schritte pro Rezept', 3, 30, 1) +
    fRange('cooking.max_tokens', 'Rezept-Detailgrad', 256, 4096, 256, {256:'Kurz',512:'Normal',1024:'Ausfuehrlich',2048:'Sehr ausfuehrlich',4096:'Maximum'}) +
    fToggle('cooking.timer_notify_tts', 'Timer-Erinnerungen per Sprache')
  ) +
  sectionWrap('&#128295;', 'Wartung',
    fInfo('Automatische Wartungshinweise fuer Geraete im Haushalt.') +
    fToggle('maintenance.enabled', 'Wartungs-Erinnerungen aktiv')
  ) +
  sectionWrap('&#128101;', 'Personen-Anrede',
    fInfo('Wie soll der Assistent einzelne Personen ansprechen? Der Hauptbenutzer wird standardmaessig als "Sir" angesprochen.') +
    fTextarea('persons.titles', 'Anrede pro Person', 'z.B. alex: Sir\nmaria: Frau Mueller')
  ) +
  sectionWrap('&#128276;', 'Benachrichtigungskanaele',
    fInfo('Welche Kanaele soll der Assistent fuer Benachrichtigungen nutzen? Kanaele koennen einzeln konfiguriert werden.') +
    '<div id="notifyChannelsContainer" style="color:var(--text-muted);font-size:12px;">Wird geladen...</div>' +
    '<div style="margin-top:10px;"><button class="btn btn-primary" style="font-size:12px;" onclick="saveNotifyChannels()">Kanaele speichern</button></div>'
  );
}

// ---- Notification Channels ----
let _notifyChannels = {};

async function loadNotifyChannels() {
  try {
    const d = await api('/api/ui/notification-channels');
    _notifyChannels = d.channels || {};
    renderNotifyChannels();
  } catch(e) { console.error('Notify channels fail:', e); }
}

function renderNotifyChannels() {
  const c = document.getElementById('notifyChannelsContainer');
  if (!c) return;
  const icons = {websocket:'&#127760;', tts:'&#128266;', ha_notify:'&#128241;'};
  const labels = {websocket:'WebSocket (Dashboard)', tts:'Sprachausgabe (TTS)', ha_notify:'HA Benachrichtigung (App)'};
  let html = '';
  for (const [name, ch] of Object.entries(_notifyChannels)) {
    const icon = icons[name] || '&#128276;';
    const label = labels[name] || name;
    const pref = ch.preferred || false;
    const urgency = ch.urgency_min || 'low';
    const info = name==='websocket' && ch.connected_clients !== undefined ? ` (${ch.connected_clients} verbunden)` : '';
    html += `<div style="padding:10px;margin-bottom:8px;background:var(--bg-secondary);border-radius:6px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <span style="font-size:13px;font-weight:600;">${icon} ${label}${info}</span>
        <label class="toggle" style="margin:0;">
          <input type="checkbox" data-notify="${name}" data-field="preferred" ${pref?'checked':''} onchange="updateNotifyChannel('${name}','preferred',this.checked)">
          <span class="toggle-track"></span><span class="toggle-thumb"></span>
        </label>
      </div>
      <div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px;">${esc(ch.description||'')}</div>
      <div style="display:flex;gap:12px;align-items:center;">
        <label style="font-size:11px;color:var(--text-muted);">Min. Dringlichkeit:</label>
        <select data-notify="${name}" data-field="urgency_min" style="font-size:11px;padding:3px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);"
          onchange="updateNotifyChannel('${name}','urgency_min',this.value)">
          <option value="low" ${urgency==='low'?'selected':''}>Niedrig</option>
          <option value="medium" ${urgency==='medium'?'selected':''}>Mittel</option>
          <option value="high" ${urgency==='high'?'selected':''}>Hoch</option>
        </select>
      </div>
    </div>`;
  }
  if (!html) html = '<div style="font-size:12px;color:var(--text-muted);">Keine Kanaele verfuegbar</div>';
  c.innerHTML = html;
}

function updateNotifyChannel(name, field, value) {
  if (_notifyChannels[name]) _notifyChannels[name][field] = value;
}

async function saveNotifyChannels() {
  try {
    const payload = {};
    for (const [name, ch] of Object.entries(_notifyChannels)) {
      payload[name] = { preferred: !!ch.preferred, urgency_min: ch.urgency_min || 'low' };
      if (ch.quiet_hours) payload[name].quiet_hours = ch.quiet_hours;
    }
    await api('/api/ui/notification-channels', 'PUT', {channels: payload});
    toast('Benachrichtigungskanaele gespeichert');
  } catch(e) { toast('Fehler beim Speichern', 'error'); }
}

// ---- API Key Management ----
async function loadApiKey() {
  try {
    const data = await api('/api/ui/api-key');
    const el = document.getElementById('apiKeyDisplay');
    if (el && data.api_key) el.value = data.api_key;
    const cb = document.getElementById('apiKeyEnforcement');
    if (cb) {
      cb.checked = !!data.enforcement;
      if (data.env_locked) { cb.disabled = true; }
    }
    updateEnforcementHint(!!data.enforcement, !!data.env_locked);
  } catch (e) { /* ignore */ }
}
function updateEnforcementHint(active, envLocked) {
  const hint = document.getElementById('apiKeyEnforcementHint');
  if (!hint) return;
  if (envLocked) {
    hint.textContent = 'Durch Umgebungsvariable ASSISTANT_API_KEY erzwungen (kann hier nicht deaktiviert werden).';
    hint.style.color = '#f59e0b';
  } else if (active) {
    hint.textContent = 'Aktiv: Alle /api/assistant/* Anfragen benoetigen einen gueltigen API Key.';
    hint.style.color = '#10b981';
  } else {
    hint.textContent = 'Inaktiv: API ist ohne Key zugaenglich. Erst Key in Addon/HA-Integration eintragen, dann hier aktivieren.';
    hint.style.color = 'var(--text-secondary)';
  }
}
function copyApiKey() {
  const el = document.getElementById('apiKeyDisplay');
  if (el) { navigator.clipboard.writeText(el.value); toast('API Key kopiert!'); }
}
async function regenerateApiKey() {
  if (!confirm('API Key wirklich neu generieren? Addon und HA-Integration muessen danach aktualisiert werden!')) return;
  try {
    const data = await api('/api/ui/api-key/regenerate', 'POST');
    const el = document.getElementById('apiKeyDisplay');
    if (el && data.api_key) el.value = data.api_key;
    toast('Neuer API Key generiert!');
  } catch (e) { toast('Fehler: ' + e.message, 'error'); }
}
async function toggleApiKeyEnforcement(enabled) {
  const action = enabled ? 'aktivieren' : 'deaktivieren';
  if (enabled && !confirm('API Key Pruefung aktivieren? Stelle sicher, dass der Key bereits im HA-Addon und in der HA-Integration eingetragen ist, sonst funktioniert die Kommunikation nicht mehr!')) {
    const cb = document.getElementById('apiKeyEnforcement');
    if (cb) cb.checked = false;
    return;
  }
  try {
    const data = await api('/api/ui/api-key/enforcement', 'POST', { enabled });
    updateEnforcementHint(data.enforcement);
    toast('API Key Pruefung ' + (data.enforcement ? 'aktiviert' : 'deaktiviert'));
  } catch (e) {
    toast('Fehler: ' + e.message, 'error');
    const cb = document.getElementById('apiKeyEnforcement');
    if (cb) cb.checked = !enabled;
  }
}

// ---- Recovery-Key ----
async function regenerateRecoveryKey() {
  if (!confirm('Neuen Recovery-Key generieren? Der alte Key wird ungueltig! Notiere dir den neuen Key sofort.')) return;
  try {
    const data = await api('/api/ui/recovery-key/regenerate', 'POST');
    const el = document.getElementById('recoveryKeyDisplay');
    if (el && data.recovery_key) {
      el.value = data.recovery_key;
      el.style.color = 'var(--accent)';
      el.style.fontSize = '18px';
      el.style.fontWeight = '700';
    }
    toast('Neuer Recovery-Key generiert — JETZT notieren!');
  } catch (e) { toast('Fehler: ' + e.message, 'error'); }
}

// ---- Tab: KI-Autonomie (Phase 13.1 / 13.2 / 13.4) ----
let SNAPSHOTS = [];

function renderAutonomie() {
  return sectionWrap('&#129302;', 'Selbstoptimierung',
    fInfo('Der Assistent lernt aus euren Gespraechen und schlaegt Verbesserungen vor. Du entscheidest ob Vorschlaege angenommen werden. Die Kern-Identitaet ist geschuetzt.') +
    fToggle('self_optimization.enabled', 'Selbstoptimierung aktiv') +
    fSelect('self_optimization.approval_mode', 'Genehmigungsmodus', [
      {v:'manual', l:'Manuell (nur mit Bestaetigung)'},
      {v:'off', l:'Aus (keine Vorschlaege)'}
    ]) +
    fSelect('self_optimization.analysis_interval', 'Analyse-Intervall', [
      {v:'weekly', l:'Woechentlich'},
      {v:'daily', l:'Taeglich'}
    ]) +
    fNum('self_optimization.max_proposals_per_cycle', 'Max. Vorschlaege pro Zyklus', 1, 10) +
    fModelSelect('self_optimization.model', 'Analyse-Modell')
  ) +
  sectionWrap('&#128203;', 'Vorschlaege (Approval-Workflow)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jarvis macht nur Vorschlaege — DU entscheidest ob sie angewendet werden. Jede Aenderung wird vorher gesnapshot.</p>' +
    '<div id="proposalsList" style="margin-bottom:12px;"></div>' +
    '<button class="btn btn-secondary" style="font-size:12px;" onclick="runAnalysis()">Analyse jetzt starten</button>'
  ) +
  sectionWrap('&#128190;', 'Rollback & Snapshots',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jede Config-Aenderung wird gesichert. Rollback jederzeit moeglich.</p>' +
    fToggle('self_optimization.rollback.enabled', 'Rollback aktiv') +
    fNum('self_optimization.rollback.max_snapshots', 'Max. gespeicherte Snapshots', 5, 100) +
    fToggle('self_optimization.rollback.snapshot_on_every_edit', 'Snapshot bei jeder Aenderung') +
    '<div id="snapshotsList" style="margin-top:12px;"></div>'
  ) +
  sectionWrap('&#128295;', 'Parameter-Grenzen',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jarvis kann NUR innerhalb dieser Grenzen vorschlagen.</p>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">' +
    fNum('self_optimization.parameter_bounds.sarcasm_level.min', 'Sarkasmus Min', 1, 5) +
    fNum('self_optimization.parameter_bounds.sarcasm_level.max', 'Sarkasmus Max', 1, 5) +
    fNum('self_optimization.parameter_bounds.opinion_intensity.min', 'Meinungen Min', 0, 3) +
    fNum('self_optimization.parameter_bounds.opinion_intensity.max', 'Meinungen Max', 0, 3) +
    fNum('self_optimization.parameter_bounds.max_response_sentences.min', 'Saetze Min', 1, 10) +
    fNum('self_optimization.parameter_bounds.max_response_sentences.max', 'Saetze Max', 1, 10) +
    fNum('self_optimization.parameter_bounds.formality_min.min', 'Formalitaet-Min Min', 0, 100) +
    fNum('self_optimization.parameter_bounds.formality_min.max', 'Formalitaet-Min Max', 0, 100) +
    '</div>'
  ) +
  sectionWrap('&#128683;', 'Geschuetzte Bereiche (Immutable)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Diese Bereiche kann Jarvis NIEMALS selbst aendern.</p>' +
    fChipSelect('self_optimization.immutable_keys', 'Geschuetzte Bereiche (nicht aenderbar durch KI)', [
      'security','trust_levels','response_filter.banned_phrases',
      'response_filter.banned_starters','household','assistant.name',
      'self_optimization.immutable_keys','self_optimization.approval_mode',
      'models.fast','models.smart','models.deep','autonomy.level'
    ], 'Klicke auf Bereiche die die KI NIEMALS selbst aendern darf.')
  ) +
  sectionWrap('&#9889;', 'Self-Automation (Phase 13.2)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jarvis erstellt HA-Automationen aus natuerlicher Sprache. Approval-Workflow: Du musst jede Automation bestaetigen.</p>' +
    fToggle('self_automation.enabled', 'Self-Automation aktiv') +
    fNum('self_automation.max_per_day', 'Max. Automationen pro Tag', 1, 20) +
    fModelSelect('self_automation.model', 'Modell fuer Automations-Erstellung')
  ) +
  sectionWrap('&#128221;', 'Config-Selbstmodifikation (Phase 13.1)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jarvis kann nur diese 3 Dateien editieren (Whitelist). settings.yaml ist NICHT editierbar durch Jarvis.</p>' +
    '<div style="display:flex;flex-direction:column;gap:8px;">' +
    '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-secondary);border-radius:6px;">' +
      '<span style="color:var(--success);">&#9989;</span><span style="font-size:13px;">easter_eggs.yaml</span>' +
      '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">Easter Eggs &amp; Gag-Antworten</span></div>' +
    '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-secondary);border-radius:6px;">' +
      '<span style="color:var(--success);">&#9989;</span><span style="font-size:13px;">opinion_rules.yaml</span>' +
      '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">Meinungs-Kommentare</span></div>' +
    '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-secondary);border-radius:6px;">' +
      '<span style="color:var(--success);">&#9989;</span><span style="font-size:13px;">room_profiles.yaml</span>' +
      '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">Raum-Metadaten</span></div>' +
    '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-secondary);border-radius:6px;opacity:0.5;">' +
      '<span style="color:var(--danger);">&#10060;</span><span style="font-size:13px;">settings.yaml</span>' +
      '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">NUR durch User aenderbar</span></div>' +
    '</div>'
  );
}

async function loadOptStatus() {
  try {
    const data = await api('/api/ui/self-optimization/status');
    renderProposalList(data.proposals || []);
  } catch(e) { console.error('OptStatus fail:', e); }
}

function renderProposalList(proposals) {
  const c = document.getElementById('proposalsList');
  if (!c) return;
  if (proposals.length === 0) {
    c.innerHTML = '<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;">Keine offenen Vorschlaege</div>';
    return;
  }
  c.innerHTML = '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">Offene Vorschlaege:</div>' +
    proposals.map((p, i) => {
      const conf = Math.round((p.confidence || 0) * 100);
      return `<div style="padding:8px;margin-bottom:6px;background:var(--bg-secondary);border-radius:6px;border-left:3px solid var(--accent);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <span style="font-weight:600;font-size:13px;">${esc(p.parameter)}: ${esc(String(p.current))} &#8594; ${esc(String(p.proposed))}</span>
          <span style="font-size:11px;color:var(--text-muted);background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${conf}%</span>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${esc(p.reason)}</div>
        <div style="display:flex;gap:6px;justify-content:flex-end;">
          <button class="btn btn-secondary" style="padding:3px 10px;font-size:11px;background:var(--danger);border-color:var(--danger);color:white;" onclick="rejectProposal(${i})">Ablehnen</button>
          <button class="btn btn-primary" style="padding:3px 10px;font-size:11px;" onclick="approveProposal(${i})">Annehmen</button>
        </div>
      </div>`;
    }).join('') +
    (proposals.length > 1 ? '<div style="text-align:right;margin-top:6px;"><button class="btn btn-secondary" style="padding:3px 12px;font-size:11px;" onclick="rejectAllProposals()">Alle ablehnen</button></div>' : '');
}

async function approveProposal(index) {
  if (!confirm('Diesen Vorschlag wirklich anwenden? (Snapshot wird vorher erstellt)')) return;
  try {
    const result = await api('/api/ui/self-optimization/approve', 'POST', {index});
    if (result.success) {
      toast('Angewendet: ' + result.message);
      S = await api('/api/ui/settings');
      renderCurrentTab();
      loadOptStatus();
      loadSnapshots();
    } else {
      toast(result.message, 'error');
    }
  } catch(e) { toast('Fehler', 'error'); }
}

async function rejectProposal(index) {
  try {
    const result = await api('/api/ui/self-optimization/reject', 'POST', {index});
    if (result.success) {
      toast('Abgelehnt');
      loadOptStatus();
    }
  } catch(e) { toast('Fehler', 'error'); }
}

async function rejectAllProposals() {
  try {
    const result = await api('/api/ui/self-optimization/reject-all', 'POST', {});
    if (result.success) {
      toast(result.message);
      loadOptStatus();
    }
  } catch(e) { toast('Fehler', 'error'); }
}

async function runAnalysis() {
  toast('Analyse wird gestartet...', 'info');
  try {
    const result = await api('/api/ui/self-optimization/run-analysis', 'POST', {});
    toast(result.message);
    loadOptStatus();
  } catch(e) { toast('Analyse-Fehler', 'error'); }
}

async function loadSnapshots() {
  try {
    const data = await api('/api/ui/snapshots');
    SNAPSHOTS = data.snapshots || [];
    renderSnapshotList();
  } catch(e) { console.error('Snapshots fail:', e); }
}

function renderSnapshotList() {
  const c = document.getElementById('snapshotsList');
  if (!c) return;
  if (SNAPSHOTS.length === 0) {
    c.innerHTML = '<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;">Keine Snapshots vorhanden</div>';
    return;
  }
  c.innerHTML = '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">Letzte Snapshots:</div>' +
    SNAPSHOTS.slice(0, 10).map(s => {
      const dt = new Date(s.timestamp).toLocaleString('de-DE', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
      return `<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;margin-bottom:4px;background:var(--bg-secondary);border-radius:6px;font-size:12px;">
        <span style="font-weight:600;min-width:100px;">${esc(s.config_file)}</span>
        <span style="color:var(--text-secondary);flex:1;">${esc(s.reason)}</span>
        <span style="color:var(--text-muted);min-width:80px;">${dt}</span>
        <button class="btn btn-secondary" style="padding:2px 8px;font-size:11px;" onclick="rollbackSnapshot('${esc(s.id)}')">Rollback</button>
      </div>`;
    }).join('');
}

async function rollbackSnapshot(snapshotId) {
  if (!confirm('Config auf diesen Snapshot zuruecksetzen?')) return;
  try {
    const result = await api('/api/ui/rollback', 'POST', {snapshot_id: snapshotId});
    if (result.success) {
      toast('Rollback erfolgreich: ' + result.message);
      // Settings neu laden
      S = await api('/api/ui/settings');
      renderCurrentTab();
      loadSnapshots();
    } else {
      toast('Rollback fehlgeschlagen: ' + result.message, 'error');
    }
  } catch(e) { toast('Rollback-Fehler', 'error'); }
}

// ---- Tab 9: Easter Eggs ----
let EGGS = [];

function renderEasterEggs() {
  let html = '<div id="easterEggsList"></div>';
  html += '<div style="margin-top:16px;text-align:center;">';
  html += '<button class="btn btn-primary" onclick="addEasterEgg()">+ Neues Easter Egg</button>';
  html += '</div>';
  return html;
}

async function loadEasterEggs() {
  try {
    const data = await api('/api/ui/easter-eggs');
    EGGS = data.easter_eggs || [];
    renderEggList();
  } catch(e) { console.error('Easter Eggs fail:', e); }
}

function renderEggList() {
  const c = document.getElementById('easterEggsList');
  if (!c) return;
  if (EGGS.length === 0) {
    c.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted);">Keine Easter Eggs vorhanden</div>';
    return;
  }
  c.innerHTML = EGGS.map((egg, i) => `
    <div class="s-section">
      <div class="s-section-hdr" onclick="toggleSec(this)" style="cursor:pointer;">
        <h3>${egg.enabled !== false ? '&#127866;' : '&#128683;'} ${esc(egg.id)}</h3>
        <span class="arrow">&#9660;</span>
      </div>
      <div class="s-section-body">
        <div class="form-group"><label>ID</label>
          <input type="text" value="${esc(egg.id)}" onchange="EGGS[${i}].id=this.value"></div>
        <div class="form-group"><label>Aktiviert</label>
          <label class="toggle"><input type="checkbox" ${egg.enabled!==false?'checked':''} onchange="EGGS[${i}].enabled=this.checked">
          <span class="toggle-track"></span><span class="toggle-thumb"></span></label></div>
        <div class="form-group"><label>Trigger (einer pro Zeile)</label>
          <textarea rows="3" onchange="EGGS[${i}].triggers=this.value.split('\\n').map(s=>s.trim()).filter(Boolean)">${esc((egg.triggers||[]).join('\n'))}</textarea>
          <div class="hint">Substring-Matching, case-insensitive</div></div>
        <div class="form-group"><label>Antworten (eine pro Zeile)</label>
          <textarea rows="4" onchange="EGGS[${i}].responses=this.value.split('\\n').map(s=>s.trim()).filter(Boolean)">${esc((egg.responses||[]).join('\n'))}</textarea>
          <div class="hint">Zufaellige Auswahl</div></div>
        <div style="text-align:right;margin-top:8px;">
          <button class="btn btn-secondary" style="background:var(--danger);border-color:var(--danger);" onclick="removeEgg(${i})">Entfernen</button>
        </div>
      </div>
    </div>`).join('');
  c.innerHTML += '<div style="margin-top:16px;text-align:center;">' +
    '<button class="btn btn-primary" onclick="saveEasterEggs()">Easter Eggs speichern</button></div>';
}

function addEasterEgg() {
  EGGS.push({id: 'neues_egg_' + Date.now(), triggers: [], responses: [], enabled: true});
  renderEggList();
}

function removeEgg(idx) {
  EGGS.splice(idx, 1);
  renderEggList();
}

async function saveEasterEggs() {
  try {
    await api('/api/ui/easter-eggs', 'PUT', {easter_eggs: EGGS});
    toast('Easter Eggs gespeichert');
  } catch(e) { toast('Fehler beim Speichern', 'error'); }
}

// ---- Collect + Save ----
function collectSettings() {
  const updates = {};
  // Text, number, select
  document.querySelectorAll('#settingsContent [data-path]').forEach(el => {
    const path = el.dataset.path;
    const tag = el.tagName.toLowerCase();
    if (tag === 'div') return; // kw-editor handled separately
    let val;
    if (el.type === 'checkbox') {
      val = el.checked;
    } else if (el.type === 'number' || el.type === 'range') {
      val = parseFloat(el.value);
      if (Number.isInteger(val) && el.step && !String(el.step).includes('.')) val = parseInt(el.value);
    } else if (tag === 'textarea') {
      const raw = el.value.trim();
      if (el.dataset.type === 'array') {
        val = raw.split('\n').map(l=>l.trim()).filter(Boolean);
      } else if (el.dataset.type === 'json') {
        // Round-trip JSON objects
        try { val = JSON.parse(raw); } catch(e) { val = raw; }
      } else {
        // Try YAML-like map parsing (only for simple key: value lines)
        try {
          const lines = raw.split('\n').filter(l=>l.trim());
          const isMap = lines.length > 0 && lines.every(l => /^[a-zA-Z0-9_.-]+\s*:/.test(l));
          if (isMap) {
            val = {};
            for (const line of lines) {
              const [k,...rest] = line.split(':');
              val[k.trim()] = rest.join(':').trim().replace(/^["']|["']$/g,'');
            }
          } else {
            val = raw;
          }
        } catch(e) { val = raw; }
      }
    } else {
      val = el.value;
    }
    setPath(updates, path, val);
  });
  // Keywords (kw-editor divs) - already maintained in S
  document.querySelectorAll('#settingsContent .kw-editor[data-path]').forEach(el => {
    const path = el.dataset.path;
    const arr = getPath(S, path) || [];
    setPath(updates, path, arr);
  });
  // Chip-Selects - already maintained in S via toggleChip()
  document.querySelectorAll('#settingsContent .chip-grid[data-path]').forEach(el => {
    const path = el.dataset.path;
    const arr = getPath(S, path) || [];
    setPath(updates, path, arr);
  });
  // Household members (dynamic list)
  if (document.getElementById('householdMembers')) {
    setPath(updates, 'household.members', collectHouseholdMembers());
  }
  return updates;
}

let _saving = false;
async function saveAllSettings() {
  if (_saving) return;
  _saving = true;
  try {
    // Erst aktuelle Tab-Werte in S uebernehmen, dann S als Basis nutzen
    const tabUpdates = collectSettings();
    deepMerge(S, tabUpdates);
    // Vollstaendiges Settings-Objekt senden (nicht nur aktiven Tab)
    const updates = JSON.parse(JSON.stringify(S));
    await api('/api/ui/settings', 'PUT', {settings: updates});
    toast('Einstellungen gespeichert');
  } catch(e) {
    toast('Fehler beim Speichern', 'error');
  } finally {
    _saving = false;
  }
}

// ---- Entities ----
async function loadEntities() {
  try {
    const data = await api('/api/ui/entities');
    ALL_ENTITIES = data.entities || [];
    const domains = [...new Set(ALL_ENTITIES.map(e => e.domain))].sort();
    const sel = document.getElementById('entityDomainFilter');
    sel.innerHTML = `<option value="">Alle Domains (${ALL_ENTITIES.length})</option>`;
    for (const d of domains) {
      const c = ALL_ENTITIES.filter(e => e.domain === d).length;
      sel.innerHTML += `<option value="${esc(d)}">${esc(d)} (${c})</option>`;
    }
    filterEntities();
  } catch(e) { console.error('Entities fail:', e); }
}

function filterEntities() {
  const domain = document.getElementById('entityDomainFilter').value;
  const search = document.getElementById('entitySearchInput').value.toLowerCase();
  let filtered = ALL_ENTITIES;
  if (domain) filtered = filtered.filter(e => e.domain === domain);
  if (search) filtered = filtered.filter(e => e.entity_id.toLowerCase().includes(search) || e.name.toLowerCase().includes(search));
  const show = filtered.slice(0, 100);
  const c = document.getElementById('entityBrowser');
  c.innerHTML = show.map(e => `
    <div class="entity-item" onclick="navigator.clipboard?.writeText('${esc(e.entity_id)}');toast('${esc(e.entity_id)} kopiert')">
      <span class="ename">${esc(e.name)}</span>
      <span class="eid">${esc(e.entity_id)}</span>
      <span style="color:var(--text-muted);font-size:11px;">${esc(e.state)}</span>
    </div>`).join('');
  if (filtered.length > 100) c.innerHTML += `<div style="padding:10px;text-align:center;color:var(--text-muted);font-size:11px;">...und ${filtered.length-100} weitere</div>`;
}

// ---- Knowledge ----
async function loadKnowledge() {
  try {
    const d = await api('/api/ui/knowledge');
    const st = d.stats || {}, fi = d.files || [];
    document.getElementById('kbStats').innerHTML = `
      <div class="stat-card"><div class="stat-label">Status</div>
        <div class="stat-value" style="font-size:18px;color:${st.enabled?'var(--success)':'var(--danger)'};">${st.enabled?'Aktiv':'Aus'}</div></div>
      <div class="stat-card"><div class="stat-label">Chunks</div><div class="stat-value">${st.total_chunks||0}</div></div>
      <div class="stat-card"><div class="stat-label">Quellen</div><div class="stat-value">${(st.sources||[]).length}</div>
        <div class="stat-sub">${(st.sources||[]).map(s=>esc(s)).join(', ')||'keine'}</div></div>`;
    document.getElementById('kbFiles').innerHTML = fi.length === 0
      ? '<div style="padding:16px;text-align:center;color:var(--text-muted);">Keine Dateien</div>'
      : fi.map(f => `<div class="file-item"><span style="font-size:16px;">&#128196;</span><span class="file-name">${esc(f.name)}</span><span class="file-size">${fmtBytes(f.size)}</span></div>`).join('');
  } catch(e) { console.error('KB fail:', e); }
}
async function ingestKnowledge() {
  try {
    const d = await api('/api/ui/knowledge/ingest', 'POST');
    toast(`${d.new_chunks} neue Chunks eingelesen`);
    loadKnowledge();
  } catch(e) { toast('Fehler beim Einlesen', 'error'); }
}

// ---- Logs & Audit ----
let currentLogTab = 'conversations';

function switchLogTab(tab) {
  currentLogTab = tab;
  document.querySelectorAll('#logsTabBar .tab-item').forEach(t => t.classList.toggle('active', t.dataset.logtab===tab));
  document.getElementById('logsContainer').style.display = tab==='conversations' ? '' : 'none';
  document.getElementById('auditContainer').style.display = tab==='audit' ? '' : 'none';
  if (tab==='conversations') loadLogs();
  else loadAudit();
}

async function loadAudit() {
  try {
    const d = await api('/api/ui/audit?limit=100');
    const entries = d.entries || [];
    const c = document.getElementById('auditContainer');
    if (entries.length === 0) {
      c.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted);">Keine Audit-Eintraege</div>';
      return;
    }
    c.innerHTML = entries.map(e => {
      const t = e.timestamp ? new Date(e.timestamp).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';
      const act = e.action || '';
      const cat = act.includes('login')||act.includes('pin')||act.includes('setup') ? 'auth'
        : act.includes('security')||act.includes('api_key')||act.includes('recovery') ? 'security'
        : act.includes('settings')||act.includes('autonomy')||act.includes('easter')||act.includes('notification') ? 'settings'
        : 'system';
      const details = e.details ? Object.entries(e.details).map(([k,v])=>`${k}: ${typeof v==='object'?JSON.stringify(v):v}`).join(', ') : '';
      return `<div class="audit-entry"><span class="audit-time">${t}</span><span class="audit-action ${cat}">${esc(act)}</span><span class="audit-details">${esc(details)}</span></div>`;
    }).join('');
  } catch(e) { console.error('Audit fail:', e); }
}

async function loadLogs() {
  try {
    const d = await api('/api/ui/logs?limit=200');
    const convs = d.conversations || [];
    const c = document.getElementById('logsContainer');
    if (convs.length === 0) { c.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted);">Keine Gespraeche</div>'; return; }
    c.innerHTML = convs.map(cv => {
      const t = cv.timestamp ? new Date(cv.timestamp).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) : '';
      const role = cv.role || 'system';
      return `<div class="log-entry"><span class="log-time">${t}</span><span class="log-role ${role}">${role}</span><span class="log-content">${esc(cv.content||'')}</span></div>`;
    }).join('');
  } catch(e) { console.error('Logs fail:', e); }
}

// ---- Fehlerspeicher ----
let _errFilter = '';

function filterErrors(level) {
  _errFilter = level;
  document.getElementById('errFilterAll').classList.toggle('active-filter', !level);
  document.getElementById('errFilterError').classList.toggle('active-filter', level==='ERROR');
  document.getElementById('errFilterWarn').classList.toggle('active-filter', level==='WARNING');
  loadErrors();
}

async function loadErrors() {
  try {
    const params = _errFilter ? `&level=${_errFilter}` : '';
    const d = await api(`/api/ui/errors?limit=200${params}`);
    const errs = d.errors || [];
    const c = document.getElementById('errorsContainer');
    if (errs.length === 0) {
      c.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted);">Keine Fehler gespeichert</div>';
    } else {
      c.innerHTML = errs.map(e => {
        const t = e.timestamp ? new Date(e.timestamp).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';
        return `<div class="err-entry level-${esc(e.level)}"><span class="err-time">${t}</span><span class="err-level ${esc(e.level)}">${esc(e.level)}</span><span class="err-logger" title="${esc(e.logger||'')}">${esc(e.logger||'')}</span><span class="err-msg">${esc(e.message||'')}</span></div>`;
      }).join('');
    }
    document.getElementById('errorsInfo').textContent = `${d.total} Eintraege gespeichert (max. 200)`;
    updateErrBadge(d.total);
  } catch(e) { console.error('Errors fail:', e); }
}

async function clearErrors() {
  if (!confirm('Fehlerspeicher wirklich leeren?')) return;
  try {
    await api('/api/ui/errors', 'DELETE');
    toast('Fehlerspeicher geleert');
    loadErrors();
  } catch(e) { toast('Fehler beim Leeren', 'error'); }
}

function updateErrBadge(count) {
  const b = document.getElementById('errBadge');
  if (count > 0) { b.textContent = count > 99 ? '99+' : count; b.style.display = 'inline-flex'; }
  else { b.style.display = 'none'; }
}

// Fehlerzahl beim Seitennavigation aktualisieren
async function refreshErrBadge() {
  try {
    const d = await api('/api/ui/errors?limit=1');
    updateErrBadge(d.total);
  } catch(e) {}
}

// ============================================================
// System-Tab (Update, Restart, Status)
// ============================================================

let _sysStatus = null;
let _updating = false;

function renderSystem() {
  return sectionWrap('&#128300;', 'System-Status',
    '<div id="sysStatusBox" style="font-family:var(--font-mono);font-size:12px;color:var(--text-secondary);">Lade...</div>' +
    '<button class="btn btn-secondary" style="margin-top:12px;font-size:12px;" onclick="loadSystemStatus()">Status aktualisieren</button>'
  ) +
  sectionWrap('&#128640;', 'System-Update',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Holt neuen Code von Git und baut die Container neu. Der Assistant startet dabei kurz neu.</p>' +
    '<div id="sysUpdateCheck" style="margin-bottom:12px;"></div>' +
    '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
      '<button class="btn btn-primary" id="btnSysUpdate" onclick="doSystemUpdate()">&#128640; System-Update starten</button>' +
      '<button class="btn btn-secondary" id="btnSysCheckUpdate" onclick="checkForUpdates()">&#128269; Auf Updates pruefen</button>' +
    '</div>' +
    '<div id="sysUpdateLog" style="display:none;margin-top:16px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;max-height:300px;overflow-y:auto;">' +
      '<div style="font-size:11px;font-family:var(--font-mono);white-space:pre-wrap;" id="sysUpdateLogContent"></div>' +
    '</div>'
  ) +
  sectionWrap('&#128260;', 'Container neustarten',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Startet alle Container neu ohne Rebuild. Schneller als ein volles Update.</p>' +
    '<button class="btn btn-secondary" id="btnSysRestart" onclick="doSystemRestart()">&#128260; Container neustarten</button>'
  ) +
  sectionWrap('&#129302;', 'Ollama-Modelle aktualisieren',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Aktualisiert alle installierten LLM-Modelle auf die neueste Version.</p>' +
    '<div id="sysModelsList" style="margin-bottom:12px;font-size:12px;color:var(--text-secondary);"></div>' +
    '<button class="btn btn-secondary" id="btnSysModels" onclick="doUpdateModels()">&#129302; Modelle aktualisieren</button>' +
    '<div id="sysModelsLog" style="display:none;margin-top:12px;font-size:12px;font-family:var(--font-mono);color:var(--text-secondary);"></div>'
  );
}

async function loadSystemStatus() {
  const box = document.getElementById('sysStatusBox');
  if (!box) return;
  try {
    _sysStatus = await api('/api/ui/system/status');
    const s = _sysStatus;
    const git = s.git || {};
    const containers = s.containers || {};
    const ollama = s.ollama || {};
    const disk = s.disk?.system || {};

    const cStatus = Object.entries(containers).map(([name, status]) => {
      const color = status === 'healthy' ? 'var(--success)' : status === 'unhealthy' ? 'var(--danger)' : 'var(--warning)';
      const short = name.replace('mindhome-', '').replace('mha-', '');
      return `<span style="color:${color};">&#9679;</span> ${short}: ${status}`;
    }).join('&nbsp;&nbsp;|&nbsp;&nbsp;');

    const models = document.getElementById('sysModelsList');
    if (models && ollama.models) {
      models.innerHTML = '<strong>Installiert:</strong> ' + esc(ollama.models).split('\n').slice(1).filter(l=>l.trim()).map(l => l.split(/\s+/)[0]).join(', ');
    }

    box.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px 24px;">
        <div><strong>Version:</strong> ${esc(s.version || '?')}</div>
        <div><strong>Branch:</strong> ${esc(git.branch || '?')}</div>
        <div style="grid-column:1/-1;"><strong>Commit:</strong> ${esc(git.commit || '?')}</div>
        <div style="grid-column:1/-1;"><strong>Container:</strong> ${cStatus}</div>
        <div><strong>Ollama:</strong> ${ollama.available ? '<span style="color:var(--success);">Online</span>' : '<span style="color:var(--danger);">Offline</span>'}</div>
        <div><strong>Disk frei:</strong> ${disk.free_gb || '?'} GB / ${disk.total_gb || '?'} GB</div>
      </div>
      ${git.changes ? '<div style="margin-top:8px;padding:8px;background:var(--bg-hover);border-radius:4px;"><strong>Lokale Aenderungen:</strong><pre style="margin:4px 0 0;font-size:11px;">' + esc(git.changes) + '</pre></div>' : ''}
    `;
  } catch(e) {
    box.innerHTML = '<span style="color:var(--danger);">Fehler beim Laden: ' + esc(e.message) + '</span>';
  }
}

async function checkForUpdates() {
  const box = document.getElementById('sysUpdateCheck');
  const btn = document.getElementById('btnSysCheckUpdate');
  if (!box || !btn) return;
  btn.disabled = true;
  btn.textContent = 'Pruefe...';
  try {
    const data = await api('/api/ui/system/update-check');
    if (data.updates_available) {
      const commits = (data.new_commits || []).map(c => '<div style="padding:2px 0;">' + esc(c) + '</div>').join('');
      box.innerHTML = '<div style="padding:10px;background:var(--bg-hover);border-left:3px solid var(--accent);border-radius:4px;">' +
        '<strong style="color:var(--accent);">&#9889; Updates verfuegbar!</strong> (' + esc(data.local) + ' &rarr; ' + esc(data.remote) + ')' +
        '<div style="margin-top:8px;font-size:11px;font-family:var(--font-mono);">' + commits + '</div></div>';
    } else {
      box.innerHTML = '<div style="padding:8px;color:var(--success);"><strong>&#10003;</strong> System ist aktuell (' + esc(data.local || '') + ')</div>';
    }
  } catch(e) {
    box.innerHTML = '<span style="color:var(--danger);">Fehler: ' + esc(e.message) + '</span>';
  } finally {
    btn.disabled = false;
    btn.textContent = '\u{1F50D} Auf Updates pruefen';
  }
}

function _waitForRestart() {
  // Pollt alle 3s bis der Server wieder antwortet, dann Reload
  toast('Container startet neu... bitte kurz warten.');
  let attempts = 0;
  const poll = setInterval(async () => {
    attempts++;
    try {
      const r = await fetch('/api/assistant/health');
      if (r.ok) { clearInterval(poll); location.reload(); }
    } catch(e) { /* noch nicht bereit */ }
    if (attempts > 40) { clearInterval(poll); location.reload(); }
  }, 3000);
}

async function doSystemUpdate() {
  if (_updating) return;
  if (!confirm('System-Update starten?\n\nDer Assistant wird kurz neu gestartet.')) return;
  _updating = true;
  const btn = document.getElementById('btnSysUpdate');
  const logBox = document.getElementById('sysUpdateLog');
  const logContent = document.getElementById('sysUpdateLogContent');
  if (btn) { btn.disabled = true; btn.textContent = 'Update laeuft...'; }
  if (logBox) logBox.style.display = 'block';
  if (logContent) logContent.textContent = 'Update gestartet...\n';

  try {
    const data = await api('/api/ui/system/update', 'POST');
    if (logContent) logContent.textContent = (data.log || []).join('\n');
    if (data.success) {
      toast('Update erfolgreich! Container startet neu...');
      _waitForRestart();
    } else {
      toast('Update fehlgeschlagen — siehe Log', 'error');
      _updating = false;
      if (btn) { btn.disabled = false; btn.textContent = '\u{1F680} System-Update starten'; }
    }
  } catch(e) {
    if (logContent) logContent.textContent += '\nFehler: ' + e.message;
    if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
      _waitForRestart();
    } else {
      toast('Update-Fehler: ' + e.message, 'error');
      _updating = false;
      if (btn) { btn.disabled = false; btn.textContent = '\u{1F680} System-Update starten'; }
    }
  }
}

async function doSystemRestart() {
  if (!confirm('Alle Container jetzt neustarten?')) return;
  const btn = document.getElementById('btnSysRestart');
  if (btn) { btn.disabled = true; btn.textContent = 'Neustart laeuft...'; }
  try {
    await api('/api/ui/system/restart', 'POST');
  } catch(e) { /* erwartbar: Verbindung bricht ab */ }
  _waitForRestart();
}

async function doUpdateModels() {
  if (!confirm('Alle Ollama-Modelle aktualisieren?\n\nDas kann je nach Modellgroesse einige Minuten dauern.')) return;
  const btn = document.getElementById('btnSysModels');
  const logBox = document.getElementById('sysModelsLog');
  if (btn) { btn.disabled = true; btn.textContent = 'Aktualisiere...'; }
  if (logBox) { logBox.style.display = 'block'; logBox.textContent = 'Modelle werden aktualisiert...\n'; }
  try {
    const data = await api('/api/ui/system/update-models', 'POST');
    if (logBox) {
      logBox.textContent = (data.models || []).map(m =>
        (m.success ? '\u2713' : '\u2717') + ' ' + m.model + ': ' + (m.output || '').split('\n').pop()
      ).join('\n');
    }
    if (data.success) {
      toast('Alle Modelle aktualisiert!');
    } else {
      toast('Einige Modelle konnten nicht aktualisiert werden', 'error');
    }
  } catch(e) {
    toast('Fehler: ' + e.message, 'error');
    if (logBox) logBox.textContent += '\nFehler: ' + e.message;
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = '\u{1F916} Modelle aktualisieren'; }
  }
}

</script>
</body>
</html>
