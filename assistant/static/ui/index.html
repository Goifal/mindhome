<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jarvis â€” MindHome Dashboard</title>
<style>
/* ============================================================
   MindHome Design System â€” Jarvis Dashboard v2
   Dark futuristic, amber accents, Outfit font
   ============================================================ */
/* Offline-Fonts: System-Fonts statt Google CDN (Offline-Prinzip) */
@font-face {
  font-family: 'Outfit';
  font-style: normal;
  font-weight: 300 700;
  font-display: swap;
  src: local('Outfit'), local('Inter'), local('Segoe UI');
}
@font-face {
  font-family: 'JetBrains Mono';
  font-style: normal;
  font-weight: 400 500;
  font-display: swap;
  src: local('JetBrains Mono'), local('SF Mono'), local('Consolas'), local('Menlo');
}

:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2035;
  --bg-card-hover: #1f2847;
  --bg-input: #151d30;
  --bg-overlay: rgba(10, 14, 23, 0.85);
  --text-primary: #e8ecf4;
  --text-secondary: #8892a8;
  --text-muted: #5a6478;
  --accent: #f59e0b;
  --accent-dim: rgba(245, 158, 11, 0.15);
  --accent-glow: rgba(245, 158, 11, 0.3);
  --blue: #3b82f6;
  --blue-dim: rgba(59, 130, 246, 0.15);
  --success: #10b981;
  --success-dim: rgba(16, 185, 129, 0.15);
  --danger: #ef4444;
  --danger-dim: rgba(239, 68, 68, 0.15);
  --border: rgba(255, 255, 255, 0.06);
  --border-hover: rgba(255, 255, 255, 0.12);
  --border-accent: rgba(245, 158, 11, 0.3);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
  --shadow-glow: 0 0 20px rgba(245, 158, 11, 0.15);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --font: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'JetBrains Mono', 'SF Mono', monospace;
  --sidebar-w: 220px;
  --header-h: 56px;
  --fast: 0.15s ease;
  --normal: 0.25s ease;
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:var(--font); background:var(--bg-primary); color:var(--text-primary); min-height:100vh; overflow-x:hidden; }

/* ---- Login ---- */
.login-screen { display:flex; align-items:center; justify-content:center; min-height:100vh; }
.login-box { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:48px 40px; width:360px; text-align:center; box-shadow:var(--shadow-lg); }
.login-box h1 { font-size:28px; font-weight:600; margin-bottom:8px; color:var(--accent); }
.login-box p { color:var(--text-secondary); margin-bottom:32px; font-size:14px; }
.login-box input { width:100%; padding:14px 16px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary); font-family:var(--mono); font-size:24px; text-align:center; letter-spacing:12px; outline:none; }
.login-box input:focus { border-color:var(--accent); }
.login-box input::placeholder { letter-spacing:4px; font-size:14px; color:var(--text-muted); }
.login-box button { width:100%; margin-top:20px; padding:14px; background:var(--accent); color:#0a0e17; border:none; border-radius:var(--radius-sm); font-family:var(--font); font-size:16px; font-weight:600; cursor:pointer; }
.login-box button:hover { opacity:0.9; }
.login-error { color:var(--danger); font-size:13px; margin-top:12px; min-height:20px; }

/* ---- App ---- */
.app { display:none; }
.app.active { display:flex; min-height:100vh; }

/* Sidebar */
.sidebar { width:var(--sidebar-w); background:var(--bg-secondary); border-right:1px solid var(--border); display:flex; flex-direction:column; position:fixed; top:0; left:0; bottom:0; z-index:100; }
.sidebar-logo { padding:18px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
.sidebar-logo .logo-icon { width:34px; height:34px; background:var(--accent-dim); border-radius:var(--radius-sm); display:flex; align-items:center; justify-content:center; font-size:18px; }
.sidebar-logo h2 { font-size:17px; font-weight:600; }
.sidebar-logo span { font-size:10px; color:var(--text-muted); display:block; }
.sidebar-nav { padding:12px 8px; flex:1; overflow-y:auto; }
.nav-item { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:var(--radius-sm); color:var(--text-secondary); cursor:pointer; font-size:13px; font-weight:500; margin-bottom:2px; transition:all var(--fast); }
.nav-item:hover { background:var(--bg-card); color:var(--text-primary); }
.nav-item.active { background:var(--accent-dim); color:var(--accent); }
.nav-item .nav-icon { width:18px; text-align:center; font-size:15px; }
.sidebar-footer { padding:12px; border-top:1px solid var(--border); font-size:11px; color:var(--text-muted); text-align:center; }

/* Main */
.main { margin-left:var(--sidebar-w); flex:1; min-height:100vh; }
.main-header { height:var(--header-h); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 28px; background:var(--bg-secondary); position:sticky; top:0; z-index:50; }
.main-header h1 { font-size:17px; font-weight:600; }
.main-content { padding:28px; }

/* Responsive */
@media (max-width:900px) {
  .sidebar { transform:translateX(-100%); transition:transform var(--normal); }
  .sidebar.open { transform:translateX(0); }
  .main { margin-left:0; }
  .mobile-toggle { display:flex !important; }
}

/* Pages */
.page { display:none; }
.page.active { display:block; }

/* Grid */
.grid { display:grid; gap:16px; }
.grid-2 { grid-template-columns:repeat(2,1fr); }
.grid-3 { grid-template-columns:repeat(3,1fr); }
.grid-4 { grid-template-columns:repeat(4,1fr); }
@media (max-width:1200px) { .grid-4 { grid-template-columns:repeat(2,1fr); } }
@media (max-width:900px) { .grid-2,.grid-3,.grid-4 { grid-template-columns:1fr; } }

/* Card */
.card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md); padding:20px; margin-bottom:16px; }
.card:hover { border-color:var(--border-hover); }
.card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.card-header h3 { font-size:15px; font-weight:600; }

/* Stat */
.stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md); padding:18px 20px; }
.stat-card:hover { border-color:var(--border-hover); box-shadow:var(--shadow-md); }
.stat-label { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; }
.stat-value { font-size:26px; font-weight:700; font-family:var(--mono); }
.stat-sub { font-size:11px; color:var(--text-secondary); margin-top:4px; }

/* Form */
.form-group { margin-bottom:16px; }
.form-group label { display:block; font-size:13px; font-weight:500; color:var(--text-secondary); margin-bottom:6px; }
.form-group .hint { font-size:11px; color:var(--text-muted); margin-top:3px; }
input[type="text"],input[type="number"],select,textarea { width:100%; padding:9px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary); font-family:var(--font); font-size:13px; outline:none; }
input:focus,select:focus,textarea:focus { border-color:var(--accent); }
select { cursor:pointer; }
textarea { resize:vertical; min-height:70px; font-family:var(--mono); font-size:12px; }

/* Range */
.range-group { display:flex; align-items:center; gap:14px; }
.range-group input[type="range"] { flex:1; -webkit-appearance:none; height:5px; background:var(--bg-input); border-radius:3px; border:none; outline:none; }
.range-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); cursor:pointer; box-shadow:0 0 8px var(--accent-glow); }
.range-value { min-width:40px; text-align:center; font-family:var(--mono); font-size:14px; font-weight:600; color:var(--accent); }

/* Toggle */
.toggle-group { display:flex; align-items:center; justify-content:space-between; }
.toggle { position:relative; width:42px; height:22px; cursor:pointer; }
.toggle input { display:none; }
.toggle-track { position:absolute; inset:0; background:var(--bg-input); border:1px solid var(--border); border-radius:11px; transition:all var(--fast); }
.toggle input:checked + .toggle-track { background:var(--accent-dim); border-color:var(--accent); }
.toggle-thumb { position:absolute; top:3px; left:3px; width:16px; height:16px; border-radius:50%; background:var(--text-muted); transition:all var(--fast); }
.toggle input:checked ~ .toggle-thumb { left:23px; background:var(--accent); }

/* Buttons */
.btn { display:inline-flex; align-items:center; gap:8px; padding:9px 18px; border:none; border-radius:var(--radius-sm); font-family:var(--font); font-size:13px; font-weight:500; cursor:pointer; transition:all var(--fast); }
.btn-primary { background:var(--accent); color:#0a0e17; }
.btn-primary:hover { opacity:0.9; box-shadow:var(--shadow-glow); }
.btn-secondary { background:var(--bg-input); color:var(--text-primary); border:1px solid var(--border); }
.btn-secondary:hover { border-color:var(--border-hover); }
.btn-danger { background:var(--danger-dim); color:var(--danger); }
.btn-sm { padding:5px 12px; font-size:12px; }

/* Tab Bar */
.tab-bar { display:flex; gap:2px; background:var(--bg-input); padding:3px; border-radius:var(--radius-sm); margin-bottom:20px; flex-wrap:wrap; }
.tab-item { padding:7px 14px; border-radius:6px; font-size:12px; font-weight:500; color:var(--text-secondary); cursor:pointer; transition:all var(--fast); white-space:nowrap; }
.tab-item:hover { color:var(--text-primary); }
.tab-item.active { background:var(--bg-card); color:var(--accent); box-shadow:var(--shadow-sm); }

/* Settings Section (collapsible) */
.s-section { border:1px solid var(--border); border-radius:var(--radius-md); margin-bottom:14px; overflow:hidden; }
.s-section-hdr { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:var(--bg-card); cursor:pointer; transition:background var(--fast); }
.s-section-hdr:hover { background:var(--bg-card-hover); }
.s-section-hdr h3 { font-size:14px; font-weight:600; display:flex; align-items:center; gap:8px; }
.s-section-hdr .arrow { transition:transform var(--fast); color:var(--text-muted); font-size:12px; }
.s-section-hdr.open .arrow { transform:rotate(180deg); }
.s-section-body { padding:0 18px; max-height:0; overflow:hidden; transition:max-height 0.3s ease,padding 0.3s ease; }
.s-section-body.open { padding:18px; max-height:5000px; }

/* Entity */
.entity-picker { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px; margin-bottom:14px; }
.entity-search { padding:8px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-primary); font-size:13px; width:100%; margin-bottom:10px; outline:none; font-family:var(--font); }
.entity-search:focus { border-color:var(--accent); }
.entity-list { max-height:400px; overflow-y:auto; border:1px solid var(--border); border-radius:var(--radius-sm); }
.entity-item { display:flex; align-items:center; gap:10px; padding:8px 12px; cursor:pointer; font-size:13px; border-bottom:1px solid var(--border); transition:background var(--fast); }
.entity-item:last-child { border-bottom:none; }
.entity-item:hover { background:var(--bg-card-hover); }
.entity-item .eid { color:var(--text-muted); font-family:var(--mono); font-size:11px; }
.entity-item .ename { flex:1; }
.selected-entities { display:flex; flex-wrap:wrap; gap:5px; margin-top:6px; }
.entity-tag { display:inline-flex; align-items:center; gap:5px; padding:3px 9px; background:var(--accent-dim); border:1px solid var(--border-accent); border-radius:16px; font-size:11px; color:var(--accent); font-family:var(--mono); }
.entity-tag .remove { cursor:pointer; opacity:0.6; font-size:13px; }
.entity-tag .remove:hover { opacity:1; }

/* Logs */
.log-entry { display:flex; gap:14px; padding:10px 14px; border-bottom:1px solid var(--border); font-size:12px; }
.log-entry:hover { background:var(--bg-card-hover); }
.log-time { color:var(--text-muted); font-family:var(--mono); font-size:11px; min-width:70px; }
.log-role { min-width:55px; font-weight:600; font-size:11px; text-transform:uppercase; }
.log-role.user { color:var(--blue); }
.log-role.assistant { color:var(--accent); }
.log-content { flex:1; color:var(--text-primary); line-height:1.5; }

/* Section Header */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
.section-header h2 { font-size:18px; font-weight:600; }
.section-header p { font-size:12px; color:var(--text-secondary); margin-top:3px; }

/* Knowledge Files */
.file-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid var(--border); font-size:12px; }
.file-name { flex:1; font-weight:500; }
.file-size { color:var(--text-muted); font-family:var(--mono); font-size:11px; }

/* Badge */
.badge { padding:3px 10px; border-radius:16px; font-size:11px; font-weight:500; }
.badge-ok { background:var(--success-dim); color:var(--success); }
.badge-warn { background:rgba(245,158,11,0.15); color:var(--accent); }
.badge-err { background:var(--danger-dim); color:var(--danger); }

/* Mobile */
.mobile-toggle { display:none; align-items:center; justify-content:center; width:34px; height:34px; border-radius:var(--radius-sm); background:var(--bg-card); border:1px solid var(--border); cursor:pointer; font-size:16px; }

/* Toast */
.toast { position:fixed; bottom:20px; right:20px; padding:12px 22px; border-radius:var(--radius-sm); font-size:13px; font-weight:500; box-shadow:var(--shadow-lg); z-index:9999; transform:translateY(80px); opacity:0; transition:all 0.3s ease; }
.toast.show { transform:translateY(0); opacity:1; }
.toast-success { background:var(--success); color:white; }
.toast-error { background:var(--danger); color:white; }
.toast-info { background:var(--blue); color:white; }

/* Scrollbar */
::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border-hover); border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:var(--text-muted); }

/* Loading */
.spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; display:inline-block; margin-right:10px; }
@keyframes spin { to { transform:rotate(360deg); } }

/* Keyword tags editor */
.kw-editor { display:flex; flex-wrap:wrap; gap:4px; padding:8px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); min-height:36px; cursor:text; }
.kw-tag { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; background:var(--accent-dim); border:1px solid var(--border-accent); border-radius:12px; font-size:11px; color:var(--accent); font-family:var(--mono); }
.kw-tag .kw-rm { cursor:pointer; opacity:0.6; }
.kw-tag .kw-rm:hover { opacity:1; }
.kw-input { border:none; background:transparent; color:var(--text-primary); font-family:var(--font); font-size:12px; outline:none; min-width:80px; flex:1; }

/* Chip Select â€” klickbare vordefinierte Optionen */
.chip-grid { display:flex; flex-wrap:wrap; gap:6px; padding:8px 0; }
.chip-opt { display:inline-flex; align-items:center; gap:4px; padding:5px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:16px; font-size:12px; color:var(--text-secondary); cursor:pointer; transition:all var(--fast); user-select:none; }
.chip-opt:hover { border-color:var(--border-hover); color:var(--text-primary); background:var(--bg-card-hover); }
.chip-opt.selected { background:var(--accent-dim); border-color:var(--border-accent); color:var(--accent); font-weight:500; }
.chip-opt.selected::before { content:'âœ“ '; font-size:10px; }

/* Info-Hint Box */
.info-box { display:flex; align-items:flex-start; gap:8px; padding:10px 14px; background:var(--blue-dim); border:1px solid rgba(59,130,246,0.2); border-radius:var(--radius-sm); margin-bottom:14px; font-size:12px; color:var(--text-secondary); line-height:1.5; }
.info-box::before { content:'ðŸ’¡'; font-size:14px; flex-shrink:0; margin-top:1px; }
</style>
</head>
<body>

<!-- SETUP (erstmaliger Aufruf) -->
<div id="setupScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#9881;</div>
    <h1>JARVIS</h1>
    <p>Ersteinrichtung â€” PIN festlegen</p>
    <input type="password" id="setupPin" maxlength="16" placeholder="PIN waehlen" style="margin-bottom:12px;"
           onkeydown="if(event.key==='Enter')document.getElementById('setupPinConfirm').focus()">
    <input type="password" id="setupPinConfirm" maxlength="16" placeholder="PIN bestaetigen"
           onkeydown="if(event.key==='Enter')doSetup()">
    <button onclick="doSetup()">PIN setzen</button>
    <div id="setupError" class="login-error"></div>
  </div>
</div>

<!-- RECOVERY KEY anzeigen (nach Setup) -->
<div id="recoveryScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#128273;</div>
    <h1>Recovery-Key</h1>
    <p style="color:var(--accent);font-weight:600;margin-bottom:16px;">Diesen Schluessel sicher aufbewahren!</p>
    <p style="margin-bottom:20px;font-size:13px;">Falls du deinen PIN vergisst, kannst du ihn nur mit diesem Key zuruecksetzen. Er wird nur einmal angezeigt.</p>
    <div id="recoveryKeyDisplay" style="background:var(--bg-input);border:2px solid var(--accent);border-radius:var(--radius-sm);padding:18px;font-family:var(--mono);font-size:22px;letter-spacing:4px;color:var(--accent);margin-bottom:20px;user-select:all;"></div>
    <button onclick="recoveryAcknowledged()">Ich habe den Key gespeichert</button>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#9881;</div>
    <h1>JARVIS</h1>
    <p>MindHome Dashboard</p>
    <input type="password" id="pinInput" maxlength="16" placeholder="PIN" autofocus
           onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">Anmelden</button>
    <div id="loginError" class="login-error"></div>
    <div style="margin-top:20px;">
      <a href="#" onclick="showResetScreen();return false;" style="color:var(--text-muted);font-size:12px;text-decoration:none;">PIN vergessen?</a>
    </div>
  </div>
</div>

<!-- PIN RESET -->
<div id="resetScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#128273;</div>
    <h1>PIN zuruecksetzen</h1>
    <p>Recovery-Key eingeben</p>
    <input type="text" id="resetRecoveryKey" maxlength="16" placeholder="Recovery-Key" style="margin-bottom:12px;letter-spacing:2px;text-transform:uppercase;"
           onkeydown="if(event.key==='Enter')document.getElementById('resetNewPin').focus()">
    <input type="password" id="resetNewPin" maxlength="16" placeholder="Neuer PIN" style="margin-bottom:12px;"
           onkeydown="if(event.key==='Enter')document.getElementById('resetNewPinConfirm').focus()">
    <input type="password" id="resetNewPinConfirm" maxlength="16" placeholder="Neuer PIN bestaetigen"
           onkeydown="if(event.key==='Enter')doResetPin()">
    <button onclick="doResetPin()">PIN zuruecksetzen</button>
    <div id="resetError" class="login-error"></div>
    <div style="margin-top:16px;">
      <a href="#" onclick="showLoginScreen();return false;" style="color:var(--text-muted);font-size:12px;text-decoration:none;">Zurueck zur Anmeldung</a>
    </div>
  </div>
</div>

<!-- NEUER RECOVERY KEY (nach Reset) -->
<div id="newRecoveryScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <div style="font-size:44px;margin-bottom:14px;">&#128273;</div>
    <h1>Neuer Recovery-Key</h1>
    <p style="color:var(--accent);font-weight:600;margin-bottom:16px;">Neuen Schluessel sicher aufbewahren!</p>
    <p style="margin-bottom:20px;font-size:13px;">Der alte Recovery-Key ist ungueltig. Dieser neue Key wird nur einmal angezeigt.</p>
    <div id="newRecoveryKeyDisplay" style="background:var(--bg-input);border:2px solid var(--accent);border-radius:var(--radius-sm);padding:18px;font-family:var(--mono);font-size:22px;letter-spacing:4px;color:var(--accent);margin-bottom:20px;user-select:all;"></div>
    <button onclick="newRecoveryAcknowledged()">Ich habe den Key gespeichert</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">&#9881;</div>
      <div><h2>JARVIS</h2><span>MindHome Dashboard</span></div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" data-page="dashboard"><span class="nav-icon">&#9632;</span>Dashboard</div>
      <div class="nav-item" data-page="settings"><span class="nav-icon">&#9881;</span>Einstellungen</div>
      <div class="nav-item" data-page="entities"><span class="nav-icon">&#8801;</span>Entities</div>
      <div class="nav-item" data-page="knowledge"><span class="nav-icon">&#128218;</span>Wissen</div>
      <div class="nav-item" data-page="logs"><span class="nav-icon">&#9776;</span>Logs</div>
    </nav>
    <div class="sidebar-footer">MindHome Assistant v1.1.0</div>
  </aside>

  <div class="main">
    <header class="main-header">
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">&#9776;</div>
        <h1 id="pageTitle">Dashboard</h1>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <span id="statusBadge" class="badge badge-ok">Online</span>
        <button class="btn btn-sm btn-secondary" onclick="doLogout()">Abmelden</button>
      </div>
    </header>

    <div class="main-content">
      <!-- ============ DASHBOARD ============ -->
      <div id="page-dashboard" class="page active">
        <div id="dashStats" class="grid grid-4"></div>
        <div class="grid grid-2" style="margin-top:16px;">
          <div class="card"><div class="card-header"><h3>Komponenten</h3></div><div id="compList"></div></div>
          <div class="card"><div class="card-header"><h3>Status</h3></div><div id="moodInfo"></div></div>
        </div>
      </div>

      <!-- ============ SETTINGS ============ -->
      <div id="page-settings" class="page">
        <div class="section-header">
          <div><h2>Einstellungen</h2><p>Alle Konfigurationen aus settings.yaml</p></div>
          <button class="btn btn-primary" onclick="saveAllSettings()">Speichern</button>
        </div>
        <!-- 8 Tabs -->
        <div class="tab-bar" id="settingsTabBar">
          <div class="tab-item active" data-tab="tab-general">Allgemein</div>
          <div class="tab-item" data-tab="tab-persons">Personen</div>
          <div class="tab-item" data-tab="tab-personality">Persoenlichkeit</div>
          <div class="tab-item" data-tab="tab-memory">Gedaechtnis</div>
          <div class="tab-item" data-tab="tab-mood">Stimmung</div>
          <div class="tab-item" data-tab="tab-rooms">Raeume</div>
          <div class="tab-item" data-tab="tab-voice">Stimme</div>
          <div class="tab-item" data-tab="tab-routines">Routinen</div>
          <div class="tab-item" data-tab="tab-security">Sicherheit</div>
          <div class="tab-item" data-tab="tab-autonomie">KI-Autonomie</div>
          <div class="tab-item" data-tab="tab-eastereggs">Easter Eggs</div>
        </div>
        <div id="settingsContent"></div>
      </div>

      <!-- ============ ENTITIES ============ -->
      <div id="page-entities" class="page">
        <div class="section-header">
          <div><h2>Home Assistant Entities</h2><p>Alle Entities â€” klicke zum Kopieren</p></div>
          <button class="btn btn-secondary" onclick="loadEntities()">Aktualisieren</button>
        </div>
        <div class="grid grid-2" style="margin-bottom:14px;">
          <div class="form-group" style="margin-bottom:0;">
            <select id="entityDomainFilter" onchange="filterEntities()"><option value="">Alle Domains</option></select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <input type="text" id="entitySearchInput" placeholder="Entity suchen..." oninput="filterEntities()">
          </div>
        </div>
        <div class="card" style="padding:0;"><div id="entityBrowser" class="entity-list" style="max-height:500px;"></div></div>
      </div>

      <!-- ============ KNOWLEDGE ============ -->
      <div id="page-knowledge" class="page">
        <div class="section-header">
          <div><h2>Wissensdatenbank</h2><p>Dateien in config/knowledge/ â€” RAG-Quelle</p></div>
          <button class="btn btn-primary" onclick="ingestKnowledge()">Neu einlesen</button>
        </div>
        <div id="kbStats" class="grid grid-3" style="margin-bottom:16px;"></div>
        <div class="card"><div class="card-header"><h3>Dateien</h3></div><div id="kbFiles"></div></div>
      </div>

      <!-- ============ LOGS ============ -->
      <div id="page-logs" class="page">
        <div class="section-header">
          <div><h2>Gespraeche</h2><p>Letzte Interaktionen mit Jarvis</p></div>
          <button class="btn btn-secondary" onclick="loadLogs()">Aktualisieren</button>
        </div>
        <div class="card" style="padding:0;"><div id="logsContainer"></div></div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ============================================================
   Jarvis Dashboard v2 â€” JavaScript
   8 Settings Tabs: Allgemein, Persoenlichkeit, Gedaechtnis,
   Stimmung, Raeume, Stimme, Routinen, Sicherheit
   ============================================================ */

let TOKEN = '';
let S = {};  // Settings cache
let ALL_ENTITIES = [];
const API = '';

// ---- Session-Timeout: Auto-Logout bei Inaktivitaet (30 Min) ----
const SESSION_TIMEOUT_MS = 30 * 60 * 1000;  // 30 Minuten
let _sessionTimer = null;
function resetSessionTimer() {
  if (_sessionTimer) clearTimeout(_sessionTimer);
  if (!TOKEN) return;
  _sessionTimer = setTimeout(() => {
    doLogout();
    alert('Sitzung abgelaufen (30 Min Inaktivitaet). Bitte erneut anmelden.');
  }, SESSION_TIMEOUT_MS);
}
['click','keydown','scroll','mousemove','touchstart'].forEach(evt =>
  document.addEventListener(evt, resetSessionTimer, {passive: true})
);

// ---- Screens ausblenden ----
function hideAllScreens() {
  ['setupScreen','recoveryScreen','loginScreen','resetScreen','newRecoveryScreen'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  document.getElementById('app').classList.remove('active');
}

// ---- Setup-Status pruefen und richtigen Screen zeigen ----
async function checkSetupAndShow() {
  try {
    const r = await fetch(`${API}/api/ui/setup-status`);
    const d = await r.json();
    hideAllScreens();
    if (!d.setup_complete) {
      // Erster Aufruf: Setup-Screen
      document.getElementById('setupScreen').style.display = 'flex';
      document.getElementById('setupPin').focus();
    } else {
      // Setup fertig: Token pruefen oder Login zeigen
      const t = sessionStorage.getItem('jt');
      if (t) {
        // Pruefen ob Token aelter als 4h (Backend-Timeout)
        const ts = parseInt(sessionStorage.getItem('jt_ts') || '0');
        if (Date.now() - ts > 4 * 60 * 60 * 1000) {
          sessionStorage.removeItem('jt');
          sessionStorage.removeItem('jt_ts');
        } else {
          TOKEN = t;
          try {
            const sr = await fetch(`${API}/api/ui/stats`, {headers: {'Authorization': `Bearer ${TOKEN}`}});
            if (sr.ok) { resetSessionTimer(); showApp(); return; }
          } catch(e) {}
        }
      }
      showLoginScreen();
    }
  } catch(e) {
    // Fallback: Login zeigen
    showLoginScreen();
  }
}

// ---- Setup: PIN setzen ----
async function doSetup() {
  const pin = document.getElementById('setupPin').value;
  const confirm = document.getElementById('setupPinConfirm').value;
  const err = document.getElementById('setupError');
  err.textContent = '';

  if (pin.length < 4) { err.textContent = 'PIN muss mindestens 4 Zeichen haben'; return; }
  if (pin !== confirm) { err.textContent = 'PINs stimmen nicht ueberein'; return; }

  try {
    const r = await fetch(`${API}/api/ui/setup`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({pin, pin_confirm: confirm})
    });
    const d = await r.json();
    if (!r.ok) { err.textContent = d.detail || 'Fehler'; return; }

    // Recovery-Key anzeigen
    hideAllScreens();
    document.getElementById('recoveryKeyDisplay').textContent = d.recovery_key;
    document.getElementById('recoveryScreen').style.display = 'flex';
  } catch(e) { err.textContent = 'Verbindung fehlgeschlagen'; }
}

function recoveryAcknowledged() {
  hideAllScreens();
  showLoginScreen();
}

// ---- Login ----
function showLoginScreen() {
  hideAllScreens();
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('pinInput').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('pinInput').focus();
}

async function doLogin() {
  const pin = document.getElementById('pinInput').value;
  const err = document.getElementById('loginError');
  err.textContent = '';

  if (!pin) { err.textContent = 'PIN eingeben'; return; }

  try {
    const r = await fetch(`${API}/api/ui/auth`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({pin})
    });
    if (!r.ok) { err.textContent = 'Falscher PIN'; return; }
    const d = await r.json();
    TOKEN = d.token;
    sessionStorage.setItem('jt', TOKEN);
    sessionStorage.setItem('jt_ts', Date.now().toString());
    resetSessionTimer();
    showApp();
  } catch(e) { err.textContent = 'Verbindung fehlgeschlagen'; }
}

function doLogout() {
  TOKEN = '';
  sessionStorage.removeItem('jt');
  sessionStorage.removeItem('jt_ts');
  if (_sessionTimer) { clearTimeout(_sessionTimer); _sessionTimer = null; }
  hideAllScreens();
  showLoginScreen();
}

function showApp() {
  hideAllScreens();
  document.getElementById('app').classList.add('active');
  loadDashboard();
}

// ---- PIN Reset ----
function showResetScreen() {
  hideAllScreens();
  document.getElementById('resetScreen').style.display = 'flex';
  document.getElementById('resetRecoveryKey').value = '';
  document.getElementById('resetNewPin').value = '';
  document.getElementById('resetNewPinConfirm').value = '';
  document.getElementById('resetError').textContent = '';
  document.getElementById('resetRecoveryKey').focus();
}

async function doResetPin() {
  const recovery_key = document.getElementById('resetRecoveryKey').value.trim().toUpperCase();
  const new_pin = document.getElementById('resetNewPin').value;
  const new_pin_confirm = document.getElementById('resetNewPinConfirm').value;
  const err = document.getElementById('resetError');
  err.textContent = '';

  if (!recovery_key) { err.textContent = 'Recovery-Key eingeben'; return; }
  if (new_pin.length < 4) { err.textContent = 'PIN muss mindestens 4 Zeichen haben'; return; }
  if (new_pin !== new_pin_confirm) { err.textContent = 'PINs stimmen nicht ueberein'; return; }

  try {
    const r = await fetch(`${API}/api/ui/reset-pin`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({recovery_key, new_pin, new_pin_confirm})
    });
    const d = await r.json();
    if (!r.ok) { err.textContent = d.detail || 'Falscher Recovery-Key'; return; }

    // Neuen Recovery-Key anzeigen
    hideAllScreens();
    document.getElementById('newRecoveryKeyDisplay').textContent = d.recovery_key;
    document.getElementById('newRecoveryScreen').style.display = 'flex';
  } catch(e) { err.textContent = 'Verbindung fehlgeschlagen'; }
}

function newRecoveryAcknowledged() {
  hideAllScreens();
  showLoginScreen();
}

// ---- Init: Setup-Status pruefen ----
checkSetupAndShow();

// ---- API ----
async function api(path, method='GET', body=null) {
  const url = `${API}${path}`;
  const opts = {method, headers:{'Content-Type':'application/json', 'Authorization': `Bearer ${TOKEN}`}};
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(url, opts);
  if (r.status === 401) { doLogout(); throw new Error('Auth'); }
  return r.json();
}

// ---- Navigation ----
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    item.classList.add('active');
    const pg = item.dataset.page;
    document.getElementById(`page-${pg}`).classList.add('active');
    document.getElementById('pageTitle').textContent = item.textContent.trim();
    if (pg==='dashboard') loadDashboard();
    else if (pg==='settings') loadSettings();
    else if (pg==='entities') loadEntities();
    else if (pg==='knowledge') loadKnowledge();
    else if (pg==='logs') loadLogs();
    document.getElementById('sidebar').classList.remove('open');
  });
});

// ---- Toast ----
function toast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast toast-${type} show`;
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ---- Helpers ----
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function fmtBytes(b) { if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
function getPath(obj,path) { return path.split('.').reduce((o,k)=>o?.[k], obj); }
function setPath(obj,path,val) {
  const parts=path.split('.'); let cur=obj;
  for(let i=0;i<parts.length-1;i++) { if(!cur[parts[i]]) cur[parts[i]]={}; cur=cur[parts[i]]; }
  cur[parts[parts.length-1]]=val;
}

// ---- Dashboard ----
async function loadDashboard() {
  try {
    const d = await api('/api/ui/stats');
    const mem=d.memory||{}, sem=mem.semantic||{}, kb=d.knowledge_base||{}, auto=d.autonomy||{};
    document.getElementById('dashStats').innerHTML = `
      <div class="stat-card"><div class="stat-label">Fakten</div><div class="stat-value">${sem.total_facts||0}</div>
        <div class="stat-sub">${(sem.persons||[]).length} Personen</div></div>
      <div class="stat-card"><div class="stat-label">Wissensbasis</div><div class="stat-value">${kb.total_chunks||0}</div>
        <div class="stat-sub">${(kb.sources||[]).length} Quellen</div></div>
      <div class="stat-card"><div class="stat-label">Episoden</div><div class="stat-value">${mem.episodic_count||0}</div>
        <div class="stat-sub">Langzeitgedaechtnis</div></div>
      <div class="stat-card"><div class="stat-label">Autonomie</div><div class="stat-value" style="color:var(--accent);">${auto.level||'?'}/5</div>
        <div class="stat-sub">${auto.name||''}</div></div>`;
    const comps=d.components||{};
    let ch='';
    for(const [n,s] of Object.entries(comps)) {
      const ok=s==='connected'||String(s).includes('active');
      ch+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
        <span style="font-size:12px;">${n}</span>
        <span style="font-size:11px;color:${ok?'var(--success)':'var(--danger)'};font-family:var(--mono);">${s}</span></div>`;
    }
    document.getElementById('compList').innerHTML=ch;
    const mood=d.mood||{};
    document.getElementById('moodInfo').innerHTML=`
      <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;">
        <span style="font-size:12px;">Stimmung</span><span style="font-size:12px;color:var(--accent);font-weight:600;">${mood.mood||'neutral'}</span></div>
      <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;">
        <span style="font-size:12px;">Stress</span><span style="font-size:12px;font-family:var(--mono);">${(mood.stress_level||0).toFixed(2)}</span></div>
      <div style="padding:8px 0;display:flex;justify-content:space-between;">
        <span style="font-size:12px;">Redis</span><span style="font-size:11px;color:${mem.redis_connected?'var(--success)':'var(--danger)'};">${mem.redis_connected?'Verbunden':'Getrennt'}</span></div>`;
  } catch(e) { console.error('Dashboard fail:', e); }
}

// ============================================================
//  SETTINGS - 8 Tabs
// ============================================================

let currentTab = 'tab-general';

// Tab switching
document.getElementById('settingsTabBar').addEventListener('click', e => {
  const tab = e.target.closest('.tab-item');
  if (!tab) return;
  document.querySelectorAll('#settingsTabBar .tab-item').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  currentTab = tab.dataset.tab;
  renderCurrentTab();
});

async function loadSettings() {
  try {
    S = await api('/api/ui/settings');
    renderCurrentTab();
  } catch(e) { console.error('Settings fail:', e); }
}

function renderCurrentTab() {
  const c = document.getElementById('settingsContent');
  switch(currentTab) {
    case 'tab-general': c.innerHTML = renderGeneral(); break;
    case 'tab-persons': c.innerHTML = renderPersons(); break;
    case 'tab-personality': c.innerHTML = renderPersonality(); break;
    case 'tab-memory': c.innerHTML = renderMemory(); break;
    case 'tab-mood': c.innerHTML = renderMood(); break;
    case 'tab-rooms': c.innerHTML = renderRooms(); break;
    case 'tab-voice': c.innerHTML = renderVoice(); break;
    case 'tab-routines': c.innerHTML = renderRoutines(); break;
    case 'tab-security': c.innerHTML = renderSecurity(); loadApiKey(); break;
    case 'tab-autonomie': c.innerHTML = renderAutonomie(); loadSnapshots(); loadOptStatus(); break;
    case 'tab-eastereggs': c.innerHTML = renderEasterEggs(); loadEasterEggs(); break;
  }
  bindFormEvents();
}

// ---- Form field generators ----
function fText(path, label, hint='', ro=false) {
  const v = getPath(S,path) ?? '';
  return `<div class="form-group"><label>${label}</label>
    <input type="text" data-path="${path}" value="${esc(String(v))}" ${ro?'readonly':''}>${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}
function fNum(path, label, min='', max='', step='1', hint='') {
  const v = getPath(S,path) ?? '';
  return `<div class="form-group"><label>${label}</label>
    <input type="number" data-path="${path}" value="${v}" min="${min}" max="${max}" step="${step}">${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}
function fRange(path, label, min, max, step, labels=null) {
  const v = getPath(S,path) ?? min;
  const lbl = labels ? (labels[v]||v) : v;
  return `<div class="form-group"><label>${label}</label>
    <div class="range-group"><input type="range" data-path="${path}" min="${min}" max="${max}" step="${step}" value="${v}"
      oninput="updRange(this)"><span class="range-value" id="rv_${path.replace(/\./g,'_')}">${lbl}</span></div></div>`;
}
function fToggle(path, label) {
  const v = getPath(S,path);
  return `<div class="form-group"><div class="toggle-group"><label>${label}</label>
    <label class="toggle"><input type="checkbox" data-path="${path}" ${v?'checked':''}><span class="toggle-track"></span><span class="toggle-thumb"></span></label></div></div>`;
}
function fSelect(path, label, opts) {
  const v = getPath(S,path) ?? '';
  let h = `<div class="form-group"><label>${label}</label><select data-path="${path}">`;
  for(const o of opts) h += `<option value="${o.v}" ${v===o.v?'selected':''}>${o.l}</option>`;
  return h + `</select></div>`;
}
function fKeywords(path, label) {
  const arr = getPath(S,path) || [];
  let tags = arr.map(k => `<span class="kw-tag">${esc(k)}<span class="kw-rm" onclick="rmKw(this,'${path}')">&#10005;</span></span>`).join('');
  return `<div class="form-group"><label>${label}</label>
    <div class="kw-editor" data-path="${path}" onclick="this.querySelector('input').focus()">
      ${tags}<input class="kw-input" placeholder="+ hinzufuegen..." onkeydown="addKw(event,this,'${path}')">
    </div></div>`;
}
function fTextarea(path, label, hint='') {
  const v = getPath(S,path);
  const txt = Array.isArray(v) ? v.join('\n') : (typeof v === 'object' ? JSON.stringify(v,null,2) : String(v??''));
  return `<div class="form-group"><label>${label}</label>
    <textarea data-path="${path}" data-type="${Array.isArray(v)?'array':'text'}">${esc(txt)}</textarea>${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}

// Klickbare Chip-Auswahl (vordefinierte Optionen zum An/Abklicken)
function fChipSelect(path, label, options, hint='') {
  const arr = getPath(S, path) || [];
  let chips = options.map(opt => {
    const val = typeof opt === 'string' ? opt : opt.v;
    const lbl = typeof opt === 'string' ? opt : opt.l;
    const sel = arr.includes(val) ? 'selected' : '';
    return `<span class="chip-opt ${sel}" data-chip-path="${path}" data-chip-val="${esc(val)}" onclick="toggleChip('${path}','${esc(val)}')">${esc(lbl)}</span>`;
  }).join('');
  // Auch custom Werte anzeigen die nicht in options sind
  const optValues = options.map(o => typeof o === 'string' ? o : o.v);
  arr.filter(v => !optValues.includes(v)).forEach(v => {
    chips += `<span class="chip-opt selected" data-chip-path="${path}" data-chip-val="${esc(v)}" onclick="toggleChip('${path}','${esc(v)}')">${esc(v)}</span>`;
  });
  return `<div class="form-group"><label>${label}</label>
    <div class="chip-grid" data-path="${path}">${chips}</div>
    ${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}

function toggleChip(path, value) {
  const arr = getPath(S, path) || [];
  const idx = arr.indexOf(value);
  if (idx >= 0) arr.splice(idx, 1); else arr.push(value);
  setPath(S, path, arr);
  renderCurrentTab();
}

// Modell-Auswahl als Dropdown
function fModelSelect(path, label, hint='') {
  const v = getPath(S, path) ?? '';
  const models = [
    {v:'qwen3:4b', l:'Qwen3 4B (Schnell)'},
    {v:'qwen3:8b', l:'Qwen3 8B (Ausgewogen)'},
    {v:'qwen3:14b', l:'Qwen3 14B (Smart)'},
    {v:'qwen3:32b', l:'Qwen3 32B (Deep)'},
    {v:'llama3.2:3b', l:'Llama 3.2 3B'},
    {v:'llama3.1:8b', l:'Llama 3.1 8B'},
    {v:'gemma3:4b', l:'Gemma3 4B'},
    {v:'gemma3:12b', l:'Gemma3 12B'},
    {v:'gemma3:27b', l:'Gemma3 27B'},
    {v:'phi4:14b', l:'Phi4 14B'},
    {v:'mistral:7b', l:'Mistral 7B'},
    {v:'deepseek-r1:14b', l:'DeepSeek-R1 14B'},
    {v:'deepseek-r1:32b', l:'DeepSeek-R1 32B'},
  ];
  // Aktuellen Wert in Liste sicherstellen
  const hasVal = models.some(m => m.v === v);
  let h = `<div class="form-group"><label>${label}</label><select data-path="${path}">`;
  if (!hasVal && v) h += `<option value="${esc(v)}" selected>${esc(v)}</option>`;
  for (const m of models) h += `<option value="${m.v}" ${v===m.v?'selected':''}>${m.l}</option>`;
  return h + `</select>${hint?`<div class="hint">${hint}</div>`:''}</div>`;
}

// Info-Box
function fInfo(text) {
  return `<div class="info-box">${text}</div>`;
}

function sectionWrap(icon, title, content) {
  return `<div class="s-section"><div class="s-section-hdr open" onclick="toggleSec(this)">
    <h3>${icon} ${title}</h3><span class="arrow">&#9660;</span></div>
    <div class="s-section-body open">${content}</div></div>`;
}

function updRange(el) {
  const path = el.dataset.path;
  document.getElementById('rv_'+path.replace(/\./g,'_')).textContent = el.value;
}
function toggleSec(hdr) { hdr.classList.toggle('open'); hdr.nextElementSibling.classList.toggle('open'); }

function addKw(e, input, path) {
  if (e.key !== 'Enter' || !input.value.trim()) return;
  e.preventDefault();
  const arr = getPath(S, path) || [];
  const val = input.value.trim();
  if (!arr.includes(val)) {
    arr.push(val);
    setPath(S, path, arr);
    renderCurrentTab();
  }
}
function rmKw(el, path) {
  const tag = el.parentElement;
  const word = tag.textContent.replace('âœ•','').trim();
  const arr = (getPath(S, path) || []).filter(k => k !== word);
  setPath(S, path, arr);
  renderCurrentTab();
}

function bindFormEvents() {
  // no-op: we collect on save
}

// ---- Tab 1: Allgemein ----
function renderGeneral() {
  return sectionWrap('&#9881;', 'Assistent',
    fInfo('Grundeinstellungen fuer deinen Assistenten â€” Name, Sprache und Version.') +
    fText('assistant.name', 'Name', 'So stellt sich der Assistent vor') +
    fText('assistant.version', 'Version', '', true) +
    fSelect('assistant.language', 'Sprache', [{v:'de',l:'Deutsch'},{v:'en',l:'English'}])
  ) +
  sectionWrap('&#9889;', 'Autonomie',
    fInfo('Wie selbststaendig darf der Assistent handeln? Je hoeher, desto mehr macht er eigenstaendig.') +
    fRange('autonomy.level', 'Autonomie-Level', 1, 5, 1, {1:'Assistent',2:'Butler',3:'Mitbewohner',4:'Vertrauter',5:'Autopilot'})
  ) +
  sectionWrap('&#129302;', 'Modell-Routing',
    fInfo('Welche KI-Modelle sollen fuer welche Aufgaben genutzt werden? Deaktivierte Modelle werden uebersprungen â€” Fallback auf das naechstkleinere.') +
    fToggle('models.enabled.fast', 'Fast â€” Einfache Befehle (Licht an, Timer, etc.)') +
    fToggle('models.enabled.smart', 'Smart â€” Konversation & Standardanfragen') +
    fToggle('models.enabled.deep', 'Deep â€” Komplexe Analyse & Planung') +
    fModelSelect('models.fast', 'Fast-Modell', 'Fuer schnelle, einfache Befehle') +
    fModelSelect('models.smart', 'Smart-Modell', 'Fuer normale Gespraeche') +
    fModelSelect('models.deep', 'Deep-Modell', 'Fuer komplexe Aufgaben') +
    fRange('models.deep_min_words', 'Deep ab Woertern', 5, 50, 1, {5:'5',10:'10',15:'15',20:'20',25:'25',30:'30',35:'35',40:'40',45:'45',50:'50'}) +
    fRange('models.options.temperature', 'Kreativitaet (Temperatur)', 0, 2, 0.1, {0:'Exakt',0.5:'Konservativ',0.7:'Standard',1:'Kreativ',1.5:'Sehr kreativ',2:'Maximum'}) +
    fRange('models.options.max_tokens', 'Antwortlaenge (Max Tokens)', 64, 4096, 64)
  ) +
  sectionWrap('&#127991;', 'Schnell-Erkennung',
    fInfo('Klicke auf Woerter, die das jeweilige Modell ausloesen sollen. Ausgewaehlte Woerter sind hervorgehoben.') +
    fChipSelect('models.fast_keywords', 'Fast-Keywords â€” Woerter fuer schnelle Antworten', [
      'licht','lampe','an','aus','timer','stopp','danke','ja','nein','ok','stop',
      'wecker','alarm','pause','weiter','leiser','lauter','heller','dunkler',
      'rolladen','hoch','runter','temperatur','heizung','musik'
    ]) +
    fChipSelect('models.deep_keywords', 'Deep-Keywords â€” Woerter fuer ausfuehrliche Analyse', [
      'warum','erklaere','vergleiche','analysiere','plane','zusammenfassung',
      'recherchiere','berechne','strategie','vor- und nachteile','unterschied',
      'optimiere','hilf mir bei','was meinst du','ueberblick'
    ]) +
    fChipSelect('models.cooking_keywords', 'Koch-Keywords â€” Woerter die den Koch-Modus aktivieren', [
      'rezept','kochen','backen','zubereiten','gericht','essen','zutaten',
      'portion','mahlzeit','fruehstueck','mittagessen','abendessen','snack',
      'dessert','kuchen','suppe','salat','pizza','pasta','sauce'
    ])
  ) +
  sectionWrap('&#128274;', 'Dashboard & PIN',
    fInfo('Der Zugang zum Dashboard ist mit einer PIN geschuetzt. Der Recovery-Key wird benoetigt wenn du die PIN vergisst.') +
    '<div class="form-group"><label>PIN-Schutz</label>' +
    '<p style="font-size:12px;color:var(--success);margin-bottom:8px;">PIN ist gesetzt und aktiv</p>' +
    '<p style="font-size:11px;color:var(--text-muted);margin-bottom:12px;">PIN aendern: "PIN vergessen?" auf dem Login-Screen nutzen.</p></div>' +
    '<div class="form-group"><label>Recovery-Key</label>' +
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Falls du deine PIN vergisst, brauchst du diesen Key zum Zuruecksetzen. Sicher aufbewahren!</p>' +
    '<div style="display:flex;gap:8px;align-items:center;">' +
    '<input type="text" id="recoveryKeyDisplay" readonly style="flex:1;font-family:var(--mono);font-size:14px;letter-spacing:2px;text-align:center;" value="Versteckt â€” Klicke Generieren" />' +
    '<button class="btn btn-primary" onclick="regenerateRecoveryKey()" style="white-space:nowrap;">Neu generieren</button>' +
    '</div>' +
    '<p style="font-size:11px;color:var(--danger);margin-top:6px;">Nach dem Generieren wird der Key nur EINMAL angezeigt. Notiere ihn sofort!</p>' +
    '</div>'
  );
}

// ---- Tab: Personen & Haushalt ----
function renderPersons() {
  const members = getPath(S, 'household.members') || [];
  const primaryUser = getPath(S, 'household.primary_user') || '';

  const roleInfo = {
    owner: {icon:'&#128081;', color:'var(--accent)', desc:'Voller Zugriff inkl. Sicherheit'},
    member: {icon:'&#128100;', color:'var(--blue)', desc:'Alles ausser Sicherheit'},
    guest: {icon:'&#128587;', color:'var(--text-muted)', desc:'Nur Licht, Klima, Medien'}
  };

  let memberRows = '';
  members.forEach((m, i) => {
    const ri = roleInfo[m.role] || roleInfo.member;
    memberRows += `<div class="person-row" style="display:flex;gap:10px;align-items:center;margin-bottom:10px;padding:12px;background:var(--bg-secondary);border-radius:var(--radius-sm);border-left:3px solid ${ri.color};">
      <span style="font-size:20px;">${ri.icon}</span>
      <input type="text" value="${esc(m.name || '')}" data-member-idx="${i}" data-member-field="name"
        placeholder="Name eingeben..." style="flex:1;font-size:14px;">
      <select data-member-idx="${i}" data-member-field="role" style="width:160px;" onchange="renderCurrentTab()">
        <option value="owner" ${m.role==='owner'?'selected':''}>&#128081; Hausherr/in</option>
        <option value="member" ${m.role==='member'?'selected':''}>&#128100; Mitbewohner/in</option>
        <option value="guest" ${m.role==='guest'?'selected':''}>&#128587; Gast</option>
      </select>
      <button class="btn btn-danger btn-sm" onclick="removeHouseholdMember(${i})"
        style="padding:6px 10px;min-width:auto;" title="Entfernen">&#128465;</button>
    </div>`;
  });

  return sectionWrap('&#128100;', 'Hauptbenutzer',
    fInfo('Dein Name â€” so kennt und begruesst dich der Assistent.') +
    '<div class="form-group"><label>Dein Name</label>' +
    '<input type="text" data-path="household.primary_user" value="' + esc(primaryUser) + '" placeholder="z.B. Alex" style="font-size:15px;">' +
    '</div>'
  ) +
  sectionWrap('&#128106;', 'Haushaltsmitglieder',
    fInfo('Alle Personen im Haushalt. Die Rolle bestimmt was jeder steuern darf.') +
    '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;">' +
    '<div style="padding:8px 12px;background:var(--accent-dim);border-radius:6px;font-size:11px;text-align:center;"><b>&#128081; Hausherr/in</b><br>Voller Zugriff</div>' +
    '<div style="padding:8px 12px;background:var(--blue-dim);border-radius:6px;font-size:11px;text-align:center;"><b>&#128100; Mitbewohner/in</b><br>Alles ausser Sicherheit</div>' +
    '<div style="padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:6px;font-size:11px;text-align:center;"><b>&#128587; Gast</b><br>Nur Licht, Klima, Medien</div>' +
    '</div>' +
    '<div id="householdMembers">' + memberRows + '</div>' +
    '<button class="btn btn-secondary" onclick="addHouseholdMember()" style="margin-top:8px;width:100%;justify-content:center;">+ Person hinzufuegen</button>'
  );
}

function addHouseholdMember() {
  const members = getPath(S, 'household.members') || [];
  members.push({name: '', role: 'member'});
  setPath(S, 'household.members', members);
  renderCurrentTab();
}

function removeHouseholdMember(idx) {
  const members = getPath(S, 'household.members') || [];
  members.splice(idx, 1);
  setPath(S, 'household.members', members);
  renderCurrentTab();
}

function collectHouseholdMembers() {
  const members = [];
  document.querySelectorAll('#householdMembers .person-row').forEach(row => {
    const nameEl = row.querySelector('[data-member-field="name"]');
    const roleEl = row.querySelector('[data-member-field="role"]');
    if (nameEl && roleEl && nameEl.value.trim()) {
      members.push({name: nameEl.value.trim(), role: roleEl.value});
    }
  });
  return members;
}

// ---- Tab 2: Persoenlichkeit ----
function renderPersonality() {
  const styleOpts = [
    {v:'minimal',l:'Minimal â€” Kurz und praezise'},
    {v:'verschlafen',l:'Verschlafen â€” Ruhig, wenig Worte'},
    {v:'knapp',l:'Knapp â€” Auf den Punkt'},
    {v:'freundlich',l:'Freundlich â€” Warm und einladend'},
    {v:'butler',l:'Butler â€” Formell und elegant'},
    {v:'entspannt',l:'Entspannt â€” Locker und gemuetlich'},
    {v:'sachlich',l:'Sachlich â€” Neutral und informativ'},
    {v:'warm',l:'Warm â€” Herzlich und persoenlich'},
    {v:'muede',l:'Muede â€” Kurz, leise, sanft'}
  ];
  return sectionWrap('&#127917;', 'Stil & Charakter',
    fInfo('Wie soll sich der Assistent verhalten? Stil, Humor und Meinungsfreude einstellen.') +
    fSelect('personality.style', 'Grundstil', [{v:'butler',l:'Butler â€” Formell & elegant'},{v:'minimal',l:'Minimal â€” Kurz & praezise'},{v:'freundlich',l:'Freundlich â€” Warm & locker'}]) +
    fRange('personality.sarcasm_level', 'Sarkasmus-Level', 1, 5, 1, {1:'Sachlich',2:'Gelegentl. trocken',3:'Standard Butler',4:'Haeufig',5:'Vollgas Ironie'}) +
    fRange('personality.opinion_intensity', 'Meinungs-Intensitaet', 0, 3, 1, {0:'Still',1:'Selten',2:'Gelegentlich',3:'Redselig'}) +
    fToggle('personality.self_irony_enabled', 'Selbstironie aktiviert') +
    fRange('personality.self_irony_max_per_day', 'Max. Selbstironie pro Tag', 0, 20, 1)
  ) +
  sectionWrap('&#128200;', 'Charakter-Entwicklung',
    fInfo('Der Assistent wird mit der Zeit weniger formell â€” wie ein echter Butler, der seinen Herrn kennenlernt.') +
    fToggle('personality.character_evolution', 'Charakter entwickelt sich ueber Zeit') +
    fRange('personality.formality_start', 'Formalitaet am Anfang', 0, 100, 5, {0:'Sehr locker',25:'Locker',50:'Normal',75:'Formell',100:'Sehr formell'}) +
    fRange('personality.formality_min', 'Minimale Formalitaet', 0, 100, 5, {0:'Sehr locker',25:'Locker',50:'Normal',75:'Formell',100:'Sehr formell'}) +
    fRange('personality.formality_decay_per_day', 'Abbau pro Tag', 0, 5, 0.1)
  ) +
  sectionWrap('&#128336;', 'Tageszeit-Stile',
    fInfo('Der Assistent passt seinen Stil je nach Tageszeit an. Waehle fuer jede Zeit einen passenden Stil und maximale Satzlaenge.') +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#127749; Fruehmorgens (05:00 - 08:00)</div>' +
    fSelect('personality.time_layers.early_morning.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.early_morning.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>' +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#9728; Morgens (08:00 - 12:00)</div>' +
    fSelect('personality.time_layers.morning.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.morning.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>' +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#127774; Nachmittags (12:00 - 18:00)</div>' +
    fSelect('personality.time_layers.afternoon.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.afternoon.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>' +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#127751; Abends (18:00 - 22:00)</div>' +
    fSelect('personality.time_layers.evening.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.evening.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>' +
    '<div style="margin-bottom:12px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-sm);">' +
    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">&#127769; Nachts (22:00 - 05:00)</div>' +
    fSelect('personality.time_layers.night.style', 'Stil', styleOpts) +
    fRange('personality.time_layers.night.max_sentences', 'Max. Saetze', 1, 10, 1) +
    '</div>'
  );
}

// ---- Tab 3: Gedaechtnis ----
function renderMemory() {
  return sectionWrap('&#128065;', 'Semantisches Gedaechtnis',
    fInfo('Der Assistent merkt sich Fakten aus Gespraechen â€” z.B. "Du trinkst gern Kaffee". Hier steuerst du, wie das funktioniert.') +
    fToggle('memory.extraction_enabled', 'Fakten automatisch aus Gespraechen lernen') +
    fRange('memory.extraction_min_words', 'Min. Nachrichtenlaenge fuer Extraktion', 1, 20, 1) +
    fModelSelect('memory.extraction_model', 'Modell fuer Fakten-Extraktion') +
    fRange('memory.extraction_temperature', 'Extraktions-Genauigkeit', 0, 1, 0.1, {0:'Sehr exakt',0.1:'Exakt',0.3:'Normal',0.5:'Flexibel',0.7:'Kreativ',1:'Sehr kreativ'}) +
    fRange('memory.extraction_max_tokens', 'Max. Antwortlaenge Extraktion', 64, 2048, 64) +
    fRange('memory.max_person_facts_in_context', 'Personen-Fakten im Gespraech', 1, 20, 1) +
    fRange('memory.max_relevant_facts_in_context', 'Relevante Fakten im Gespraech', 1, 10, 1) +
    fRange('memory.min_confidence_for_context', 'Min. Sicherheit fuer Nutzung', 0, 1, 0.05, {0:'Alles nutzen',0.3:'Niedrig',0.5:'Mittel',0.6:'Standard',0.8:'Hoch',1:'Nur sichere'}) +
    fRange('memory.duplicate_threshold', 'Duplikat-Erkennung', 0, 1, 0.05, {0:'Streng',0.5:'Mittel',0.8:'Locker',1:'Aus'}) +
    fRange('memory.episode_min_words', 'Min. Woerter fuer Episode', 1, 20, 1) +
    fRange('memory.default_confidence', 'Standard-Sicherheit neuer Fakten', 0, 1, 0.05)
  ) +
  sectionWrap('&#128218;', 'Wissensdatenbank (RAG)',
    fInfo('Eigene Dokumente als Wissensquelle. Dateien in config/knowledge/ werden automatisch eingelesen.') +
    fToggle('knowledge_base.enabled', 'Wissensdatenbank aktiv') +
    fToggle('knowledge_base.auto_ingest', 'Automatisch beim Start einlesen') +
    fRange('knowledge_base.chunk_size', 'Textblock-Groesse', 100, 2000, 50, {100:'Klein (100)',300:'Mittel (300)',500:'Standard (500)',1000:'Gross (1000)',2000:'Sehr gross (2000)'}) +
    fRange('knowledge_base.chunk_overlap', 'Ueberlappung zwischen Bloecken', 0, 500, 25) +
    fRange('knowledge_base.max_distance', 'Suchgenauigkeit', 0.5, 2, 0.1, {0.5:'Sehr genau',1:'Standard',1.5:'Breit',2:'Sehr breit'}) +
    fRange('knowledge_base.search_limit', 'Max. Treffer pro Suche', 1, 10, 1) +
    fChipSelect('knowledge_base.supported_extensions', 'Unterstuetzte Dateitypen', [
      '.txt','.md','.pdf','.csv','.json','.yaml','.yml','.xml','.html','.log','.doc','.docx'
    ], 'Welche Dateitypen sollen eingelesen werden?')
  ) +
  sectionWrap('&#128221;', 'Korrektur-Lernen',
    fInfo('Wenn du den Assistenten korrigierst, merkt er sich das. Wie sicher soll er sich bei Korrekturen sein?') +
    fRange('correction.confidence', 'Sicherheit bei Korrekturen', 0, 1, 0.05, {0:'Unsicher',0.5:'Mittel',0.8:'Sicher',0.95:'Sehr sicher',1:'Absolut sicher'}) +
    fModelSelect('correction.model', 'Modell fuer Korrektur-Analyse') +
    fRange('correction.temperature', 'Analyse-Kreativitaet', 0, 1, 0.1, {0:'Exakt',0.3:'Normal',0.5:'Flexibel',1:'Kreativ'})
  ) +
  sectionWrap('&#128197;', 'Tages-Zusammenfassung',
    fInfo('Automatische Zusammenfassungen des Tages, der Woche und des Monats.') +
    fRange('summarizer.run_hour', 'Uhrzeit (Stunde)', 0, 23, 1) +
    fRange('summarizer.run_minute', 'Uhrzeit (Minute)', 0, 59, 1) +
    fModelSelect('summarizer.model', 'Zusammenfassungs-Modell') +
    fRange('summarizer.max_tokens_daily', 'Laenge taeglich', 128, 2048, 64) +
    fRange('summarizer.max_tokens_weekly', 'Laenge woechentlich', 128, 2048, 64) +
    fRange('summarizer.max_tokens_monthly', 'Laenge monatlich', 128, 2048, 64)
  ) +
  sectionWrap('&#128172;', 'Kontext',
    fInfo('Wie viel Gespraechsverlauf soll der Assistent bei jeder Antwort beruecksichtigen?') +
    fRange('context.recent_conversations', 'Letzte Gespraeche merken', 1, 20, 1) +
    fRange('context.api_timeout', 'Wartezeit fuer Antworten (Sek.)', 1, 30, 1)
  );
}

// ---- Tab 4: Stimmung ----
function renderMood() {
  return sectionWrap('&#128578;', 'Stimmungserkennung',
    fInfo('Der Assistent erkennt deine Stimmung anhand von Worten und Sprechgeschwindigkeit und passt seine Antworten an.') +
    fRange('mood.rapid_command_seconds', 'Schnelle Befehle erkennen (Sek.)', 1, 30, 1, {1:'1s',5:'5s',10:'10s',15:'15s',30:'30s'}) +
    fRange('mood.stress_decay_seconds', 'Stress-Abbau nach (Sek.)', 60, 600, 30, {60:'1 Min',120:'2 Min',180:'3 Min',300:'5 Min',600:'10 Min'}) +
    fRange('mood.frustration_threshold', 'Frustrations-Schwelle', 1, 10, 1, {1:'Empfindlich',3:'Normal',5:'Geduldig',7:'Sehr geduldig',10:'Ignorieren'}) +
    fRange('mood.tired_hour_start', 'Muede ab Uhrzeit', 0, 23, 1) +
    fRange('mood.tired_hour_end', 'Muede bis Uhrzeit', 0, 23, 1)
  ) +
  sectionWrap('&#9889;', 'Stress-Einfluss',
    fInfo('Wie stark beeinflussen verschiedene Signale den erkannten Stresslevel?') +
    fRange('mood.rapid_command_stress_boost', 'Schnelle Befehle hintereinander', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.positive_stress_reduction', 'Positive Worte reduzieren Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.negative_stress_boost', 'Negative Worte erhoehen Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.impatient_stress_boost', 'Ungeduld erhoeht Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.tired_boost', 'Muedigkeit erhoeht Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'}) +
    fRange('mood.repetition_stress_boost', 'Wiederholungen erhoehen Stress', 0, 0.5, 0.05, {0:'Kein Einfluss',0.1:'Schwach',0.25:'Mittel',0.5:'Stark'})
  ) +
  sectionWrap('&#128172;', 'Stimmungs-Erkennung â€” Woerter',
    fInfo('Klicke auf Woerter, die der Assistent als Stimmungssignal erkennen soll.') +
    fChipSelect('mood.positive_keywords', 'Positive Stimmung', [
      'danke','super','toll','perfekt','genau','klasse','wunderbar','prima',
      'cool','nice','geil','mega','hammer','top','gut gemacht','bravo',
      'lieb','freut mich','ausgezeichnet','fantastisch','herrlich'
    ]) +
    fChipSelect('mood.negative_keywords', 'Negative Stimmung', [
      'mist','scheisse','nein','falsch','schlecht','nervig','bloed',
      'egal','vergiss es','lass','stopp','aufhoeren','genug',
      'katastrophe','furchtbar','schrecklich','idiot','dumm'
    ]) +
    fChipSelect('mood.impatient_keywords', 'Ungeduld', [
      'schnell','sofort','jetzt','beeil dich','mach schon','hurry',
      'los','tempo','endlich','wird das noch','wie lange noch',
      'komm schon','beeilung','dalli','zack zack'
    ]) +
    fChipSelect('mood.tired_keywords', 'Muedigkeit', [
      'muede','schlafen','gute nacht','schlaf','bett','gaehnen',
      'erschoepft','fertig','kaputt','ausgelaugt','matt',
      'pennen','heia','einschlafen','nachts'
    ])
  ) +
  sectionWrap('&#127908;', 'Stimm-Analyse',
    fInfo('Der Assistent erkennt anhand deiner Sprechgeschwindigkeit ob du gestresst, muede oder entspannt bist.') +
    fToggle('voice_analysis.enabled', 'Stimm-Analyse aktiv') +
    fRange('voice_analysis.wpm_fast', 'Schnelles Sprechen ab (WPM)', 100, 300, 10, {100:'100',150:'150',180:'180',200:'200',250:'250',300:'300'}) +
    fRange('voice_analysis.wpm_slow', 'Langsames Sprechen unter (WPM)', 30, 150, 10, {30:'30',60:'60',80:'80',100:'100',120:'120',150:'150'}) +
    fRange('voice_analysis.wpm_normal', 'Normales Sprechtempo (WPM)', 50, 200, 10, {50:'50',80:'80',100:'100',120:'120',150:'150',200:'200'}) +
    fToggle('voice_analysis.use_whisper_metadata', 'Whisper-Metadaten nutzen') +
    fRange('voice_analysis.voice_weight', 'Stimm-Gewichtung', 0, 1, 0.05, {0:'Ignorieren',0.25:'Schwach',0.5:'Mittel',0.75:'Stark',1:'Voll'})
  );
}

// ---- Tab 5: Raeume ----
function renderRooms() {
  return sectionWrap('&#127968;', 'Multi-Room',
    fInfo('Der Assistent erkennt in welchem Raum du bist und antwortet dort. Praesenz-Timeout = wie lange er dich in einem Raum "merkt".') +
    fToggle('multi_room.enabled', 'Multi-Room Erkennung aktiv') +
    fRange('multi_room.presence_timeout_minutes', 'Praesenz-Timeout', 1, 60, 1, {1:'1 Min',5:'5 Min',10:'10 Min',15:'15 Min',30:'30 Min',60:'1 Std'})
  ) +
  sectionWrap('&#128266;', 'Raum-Speaker',
    fInfo('Welcher Lautsprecher gehoert zu welchem Raum? Format: raumname: media_player.entity_id (ein Eintrag pro Zeile)') +
    fTextarea('multi_room.room_speakers', 'Speaker-Zuordnung', 'z.B. wohnzimmer: media_player.wohnzimmer_speaker')
  ) +
  sectionWrap('&#128694;', 'Raum-Bewegungsmelder',
    fInfo('Welcher Bewegungsmelder gehoert zu welchem Raum? Damit weiss der Assistent wo du bist.') +
    fTextarea('multi_room.room_motion_sensors', 'Bewegungsmelder-Zuordnung', 'z.B. wohnzimmer: binary_sensor.motion_wohnzimmer')
  ) +
  sectionWrap('&#127916;', 'Aktivitaets-Sensoren',
    fInfo('Welche Home Assistant Entities sollen fuer die Aktivitaetserkennung genutzt werden? Gehe zu "Entities" im Seitenmenue um IDs nachzuschlagen.') +
    fKeywords('activity.entities.media_players', 'Media Player (z.B. media_player.tv)') +
    fKeywords('activity.entities.mic_sensors', 'Mikrofon-Sensoren') +
    fKeywords('activity.entities.bed_sensors', 'Bett-Sensoren (Schlaf-Erkennung)') +
    fKeywords('activity.entities.pc_sensors', 'PC-Sensoren (Arbeit-Erkennung)')
  ) +
  sectionWrap('&#9200;', 'Aktivitaets-Zeiten',
    fInfo('Wann ist Nacht? Ab wann zaehlt Besuch? Wie lange muss Fokus dauern?') +
    fRange('activity.thresholds.night_start', 'Nacht beginnt um', 0, 23, 1) +
    fRange('activity.thresholds.night_end', 'Nacht endet um', 0, 23, 1) +
    fRange('activity.thresholds.guest_person_count', 'Besuch ab Personen', 1, 10, 1) +
    fRange('activity.thresholds.focus_min_minutes', 'Fokus-Modus ab Minuten', 5, 120, 5, {5:'5 Min',15:'15 Min',30:'30 Min',60:'1 Std',120:'2 Std'})
  ) +
  sectionWrap('&#128101;', 'Personen-Profile',
    fInfo('Erweiterte Einstellungen pro Person â€” Benachrichtigungs-Service und bevorzugter Raum.') +
    fTextarea('persons.profiles', 'Profile', 'z.B. alex: {notify_service: notify.mobile, preferred_room: wohnzimmer}')
  );
}

// ---- Tab 6: Stimme ----
function renderVoice() {
  const soundOpts = [
    {v:'',l:'Kein Sound'},
    {v:'listening',l:'Zuhoeren-Ton'},
    {v:'confirmed',l:'Bestaetigung'},
    {v:'warning',l:'Warnung'},
    {v:'alarm',l:'Alarm'},
    {v:'doorbell',l:'Tuerklingel'},
    {v:'greeting',l:'Begruessung'},
    {v:'error',l:'Fehler'},
    {v:'goodnight',l:'Gute Nacht'},
    {v:'chime',l:'Glockenspiel'},
    {v:'notification',l:'Benachrichtigung'}
  ];
  return sectionWrap('&#128266;', 'Sprachausgabe (TTS)',
    fInfo('Wie schnell und mit welchen Pausen soll der Assistent sprechen?') +
    fToggle('tts.ssml_enabled', 'Fortgeschrittene Betonung (SSML)') +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Sprechgeschwindigkeit pro Situation</div>' +
    fRange('tts.speed.confirmation', 'Bestaetigung', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.warning', 'Warnung', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.briefing', 'Briefing', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.greeting', 'Begruessung', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.question', 'Frage', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    fRange('tts.speed.casual', 'Normal', 50, 200, 5, {50:'Langsam',100:'Normal',150:'Schnell',200:'Sehr schnell'}) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Sprechpausen</div>' +
    fRange('tts.pauses.before_important', 'Vor wichtigen Infos (ms)', 0, 1000, 50) +
    fRange('tts.pauses.between_sentences', 'Zwischen Saetzen (ms)', 0, 1000, 50) +
    fRange('tts.pauses.after_greeting', 'Nach Begruessung (ms)', 0, 1000, 50) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Fluestern</div>' +
    fChipSelect('tts.whisper_triggers', 'Fluestern aktivieren bei', [
      'psst','leise','fluestern','schlafen','baby','schlaf','ruhe',
      'still','shh','nachts','nacht'
    ]) +
    fChipSelect('tts.whisper_cancel_triggers', 'Fluestern beenden bei', [
      'normal','laut','aufwachen','morgen','wach','genug gefluestert'
    ])
  ) +
  sectionWrap('&#128264;', 'Lautstaerke',
    fInfo('Lautstaerke je nach Tageszeit. 0 = stumm, 1 = volle Lautstaerke.') +
    fRange('volume.day', '&#9728; Tag', 0, 1, 0.05) +
    fRange('volume.evening', '&#127751; Abend', 0, 1, 0.05) +
    fRange('volume.night', '&#127769; Nacht', 0, 1, 0.05) +
    fRange('volume.sleeping', '&#128164; Schlafen', 0, 1, 0.05) +
    fRange('volume.emergency', '&#128680; Notfall', 0, 1, 0.05) +
    fRange('volume.whisper', '&#129296; Fluestern', 0, 1, 0.05) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Tageszeit-Wechsel</div>' +
    fRange('volume.morning_start', 'Morgen ab', 0, 23, 1) +
    fRange('volume.evening_start', 'Abend ab', 0, 23, 1) +
    fRange('volume.night_start', 'Nacht ab', 0, 23, 1)
  ) +
  sectionWrap('&#127925;', 'Sound-Effekte',
    fInfo('Kurze Toene bei bestimmten Ereignissen. Deaktiviere Sounds komplett oder waehle pro Ereignis.') +
    fToggle('sounds.enabled', 'Sound-Effekte aktiv') +
    fSelect('sounds.events.listening', 'Zuhoeren-Sound', soundOpts) +
    fSelect('sounds.events.confirmed', 'Bestaetigung-Sound', soundOpts) +
    fSelect('sounds.events.warning', 'Warnung-Sound', soundOpts) +
    fSelect('sounds.events.alarm', 'Alarm-Sound', soundOpts) +
    fSelect('sounds.events.doorbell', 'Tuerklingel-Sound', soundOpts) +
    fSelect('sounds.events.greeting', 'Begruessung-Sound', soundOpts) +
    fSelect('sounds.events.error', 'Fehler-Sound', soundOpts) +
    fSelect('sounds.events.goodnight', 'Gute-Nacht-Sound', soundOpts) +
    fRange('sounds.night_volume_factor', 'Nacht-Lautstaerke-Faktor', 0, 1, 0.1, {0:'Stumm',0.3:'Leise',0.5:'Halb',0.7:'Etwas leiser',1:'Normal'})
  ) +
  sectionWrap('&#127916;', 'Szenen-Uebergaenge',
    fInfo('Wie lange dauert der Uebergang bei Szenen-Wechsel? (z.B. Licht dimmen fuer Filmabend)') +
    fToggle('narration.enabled', 'Szenen-Narration aktiv') +
    fRange('narration.default_transition', 'Standard (Sek.)', 1, 20, 1) +
    fRange('narration.scene_transitions.filmabend', 'Filmabend (Sek.)', 1, 30, 1) +
    fRange('narration.scene_transitions.gute_nacht', 'Gute Nacht (Sek.)', 1, 30, 1) +
    fRange('narration.scene_transitions.aufwachen', 'Aufwachen (Sek.)', 1, 30, 1) +
    fRange('narration.scene_transitions.gemuetlich', 'Gemuetlich (Sek.)', 1, 30, 1) +
    fRange('narration.step_delay', 'Verzoegerung zwischen Schritten (Sek.)', 0, 10, 0.5) +
    fToggle('narration.narrate_actions', 'Aktionen ansagen ("Licht wird gedimmt...")')
  ) +
  sectionWrap('&#128100;', 'Sprecher-Erkennung',
    fInfo('Erkennt wer spricht und passt die Antwort an. Jede Person muss einmalig "eingelernt" werden.') +
    fToggle('speaker_recognition.enabled', 'Sprecher-Erkennung aktiv') +
    fRange('speaker_recognition.min_confidence', 'Erkennungs-Sicherheit', 0, 1, 0.05, {0:'Jeder',0.3:'Niedrig',0.5:'Mittel',0.7:'Hoch',0.9:'Sehr hoch',1:'Perfekt'}) +
    fRange('speaker_recognition.enrollment_duration', 'Einlern-Dauer (Sek.)', 5, 120, 5, {5:'5s (kurz)',15:'15s',30:'30s (empfohlen)',60:'1 Min',120:'2 Min'}) +
    fToggle('speaker_recognition.fallback_ask', 'Bei Unsicherheit nachfragen: "Wer spricht?"') +
    fRange('speaker_recognition.max_profiles', 'Max. Sprecher-Profile', 1, 50, 1)
  );
}

// ---- Tab 7: Routinen ----
function renderRoutines() {
  const morningStyleOpts = [
    {v:'kompakt',l:'Kompakt â€” Kurzes Briefing'},
    {v:'ausfuehrlich',l:'Ausfuehrlich â€” Detailliertes Update'},
    {v:'freundlich',l:'Freundlich â€” Lockerer Start'},
    {v:'butler',l:'Butler â€” Formeller Morgengruss'},
    {v:'minimal',l:'Minimal â€” Nur das Wichtigste'},
    {v:'entspannt',l:'Entspannt â€” Gemuetlicher Start'}
  ];
  return sectionWrap('&#127748;', 'Morgen-Briefing',
    fInfo('Automatisches Update am Morgen â€” Wetter, Termine, Neuigkeiten. Wird ausgeloest wenn du morgens das erste Mal erkannt wirst.') +
    fToggle('routines.morning_briefing.enabled', 'Morgen-Briefing aktiv') +
    fSelect('routines.morning_briefing.trigger', 'Ausloeser', [
      {v:'first_motion_after_night',l:'Erste Bewegung nach der Nacht'},
      {v:'first_voice_after_night',l:'Erstes Sprachkommando nach der Nacht'},
      {v:'alarm_dismissed',l:'Wecker ausgeschaltet'},
      {v:'manual',l:'Nur auf Anfrage'}
    ]) +
    fChipSelect('routines.morning_briefing.modules', 'Was soll im Briefing enthalten sein?', [
      {v:'greeting',l:'Begruessung'},
      {v:'weather',l:'Wetter'},
      {v:'calendar',l:'Termine'},
      {v:'news',l:'Nachrichten'},
      {v:'reminders',l:'Erinnerungen'},
      {v:'traffic',l:'Verkehr'},
      {v:'smart_home',l:'Smart Home Status'},
      {v:'energy',l:'Energieverbrauch'},
      {v:'birthday',l:'Geburtstage'},
      {v:'quote',l:'Tages-Zitat'}
    ]) +
    fSelect('routines.morning_briefing.weekday_style', 'Stil unter der Woche', morningStyleOpts) +
    fSelect('routines.morning_briefing.weekend_style', 'Stil am Wochenende', morningStyleOpts) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Morgen-Aktionen</div>' +
    fToggle('routines.morning_briefing.morning_actions.covers_up', 'Rolladen automatisch hochfahren') +
    fToggle('routines.morning_briefing.morning_actions.lights_soft', 'Licht sanft einschalten')
  ) +
  sectionWrap('&#127769;', 'Gute-Nacht-Routine',
    fInfo('Automatische Aktionen wenn du "Gute Nacht" sagst â€” Lichter aus, Heizung runter, alles pruefen.') +
    fToggle('routines.good_night.enabled', 'Gute-Nacht-Routine aktiv') +
    fChipSelect('routines.good_night.triggers', 'Ausloese-Phrasen', [
      'gute nacht','schlaf gut','nacht','geh schlafen','ab ins bett',
      'ich geh pennen','bis morgen','nacht jarvis','schlafenszeit'
    ]) +
    fChipSelect('routines.good_night.checks', 'Sicherheits-Checks vor dem Schlafen', [
      {v:'doors',l:'Tueren geschlossen?'},
      {v:'windows',l:'Fenster geschlossen?'},
      {v:'lights',l:'Alle Lichter aus?'},
      {v:'stove',l:'Herd aus?'},
      {v:'oven',l:'Ofen aus?'},
      {v:'iron',l:'Buegeleisen aus?'},
      {v:'garage',l:'Garage zu?'},
      {v:'alarm',l:'Alarmanlage scharf?'}
    ]) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Automatische Aktionen</div>' +
    fToggle('routines.good_night.actions.lights_off', 'Alle Lichter ausschalten') +
    fToggle('routines.good_night.actions.heating_night', 'Heizung auf Nacht-Modus') +
    fToggle('routines.good_night.actions.covers_down', 'Rolladen runterfahren') +
    fToggle('routines.good_night.actions.alarm_arm_home', 'Alarmanlage scharf schalten')
  ) +
  sectionWrap('&#128101;', 'Gaeste-Modus',
    fInfo('Wenn Besuch da ist â€” der Assistent wird formeller und zeigt keine privaten Infos.') +
    fChipSelect('routines.guest_mode.triggers', 'Aktivierung durch', [
      'besuch','gaeste','gast','besucher','gast modus','wir haben besuch',
      'gaeste da','jemand zu besuch'
    ]) +
    fToggle('routines.guest_mode.restrictions.hide_personal_info', 'Persoenliche Infos verstecken') +
    fToggle('routines.guest_mode.restrictions.formal_tone', 'Formeller Ton aktivieren') +
    fToggle('routines.guest_mode.restrictions.restrict_security', 'Sicherheitsfunktionen einschraenken') +
    fToggle('routines.guest_mode.restrictions.suggest_guest_wifi', 'Gaeste-WLAN vorschlagen')
  ) +
  sectionWrap('&#128276;', 'Proaktive Meldungen',
    fInfo('Der Assistent meldet sich von allein â€” z.B. bei offenen Fenstern oder Vergesslichkeit. Je hoeher der Autonomie-Level, desto mehr meldet er sich.') +
    fToggle('proactive.enabled', 'Proaktive Meldungen aktiv') +
    fRange('proactive.cooldown_seconds', 'Mindestabstand zwischen Meldungen', 60, 3600, 60, {60:'1 Min',120:'2 Min',300:'5 Min',600:'10 Min',1800:'30 Min',3600:'1 Std'}) +
    fRange('proactive.music_follow_cooldown_minutes', 'Musik-Nachfolge Pause', 1, 30, 1) +
    fRange('proactive.min_autonomy_level', 'Ab Autonomie-Level', 1, 5, 1, {1:'Assistent',2:'Butler',3:'Mitbewohner',4:'Vertrauter',5:'Autopilot'}) +
    fChipSelect('proactive.silence_scenes', 'Nicht stoeren bei', [
      'filmabend','schlafen','meditation','telefonat','meeting',
      'konzentration','gaeste','nicht_stoeren','musik','arbeit'
    ])
  ) +
  sectionWrap('&#9200;', 'Zeitgefuehl',
    fInfo('Der Assistent erinnert dich wenn Geraete zu lange laufen â€” z.B. Ofen vergessen, PC-Pause noetig.') +
    fToggle('time_awareness.enabled', 'Zeitgefuehl aktiv') +
    fRange('time_awareness.check_interval_minutes', 'Pruef-Intervall', 1, 30, 1, {1:'Jede Min.',5:'5 Min.',10:'10 Min.',15:'15 Min.',30:'30 Min.'}) +
    fRange('time_awareness.thresholds.oven', 'Ofen-Warnung nach', 10, 180, 5, {10:'10 Min',30:'30 Min',60:'1 Std',120:'2 Std',180:'3 Std'}) +
    fRange('time_awareness.thresholds.iron', 'Buegeleisen-Warnung nach', 5, 120, 5, {5:'5 Min',15:'15 Min',30:'30 Min',60:'1 Std',120:'2 Std'}) +
    fRange('time_awareness.thresholds.light_empty_room', 'Licht im leeren Raum nach', 5, 120, 5, {5:'5 Min',15:'15 Min',30:'30 Min',60:'1 Std'}) +
    fRange('time_awareness.thresholds.window_open_cold', 'Fenster offen bei Kaelte nach', 30, 600, 30, {30:'30 Min',60:'1 Std',120:'2 Std',300:'5 Std',600:'10 Std'}) +
    fRange('time_awareness.thresholds.pc_no_break', 'PC-Pause erinnern nach', 60, 720, 30, {60:'1 Std',120:'2 Std',180:'3 Std',360:'6 Std',720:'12 Std'}) +
    fToggle('time_awareness.counters.coffee_machine', 'Kaffee-Zaehler (zaehlt deine Kaffees)')
  ) +
  sectionWrap('&#128300;', 'Vorausdenken',
    fInfo('Der Assistent lernt deine Gewohnheiten und schlaegt Aktionen vor â€” z.B. "Du machst normalerweise jetzt das Licht an".') +
    fToggle('anticipation.enabled', 'Vorausdenken aktiv') +
    fRange('anticipation.history_days', 'Lern-Zeitraum (Tage)', 7, 90, 7, {7:'1 Woche',14:'2 Wochen',30:'1 Monat',60:'2 Monate',90:'3 Monate'}) +
    fRange('anticipation.min_confidence', 'Mindest-Sicherheit', 0, 1, 0.05, {0:'Alles vorschlagen',0.3:'Niedrig',0.5:'Mittel',0.7:'Hoch',0.9:'Sehr hoch'}) +
    fRange('anticipation.check_interval_minutes', 'Pruef-Intervall', 5, 60, 5, {5:'5 Min',10:'10 Min',15:'15 Min',30:'30 Min',60:'1 Std'}) +
    '<div style="margin:12px 0;font-weight:600;font-size:13px;">Ab welcher Sicherheit...</div>' +
    fRange('anticipation.thresholds.ask', '...nachfragen?', 0, 1, 0.05, {0.3:'30%',0.5:'50%',0.6:'60%',0.7:'70%',0.8:'80%'}) +
    fRange('anticipation.thresholds.suggest', '...vorschlagen?', 0, 1, 0.05, {0.5:'50%',0.6:'60%',0.7:'70%',0.8:'80%',0.9:'90%'}) +
    fRange('anticipation.thresholds.auto', '...automatisch ausfuehren?', 0, 1, 0.05, {0.7:'70%',0.8:'80%',0.9:'90%',0.95:'95%',1:'100%'})
  ) +
  sectionWrap('&#128203;', 'Absicht-Erkennung',
    fInfo('Erkennt offene Absichten â€” z.B. "Ich muss noch einkaufen" wird als Aufgabe gemerkt und spaeter erinnert.') +
    fToggle('intent_tracking.enabled', 'Absicht-Erkennung aktiv') +
    fRange('intent_tracking.check_interval_minutes', 'Pruef-Intervall', 10, 240, 10, {10:'10 Min',30:'30 Min',60:'1 Std',120:'2 Std',240:'4 Std'}) +
    fRange('intent_tracking.remind_hours_before', 'Erinnerung vorher', 1, 48, 1, {1:'1 Std',2:'2 Std',4:'4 Std',12:'12 Std',24:'1 Tag',48:'2 Tage'})
  ) +
  sectionWrap('&#128172;', 'Gespraechs-Fortfuehrung',
    fInfo('Wenn ein Gespraech unterbrochen wird â€” soll der Assistent spaeter nachfragen? "Wolltest du vorhin noch was wegen...?"') +
    fToggle('conversation_continuity.enabled', 'Gespraech fortsetzen') +
    fRange('conversation_continuity.resume_after_minutes', 'Nachfragen nach', 1, 60, 1, {1:'1 Min',5:'5 Min',10:'10 Min',15:'15 Min',30:'30 Min',60:'1 Std'}) +
    fRange('conversation_continuity.expire_hours', 'Thema vergessen nach', 1, 72, 1, {1:'1 Std',6:'6 Std',12:'12 Std',24:'1 Tag',48:'2 Tage',72:'3 Tage'})
  );
}

// ---- Tab 8: Sicherheit & Erweitert ----
function renderSecurity() {
  const hMode = getPath(S, 'heating.mode') || 'room_thermostat';
  const isCurve = hMode === 'heating_curve';

  return sectionWrap('&#128293;', 'Heizung',
    fInfo('Wie wird geheizt? Einzelraumregelung = jeder Raum hat eigenen Thermostat. Heizkurve = zentrale Waermepumpe mit Offset-Steuerung.') +
    '<div class="form-group"><label>Heizungsmodus</label>' +
    '<select data-path="heating.mode" onchange="setPath(S,\'heating.mode\',this.value);renderCurrentTab();">' +
    '<option value="room_thermostat" ' + (hMode==='room_thermostat'?'selected':'') + '>Raumthermostate (Einzelraumregelung)</option>' +
    '<option value="heating_curve" ' + (hMode==='heating_curve'?'selected':'') + '>Heizkurve (Waermepumpe, Vorlauf-Offset)</option>' +
    '</select></div>' +
    (isCurve ?
      fText('heating.curve_entity', 'Heizungs-Entity', 'z.B. climate.panasonic_heat_pump_main_z1_temp') +
      fRange('heating.curve_offset_min', 'Min. Offset (Â°C)', -10, 0, 0.5) +
      fRange('heating.curve_offset_max', 'Max. Offset (Â°C)', 0, 10, 0.5) +
      fRange('heating.night_offset', 'Nacht-Offset (Â°C)', -10, 0, 0.5) +
      fRange('heating.away_offset', 'Abwesenheits-Offset (Â°C)', -10, 0, 0.5)
    :
      '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Jeder Raum hat seinen eigenen Thermostat. Temperatur-Grenzen findest du unten bei Sicherheit.</p>'
    )
  ) +
  sectionWrap('&#128274;', 'Sicherheit',
    fInfo('Welche Aktionen brauchen eine Bestaetigung? Und welche Temperatur-Grenzen gelten?') +
    fChipSelect('security.require_confirmation', 'Bestaetigung erforderlich fuer', [
      {v:'alarm_disarm',l:'Alarm deaktivieren'},
      {v:'alarm_arm',l:'Alarm aktivieren'},
      {v:'lock_unlock',l:'Tuerschloss oeffnen'},
      {v:'garage_open',l:'Garage oeffnen'},
      {v:'heating_off',l:'Heizung ausschalten'},
      {v:'all_lights_off',l:'Alle Lichter aus'},
      {v:'cover_open',l:'Rolladen oeffnen'},
      {v:'camera_disable',l:'Kamera deaktivieren'},
      {v:'automation_delete',l:'Automation loeschen'}
    ]) +
    (!isCurve ?
      fRange('security.climate_limits.min', 'Temperatur Min (Â°C)', 5, 25, 0.5) +
      fRange('security.climate_limits.max', 'Temperatur Max (Â°C)', 20, 35, 0.5)
    : '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Im Heizkurven-Modus gelten die Offset-Grenzen von oben.</p>'
    )
  ) +
  sectionWrap('&#128273;', 'API Key (Netzwerk-Schutz)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Schuetzt die Assistant-API gegen unbefugte Netzwerkzugriffe. Diesen Key im HA-Addon und in der HA-Integration eintragen, DANN Pruefung aktivieren.</p>' +
    '<div class="form-group" style="margin-bottom:12px;">' +
    '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;">' +
    '<input type="checkbox" id="apiKeyEnforcement" onchange="toggleApiKeyEnforcement(this.checked)" style="width:18px;height:18px;" />' +
    '<span>API Key Pruefung aktiv</span>' +
    '</label>' +
    '<p id="apiKeyEnforcementHint" style="font-size:11px;color:var(--text-secondary);margin-top:4px;"></p>' +
    '</div>' +
    '<div class="form-group"><label>Aktueller API Key</label>' +
    '<div style="display:flex;gap:8px;align-items:center;">' +
    '<input type="text" id="apiKeyDisplay" readonly style="flex:1;font-family:monospace;font-size:12px;" value="Wird geladen..." />' +
    '<button onclick="copyApiKey()" style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--card-bg);cursor:pointer;font-size:12px;">Kopieren</button>' +
    '</div></div>' +
    '<div style="margin-top:8px;"><button onclick="regenerateApiKey()" style="padding:6px 12px;border:1px solid #e74c3c;border-radius:6px;background:transparent;color:#e74c3c;cursor:pointer;font-size:12px;">Key neu generieren</button>' +
    '<span style="font-size:11px;color:var(--text-secondary);margin-left:8px;">Achtung: Addon + HA-Integration muessen danach aktualisiert werden!</span></div>'
  ) +
  sectionWrap('&#128272;', 'Vertrauensstufen',
    fInfo('Standard-Vertrauensstufe fuer neue Personen und was Gaeste/Besitzer duerfen.') +
    fSelect('trust_levels.default', 'Standard fuer neue Personen', [
      {v:0,l:'Gast (eingeschraenkt)'},
      {v:1,l:'Mitbewohner (normal)'},
      {v:2,l:'Besitzer (voll)'}
    ]) +
    fChipSelect('trust_levels.guest_allowed_actions', 'Gaeste duerfen', [
      {v:'light_control',l:'Licht steuern'},
      {v:'climate_control',l:'Temperatur aendern'},
      {v:'media_control',l:'Musik/TV steuern'},
      {v:'cover_control',l:'Rolladen steuern'},
      {v:'scene_activate',l:'Szenen aktivieren'},
      {v:'timer_set',l:'Timer stellen'},
      {v:'weather_query',l:'Wetter fragen'},
      {v:'smalltalk',l:'Smalltalk'}
    ]) +
    fChipSelect('trust_levels.security_actions', 'Nur Besitzer duerfen', [
      {v:'alarm_control',l:'Alarmanlage'},
      {v:'lock_control',l:'Tuerschloesser'},
      {v:'camera_control',l:'Kameras'},
      {v:'garage_control',l:'Garage'},
      {v:'automation_edit',l:'Automationen bearbeiten'},
      {v:'settings_change',l:'Einstellungen aendern'},
      {v:'person_manage',l:'Personen verwalten'},
      {v:'system_restart',l:'System neustarten'}
    ])
  ) +
  sectionWrap('&#128295;', 'Diagnostik',
    fInfo('Automatische Pruefung von Sensoren, Batterien und Geraetestatus.') +
    fToggle('diagnostics.enabled', 'Geraete-Diagnostik aktiv') +
    fRange('diagnostics.check_interval_minutes', 'Pruef-Intervall', 5, 120, 5, {5:'5 Min',15:'15 Min',30:'30 Min',60:'1 Std',120:'2 Std'}) +
    fRange('diagnostics.battery_warning_threshold', 'Batterie-Warnung ab', 5, 50, 5, {5:'5%',10:'10%',15:'15%',20:'20%',30:'30%',50:'50%'}) +
    fRange('diagnostics.stale_sensor_minutes', 'Sensor veraltet nach', 30, 600, 30, {30:'30 Min',60:'1 Std',120:'2 Std',300:'5 Std',600:'10 Std'}) +
    fRange('diagnostics.offline_threshold_minutes', 'Geraet offline nach', 10, 120, 10, {10:'10 Min',30:'30 Min',60:'1 Std',120:'2 Std'}) +
    fRange('diagnostics.alert_cooldown_minutes', 'Wiederholung fruehestens nach', 10, 240, 10, {10:'10 Min',30:'30 Min',60:'1 Std',120:'2 Std',240:'4 Std'})
  ) +
  sectionWrap('&#128200;', 'Feedback-System',
    fInfo('Wie reagiert der Assistent auf positives/negatives Feedback? Scores bestimmen wie haeufig er sich meldet.') +
    fRange('feedback.auto_timeout_seconds', 'Feedback-Timeout', 30, 600, 30, {30:'30s',60:'1 Min',120:'2 Min',300:'5 Min',600:'10 Min'}) +
    fRange('feedback.base_cooldown_seconds', 'Basis-Abstand', 60, 1800, 60, {60:'1 Min',120:'2 Min',300:'5 Min',600:'10 Min',1800:'30 Min'}) +
    fRange('feedback.score_suppress', 'Unterdruecken unter', 0, 1, 0.05) +
    fRange('feedback.score_reduce', 'Reduzieren unter', 0, 1, 0.05) +
    fRange('feedback.score_normal', 'Normal ab', 0, 1, 0.05) +
    fRange('feedback.score_boost', 'Boost ab', 0, 1, 0.05)
  ) +
  sectionWrap('&#128683;', 'Antwort-Filter',
    fInfo('Unerwuenschte Phrasen aus den Antworten filtern und maximale Antwortlaenge begrenzen.') +
    fToggle('response_filter.enabled', 'Antwort-Filter aktiv') +
    fRange('response_filter.max_response_sentences', 'Max. Saetze pro Antwort', 0, 20, 1, {0:'Kein Limit',1:'1',2:'2',3:'3',5:'5',10:'10',20:'20'}) +
    fChipSelect('response_filter.banned_phrases', 'Verbotene Phrasen', [
      'als KI','als Sprachmodell','ich bin ein KI','ich habe keine Gefuehle',
      'ich bin nur eine Maschine','als AI','language model','ich kann nicht fuehlen',
      'ich bin kein Mensch','mein Training','meine Trainingsdaten'
    ]) +
    fChipSelect('response_filter.banned_starters', 'Verbotene Satzanfaenge', [
      'Natuerlich!','Selbstverstaendlich!','Klar!','Gerne!',
      'Absolut!','Definitiv!','Auf jeden Fall!','Sicher!',
      'Das ist eine gute Frage','Ich verstehe'
    ])
  ) +
  sectionWrap('&#127859;', 'Koch-Assistent',
    fInfo('Der Assistent kann dir Rezepte vorschlagen und beim Kochen helfen â€” Schritt fuer Schritt mit Timer.') +
    fToggle('cooking.enabled', 'Koch-Assistent aktiv') +
    fSelect('cooking.language', 'Rezept-Sprache', [{v:'de',l:'Deutsch'},{v:'en',l:'English'}]) +
    fRange('cooking.default_portions', 'Standard-Portionen', 1, 12, 1) +
    fRange('cooking.max_steps', 'Max. Schritte pro Rezept', 3, 30, 1) +
    fRange('cooking.max_tokens', 'Rezept-Detailgrad', 256, 4096, 256, {256:'Kurz',512:'Normal',1024:'Ausfuehrlich',2048:'Sehr ausfuehrlich',4096:'Maximum'}) +
    fToggle('cooking.timer_notify_tts', 'Timer-Erinnerungen per Sprache')
  ) +
  sectionWrap('&#128295;', 'Wartung',
    fInfo('Automatische Wartungshinweise fuer Geraete im Haushalt.') +
    fToggle('maintenance.enabled', 'Wartungs-Erinnerungen aktiv')
  ) +
  sectionWrap('&#128101;', 'Personen-Anrede',
    fInfo('Wie soll der Assistent einzelne Personen ansprechen? Der Hauptbenutzer wird standardmaessig als "Sir" angesprochen.') +
    fTextarea('persons.titles', 'Anrede pro Person', 'z.B. alex: Sir\nmaria: Frau Mueller')
  );
}

// ---- API Key Management ----
async function loadApiKey() {
  try {
    const data = await api('ui/api-key');
    const el = document.getElementById('apiKeyDisplay');
    if (el && data.api_key) el.value = data.api_key;
    const cb = document.getElementById('apiKeyEnforcement');
    if (cb) {
      cb.checked = !!data.enforcement;
      if (data.env_locked) { cb.disabled = true; }
    }
    updateEnforcementHint(!!data.enforcement, !!data.env_locked);
  } catch (e) { /* ignore */ }
}
function updateEnforcementHint(active, envLocked) {
  const hint = document.getElementById('apiKeyEnforcementHint');
  if (!hint) return;
  if (envLocked) {
    hint.textContent = 'Durch Umgebungsvariable ASSISTANT_API_KEY erzwungen (kann hier nicht deaktiviert werden).';
    hint.style.color = '#f59e0b';
  } else if (active) {
    hint.textContent = 'Aktiv: Alle /api/assistant/* Anfragen benoetigen einen gueltigen API Key.';
    hint.style.color = '#10b981';
  } else {
    hint.textContent = 'Inaktiv: API ist ohne Key zugaenglich. Erst Key in Addon/HA-Integration eintragen, dann hier aktivieren.';
    hint.style.color = 'var(--text-secondary)';
  }
}
function copyApiKey() {
  const el = document.getElementById('apiKeyDisplay');
  if (el) { navigator.clipboard.writeText(el.value); toast('API Key kopiert!'); }
}
async function regenerateApiKey() {
  if (!confirm('API Key wirklich neu generieren? Addon und HA-Integration muessen danach aktualisiert werden!')) return;
  try {
    const data = await api('ui/api-key/regenerate', 'POST');
    const el = document.getElementById('apiKeyDisplay');
    if (el && data.api_key) el.value = data.api_key;
    toast('Neuer API Key generiert!');
  } catch (e) { toast('Fehler: ' + e.message, true); }
}
async function toggleApiKeyEnforcement(enabled) {
  const action = enabled ? 'aktivieren' : 'deaktivieren';
  if (enabled && !confirm('API Key Pruefung aktivieren? Stelle sicher, dass der Key bereits im HA-Addon und in der HA-Integration eingetragen ist, sonst funktioniert die Kommunikation nicht mehr!')) {
    const cb = document.getElementById('apiKeyEnforcement');
    if (cb) cb.checked = false;
    return;
  }
  try {
    const data = await api('ui/api-key/enforcement', 'POST', { enabled });
    updateEnforcementHint(data.enforcement);
    toast('API Key Pruefung ' + (data.enforcement ? 'aktiviert' : 'deaktiviert'));
  } catch (e) {
    toast('Fehler: ' + e.message, true);
    const cb = document.getElementById('apiKeyEnforcement');
    if (cb) cb.checked = !enabled;
  }
}

// ---- Recovery-Key ----
async function regenerateRecoveryKey() {
  if (!confirm('Neuen Recovery-Key generieren? Der alte Key wird ungueltig! Notiere dir den neuen Key sofort.')) return;
  try {
    const data = await api('ui/recovery-key/regenerate', 'POST');
    const el = document.getElementById('recoveryKeyDisplay');
    if (el && data.recovery_key) {
      el.value = data.recovery_key;
      el.style.color = 'var(--accent)';
      el.style.fontSize = '18px';
      el.style.fontWeight = '700';
    }
    toast('Neuer Recovery-Key generiert â€” JETZT notieren!');
  } catch (e) { toast('Fehler: ' + e.message, true); }
}

// ---- Tab: KI-Autonomie (Phase 13.1 / 13.2 / 13.4) ----
let SNAPSHOTS = [];

function renderAutonomie() {
  return sectionWrap('&#129302;', 'Selbstoptimierung',
    fInfo('Der Assistent lernt aus euren Gespraechen und schlaegt Verbesserungen vor. Du entscheidest ob Vorschlaege angenommen werden. Die Kern-Identitaet ist geschuetzt.') +
    fToggle('self_optimization.enabled', 'Selbstoptimierung aktiv') +
    fSelect('self_optimization.approval_mode', 'Genehmigungsmodus', [
      {v:'manual', l:'Manuell (nur mit Bestaetigung)'},
      {v:'off', l:'Aus (keine Vorschlaege)'}
    ]) +
    fSelect('self_optimization.analysis_interval', 'Analyse-Intervall', [
      {v:'weekly', l:'Woechentlich'},
      {v:'daily', l:'Taeglich'}
    ]) +
    fNum('self_optimization.max_proposals_per_cycle', 'Max. Vorschlaege pro Zyklus', 1, 10) +
    fModelSelect('self_optimization.model', 'Analyse-Modell')
  ) +
  sectionWrap('&#128203;', 'Vorschlaege (Approval-Workflow)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jarvis macht nur Vorschlaege â€” DU entscheidest ob sie angewendet werden. Jede Aenderung wird vorher gesnapshot.</p>' +
    '<div id="proposalsList" style="margin-bottom:12px;"></div>' +
    '<button class="btn btn-secondary" style="font-size:12px;" onclick="runAnalysis()">Analyse jetzt starten</button>'
  ) +
  sectionWrap('&#128190;', 'Rollback & Snapshots',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jede Config-Aenderung wird gesichert. Rollback jederzeit moeglich.</p>' +
    fToggle('self_optimization.rollback.enabled', 'Rollback aktiv') +
    fNum('self_optimization.rollback.max_snapshots', 'Max. gespeicherte Snapshots', 5, 100) +
    fToggle('self_optimization.rollback.snapshot_on_every_edit', 'Snapshot bei jeder Aenderung') +
    '<div id="snapshotsList" style="margin-top:12px;"></div>'
  ) +
  sectionWrap('&#128295;', 'Parameter-Grenzen',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jarvis kann NUR innerhalb dieser Grenzen vorschlagen.</p>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">' +
    fNum('self_optimization.parameter_bounds.sarcasm_level.min', 'Sarkasmus Min', 1, 5) +
    fNum('self_optimization.parameter_bounds.sarcasm_level.max', 'Sarkasmus Max', 1, 5) +
    fNum('self_optimization.parameter_bounds.opinion_intensity.min', 'Meinungen Min', 0, 3) +
    fNum('self_optimization.parameter_bounds.opinion_intensity.max', 'Meinungen Max', 0, 3) +
    fNum('self_optimization.parameter_bounds.max_response_sentences.min', 'Saetze Min', 1, 10) +
    fNum('self_optimization.parameter_bounds.max_response_sentences.max', 'Saetze Max', 1, 10) +
    fNum('self_optimization.parameter_bounds.formality_min.min', 'Formalitaet-Min Min', 0, 100) +
    fNum('self_optimization.parameter_bounds.formality_min.max', 'Formalitaet-Min Max', 0, 100) +
    '</div>'
  ) +
  sectionWrap('&#128683;', 'Geschuetzte Bereiche (Immutable)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Diese Bereiche kann Jarvis NIEMALS selbst aendern.</p>' +
    fChipSelect('self_optimization.immutable_keys', 'Geschuetzte Bereiche (nicht aenderbar durch KI)', [
      'security','trust_levels','response_filter.banned_phrases',
      'response_filter.banned_starters','household','assistant.name',
      'self_optimization.immutable_keys','self_optimization.approval_mode',
      'models.fast','models.smart','models.deep','autonomy.level'
    ], 'Klicke auf Bereiche die die KI NIEMALS selbst aendern darf.')
  ) +
  sectionWrap('&#9889;', 'Self-Automation (Phase 13.2)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jarvis erstellt HA-Automationen aus natuerlicher Sprache. Approval-Workflow: Du musst jede Automation bestaetigen.</p>' +
    fToggle('self_automation.enabled', 'Self-Automation aktiv') +
    fNum('self_automation.max_per_day', 'Max. Automationen pro Tag', 1, 20) +
    fModelSelect('self_automation.model', 'Modell fuer Automations-Erstellung')
  ) +
  sectionWrap('&#128221;', 'Config-Selbstmodifikation (Phase 13.1)',
    '<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Jarvis kann nur diese 3 Dateien editieren (Whitelist). settings.yaml ist NICHT editierbar durch Jarvis.</p>' +
    '<div style="display:flex;flex-direction:column;gap:8px;">' +
    '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-secondary);border-radius:6px;">' +
      '<span style="color:var(--success);">&#9989;</span><span style="font-size:13px;">easter_eggs.yaml</span>' +
      '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">Easter Eggs &amp; Gag-Antworten</span></div>' +
    '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-secondary);border-radius:6px;">' +
      '<span style="color:var(--success);">&#9989;</span><span style="font-size:13px;">opinion_rules.yaml</span>' +
      '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">Meinungs-Kommentare</span></div>' +
    '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-secondary);border-radius:6px;">' +
      '<span style="color:var(--success);">&#9989;</span><span style="font-size:13px;">room_profiles.yaml</span>' +
      '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">Raum-Metadaten</span></div>' +
    '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-secondary);border-radius:6px;opacity:0.5;">' +
      '<span style="color:var(--danger);">&#10060;</span><span style="font-size:13px;">settings.yaml</span>' +
      '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">NUR durch User aenderbar</span></div>' +
    '</div>'
  );
}

async function loadOptStatus() {
  try {
    const data = await api('/api/ui/self-optimization/status');
    renderProposalList(data.proposals || []);
  } catch(e) { console.error('OptStatus fail:', e); }
}

function renderProposalList(proposals) {
  const c = document.getElementById('proposalsList');
  if (!c) return;
  if (proposals.length === 0) {
    c.innerHTML = '<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;">Keine offenen Vorschlaege</div>';
    return;
  }
  c.innerHTML = '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">Offene Vorschlaege:</div>' +
    proposals.map((p, i) => {
      const conf = Math.round((p.confidence || 0) * 100);
      return `<div style="padding:8px;margin-bottom:6px;background:var(--bg-secondary);border-radius:6px;border-left:3px solid var(--warning);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <span style="font-weight:600;font-size:13px;">${esc(p.parameter)}: ${esc(String(p.current))} &#8594; ${esc(String(p.proposed))}</span>
          <span style="font-size:11px;color:var(--text-muted);background:var(--bg-primary);padding:2px 6px;border-radius:4px;">${conf}%</span>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${esc(p.reason)}</div>
        <div style="display:flex;gap:6px;justify-content:flex-end;">
          <button class="btn btn-secondary" style="padding:3px 10px;font-size:11px;background:var(--danger);border-color:var(--danger);color:white;" onclick="rejectProposal(${i})">Ablehnen</button>
          <button class="btn btn-primary" style="padding:3px 10px;font-size:11px;" onclick="approveProposal(${i})">Annehmen</button>
        </div>
      </div>`;
    }).join('') +
    (proposals.length > 1 ? '<div style="text-align:right;margin-top:6px;"><button class="btn btn-secondary" style="padding:3px 12px;font-size:11px;" onclick="rejectAllProposals()">Alle ablehnen</button></div>' : '');
}

async function approveProposal(index) {
  if (!confirm('Diesen Vorschlag wirklich anwenden? (Snapshot wird vorher erstellt)')) return;
  try {
    const result = await api('/api/ui/self-optimization/approve', 'POST', {index});
    if (result.success) {
      toast('Angewendet: ' + result.message);
      S = await api('/api/ui/settings');
      renderCurrentTab();
      loadOptStatus();
      loadSnapshots();
    } else {
      toast(result.message, 'error');
    }
  } catch(e) { toast('Fehler', 'error'); }
}

async function rejectProposal(index) {
  try {
    const result = await api('/api/ui/self-optimization/reject', 'POST', {index});
    if (result.success) {
      toast('Abgelehnt');
      loadOptStatus();
    }
  } catch(e) { toast('Fehler', 'error'); }
}

async function rejectAllProposals() {
  try {
    const result = await api('/api/ui/self-optimization/reject-all', 'POST', {});
    if (result.success) {
      toast(result.message);
      loadOptStatus();
    }
  } catch(e) { toast('Fehler', 'error'); }
}

async function runAnalysis() {
  toast('Analyse wird gestartet...', 'info');
  try {
    const result = await api('/api/ui/self-optimization/run-analysis', 'POST', {});
    toast(result.message);
    loadOptStatus();
  } catch(e) { toast('Analyse-Fehler', 'error'); }
}

async function loadSnapshots() {
  try {
    const data = await api('/api/ui/snapshots');
    SNAPSHOTS = data.snapshots || [];
    renderSnapshotList();
  } catch(e) { console.error('Snapshots fail:', e); }
}

function renderSnapshotList() {
  const c = document.getElementById('snapshotsList');
  if (!c) return;
  if (SNAPSHOTS.length === 0) {
    c.innerHTML = '<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;">Keine Snapshots vorhanden</div>';
    return;
  }
  c.innerHTML = '<div style="font-weight:600;font-size:13px;margin-bottom:8px;">Letzte Snapshots:</div>' +
    SNAPSHOTS.slice(0, 10).map(s => {
      const dt = new Date(s.timestamp).toLocaleString('de-DE', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
      return `<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;margin-bottom:4px;background:var(--bg-secondary);border-radius:6px;font-size:12px;">
        <span style="font-weight:600;min-width:100px;">${esc(s.config_file)}</span>
        <span style="color:var(--text-secondary);flex:1;">${esc(s.reason)}</span>
        <span style="color:var(--text-muted);min-width:80px;">${dt}</span>
        <button class="btn btn-secondary" style="padding:2px 8px;font-size:11px;" onclick="rollbackSnapshot('${esc(s.id)}')">Rollback</button>
      </div>`;
    }).join('');
}

async function rollbackSnapshot(snapshotId) {
  if (!confirm('Config auf diesen Snapshot zuruecksetzen?')) return;
  try {
    const result = await api('/api/ui/rollback', 'POST', {snapshot_id: snapshotId});
    if (result.success) {
      toast('Rollback erfolgreich: ' + result.message);
      // Settings neu laden
      S = await api('/api/ui/settings');
      renderCurrentTab();
      loadSnapshots();
    } else {
      toast('Rollback fehlgeschlagen: ' + result.message, 'error');
    }
  } catch(e) { toast('Rollback-Fehler', 'error'); }
}

// ---- Tab 9: Easter Eggs ----
let EGGS = [];

function renderEasterEggs() {
  let html = '<div id="easterEggsList"></div>';
  html += '<div style="margin-top:16px;text-align:center;">';
  html += '<button class="btn btn-primary" onclick="addEasterEgg()">+ Neues Easter Egg</button>';
  html += '</div>';
  return html;
}

async function loadEasterEggs() {
  try {
    const data = await api('/api/ui/easter-eggs');
    EGGS = data.easter_eggs || [];
    renderEggList();
  } catch(e) { console.error('Easter Eggs fail:', e); }
}

function renderEggList() {
  const c = document.getElementById('easterEggsList');
  if (!c) return;
  if (EGGS.length === 0) {
    c.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted);">Keine Easter Eggs vorhanden</div>';
    return;
  }
  c.innerHTML = EGGS.map((egg, i) => `
    <div class="s-section">
      <div class="s-section-hdr" onclick="toggleSec(this)" style="cursor:pointer;">
        <h3>${egg.enabled !== false ? '&#127866;' : '&#128683;'} ${esc(egg.id)}</h3>
        <span class="arrow">&#9660;</span>
      </div>
      <div class="s-section-body">
        <div class="form-group"><label>ID</label>
          <input type="text" value="${esc(egg.id)}" onchange="EGGS[${i}].id=this.value"></div>
        <div class="form-group"><label>Aktiviert</label>
          <label class="toggle"><input type="checkbox" ${egg.enabled!==false?'checked':''} onchange="EGGS[${i}].enabled=this.checked">
          <span class="toggle-track"></span><span class="toggle-thumb"></span></label></div>
        <div class="form-group"><label>Trigger (einer pro Zeile)</label>
          <textarea rows="3" onchange="EGGS[${i}].triggers=this.value.split('\\n').map(s=>s.trim()).filter(Boolean)">${(egg.triggers||[]).join('\n')}</textarea>
          <div class="hint">Substring-Matching, case-insensitive</div></div>
        <div class="form-group"><label>Antworten (eine pro Zeile)</label>
          <textarea rows="4" onchange="EGGS[${i}].responses=this.value.split('\\n').map(s=>s.trim()).filter(Boolean)">${(egg.responses||[]).join('\n')}</textarea>
          <div class="hint">Zufaellige Auswahl</div></div>
        <div style="text-align:right;margin-top:8px;">
          <button class="btn btn-secondary" style="background:var(--danger);border-color:var(--danger);" onclick="removeEgg(${i})">Entfernen</button>
        </div>
      </div>
    </div>`).join('');
  c.innerHTML += '<div style="margin-top:16px;text-align:center;">' +
    '<button class="btn btn-primary" onclick="saveEasterEggs()">Easter Eggs speichern</button></div>';
}

function addEasterEgg() {
  EGGS.push({id: 'neues_egg_' + Date.now(), triggers: [], responses: [], enabled: true});
  renderEggList();
}

function removeEgg(idx) {
  EGGS.splice(idx, 1);
  renderEggList();
}

async function saveEasterEggs() {
  try {
    await api('/api/ui/easter-eggs', 'PUT', {easter_eggs: EGGS});
    toast('Easter Eggs gespeichert');
  } catch(e) { toast('Fehler beim Speichern', 'error'); }
}

// ---- Collect + Save ----
function collectSettings() {
  const updates = {};
  // Text, number, select
  document.querySelectorAll('#settingsContent [data-path]').forEach(el => {
    const path = el.dataset.path;
    const tag = el.tagName.toLowerCase();
    if (tag === 'div') return; // kw-editor handled separately
    let val;
    if (el.type === 'checkbox') {
      val = el.checked;
    } else if (el.type === 'number' || el.type === 'range') {
      val = parseFloat(el.value);
      if (Number.isInteger(val) && !el.step?.includes('.') && el.step !== '0.1' && el.step !== '0.05' && el.step !== '0.5') val = parseInt(el.value);
    } else if (tag === 'textarea') {
      const raw = el.value.trim();
      if (el.dataset.type === 'array') {
        val = raw.split('\n').map(l=>l.trim()).filter(Boolean);
      } else {
        // Try YAML-like map parsing
        try {
          const lines = raw.split('\n').filter(l=>l.trim());
          const isMap = lines.every(l => l.includes(':'));
          if (isMap && lines.length > 0) {
            val = {};
            for (const line of lines) {
              const [k,...rest] = line.split(':');
              val[k.trim()] = rest.join(':').trim().replace(/^["']|["']$/g,'');
            }
          } else {
            val = raw;
          }
        } catch(e) { val = raw; }
      }
    } else {
      val = el.value;
    }
    setPath(updates, path, val);
  });
  // Keywords (kw-editor divs) - already maintained in S
  document.querySelectorAll('#settingsContent .kw-editor[data-path]').forEach(el => {
    const path = el.dataset.path;
    const arr = getPath(S, path) || [];
    setPath(updates, path, arr);
  });
  // Chip-Selects - already maintained in S via toggleChip()
  document.querySelectorAll('#settingsContent .chip-grid[data-path]').forEach(el => {
    const path = el.dataset.path;
    const arr = getPath(S, path) || [];
    setPath(updates, path, arr);
  });
  // Household members (dynamic list)
  if (document.getElementById('householdMembers')) {
    setPath(updates, 'household.members', collectHouseholdMembers());
  }
  return updates;
}

async function saveAllSettings() {
  // Erst aktuelle Tab-Werte in S uebernehmen, dann S als Basis nutzen
  const tabUpdates = collectSettings();
  Object.keys(tabUpdates).forEach(key => {
    if (typeof tabUpdates[key] === 'object' && !Array.isArray(tabUpdates[key]) && S[key]) {
      Object.assign(S[key], tabUpdates[key]);
    } else {
      S[key] = tabUpdates[key];
    }
  });
  // Vollstaendiges Settings-Objekt senden (nicht nur aktiven Tab)
  const updates = JSON.parse(JSON.stringify(S));
  try {
    await api('/api/ui/settings', 'PUT', {settings: updates});
    // Also update local cache
    Object.assign(S, JSON.parse(JSON.stringify(updates)));
    toast('Einstellungen gespeichert');
  } catch(e) {
    toast('Fehler beim Speichern', 'error');
  }
}

// ---- Entities ----
async function loadEntities() {
  try {
    const data = await api('/api/ui/entities');
    ALL_ENTITIES = data.entities || [];
    const domains = [...new Set(ALL_ENTITIES.map(e => e.domain))].sort();
    const sel = document.getElementById('entityDomainFilter');
    sel.innerHTML = `<option value="">Alle Domains (${ALL_ENTITIES.length})</option>`;
    for (const d of domains) {
      const c = ALL_ENTITIES.filter(e => e.domain === d).length;
      sel.innerHTML += `<option value="${d}">${d} (${c})</option>`;
    }
    filterEntities();
  } catch(e) { console.error('Entities fail:', e); }
}

function filterEntities() {
  const domain = document.getElementById('entityDomainFilter').value;
  const search = document.getElementById('entitySearchInput').value.toLowerCase();
  let filtered = ALL_ENTITIES;
  if (domain) filtered = filtered.filter(e => e.domain === domain);
  if (search) filtered = filtered.filter(e => e.entity_id.toLowerCase().includes(search) || e.name.toLowerCase().includes(search));
  const show = filtered.slice(0, 100);
  const c = document.getElementById('entityBrowser');
  c.innerHTML = show.map(e => `
    <div class="entity-item" onclick="navigator.clipboard?.writeText('${esc(e.entity_id)}');toast('${esc(e.entity_id)} kopiert')">
      <span class="ename">${esc(e.name)}</span>
      <span class="eid">${esc(e.entity_id)}</span>
      <span style="color:var(--text-muted);font-size:11px;">${esc(e.state)}</span>
    </div>`).join('');
  if (filtered.length > 100) c.innerHTML += `<div style="padding:10px;text-align:center;color:var(--text-muted);font-size:11px;">...und ${filtered.length-100} weitere</div>`;
}

// ---- Knowledge ----
async function loadKnowledge() {
  try {
    const d = await api('/api/ui/knowledge');
    const st = d.stats || {}, fi = d.files || [];
    document.getElementById('kbStats').innerHTML = `
      <div class="stat-card"><div class="stat-label">Status</div>
        <div class="stat-value" style="font-size:18px;color:${st.enabled?'var(--success)':'var(--danger)'};">${st.enabled?'Aktiv':'Aus'}</div></div>
      <div class="stat-card"><div class="stat-label">Chunks</div><div class="stat-value">${st.total_chunks||0}</div></div>
      <div class="stat-card"><div class="stat-label">Quellen</div><div class="stat-value">${(st.sources||[]).length}</div>
        <div class="stat-sub">${(st.sources||[]).join(', ')||'keine'}</div></div>`;
    document.getElementById('kbFiles').innerHTML = fi.length === 0
      ? '<div style="padding:16px;text-align:center;color:var(--text-muted);">Keine Dateien</div>'
      : fi.map(f => `<div class="file-item"><span style="font-size:16px;">&#128196;</span><span class="file-name">${esc(f.name)}</span><span class="file-size">${fmtBytes(f.size)}</span></div>`).join('');
  } catch(e) { console.error('KB fail:', e); }
}
async function ingestKnowledge() {
  try {
    const d = await api('/api/ui/knowledge/ingest', 'POST');
    toast(`${d.new_chunks} neue Chunks eingelesen`);
    loadKnowledge();
  } catch(e) { toast('Fehler beim Einlesen', 'error'); }
}

// ---- Logs ----
async function loadLogs() {
  try {
    const d = await api('/api/ui/logs');
    const convs = d.conversations || [];
    const c = document.getElementById('logsContainer');
    if (convs.length === 0) { c.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted);">Keine Gespraeche</div>'; return; }
    c.innerHTML = convs.map(cv => {
      const t = cv.timestamp ? new Date(cv.timestamp).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) : '';
      const role = cv.role || 'system';
      return `<div class="log-entry"><span class="log-time">${t}</span><span class="log-role ${role}">${role}</span><span class="log-content">${esc(cv.content||'')}</span></div>`;
    }).join('');
  } catch(e) { console.error('Logs fail:', e); }
}
</script>
</body>
</html>
