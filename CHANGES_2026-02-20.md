# MindHome Aenderungen — 20. Februar 2026 (ab 05:00)

## Uebersicht

Heute wurden 6 Bugs gefixt in 2 Commits auf Branch `claude/review-assistant-If74F`.

---

## 1. Dashboard UI — Cache-Control Headers

**Problem:** Browser zeigt alte gecachte Version der Dashboard-Seite. Der "Personen" Tab fehlt, Sektionen sind eingeklappt — obwohl der Code laengst aktualisiert wurde.

**Ursache:** Kein `Cache-Control` Header auf dem `/ui/` Endpoint. Browser cached die HTML-Datei und laedt sie nicht neu.

**Fix:** `no-cache, no-store, must-revalidate` Headers hinzugefuegt.

**Datei:** `assistant/assistant/main.py` (Zeile 1648-1657)

---

## 2. Drei wiederkehrende Datenbank-Fehler

### 2a. Geofence "Instance not bound to Session" (alle 60 Sekunden)

**Problem:** SQLAlchemy-Objekte wurden ausserhalb ihres Session-Kontexts verwendet. Die `for`-Schleife ueber `assignments` stand AUSSERHALB des `with self.get_session()` Blocks.

**Fix:** Die gesamte Verarbeitungslogik in den Session-Kontext verschoben.

**Datei:** `addon/rootfs/opt/mindhome/engines/access_control.py` (Methode `check()`)

### 2b. FK-Constraint bei Pattern-Cleanup

**Problem:** Beim Loeschen staler Patterns scheiterte `session.delete()` weil `predictions` und `pattern_match_log` Tabellen noch auf die Pattern-IDs verwiesen. Keine CASCADE-Regeln definiert.

**Fix:** Vor dem Loeschen werden jetzt zuerst die abhaengigen Datensaetze entfernt (Predictions, PatternMatchLog, self-referential depends_on_pattern_id).

**Datei:** `addon/rootfs/opt/mindhome/pattern_engine.py` (Cleanup-Block ca. Zeile 868)

### 2c. "database is locked" bei DataCollection

**Problem:** Concurrent Writes auf die `data_collection` Tabelle von StateLogger und _update_storage_sizes() Thread. SQLite erlaubt nur einen Writer gleichzeitig.

**Fix:** Retry-Logik (3 Versuche mit 100ms/200ms Pause) beim Commit in `log_state_change()`.

**Datei:** `addon/rootfs/opt/mindhome/pattern_engine.py` (Zeile ~530)

---

## 3. Sprachnachrichten funktionieren nicht

### 3a. Audio-Format: webm statt wav (Hauptproblem)

**Problem:** Der Browser nimmt Audio in `audio/webm` Format auf (MediaRecorder). Das Backend leitet dieses Format direkt an die HA Whisper STT API weiter. Whisper erwartet aber `audio/wav` (PCM 16-bit, 16kHz mono) und kann webm nicht verarbeiten → "Sprache nicht erkannt".

**Fix:**
1. `ffmpeg` zum Docker-Container hinzugefuegt (Dockerfile)
2. Im Backend wird Audio automatisch von webm zu WAV konvertiert bevor es an Whisper geht

**Dateien:**
- `addon/Dockerfile` — ffmpeg installiert
- `addon/rootfs/opt/mindhome/routes/chat.py` — Konvertierungslogik

### 3b. HTTPS-Fehlermeldung verbessert

**Problem:** Mikrofon-Zugriff braucht HTTPS (Browser-Sicherheit). Die Fehlermeldung war unklar.

**Fix:** Fehlermeldung verweist jetzt auf HA-Ingress/Seitenleiste als Loesung.

**Datei:** `addon/rootfs/opt/mindhome/static/frontend/app.jsx`

### 3c. Stilles Verwerfen bei zu kurzer Aufnahme

**Problem:** Aufnahmen unter 500 Bytes wurden ohne Feedback verworfen (stilles `return`).

**Fix:** Toast-Meldung "Aufnahme zu kurz" wird angezeigt.

**Datei:** `addon/rootfs/opt/mindhome/static/frontend/app.jsx`

---

## Was du tun musst

### Schritt 1: Code auf PC2 aktualisieren (Assistant)

```bash
cd ~/mindhome
git pull origin claude/review-assistant-If74F
cd assistant
docker compose up -d --build
```

### Schritt 2: MindHome Addon in Home Assistant neu bauen

Da das **Dockerfile** geaendert wurde (ffmpeg hinzugefuegt), muss das Addon komplett neu gebaut werden:

1. In Home Assistant → **Einstellungen → Add-ons → MindHome**
2. **Addon stoppen**
3. **Addon deinstallieren**
4. **Addon Repository neu laden** (oder manuell das Git-Repo auf dem HA-Server pullen)
5. **Addon neu installieren** → Beim Installieren wird das Docker-Image neu gebaut mit ffmpeg
6. **Addon starten**

Alternativ, wenn du SSH-Zugang zum HA-Server hast:
```bash
cd /addons/mindhome   # oder wo dein Addon-Repo liegt
git pull origin claude/review-assistant-If74F
# In HA: Addon neu bauen (Einstellungen → Add-ons → MindHome → Neu bauen)
```

### Schritt 3: Browser-Cache leeren

Damit das Dashboard die neue Version laedt:
- **Safari (iPad/Mac):** Einstellungen → Safari → Verlauf und Websitedaten loeschen
- **Chrome:** Strg+Shift+Delete → "Bilder und Dateien im Cache"
- **Oder:** Seite im privaten/Inkognito-Modus oeffnen

Nach dem Rebuild erzwingen die neuen Cache-Control Headers, dass immer die aktuelle Version geladen wird.

### Schritt 4: Sprachnachrichten testen

1. MindHome **ueber die HA-Seitenleiste** oeffnen (Ingress = HTTPS)
2. Im Chat den **Mikrofon-Button** druecken
3. Etwas sagen und **Stop** druecken
4. Erwartung: Text erscheint im Chat als transkribierte Nachricht

### Schritt 5: Logs pruefen

```bash
# Assistant-Logs (PC2):
cd ~/mindhome/assistant
docker compose logs assistant --tail 50 -f

# Addon-Logs (HA):
# In HA: Einstellungen → Add-ons → MindHome → Protokoll
```

**Erwartete Verbesserungen:**
- Geofence-Fehler (alle 60s) verschwinden komplett
- FK-Constraint-Fehler beim naechsten Pattern-Analysis-Lauf weg
- "database is locked" durch Retries aufgefangen
- Sprachnachrichten funktionieren (Audio wird zu WAV konvertiert)

---

## 4. Jarvis-Aktionen werden nicht ausgefuehrt ("Schalte Licht ein" → nichts passiert)

### 4a. Umlaut-Normalisierung in Entity-Suche (Hauptursache)

**Problem:** Die `_find_entity()` Funktion normalisiert nur ASCII-Digraphen (`ue→u`) aber NICHT Unicode-Umlaute (`ü→u`). Wenn das LLM "Küche" sagt (mit ü), wird das HA-Entity `light.kuche_licht` nicht gefunden.

**Fix:** Neue `_normalize_name()` Methode die BEIDE Formen normalisiert:
- Unicode: ü→u, ä→a, ö→o, ß→ss
- Digraphen: ue→u, ae→a, oe→o
- Normalisierung wird auf BEIDE Seiten angewendet (Suchbegriff UND Entity-Name)

**Datei:** `assistant/assistant/function_calling.py`

### 4b. LLM sagt "Erledigt" obwohl Aktion gescheitert ist

**Problem:** Das LLM generiert gleichzeitig Text ("Ich schalte das Licht ein") UND Tool-Calls. Wenn der Tool-Call fehlschlaegt, wird die Fehlerbehandlung uebersprungen weil `response_text` bereits gesetzt ist.

**Fix:** Nach der Tool-Execution wird IMMER auf Fehler geprueft. Bei fehlgeschlagenen Aktionen wird der optimistische Text durch die Fehlermeldung ersetzt.

**Datei:** `assistant/assistant/brain.py`
