# ============================================================
# M5Stack Atom Echo — Voice Satellite (Test-Konfiguration)
# Mic-Input:  SPM1423 PDM Mikrofon (1x, mono)
# TTS-Output: Eingebauter NS4168 I2S Speaker (0.5W)
# ============================================================
#
# INBETRIEBNAHME:
# ───────────────
# 1. ESPHome Add-on in Home Assistant installieren
#    (Einstellungen → Add-ons → ESPHome)
#
# 2. ESPHome Dashboard oeffnen → "New Device" klicken
#    → Name: atom-echo-test → Weiter
#    → Den generierten YAML-Inhalt KOMPLETT durch diese Datei ersetzen
#
# 3. Secrets konfigurieren:
#    → Im ESPHome Dashboard oben rechts auf "Secrets" klicken
#    → Folgende Eintraege hinzufuegen:
#      wifi_ssid: "DEIN_WLAN_NAME"
#      wifi_password: "DEIN_WLAN_PASSWORT"
#      api_encryption_key: "xxxx"   (Base64 Key, wird beim ersten Compile generiert)
#      ota_password: "ein-sicheres-passwort"
#
# 4. Erster Flash per USB:
#    → M5 Atom Echo per USB-C an den PC/NUC anschliessen
#      (auf dem Home Assistant laeuft)
#    → "Install" → "Plug into this computer" waehlen
#    → ALTERNATIV: "Install" → "Manual download" → .bin Datei
#      herunterladen und ueber https://web.esphome.io flashen
#
# 5. In Home Assistant einbinden:
#    → Einstellungen → Geraete & Dienste
#    → "Atom Echo Test" sollte automatisch erkannt werden
#    → "Konfigurieren" klicken
#    → Voice Assistant Pipeline zuweisen (z.B. "Home Assistant")
#
# 6. Testen:
#    → "Hey Jarvis" sagen → LED wird blau
#    → Frage stellen → LED wird gruen (Verarbeitung)
#    → Antwort kommt ueber den eingebauten Speaker
#
# HINWEIS: Der eingebaute 0.5W Speaker ist leise aber fuer Tests OK.
# Fuer den Produktivbetrieb empfehlen wir die Sonos-Variante
# (siehe docs/SPEAKER_RECOGNITION.md)
# ============================================================

esphome:
  name: atom-echo-test
  friendly_name: "Atom Echo Test"
  min_version: 2024.11.0

esp32:
  board: m5stack-atom
  framework:
    type: esp-idf

# --- Logging ---
logger:

# --- WiFi ---
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Fallback-Hotspot wenn WiFi nicht erreichbar
  ap:
    ssid: "Atom-Echo-Test"
    password: "mindhome123"

captive_portal:

# --- I2S Audio Bus (Mikrofon + Speaker teilen sich den Bus) ---
i2s_audio:
  - id: i2s_audio_bus
    i2s_lrclk_pin: GPIO33
    i2s_bclk_pin: GPIO19

# --- Mikrofon: SPM1423 PDM (mono) ---
microphone:
  - platform: i2s_audio
    id: atom_mic
    adc_type: external
    i2s_audio_id: i2s_audio_bus
    i2s_din_pin: GPIO23
    pdm: true

# --- Speaker: NS4168 I2S (0.5W, eingebaut) ---
speaker:
  - platform: i2s_audio
    id: atom_speaker
    i2s_audio_id: i2s_audio_bus
    dac_type: external
    i2s_dout_pin: GPIO22
    i2s_mode: primary

# --- Wake Word (lokal auf dem ESP32) ---
# VAD reduziert False Positives, wake_word-Parameter informiert HA
micro_wake_word:
  vad:
  models:
    - model: hey_jarvis
  on_wake_word_detected:
    - voice_assistant.start:
        wake_word: !lambda return wake_word;

# --- Voice Assistant (mit eingebautem Speaker) ---
# WICHTIG: use_wake_word wird per Lambda auf false gesetzt,
# weil micro_wake_word die lokale Erkennung uebernimmt.
voice_assistant:
  id: va
  microphone: atom_mic
  speaker: atom_speaker
  noise_suppression_level: 2
  auto_gain: 31dBFS

  # Nach Verbindung zu HA: Wake Word starten
  on_client_connected:
    - delay: 2s
    - lambda: id(va).set_use_wake_word(false);
    - micro_wake_word.start:

  # Bei Verbindungsverlust: Wake Word stoppen
  on_client_disconnected:
    - micro_wake_word.stop:

  # LED-Feedback
  on_listening:
    - light.turn_on:
        id: led
        blue: 100%
        red: 0%
        green: 0%
        brightness: 75%
        effect: none
  on_stt_vad_end:
    - light.turn_on:
        id: led
        blue: 0%
        red: 0%
        green: 100%
        brightness: 50%
        effect: none
  on_tts_start:
    - light.turn_on:
        id: led
        blue: 0%
        red: 100%
        green: 50%
        brightness: 60%
        effect: none
  on_end:
    - wait_until:
        not:
          speaker.is_playing:
    - lambda: id(va).set_use_wake_word(false);
    - micro_wake_word.start:
    - light.turn_off:
        id: led
  on_error:
    - light.turn_on:
        id: led
        red: 100%
        green: 0%
        blue: 0%
        brightness: 75%
        effect: none
    - delay: 3s
    - lambda: id(va).set_use_wake_word(false);
    - micro_wake_word.start:
    - light.turn_off:
        id: led

# --- RGB LED (1x SK6812) ---
light:
  - platform: esp32_rmt_led_strip
    id: led
    pin: GPIO27
    num_leds: 1
    chipset: SK6812
    rgb_order: GRB

# --- Button (Kurzerdruck = Wake Word neustarten, Langdruck 10s = Factory Reset) ---
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO39
      inverted: true
    name: "Button"
    id: echo_button
    on_multi_click:
      - timing:
          - ON for at least 50ms
          - OFF for at least 50ms
        then:
          - if:
              condition:
                voice_assistant.is_running:
              then:
                - voice_assistant.stop:
              else:
                - lambda: id(va).set_use_wake_word(false);
                - micro_wake_word.start:
      - timing:
          - ON for at least 10s
        then:
          - button.press: factory_reset_btn

# --- Factory Reset Button (intern) ---
button:
  - platform: factory_reset
    id: factory_reset_btn
    name: "Factory Reset"
    entity_category: diagnostic

# --- API & OTA ---
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password
